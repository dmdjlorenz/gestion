<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BARTH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    touch-action: manipulation;
    overscroll-behavior-y: none;
    max-width: 100%;
    overflow-x: hidden;
}

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type=number] {
    -moz-appearance: textfield;
}

html {
    width: 100%;
    overflow-x: hidden;
}

.invoice-button-group.buttons.no-print {
    display: flex ‚Äú‚Ä¶flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}
.invoice-button-group .button-row {
    display: flex;
    flex-wrap: nowrap;
    gap: 9px;
    width: 100%;
    max-width: 100%;
    justify-content: center;
}
.invoice-button-group .button-row button {
    min-width: 110px;
    text-align: center;
    padding: 8px 8px;
    font-size: 16px;
    flex: 1;
    max-width: 220px;
}
@media (max-width: 480px) {
    .invoice-button-group .button-row {
        flex-wrap: wrap;
        gap: 6px;
    }
    .invoice-button-group .button-row button {
        min-width: 80px;
        font-size: 18px;
        padding: 12px 6px;
    }
}
@media print {
    .invoice-button-group.buttons.no-print {
        display: none !important;
    }
}
.buttons.no-print button {
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 4px;
    white-space: nowrap;
    cursor: pointer;
    border: none;
    text-align: center;
    box-sizing: border-box;
}
.buttons.no-print {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}
@media (max-width: 480px) {
    .buttons.no-print button {
        padding: 8px 12px;
        font-size: 16px;
    }
}
.button-container {
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
    justify-content: center;
}
#addProductBtn, #deleteProductBtn {
    padding: 6px 10px;
    font-size: 13px;
    white-space: nowrap;
}
.hidden {
    display: none !important;
}
#tableauBenefices {
    width: 100%;
    border-collapse: collapse;
    font-size: 16px;
    table-layout: auto;
}
#tableauBenefices th, #tableauBenefices td {
    padding: 6px;
    border: 1px solid #ddd;
    text-align: center;
}
@media (max-width: 600px) {
    #tableauBenefices {
        font-size: 12px;
    }
}
.standard-popup {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
}
#homePage {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}
#homePage h1, #homePage h2 {
    color: #333;
    margin-bottom: 20px;
}
#homePage .button-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    max-width: 400px;
    margin: 0 auto;
}
#homePage button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 130px;
    height: 130px;
    padding: 10px;
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 16px;
    cursor: pointer;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: transform 0.2s;
}
#homePage button:hover {
    transform: scale(1.05);
}
#homePage button i {
    font-size: 32px;
    margin-bottom: 10px;
}
#homePage #recipeBookBtn {
    background: #32CD32;
}
#homePage #recipeBookBtn:hover {
    background: #2AB82A;
}
#homePage #purchasesBtn {
    background: #C71585;
}
#homePage #purchasesBtn:hover {
    background: #B01378;
}
#homePage #personnelBtn {
    background: #6f42c1;
}
#homePage #personnelBtn:hover {
    background: #5a32a3;
}
#homePage #invoiceBtn {
    background: #0000FF;
}
#homePage #invoiceBtn:hover {
    background: #0000CC;
}
#homePage #budgetBtn {
    background: #FFA500;
}
#homePage #budgetBtn:hover {
    background: #E59400;
}
#homePage #officialRecipeBookBtn {
    background: #32CD32;
}
#homePage #officialRecipeBookBtn:hover {
    background: #2AB82A;
}
#homePage #indicatorsBtn {
    background: #800000;
}
#homePage #indicatorsBtn:hover {
    background: #660000;
}
#homePage #settingsBtn {
    background: #808080;
}
#homePage #settingsBtn:hover {
    background: #666666;
}
@media (max-width: 480px) {
    #homePage .button-grid {
        max-width: 300px;
    }
    #homePage button {
        width: 130px;
        height: 130px;
    }
}
#passwordPage {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}
#passwordPage h2 {
    color: #333;
    margin-bottom: 20px;
}
#passwordPage input {
    padding: 10px;
    width: 80%;
    max-width: 300px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}
#passwordPage button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}
#passwordPage button:hover {
    background: #0056b3;
}
#recipeBookPage, #recipeManagementPage, #invoicePage, #invoiceManagementPage, #invoiceDetailPage, #purchasesPage, #purchasesManagementPage, #personnelPage, #personnelManagementPage {
    max-width: 600px;
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
#recipeBookPage h1, #recipeManagementPage h1, #invoicePage h1, #invoiceManagementPage h1, #invoiceDetailPage h1, #purchasesPage h1, #purchasesManagementPage h1, #personnelPage h1, #personnelManagementPage h1 {
    text-align: center;
    font-size: 1.5em;
    margin-bottom: 10px;
    color: #333;
}
button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}
button:hover {
    background: #0056b3;
}
#recipeBookPage .date-nav, #purchasesPage .date-nav, #personnelPage .date-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}
#recipeBookPage .date-nav button, #purchasesPage .date-nav button, #personnelPage .date-nav button {
    background: #ddd;
    color: #333;
    padding: 8px 12px;
}
#recipeBookPage .date-nav button:hover, #purchasesPage .date-nav button:hover, #personnelPage .date-nav button:hover {
    background: #ccc;
}
#saveRecipeBtn, #addPurchaseBtn, #addPersonnelBtn, #addProductBtn {
    background: #32CD32;
}
#saveRecipeBtn:hover, #addPurchaseBtn:hover, #addPersonnelBtn:hover, #addProductBtn:hover {
    background: #2AB82A;
}
#deleteProductBtn, #deleteRecipeBtn, #deleteDetailBtn, #clearInvoiceBtn, .delete-btn {
    background: #FF0000;
}
#deleteProductBtn:hover, #deleteRecipeBtn:hover, #deleteDetailBtn:hover, #clearInvoiceBtn:hover, .delete-btn:hover {
    background: #CC0000;
}
#manageRecipesBtn, #manageInvoicesBtn, #managePurchasesBtn, #managePersonnelBtn {
    background: #0000FF;
}
#manageRecipesBtn:hover, #manageInvoicesBtn:hover, #managePurchasesBtn:hover, #managePersonnelBtn:hover {
    background: #0000CC;
}
#printInvoiceBtn, #printAllRecipesBtn, #printAllInvoicesBtn, #printPurchasesBtn, #printPersonnelBtn, #printDetailBtn, #printBluetoothBtn, #printBluetoothPurchasesBtn, #printBluetoothPersonnelBtn, #printBluetoothSalesBtn {
    background: #FFFF00;
    color: #000;
}
#printInvoiceBtn:hover, #printAllRecipesBtn:hover, #printAllInvoicesBtn:hover, #printPurchasesBtn:hover, #printPersonnelBtn:hover, #printDetailBtn:hover, #printBluetoothBtn:hover, #printBluetoothPurchasesBtn:hover, #printBluetoothPersonnelBtn:hover, #printBluetoothSalesBtn:hover {
    background: #CCCC00;
}
#sendSmsInvoiceBtn, #sendEmailInvoiceBtn {
    background: #800080;
}
#sendSmsInvoiceBtn:hover, #sendEmailInvoiceBtn:hover {
    background: #660066;
}
#saveInvoiceBtn {
    background: #32CD32;
}
#saveInvoiceBtn:hover {
    background: #2AB82A;
}
#recipeBookPage .buttons button[onclick="backToHome()"],
#recipeManagementPage .buttons button[onclick="backToRecipeBook()"],
#invoicePage .buttons button[onclick="backToHome()"],
#invoiceManagementPage .buttons button[onclick="backToInvoice()"],
#invoiceDetailPage .buttons button[onclick="backToInvoiceManagement()"],
#purchasesPage .buttons button[onclick="backToHome()"],
#purchasesManagementPage .buttons button[onclick="backToPurchases()"],
#personnelPage .buttons button[onclick="backToHome()"],
#budgetPage button[onclick="backToHome()"],
#personnelManagementPage .buttons button[onclick="backToPersonnel()"],
#indicatorsPage button[onclick="backToHome()"],
#fiscalPage button[onclick="backToHome()"] {
    background: #808080;
}
#recipeBookPage .buttons button[onclick="backToHome()"]:hover,
#recipeManagementPage .buttons button[onclick="backToRecipeBook()"]:hover,
#invoicePage .buttons button[onclick="backToHome()"]:hover,
#invoiceManagementPage .buttons button[onclick="backToInvoice()"]:hover,
#invoiceDetailPage .buttons button[onclick="backToInvoiceManagement()"]:hover,
#purchasesPage .buttons button[onclick="backToHome()"]:hover,
#purchasesManagementPage .buttons button[onclick="backToPurchases()"]:hover,
#personnelPage .buttons button[onclick="backToHome()"]:hover,
#budgetPage button[onclick="backToHome()"]:hover,
#personnelManagementPage .buttons button[onclick="backToPersonnel()"]:hover,
#indicatorsPage button[onclick="backToHome()"]:hover,
#fiscalPage button[onclick="backToHome()"]:hover {
    background: #666666;
}
#recipeBookPage .input-group, #purchasesPage .input-group, #personnelPage .input-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}
#recipeBookPage .input-field, #purchasesPage .input-field, #personnelPage .input-field {
    display: flex;
    flex-direction: column;
}
#recipeBookPage label, #purchasesPage label, #personnelPage label {
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}
#recipeBookPage input, #purchasesPage input[type="number"], #personnelPage input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
}
#purchasesPage input[type="text"], #personnelPage input[type="text"] {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
}
#purchasesPage .radio-group, #personnelPage .select-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}
#invoicePage .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 5px;
}
#invoicePage .checkbox-group label, #purchasesPage .radio-group label, #personnelPage .select-group label {
    display: flex;
    align-items: center;
    font-size: 16px;
    color: #333;
    font-weight: normal;
}
#invoicePage .checkbox-group input[type="checkbox"], #purchasesPage .radio-group input[type="radio"] {
    margin-right: 10px;
}
#invoicePage .checkbox-group {
    flex-direction: row;
    align-items: center;
    gap: 0;
    width: 100%;
    text-align: left;
}
#invoicePage .checkbox-group label {
    display: inline-flex;
    white-space: nowrap;
    margin: 0;
    padding: 0;
}
#invoicePage .checkbox-group .first-label {
    margin-right: 30px;
}
#invoicePage .checkbox-group input[type="checkbox"] {
    margin: 0 0 0 5px;
    padding: 0;
    width: 16px;
    height: 16px;
    min-width: 0;
    min-height: 0;
}
#invoicePage .dropdown {
    position: relative;
    display: block;
    width: 100%;
    margin-bottom: 10px;
}
#invoicePage .dropdown button[onclick="toggleDropdown('menuDropdown')"] {
    width: 100%;
    background: #999999;
    color: white;
}
#invoicePage .dropdown button[onclick="toggleDropdown('menuDropdown')"]:hover {
    background: #666666;
}
#invoicePage .dropdown button[onclick="toggleDropdown('commandeDropdown')"] {
    width: 100%;
    background: #008000;
    color: white;
}
#invoicePage .dropdown button[onclick="toggleDropdown('commandeDropdown')"]:hover {
    background: #006600;
}
#invoicePage .dropdown-content {
    display: none;
    position: absolute;
    background-color: #fff;
    width: 100%;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    padding: 12px 16px;
    z-index: 1;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 4px;
    box-sizing: border-box;
}
#invoicePage .show {
    display: block;
}
#invoicePage input, #invoicePage select, #personnelPage select {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}
#invoicePage #productList {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    overflow-x: auto;
}
#invoicePage #productList li {
    padding: 3px 8px;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
}
#invoicePage #productList input[type="checkbox"] {
    margin-right: 10px;
    width: 20px;
    height: 20px;
    cursor: pointer;
}
#personnelPage #personnelSummary {
    margin-top: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 210mm;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
}
#invoicePage #invoice {
    margin-top: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 210mm;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
}
:root {
    --border-color: #ddd;
    --table-header-bg: #f2f2f2;
    --orange: #FFA500;
    --orange-hover: #E59400;
    --green: #32CD32;
    --green-hover: #2AB82A;
    --red: #FF0000;
    --red-hover: #CC0000;
    --font-size-base: 14px;
    --font-size-mobile: 12px;
    --padding-base: 8px;
    --padding-compact: 6px;
    --padding-mobile: 4px;
}
* {
    box-sizing: border-box;
}
table {
    width: 100%;
    border-collapse: collapse;
}
.table-container {
    width: 100%;
    overflow-x: auto;
}
#invoicePage th, #invoicePage td,
#recipeManagementPage th, #recipeManagementPage td,
#invoiceManagementPage th, #invoiceManagementPage td,
#purchasesManagementPage th, #purchasesManagementPage td,
#personnelManagementPage th, #personnelManagementPage td {
    border: 1px solid var(--border-color);
    text-align: left;
    font-size: var(--font-size-base);
}
#recipeManagementPage table,
#invoiceManagementPage table,
#invoicePage table {
    margin-bottom: 20px;
}
#recipeManagementPage th, #recipeManagementPage td,
#invoiceManagementPage th, #invoiceManagementPage td,
#invoicePage th, #invoicePage td {
    padding: var(--padding-base);
}
#purchasesManagementPage table,
#personnelManagementPage table {
    table-layout: auto;
}
#purchasesManagementPage tfoot td {
    white-space: normal;
    overflow-wrap: break-word;
}
#purchasesManagementPage th, #purchasesManagementPage td,
#personnelManagementPage th, #personnelManagementPage td {
    padding: var(--padding-compact);
    overflow-wrap: break-word;
    max-width: 120px;
    min-width: 50px;
}
#invoicePage th,
#recipeManagementPage th,
#invoiceManagementPage th,
#purchasesManagementPage th,
#personnelManagementPage th {
    background-color: var(--table-header-bg);
}
#purchasesManagementPage th:nth-child(5),
#purchasesManagementPage td:nth-child(5) {
    max-width: 80px;
    white-space: normal;
}
#personnelManagementPage th:nth-child(6),
#personnelManagementPage td:nth-child(6) {
    max-width: 80px;
    white-space: normal;
}
.btn-orange {
    background: var(--orange);
}
.btn-orange:hover {
    background: var(--orange-hover);
}
.btn-green {
    background: var(--green);
}
.btn-green:hover {
    background: var(--green-hover);
}
.btn-red {
    background: var(--red);
}
.btn-red:hover {
    background: var(--red-hover);
}
#recipeManagementPage #exportRecipeBtn,
#recipeManagementPage #exportPurchasesPdfBtn,
#purchasesManagementPage #exportPurchasesPdfBtn,
#invoicePage #exportInvoicePdfBtn,
#personnelManagementPage #exportPersonnelPdfBtn {
    background: var(--orange);
}
#recipeManagementPage #exportRecipeBtn:hover,
#recipeManagementPage #exportPurchasesPdfBtn:hover,
#purchasesManagementPage #exportPurchasesPdfBtn:hover,
#invoicePage #exportInvoicePdfBtn:hover,
#personnelManagementPage #exportPersonnelPdfBtn:hover {
    background: var(--orange-hover);
}
#invoicePage #commandeDropdown button {
    background: var(--green);
}
#invoicePage #commandeDropdown button:hover {
    background: var(--green-hover);
}
#personnelPage .select-group button[onclick="addEmployee()"] {
    background: var(--green);
}
#personnelPage .select-group button[onclick="addEmployee()"]:hover {
    background: var(--green-hover);
}
#personnelPage .select-group button[onclick="deleteEmployee()"] {
    background: var(--red);
}
#personnelPage .select-group button[onclick="deleteEmployee()"]:hover {
    background: var(--red-hover);
}
#invoicePage #orderTotal,
#personnelPage #personnelTotal {
    width: 100%;
    margin-top: 20px;
}
#invoicePage .total-table,
#personnelPage .total-table {
    width: 100%;
    max-width: 300px;
    margin-left: auto;
    margin-right: 0;
}
#invoicePage .total-table td:last-child,
#personnelPage .total-table td:last-child {
    text-align: right;
}
#invoicePage #invoiceContainer,
#personnelPage #personnelContainer {
    background-color: white;
    width: 100%;
    max-width: 210mm;
    padding: 20px;
    margin: auto;
}
#invoicePage #invoiceHeader {
    text-align: center;
    margin-bottom: 20px;
    position: relative;
}
#invoicePage #invoiceHeader .invoice-number {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 16px;
    font-weight: bold;
}
#recipeManagementPage .date-filter,
#invoiceManagementPage .date-filter,
#purchasesManagementPage .date-filter,
#personnelManagementPage .date-filter,
#indicatorsPage .date-filter,
#fiscalPage .date-filter {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
    text-align: left;
}
#recipeManagementPage .date-filter label,
#invoiceManagementPage .date-filter label,
#purchasesManagementPage .date-filter label,
#personnelManagementPage .date-filter label,
#indicatorsPage .date-filter label,
#fiscalPage .date-filter label {
    font-weight: bold;
    color: #333;
}
#recipeManagementPage .date-filter input,
#invoiceManagementPage .date-filter input,
#purchasesManagementPage .date-filter input,
#personnelManagementPage .date-filter input,
#indicatorsPage .date-filter input,
#fiscalPage .date-filter input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}
#budgetPage .buttons,
#recipeBookPage .buttons,
#recipeManagementPage .buttons,
#invoicePage .buttons,
#invoiceManagementPage .buttons,
#purchasesPage .buttons,
#purchasesManagementPage .buttons,
#personnelPage .buttons,
#personnelManagementPage .buttons,
#invoiceDetailPage .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}
#invoiceDetailPage {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
#invoiceDetailPage h1 {
    text-align: center;
    font-size: 1.5em;
    margin-bottom: 20px;
    color: #333;
}
#recipeManagementPage th, #recipeManagementPage td,
#invoiceManagementPage th, #invoiceManagementPage td,
#personnelManagementPage th, #personnelManagementPage td {
    cursor: pointer;
}
.no-print {
    display: block;
}
@media print {
    .no-print,
    button,
    .buttons {
        display: none !important;
    }
    table {
        width: 100%;
        page-break-inside: auto;
    }
    tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
    body {
        margin: 10mm;
    }
}
@media (max-width: 480px) {
    #recipeBookPage,
    #recipeManagementPage,
    #invoicePage,
    #invoiceManagementPage,
    #invoiceDetailPage,
    #purchasesPage,
    #purchasesManagementPage,
    #personnelPage,
    #personnelManagementPage {
        padding: 12px;
    }
    #recipeBookPage h1,
    #recipeManagementPage h1,
    #invoicePage h1,
    #invoiceManagementPage h1,
    #invoiceDetailPage h1,
    #purchasesPage h1,
    #purchasesManagementPage h1,
    #personnelPage h1,
    #personnelManagementPage h1 {
        font-size: 1.2em;
    }
    #recipeBookPage input,
    #recipeBookPage button,
    #invoicePage input,
    #invoicePage button,
    #invoicePage select,
    #purchasesPage input,
    #purchasesPage button,
    #purchasesManagementPage input,
    #purchasesManagementPage button,
    #personnelPage input,
    #personnelPage button,
    #personnelPage select,
    #personnelManagementPage button {
        font-size: 0.9em;
    }
    #invoicePage th, #invoicePage td,
    #recipeManagementPage th, #recipeManagementPage td,
    #invoiceManagementPage th, #invoiceManagementPage td,
    #purchasesManagementPage th, #purchasesManagementPage td,
    #personnelManagementPage th, #personnelManagementPage td {
        font-size: var(--font-size-mobile);
        padding: var(--padding-mobile);
    }
    #purchasesManagementPage th, #purchasesManagementPage td,
    #personnelManagementPage th, #personnelManagementPage td {
        max-width: 80px;
        min-width: 40px;
    }
    #purchasesManagementPage th:nth-child(1),
    #purchasesManagementPage td:nth-child(1) {
        max-width: 90px;
        white-space: nowrap;
    }
    #purchasesManagementPage th:nth-child(5),
    #purchasesManagementPage td:nth-child(5) {
        max-width: 60px;
    }
    #personnelManagementPage th:nth-child(1),
    #personnelManagementPage td:nth-child(1) {
        max-width: 120px;
        white-space: nowrap;
    }
    #personnelManagementPage th:nth-child(6),
    #personnelManagementPage td:nth-child(6) {
        max-width: 60px;
    }
    #invoicePage #invoiceContainer,
    #personnelPage #personnelContainer {
        height: auto;
    }
}
.payment-section {
    display: flex;
    align-items: center;
    gap: 10px;
}
.payment-section label {
    display: flex;
    align-items: center;
}
.spacer {
    width: 1cm;
}
#budgetPage.hidden {
    display: none !important;
    visibility: hidden !important;
}
.container {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.container input, .container label {
    width: 100%;
    margin: 10px 0;
    padding: 10px;
    box-sizing: border-box;
}
.container input {
    border: 1px solid #ccc;
    border-radius: 4px;
}
.result {
    margin-top: 20px;
}
.negative {
    color: red;
}
.container table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}
.container table, .container th, .container td {
    border: 1px solid #ddd;
}
.container th, .container td {
    padding: 10px;
    text-align: center;
}
.container th {
    background-color: #f2f2f2;
}
.export-button {
    background: #FFA500;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
}
.export-button:hover {
    background: #E59400;
}
@media print {
    .container {
        page-break-inside: avoid;
    }
    .container table, .container tr, .container td, .container th {
        page-break-inside: avoid;
    }
}
#settingsPage {
    text-align: center;
    padding: 20px;
}
#settingsPage button {
    display: block;
    width: 80%;
    max-width: 300px;
    margin: 10px auto;
    padding: 15px;
    font-size: 16px;
    border: none;
    border-radius: 15px;
    cursor: pointer;
}
#indicatorsPage {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: center;
}
#indicatorsPage h2 {
    font-size: 1.5em;
    margin-bottom: 20px;
    color: #333;
}
#indicatorsPage table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
#indicatorsPage th, #indicatorsPage td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}
#indicatorsPage th {
    background-color: #ccc;
}
#indicatorsPage .coef-low::after {
    content: " üò¢";
    color: #FF0000;
    font-size: 34px;
}
#indicatorsPage .coef-medium::after {
    content: " üòê";
    color: #FFA500;
    font-size: 34px;
}
#indicatorsPage .coef-high::after {
    content: " üòä";
    color: #00FF00;
    font-size: 34px;
}
#indicatorsPage .coef-champagne::after {
    content: " ü•Ç";
    font-size: 34px;
}
#indicatorsPage th:nth-child(2), #indicatorsPage td:nth-child(2),
#indicatorsPage th:nth-child(3), #indicatorsPage td:nth-child(3) {
    width: 100px;
}
#indicatorsPage th:nth-child(4), #indicatorsPage td:nth-child(4) {
    font-size: 18px;
}
#indicatorsPage canvas {
    max-height: 300px;
    width: auto;
    box-sizing: border-box;
}
#indicatorsPage input[type="date"] {
    margin-right: 10px;
    padding: 5px;
}
#indicatorsPage h4 {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 1.1em;
}
.chart-container {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
    margin-bottom: 10px;
}
.chart-container canvas {
    max-width: none;
    width: auto;
}
#homePage #fiscalBtn {
    background: #FF0000;
}
#homePage #fiscalBtn:hover {
    background: #CC0000;
}
#homePage .wide-settings-btn {
    width: 280px;
    height: 60px;
    margin: 15px auto 0;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    background: #808080;
    border-radius: 16px;
    font-size: 16px;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: transform 0.2s;
}
#homePage .wide-settings-btn:hover {
    background: #666666;
    transform: scale(1.05);
}
#homePage .wide-settings-btn i {
    margin-right: 10px;
    font-size: 20px;
}
@media (max-width: 480px) {
    #homePage .wide-settings-btn {
        width: 280px;
        height: 60px;
        font-size: 14px;
    }
}

#fiscalPage {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: center;
}
#fiscalPage h2 {
    font-size: 1.5em;
    margin-bottom: 20px;
    color: #333;
}
#fiscalPage table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
#fiscalPage th, #fiscalPage td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}
#fiscalPage th {
    background-color: #ccc;
    color: #333;
}
@media (max-width: 480px) {
    #fiscalPage {
        padding: 12px;
    }
    #fiscalPage h2 {
        font-size: 1.2em;
    }
    #fiscalPage th, #fiscalPage td {
        font-size: 12px;
        padding: 4px;
    }
}

.weekday-table {
    width: 100%;
    max-width: 400px;
    border-collapse: collapse;
    margin-top: 10px;
    font-family: Arial, sans-serif;
}

.weekday-table th,
.weekday-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.weekday-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.weekday-table td {
    background-color: #fff;
}

.weekday-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.weekday-table tr:hover {
    background-color: #f5f5f5;
}
#weekdayCaChart {
    margin-top: 10px;
    max-width: 100%;
}

#homePage #bilanBtn {
    background: #00BFFF;
}
#homePage #bilanBtn:hover {
    background: #00A5E0;
}

* {
    box-sizing: border-box;
}

#bilanPage {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    text-align: center;
    width: 100%;
}

#bilanPage h2 {
    font-size: 1.5em;
    margin-bottom: 20px;
    color: #333;
}

#bilanTable {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
}

#bilanTable table {
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    width: 100%;
    min-width: 0;
}

#bilanTable th, #bilanTable td {
    border: 1px solid #ddd !important;
    padding: 8px;
    text-align: center;
    font-size: 16px !important;
    white-space: nowrap;
    width: auto;
}

#bilanTable th {
    background-color: #ccc;
    color: #333;
}

#bilanTable th:first-child,
#bilanTable td:first-child {
    position: sticky;
    left: 0;
    background: white;
    z-index: 5;
    min-width: 120px;
    border-left: 1px solid #ddd !important;
    border-right: 2px solid #ddd !important;
    box-shadow: inset 0 0 0 1px #ddd, 2px 0 2px rgba(0, 0, 0, 0.1);
}

#bilanTable input[type="number"] {
    width: 60px;
    font-size: 16px;
    padding: 3px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
}

#bilanPage .date-filter {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
    text-align: left;
}

#bilanPage .date-filter label {
    font-weight: bold;
    color: #333;
    display: block;
    margin-bottom: 5px;
}

#bilanPage .date-filter input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    width: 100%;
}

#bilanPage .buttons.no-print {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}

#bilanPage button[onclick="backToHome()"] {
    background: #808080;
    padding: 10px 20px;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

#bilanPage button[onclick="backToHome()"]:hover {
    background: #666666;
}

#bilanPage .export-button {
    background: #FFA500;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
}

#bilanPage .export-button:hover {
    background: #E59400;
}

#bilanTable::-webkit-scrollbar {
    height: 8px;
}

#bilanTable::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
}

#bilanTable::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
}

@media (max-width: 480px) {
    html {
        font-size: 16px;
    }

    #bilanPage {
        padding: 6px;
        width: 100%;
        max-width: 100%;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
    }

    #bilanPage h2 {
        font-size: 1.4em;
        margin-bottom: 10px;
    }

    #bilanTable table {
        width: 100%;
        min-width: 0;
    }

    #bilanTable th, #bilanTable td {
        font-size: 14px !important;
        padding: 6px;
        width: auto;
    }

    #bilanTable th:first-child,
    #bilanTable td:first-child {
        min-width: 90px;
        font-size: 14px !important;
    }

    #bilanTable input[type="number"] {
        width: 50px;
        font-size: 14px;
        padding: 3px;
    }

    #bilanPage .date-filter {
        gap: 5px;
        margin-bottom: 10px;
    }

    #bilanPage .date-filter label {
        font-size: 14px;
        margin-top: 4px;
        margin-bottom: 2px;
    }

    #bilanPage .date-filter input {
        padding: 6px;
        font-size: 14px;
    }

    #bilanPage .buttons.no-print {
        gap: 5px;
        margin-top: 10px;
    }

    #bilanPage button {
        font-size: 0.9em;
        padding: 6px 12px;
    }
}

@media print {
    #bilanPage .no-print,
    #bilanPage button,
    #bilanPage .buttons {
        display: none !important;
    }

    #bilanTable {
        width: 100%;
        page-break-inside: auto;
    }

    #bilanTable tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
}
/* ‚úÖ Correction sp√©cifique et isol√©e pour la page fiscale */
#fiscalPage, 
#fiscalPage * {
    box-sizing: border-box;
}

#fiscalPage {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    margin: 0 auto;
    padding: 20px;
    background: white;
}

/* üîí tout ce qui suit est limit√© √† #fiscalPage uniquement */
#fiscalPage #fiscalTable {
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
}

#fiscalPage #fiscalTable table {
    width: 100%;
    border-collapse: collapse;
    margin: 0 auto;
    text-align: center;
}

#fiscalPage #fiscalTable th, 
#fiscalPage #fiscalTable td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
}

/* ‚úÖ fige la premi√®re colonne */
#fiscalPage #fiscalTable th:first-child,
#fiscalPage #fiscalTable td:first-child {
    position: sticky;
    left: 0;
    background: white;
    z-index: 2;
    box-shadow: 2px 0 2px rgba(0,0,0,0.1);
}

#fiscalPage h3 {
    text-align: center;
    margin-bottom: 12px;
}

/*#indicatorsPage {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}*/


    </style>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icone.png" type="image/png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="MaApp">
    <link rel="apple-touch-icon" href="icone.png">
</head>
<body>
    <div id="passwordPage">
        <h2>Entrer le mot de passe</h2>
        <input type="password" id="passwordInput" placeholder="Mot de passe">
        <button onclick="checkPassword()">Valider</button>
        <p id="errorMessage" style="color: red; display: none;">Mot de passe incorrect !</p>
    </div>
 <div id="homePage" class="hidden">
  <h2>CHEZ BARTH Gestion</h2>
  <div class="button-grid">
    <button id="recipeBookBtn" onclick="showRecipeBook()">
      <i class="fas fa-euro-sign"></i>
      Ventes
    </button>
    <button id="purchasesBtn" onclick="showPurchases()">
      <i class="fas fa-shopping-cart"></i>
      Achats
    </button>
    <button id="personnelBtn" onclick="showPersonnel()">
      <i class="fas fa-users"></i>
      Personnel
    </button>
    <button id="invoiceBtn" onclick="showInvoice()">
      <i class="fas fa-file-invoice"></i>
      Commande Facture
    </button>
    <button id="budgetBtn" onclick="showBudget()">
      <i class="fas fa-wallet"></i>
      Budget
    </button>
    <button id="officialRecipeBookBtn" onclick="exportRecipeToPdfofficiel()">
      <i class="fas fa-book-open"></i>
      Livre des recettes officiel
    </button>
    <button id="indicatorsBtn" onclick="showIndicators()">
      <i class="fas fa-chart-line"></i>
      Indicateurs
    </button>
    <button id="fiscalBtn" onclick="showFiscal()">
      <span style="font-size:2em; margin-bottom:5px;">üò£</span>
      Taxes
    </button>
    <!-- Nouveaux boutons int√©gr√©s √† la grille -->
    <button id="bilanBtn" onclick="showBilan()">
      <i class="fas fa-coins"></i>
      Bilan
    </button>
    <button id="settingsBtn" onclick="showSettings()">
      <i class="fas fa-cog"></i>
      Param√®tres
    </button>
  </div>
</div>


<div id="fiscalPage" class="page hidden">
    <h2>Taxes, Imp√¥ts et Urssaf</h2>
    <div class="date-filter" style="text-align: left;">
    <label style="display: block; margin-bottom: 5px;">Date de d√©but :</label>
    <input type="text" id="fiscalStartDate" onchange="displayFiscalTable()" value="09/12/2024">
    <label style="display: block; margin-top: 10px; margin-bottom: 5px;">Date de fin :</label>
    <input type="text" id="fiscalEndDate" onchange="displayFiscalTable()">
</div>
     <div id="fiscalTable"></div>
       <div class="buttons no-print" style="margin-top: 20px;">
         <button onclick="backToHome()" style="background:#666666; color:white;">Retour</button>
       </div>
</div>


<div id="bilanPage" class="page hidden">
    <h2>COMPTES DE RESULTAT</h2>
    <div class="date-filter" style="text-align: left;">
        <label style="display: block; margin-bottom: 5px;">Date de d√©but :</label>
        <input type="date" id="bilanStartDate" value="2024-12-09" onchange="displayBilan()">
        <label style="display: block; margin-top: 10px; margin-bottom: 5px;">Date de fin :</label>
        <input type="date" id="bilanEndDate" onchange="displayBilan()">
    </div>
    <div id="bilanTable" style="overflow-x: auto; max-width: 100%;">
        <!-- Le tableau g√©n√©r√© dynamiquement s'affichera ici -->
    </div>
    <div class="buttons no-print" style="margin-top: 20px;">
        <button onclick="backToHome()" style="background:#666666; color:white;">Retour</button>
    </div>
</div>



    <!-- Nouvelle page Param√®tres -->
    <div id="settingsPage" class="page hidden">
        <h2>Param√®tres</h2>
        <button onclick="backupData()" style="background:#32CD32; color:white;">Sauvegarder et exporter les donn√©es actuelles dans un fichier "chez_barth_backup ().json"</button>
        <button onclick="resetData()" style="background:#FF0000; color:white;"> ! R√©initialiser et supprimer toutes les donn√©es saisies </button>
        <button onclick="importData()" style="background:#0000FF; color:white;">Importer des donn√©es sauvegard√©es sur fichier "chez_Barth_backup ().json"</button>
        <button onclick="navigateTo('homePage')" style="background:#666666; color:white;">Retour</button>
    </div>
<!-- ... Reste du HTML ... -->
 <div id="indicatorsPage" class="page hidden">
    <h2>Indicateurs</h2>
    <div class="date-filter">
        <label>Date de d√©but :</label>
        <input type="date" id="indicatorsStartDate" onchange="displayIndicatorsTable()" value="2024-12-01">
        <label>Date de fin :</label>
        <input type="date" id="indicatorsEndDate" onchange="displayIndicatorsTable()">
    </div>

    <div id="indicatorsTable"></div>
    <h4>Coefficient de vente</h4>
    <div class="chart-container">
        <canvas id="coefVenteChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>Co√ªt de revient Panier Moyen</h4>
    <div class="chart-container">
        <canvas id="coutReviensChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>Prix de vente Panier Moyen</h4>
    <div class="chart-container">
        <canvas id="prixVenteChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>Marge Brute Panier Moyen</h4>
    <div class="chart-container">
        <canvas id="margeBruteChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>Chiffre d'affaire mensuel</h4>
    <div class="chart-container">
        <canvas id="caMensuelChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>Ventes par jour en moyenne</h4>
    <div class="chart-container">
        <canvas id="caParJourChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>CA moyen des jours de semaine</h4>
    <div class="chart-container">
        <canvas id="weekdayCaChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <h4>Taux de cash</h4>
    <div class="chart-container">
        <canvas id="cashRateChart" style="margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    <div class="buttons no-print" style="margin-top: 20px;">
        <button onclick="backToHome()" style="background:#000000; color:white;">Retour</button>
    </div>
</div>




    <!-- Ventes -->
    <div id="recipeBookPage" class="hidden">
        <h1>GESTION DES VENTES</h1>
        <br>
        <div class="date-nav">
            <button id="prevDay">‚Üê</button>
            <span id="currentDate"></span>
            <button id="nextDay">‚Üí</button>
        </div>
        <div class="input-group">
            <div class="input-field">
                <label>Ventes Carte Bancaire (‚Ç¨)</label>
                <input type="number" id="cardInput" step="0.01" min="0">
            </div>
            <div class="input-field">
                <label>Ventes Esp√®ces (‚Ç¨)</label>
                <input type="number" id="cashInput" step="0.01" min="0">
            </div>
            <div class="input-field">
                <label>Total Ventes (‚Ç¨)</label>
                <input type="number" id="totalInput" readonly>
            </div>
        </div>
        <div class="buttons no-print">
    <button id="saveRecipeBtn">Ajouter</button>
    <button id="manageRecipesBtn" onclick="showRecipeManagement()">Bilan des Ventes</button>
    <button onclick="backToHome()">Retour</button>
</div>
    </div>

    <!-- Bilan des Ventes -->
<div id="recipeManagementPage" class="hidden">
    <h1>Bilan des Ventes</h1>
	<br>
    <!-- Bouton export PDF -->
    <button id="exportRecipeBtn" onclick="exportRecipeToPdf()" style="margin-bottom: 20px;">T√©l√©charger Livre des recettes complet (PDF)</button>
    <!-- Filtres par date -->
   <div class="date-filter">
    <label>Date de d√©but :</label>
    <input type="date" id="recipeStartDate" onchange="filterRecipes()" value="2024-12-11">

    <label>Date de fin :</label>
    <input type="date" id="recipeEndDate" onchange="filterRecipes()">
</div>

<div id="recipeList"></div>

<script>
// D√®s que la page est pr√™te
window.addEventListener('DOMContentLoaded', () => {
    // Cr√©er une date en heure de Paris
    const parisDate = new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Paris' }));

    // Formater la date en 'YYYY-MM-DD' directement
    const today = parisDate.toLocaleDateString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).split('/').reverse().join('-'); // Change le format de 'DD/MM/YYYY' √† 'YYYY-MM-DD'

    // Mettre √† jour le champ de date
    document.getElementById('recipeEndDate').value = today;

    // Cacher l'indicateur de chargement
    document.getElementById('indicatorsPage').classList.add('hidden');
});



// Ici ta fonction filterRecipes() que tu as d√©j√†
function filterRecipes() {
    // ton code...
}
</script>



    <!-- Liste des ventes -->
    <div id="recipeList"></div>

    <!-- Boutons principaux -->
    <div class="buttons no-print" style="margin-top: 10px;">
    <button id="printAllRecipesBtn" onclick="printAllRecipes()">Imprimer</button>
    <button id="printBluetoothSalesBtn" onclick="printSalesToBluetooth()">Imprimer Bluetooth</button>
    <button id="exportPurchasesPdfBtn" onclick="downloadRecipesPDF()">T√©l√©charger</button>
    <button onclick="backToRecipeBook()">Retour</button>
</div>

    <!-- Popup de d√©tail de vente -->
<div id="recipeDetailPopup" class="hidden" style="
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
">
    <h2>D√©tail de la vente</h2>
    <p id="recipeDetailDate"></p>
    <p id="recipeDetailCard"></p>
    <p id="recipeDetailCash"></p>
    <p id="recipeDetailTotal"></p>
    <p id="recipeDetailCashRate"></p>
    <div class="buttons">
        <button onclick="deleteSelectedRecipe()" style="background:#FF0000; color:white;">Supprimer</button>
        <button onclick="closeRecipeDetail()" style="background:#666666; color:white;">Fermer</button>
    </div>
</div>
</div>


<!-- Facture -->
<div id="invoicePage" class="hidden">
    <h1>GESTION DES FACTURES CLIENTS</h1>
    <div class="checkbox-group">
        <label class="first-label">CA inf √† 101000‚Ç¨ <input type="checkbox" id="caBelow101000" onchange="toggleCA(this)"></label>
        <label>CA sup √† 101000‚Ç¨ <input type="checkbox" id="caAbove101000" onchange="toggleCA(this)" checked></label>
    </div>
    <div class="dropdown">
    <button onclick="toggleDropdown('menuDropdown')">LA CARTE Chez BARTH</button>
    <div id="menuDropdown" class="dropdown-content" onclick="event.stopPropagation()">
        <select id="productSelect"></select>
        <div class="button-container">
            <button id="addProductBtn" onclick="showMenuAction('add')">Ajouter un produit</button>
            <button id="deleteProductBtn" onclick="deleteProductFromMenu()">Supprimer le produit</button>
        </div>
        <div id="menuActionArea"></div>
    </div>
</div>
    <!-- Reste du code inchang√© -->
 <div class="dropdown">
  <button onclick="toggleDropdown('commandeDropdown')">PRISE DE COMMANDE / FACTURE</button>
  <div id="commandeDropdown" class="dropdown-content" onclick="event.stopPropagation()">
    <ul id="productList"></ul>
    <div>
      <div class="input-field" style="margin: 3px 0 0px 0;">
        <span style="font-weight: bold;">Client : </span>
        <input type="text"
               id="customerNameInput"
               placeholder="Entrez le nom du client, soci√©t√©, adresse..."
               style="margin-top: 0px; width: 100%;">
      </div>

      <div class="payment-section"
           style="display: flex; align-items: center; gap: 15px; margin-top: 0px;">
        <span style="font-weight: bold;">Paiement : </span>
        <label>
          Carte <input type="radio" name="paymentMethod" value="Carte" id="paymentCard">
        </label>
        <label>
          Esp√®ce <input type="radio" name="paymentMethod" value="Esp√®ce" id="paymentCash">
        </label>
      </div>

      <button onclick="addSelectedToOrder()">Ajouter √† la commande</button>
    </div>
  </div>
</div>



    <div id="invoice">
        <div id="invoiceContainer">
            <div id="invoiceHeader"></div>
            <div id="orderList"></div>
            <div id="orderTotal"></div>
        </div>
    </div>
    <div class="no-print" style="height: 15px;"></div>

    <div class="buttons no-print invoice-button-group">
    <div class="button-row">
        <button id="saveInvoiceBtn" onclick="saveInvoice()">Enregistrer</button>
        <button id="clearInvoiceBtn" onclick="clearOrder()">Effacer</button>
        <button id="exportInvoicePdfBtn" onclick="exportInvoiceToPdf()">T√©l√©charger</button>
    </div>
    <div class="button-row">
        <button id="printInvoiceBtn" onclick="printInvoice()">Imprimer</button>
        <button id="printBluetoothBtn" onclick="printToBluetoothThermal()">Imprimer Bluetooth</button>
    </div>
    <div class="button-row">
        <button id="sendSmsInvoiceBtn" onclick="sendInvoiceBySms()">Envoyer SMS</button>
        <button id="sendEmailInvoiceBtn" onclick="sendInvoiceByEmail()">Envoyer Email</button>
    </div>
    <div class="button-row">
        <button id="manageInvoicesBtn" onclick="showInvoiceManagement()">Bilan Factures</button>
        <button onclick="backToHome()">Retour</button>
    </div>
</div>

</div>

<!-- Bilan des Factures -->
<div id="invoiceManagementPage" class="hidden">
    <h1>Bilan des Commandes Factures</h1>
<br>
    <div class="date-filter">
    <label>Date de d√©but :</label>
    <input type="date" id="startDate" onchange="filterInvoices()" value="2024-12-11">

    <label>Date de fin :</label>
    <input type="date" id="endDate" onchange="filterInvoices()">
</div>
    <div id="invoiceList"></div>
    <div class="no-print" style="height: 15px;"></div>
    <div class="buttons no-print">
        <button id="printAllInvoicesBtn" onclick="printAllInvoices()">Imprimer la liste des factures</button>
        <button onclick="backToInvoice()">Retour</button>
    </div>
</div>

<!-- D√©tail de la Facture -->
<div id="invoiceDetailPage" class="hidden">
    <div id="invoiceDetailContainer"></div>
    <div class="no-print" style="height: 15px;"></div>
    <div class="buttons no-print">
        <button id="printDetailBtn" onclick="printInvoiceDetail()">Imprimer</button>
        <button id="deleteDetailBtn" onclick="deleteInvoiceDetail()">Supprimer</button>
        <button onclick="backToInvoiceManagement()">Retour</button>
    </div>
</div>

<!-- Achats -->
<div id="purchasesPage" class="hidden">
    <h1>GESTION DES ACHATS</h1>
<br>
    <div class="date-nav">
        <button id="prevPurchaseDay">‚Üê</button>
        <span id="currentPurchaseDate"></span>
        <button id="nextPurchaseDay">‚Üí</button>
    </div>
    <div class="input-group">
        <div class="input-field">
            <label>Achats TTC (‚Ç¨)</label>
            <input type="number" id="purchaseAmount" step="0.01" min="0">
        </div>
    </div>
    <div class="radio-group">
    <label>Type d'achats</label>
    <label><input type="radio" name="purchaseType" value="Pain"> Pain</label>
    <label><input type="radio" name="purchaseType" value="Alimentaire"> Alimentaire</label>
    <label><input type="radio" name="purchaseType" value="Mat√©riel"> Mat√©riel</label>
    <label><input type="radio" name="purchaseType" value="Autre"> Autre</label>
</div>
    <div class="radio-group">
    <label>Paiement</label>
    <label><input type="radio" name="paymentMethod" value="Carte" checked> Carte</label>
    <label><input type="radio" name="paymentMethod" value="Esp√®ce"> Esp√®ce</label>
</div>
    <div class="input-group">
        <div class="input-field">
            <label>Commentaire</label>
            <input type="text" id="purchaseComment">
        </div>
    </div>
    <div class="buttons no-print">
        <button id="addPurchaseBtn" onclick="addPurchase()">Ajouter</button>
        <button id="managePurchasesBtn" onclick="showPurchasesManagement()">Bilan des Achats</button>
        <button onclick="backToHome()">Retour</button>
    </div>
</div>

<!-- Bilan des Achats -->
<div id="purchasesManagementPage" class="hidden">
    <h1>Bilan des Achats</h1>
<br>
    <!-- Filtres de dates -->
    <div class="date-filter">
    <label>Date de d√©but :</label>
    <input type="date" id="purchaseStartDate" onchange="filterPurchases()" value="2024-12-09">

    <label>Date de fin :</label>
    <input type="date" id="purchaseEndDate" onchange="filterPurchases()">
</div>

    <!-- Option afficher les commentaires -->
    <label>
        <input type="checkbox" id="showPurchaseComments" onchange="filterPurchases()"> Afficher commentaire
    </label>

    <!-- Liste des achats -->
    <div id="purchasesList"></div>

    <!-- Boutons PDF et retour -->
    <div class="buttons no-print" style="margin-top: 10px;">
        <button id="printPurchasesBtn" onclick="printPurchases()">Imprimer</button>
        <button id="printBluetoothPurchasesBtn" onclick="printPurchasesToBluetooth()">Imprimer Bluetooth</button>
        <button id="exportPurchasesPdfBtn" onclick="downloadPurchasesPDF()">T√©l√©charger</button>
        <button onclick="backToPurchases()">Retour</button>
    </div>

    <!-- Popup de d√©tail achat -->
<div id="purchaseDetailPopup" class="hidden" style="
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
">
    <h2>D√©tail de l'achat</h2>
    <p id="purchaseDetailDate"></p>
    <p id="purchaseDetailAmount"></p>
    <p id="purchaseDetailType"></p>
    <p id="purchaseDetailPayment"></p>
    <p id="purchaseDetailComment"></p>
    <div class="buttons">
        <button onclick="deleteSelectedPurchase()" style="background:#FF0000; color:white;">Supprimer</button>
        <button onclick="closePurchaseDetail()" style="background:#000000; color:white;">Fermer</button>
    </div>
</div>
</div>


<!-- Personnel -->
<div id="personnelPage" class="hidden">
    <h1>GESTION DU PERSONNEL</h1>
<br>
    <div class="date-nav">
        <button id="prevPersonnelDay">‚Üê</button>
        <span id="currentPersonnelDate"></span>
        <button id="nextPersonnelDay">‚Üí</button>
    </div>
    <div class="select-group">
        <label>Employ√©</label>
        <select id="employeeSelect"></select>
        <button onclick="addEmployee()">Rentrer nouvel employ√©</button>
        <button onclick="deleteEmployee()">Sortir ancien employ√©</button>
    </div>
  <div class="input-group">
    <div class="input-field">
        <label>Heure de d√©but</label>
        <input type="text" id="startTime" placeholder="ex: 720 pour 07:20" required>
    </div>
    <div class="input-field">
        <label>Heure de fin</label>
        <input type="text" id="endTime" placeholder="ex: 1450 pour 14:50" required>
    </div>
    <div class="input-field">
        <label>Commentaire</label>
        <input type="text" id="personnelComment">
    </div>
    <div class="input-field" style="display: flex; align-items: center; gap: 10px;">
        <div style="flex: 1; display: none;">
            <label>Total heures</label>
            <input type="text" id="hoursTotal" readonly style="width: 80px;">
        </div>
        <span style="display: none;">soit</span> <!-- Masquer aussi "soit" si inutile -->
        <div style="flex: 1;">
            <label>Total heures</label> <!-- Changement de label pour coh√©rence -->
            <input type="text" id="hoursTotalConverted" readonly style="width: 80px;">
        </div>
    </div>
</div>
    <div class="buttons no-print">
        <button id="addPersonnelBtn" onclick="addPersonnelHours()">Ajouter</button>
        <button id="managePersonnelBtn" onclick="showPersonnelManagement()">Bilan du Personnel</button>
        <button onclick="backToHome()">Retour</button>
    </div>
</div>

<!-- Bilan du Personnel -->
<div id="personnelManagementPage" class="hidden">
    <h1>Bilan du Personnel</h1>
<br>
    <div class="date-filter">
    <label>Date de d√©but :</label>
    <input type="date" id="personnelStartDate" onchange="filterPersonnel()" value="2024-12-11">

    <label>Date de fin :</label>
    <input type="date" id="personnelEndDate" onchange="filterPersonnel()">
</div>
<label><input type="checkbox" id="showComments" onchange="filterPersonnel()"> Afficher commentaire</label>

<div id="personnelList"></div>

<div class="buttons no-print" style="margin-top: 10px;">
        <button id="printPersonnelBtn" onclick="printPersonnel()">Imprimer</button>
        <button id="printBluetoothPersonnelBtn" onclick="printPersonnelToBluetooth()">Imprimer Bluetooth</button>
        <button id="exportPersonnelPdfBtn" onclick="downloadPersonnelPDF()">T√©l√©charger</button>
        <button onclick="backToPersonnel()">Retour</button>
    </div>

    <!-- Popup de d√©tail personnel -->
<div id="personnelDetailPopup" class="hidden" style="
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
">
    <h2>D√©tail d'activit√©</h2>
    <p id="personnelDetailDate"></p>
    <p id="personnelDetailEmployee"></p>
    <p id="personnelDetailStartTime"></p>
    <p id="personnelDetailEndTime"></p>
    <p id="personnelDetailHours"></p>
    <p id="personnelDetailComment"></p>
    <div class="buttons no-print" style="margin-top: 15px;">
        <button onclick="deleteSelectedPersonnel()" style="background:#FF0000; color:white;">Supprimer</button>
        <button onclick="closePersonnelDetail()" style="background:#000000; color:white;">Fermer</button>
    </div>
</div>
</div>


<!-- Budget -->
<div id="budgetPage" class="hidden">
    <div class="container">
        <h1 style="text-align: center;">BUDGET PREVISIONNEL</h1>
        <h2 style="text-align: center;">Sandwicherie CHEZ BARTH</h2>
        <p>Entrepreneur :  Mathis MOUHOU</p>
        <p>Enseigne / nom commercial :  CHEZ BARTH</p>
        <p>Statut Juridique : Entreprise Individuelle</p>
        <p>R√©gime fiscal/social :  Micro-entrepreneur</p>
      
        <p><strong>DONNEES D'ENTREE</strong> (√† modifier si besoin) :  </p>
        <div style="display: flex; align-items: center;">
            <input type="checkbox" id="budgetAnnee0" name="budgetType" checked onclick="toggleBudgetType()">
            <label for="budgetAnnee0" style="margin-right: 15px;">Budget ann√©e 0</label>
            <input type="checkbox" id="budgetAnneesSuivantes" name="budgetType" onclick="toggleBudgetType()">
            <label for="budgetAnneesSuivantes">Budget ann√©es suivantes</label>
            <br><br>
        </div>
        
        <label for="prix">Prix de vente du panier moyen (‚Ç¨):</label>
        <input type="number" id="prix" value="10" oninput="calculerResultat()">
        
        <label for="cout">Co√ªt de revient mati√®re du panier moyen (‚Ç¨):</label>
        <input type="number" id="cout" value="3.5" oninput="calculerResultat()">

        <label for="panier">Nombre de paniers par jour:</label>
        <input type="number" id="panier" value="70" oninput="calculerResultat()">
        
        <label for="jours">Nombre de jours de travail par semaine:</label>
        <input type="number" id="jours" value="5" oninput="calculerResultat()">
        
        <label for="semaines">Nombre de semaines de travail par an:</label>
        <input type="number" id="semaines" value="48" oninput="calculerResultat()">
        
        <label for="loyer">Loyer mensuel (‚Ç¨):</label>
        <input type="number" id="loyer" value="1103" oninput="calculerResultat()">
        
        <label for="salaire">Salaire brut mensuel du personnel (temps partiel ou temps plein) (‚Ç¨):</label>
        <input type="number" id="salaire" value="1800" oninput="calculerResultat()">
        
        <label for="patronales">Taux de cotisation des charges patronales (bas salaires)(%):</label>
        <input type="number" id="patronales" value="25" oninput="calculerResultat()">

        <label for="charges">Charges annuelles d'√©lectricit√©, gaz, eau, t√©l√©phone, assurance (‚Ç¨):</label>
        <input type="number" id="charges" value="3000" oninput="calculerResultat()">
        
        <label for="externes">Charges quanhuelles externes (TPE, banque, commission CB, transport, entretien, honoraires, compta, pub, autres) (‚Ç¨):</label>
        <input type="number" id="externes" value="10000" oninput="calculerResultat()">
        
        <label for="urssaf">Taux de cotisations sociales (12.415% reduit premi√®re ann√©e 6.2%) et imp√¥t sur le revenu lib√©ratoire de 1% de Mathis et formation 0.3% (%):</label>
        <input type="number" id="urssaf" value="7.5" oninput="calculerResultat()">

        <label for="tva">Taux de TVA % (vente):</label>
        <input type="number" id="tva" value="10" oninput="calculerResultat()">
        
        <label for="apport">Apport financier ou emprunt (‚Ç¨):</label>
        <input type="number" id="apport" value="75000" oninput="calculerResultat()">
        
        <div class="result" id="resultat">
            <!-- Les r√©sultats seront affich√©s ici -->
        </div>
        
        <table id="tableauBenefices">
    <!-- Le tableau des b√©n√©fices nets sera affich√© ici -->
</table>

<div class="buttons no-print" style="margin-top: 10px;">
    <button id="exportPdf" class="export-button">T√©l√©charger PDF</button>
    <button id="exportWord" class="export-button">T√©l√©charger Word</button>
    <button onclick="backToHome()">Retour</button>
</div>

    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    // Initialisation globale des variables
let invoices = [];
let invoiceCounter = 0;
let order = [];
let menu = [];
let caBelow101000 = false; // Par d√©faut, CA sup√©rieur √† 101000‚Ç¨
let currentPaymentMethod = 'Non sp√©cifi√©'; // Mode de paiement global pour la facture en cours
let filteredPersonnelRecords = [];
let selectedPersonnelRecord = null;




// Mot de passe d√©fini
const correctPassword = "mathis";

// Fonction centralis√©e pour naviguer entre les pages et mettre √† jour l'historique
function navigateTo(pageId) {
    const pages = [
        'homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 
        'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 
        'purchasesManagementPage', 'personnelPage', 'personnelManagementPage',
        'passwordPage', 'budgetPage', 'settingsPage', 'indicatorsPage' , 'fiscalPage' , 'bilanPage'
    ];
    pages.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(pageId).classList.remove('hidden');
    history.pushState({ page: pageId }, '', `#${pageId}`);
    
    if (pageId === 'recipeBookPage') updateRecipeDisplay();
    if (pageId === 'purchasesPage') updatePurchaseDisplay();
    if (pageId === 'personnelPage') updatePersonnelDisplay();
    if (pageId === 'recipeManagementPage') filterRecipes();
    if (pageId === 'invoiceManagementPage') filterInvoices();
    if (pageId === 'purchasesManagementPage') filterPurchases();
    if (pageId === 'personnelManagementPage') filterPersonnel();
    if (pageId === 'indicatorsPage') displayIndicatorsTable();
    if (pageId === 'fiscalPage') displayFiscalTable();
    if (pageId === 'bilanPage') displayBilan();

}



// Fonction pour v√©rifier le mot de passe
function checkPassword() {
    const input = document.getElementById('passwordInput').value;
    const errorMessage = document.getElementById('errorMessage');
    if (input === correctPassword) {
        const pages = [
            'homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 
            'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 
            'purchasesManagementPage', 'personnelPage', 'personnelManagementPage',
            'passwordPage', 'budgetPage', 'settingsPage' , 'indicatorsPage' , 'fiscalPage' , 'bilanPage'
        ];
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('homePage').classList.remove('hidden');
        history.replaceState({ page: 'homePage' }, '', '#homePage'); // Remplacer au lieu d'ajouter
        errorMessage.style.display = 'none';
    } else {
        errorMessage.style.display = 'block';
    }
}

// Conserver l'√©couteur pour la touche "Entr√©e"
document.getElementById('passwordInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        checkPassword();
    }
});

// Au d√©marrage, afficher la page de mot de passe et masquer le reste
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('passwordPage').classList.remove('hidden');
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.add('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.add('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');

    history.pushState({ page: 'homePage' }, '', '#homePage');
});

// D√®s que la page est pr√™te pour personnelEndDate
window.addEventListener('DOMContentLoaded', () => {
    // Cr√©er une date en heure de Paris
    const parisDate = new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Paris' }));

    // Formater la date en 'YYYY-MM-DD'
    const today = parisDate.toLocaleDateString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).split('/').reverse().join('-'); // Change le format de 'DD/MM/YYYY' √† 'YYYY-MM-DD'

    // Mettre √† jour le champ de date
    document.getElementById('personnelEndDate').value = today;
});

// D√®s que la page est pr√™te pour purchaseEndDate
window.addEventListener('DOMContentLoaded', () => {
    // Cr√©er une date en heure de Paris
    const parisDate = new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Paris' }));

    // Formater la date en 'YYYY-MM-DD'
    const today = parisDate.toLocaleDateString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).split('/').reverse().join('-'); // Change le format de 'DD/MM/YYYY' √† 'YYYY-MM-DD'

    // Mettre √† jour le champ de date
    document.getElementById('purchaseEndDate').value = today;
});

// D√®s que la page est pr√™te pour endDate
window.addEventListener('DOMContentLoaded', () => {
    // Cr√©er une date en heure de Paris
    const parisDate = new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Paris' }));

    // Formater la date en 'YYYY-MM-DD'
    const today = parisDate.toLocaleDateString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).split('/').reverse().join('-'); // Change le format de 'DD/MM/YYYY' √† 'YYYY-MM-DD'

    // Mettre √† jour le champ de date
    document.getElementById('endDate').value = today;
});







function showSettings() {
        navigateTo('settingsPage');
    }

function updateMenuTvaRates() {
    console.log('Dans updateMenuTvaRates, caBelow101000 =', caBelow101000);
    menu.forEach(item => {
        if (caBelow101000) {
            // Si CA < 101000‚Ç¨, TVA √† 0% pour tous les produits
            item.tvaRate = 0;
            item.priceHT = item.priceTTC; // Pas de TVA, donc HT = TTC
        } else {
            // Sinon, r√©tablir les taux par d√©faut : 5.5% pour boissons, 10% pour sandwichs/desserts
            if (item.type === "B") { // Boissons
                item.tvaRate = 0.055; // 5.5%
            } else { // Sandwichs et desserts (type "S")
                item.tvaRate = 0.1; // 10%
            }
            // Recalculer le prix HT √† partir du prix TTC
            item.priceHT = item.priceTTC / (1 + item.tvaRate);
        }
        console.log(`Produit ${item.name}: tvaRate = ${item.tvaRate}, priceHT = ${item.priceHT}`);
    });
    // Mettre √† jour la liste des produits et la commande apr√®s changement des taux
    updateProductList();
    updateOrderList();
}

function saveMenuToStorage() {
    try {
        localStorage.setItem('menu', JSON.stringify(menu));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde du menu:', e);
        alert('Erreur lors de la sauvegarde du menu.');
    }
}

function loadMenuFromStorage() {
    try {
        const storedMenu = localStorage.getItem('menu');
        if (storedMenu) {
            menu = JSON.parse(storedMenu);
        } else {
            menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato √† la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre √©tudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
            ];
            saveMenuToStorage();
        }
        updateMenuTvaRates(); // Initialiser les taux au chargement
    } catch (e) {
        console.error('Erreur lors du chargement du menu:', e);
        menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato √† la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre √©tudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
        ];
        updateMenuTvaRates(); // Initialiser les taux au chargement
    }
}





// Charger le menu au d√©marrage
loadMenuFromStorage();

 // Charger les factures au d√©marrage
    function loadInvoices() {
        try {
            const storedInvoices = localStorage.getItem('savedInvoices');
            console.log('Donn√©es brutes de localStorage:', storedInvoices);
            if (storedInvoices) {
                invoices = JSON.parse(storedInvoices);
                console.log('Factures charg√©es:', invoices);
                if (!Array.isArray(invoices)) {
                    throw new Error('Les donn√©es charg√©es ne sont pas un tableau');
                }
                if (invoices.length > 0) {
                    invoiceCounter = Math.max(...invoices.map(i => {
                        if (typeof i.number !== 'number') {
                            throw new Error('Num√©ro de facture invalide dans les donn√©es');
                        }
                        return i.number;
                    }));
                }
            }
        } catch (e) {
            console.error('Erreur lors du chargement des factures:', e);
            alert('Erreur lors du chargement des factures. R√©initialisation des donn√©es.');
            invoices = [];
            invoiceCounter = 0;
            localStorage.setItem('savedInvoices', JSON.stringify(invoices));
        }
    }
    loadInvoices();

    // Fonction d√©di√©e pour sauvegarder dans localStorage
    function saveInvoicesToStorage() {
        try {
            localStorage.setItem('savedInvoices', JSON.stringify(invoices));
            console.log('localStorage mis √† jour avec:', JSON.parse(localStorage.getItem('savedInvoices')));
        } catch (e) {
            console.error('Erreur lors de la sauvegarde des factures dans localStorage:', e);
            alert('Erreur lors de la sauvegarde des factures.');
        }
    }

    // Gestion des pages
    function showRecipeBook() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.remove('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        updateRecipeDisplay();
    }

    function showRecipeManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.remove('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        filterRecipes();
    }

    function showInvoice() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.remove('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.add('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');
    loadCAStatus();
    updateProductList(); // Met √† jour la liste et d√©s√©lectionne les cases
    updateOrderList();
    // R√©initialisation suppl√©mentaire au cas o√π
    document.querySelectorAll('#productList input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
}

    function showInvoiceManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.remove('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        filterInvoices();
    }

    function showInvoiceDetail() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.remove('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
    }

function showPurchases() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.add('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.remove('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');

    updatePurchaseDisplay();

    // Forcer "Carte" √† √™tre s√©lectionn√© apr√®s l'affichage complet
    setTimeout(() => {
        const carteRadio = document.querySelector('#purchasesPage input[name="paymentMethod"][value="Carte"]');
        if (carteRadio) {
            carteRadio.checked = true;
            carteRadio.dispatchEvent(new Event('change'));
        }
    }, 100);
}




    function showPurchasesManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.remove('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        filterPurchases();
    }

    function showPersonnel() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.remove('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        updatePersonnelDisplay();
    }

    function showPersonnelManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.remove('hidden');
        filterPersonnel();
    }

   function backToHome() {
        document.getElementById('homePage').classList.remove('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        document.getElementById('budgetPage').classList.add('hidden');
        document.getElementById('homePage').classList.remove('hidden');
        document.getElementById('fiscalPage').classList.remove('hidden');
        document.getElementById('bilanPage').classList.remove('hidden');
    }



    function backToRecipeBook() {
        showRecipeBook();
    }

    function backToInvoice() {
        showInvoice();
    }

    function backToInvoiceManagement() {
        showInvoiceManagement();
    }

    function backToPurchases() {
        showPurchases();
    }

    function backToPersonnel() {
        showPersonnel();
    }

    // --- Ventes ---
    let recipeCurrentDate = new Date();
  const initialSalesData = {
  "2024-12-11": { card: 352, cash: 147, total: 499 },
  "2024-12-12": { card: 164, cash: 69, total: 233 },
  "2024-12-13": { card: 134, cash: 56, total: 190 },
  "2024-12-14": { card: 183, cash: 76, total: 259 },
  "2024-12-16": { card: 316, cash: 132, total: 448 },
  "2024-12-17": { card: 212, cash: 89, total: 301 },
  "2024-12-18": { card: 182, cash: 76, total: 258 },
  "2024-12-19": { card: 234, cash: 98, total: 332 },
  "2024-12-20": { card: 123, cash: 51, total: 174 },
  "2024-12-21": { card: 212, cash: 88, total: 300 },
  "2024-12-23": { card: 160, cash: 67, total: 227 },
  "2024-12-24": { card: 144, cash: 60, total: 204 },
  "2024-12-27": { card: 52, cash: 22, total: 74 },
  "2024-12-28": { card: 169, cash: 70, total: 239 },
  "2024-12-30": { card: 207, cash: 86, total: 293 },
  "2024-12-31": { card: 176, cash: 73, total: 249 },
  "2025-01-02": { card: 148, cash: 44, total: 192 },
  "2025-01-03": { card: 209, cash: 62, total: 271 },
  "2025-01-04": { card: 166, cash: 49, total: 215 },
  "2025-01-06": { card: 108, cash: 32, total: 140 },
  "2025-01-07": { card: 198, cash: 59, total: 257 },
  "2025-01-08": { card: 285, cash: 85, total: 370 },
  "2025-01-09": { card: 241, cash: 72, total: 313 },
  "2025-01-10": { card: 361, cash: 108, total: 469 },
  "2025-01-11": { card: 252, cash: 75, total: 327 },
  "2025-01-13": { card: 313, cash: 93, total: 406 },
  "2025-01-14": { card: 179, cash: 53, total: 232 },
  "2025-01-15": { card: 259, cash: 100, total: 359 },
  "2025-01-16": { card: 242, cash: 100, total: 342 },
  "2025-01-17": { card: 296, cash: 120, total: 416 },
  "2025-01-18": { card: 200, cash: 59, total: 259 }, // ajust√©
  "2025-01-20": { card: 251, cash: 100, total: 351 },
  "2025-01-21": { card: 293, cash: 88, total: 381 },
  "2025-01-22": { card: 290, cash: 100, total: 390 },
  "2025-01-23": { card: 199, cash: 60, total: 259 },
  "2025-01-24": { card: 513, cash: 153, total: 666 },
  "2025-01-25": { card: 471, cash: 141, total: 612 },
  "2025-01-27": { card: 506, cash: 200, total: 706 },
  "2025-01-28": { card: 239, cash: 71, total: 310 },
  "2025-01-29": { card: 536, cash: 160, total: 696 },
  "2025-01-30": { card: 316, cash: 94, total: 410 },
  "2025-01-31": { card: 478, cash: 143, total: 621 }, // ajust√©
  "2025-02-01": { card: 281, cash: 100, total: 381 },
  "2025-02-03": { card: 342, cash: 100, total: 442 },
  "2025-02-04": { card: 255, cash: 100, total: 355 },
  "2025-02-05": { card: 440, cash: 150, total: 590 },
  "2025-02-06": { card: 475, cash: 200, total: 675 },
  "2025-02-07": { card: 425, cash: 150, total: 575 },
  "2025-02-08": { card: 327, cash: 100, total: 427 },
  "2025-02-10": { card: 544, cash: 200, total: 744 },
  "2025-02-11": { card: 913, cash: 350, total: 1263 },
  "2025-02-12": { card: 1253, cash: 510, total: 1763 },
  "2025-02-13": { card: 1336, cash: 500, total: 1836 },
  "2025-02-14": { card: 1210, cash: 400, total: 1610 },
  "2025-02-17": { card: 648, cash: 270, total: 918 },
  "2025-02-18": { card: 794, cash: 290, total: 1084 },
  "2025-02-19": { card: 942, cash: 300, total: 1242 },
  "2025-02-20": { card: 963, cash: 190, total: 1153 },
  "2025-02-21": { card: 1000, cash: 280, total: 1280 },
  "2025-02-24": { card: 611, cash: 390, total: 1001 },
  "2025-02-25": { card: 670, cash: 250, total: 920 },
  "2025-02-26": { card: 890, cash: 180, total: 1070 },
  "2025-02-27": { card: 1063, cash: 200, total: 1263 },
  "2025-02-28": { card: 728, cash: 230, total: 958 },
  "2025-03-03": { card: 757, cash: 120, total: 877 },
  "2025-03-04": { card: 745, cash: 360, total: 1105 },
  "2025-03-05": { card: 792, cash: 150, total: 942 },
  "2025-03-06": { card: 857, cash: 250, total: 1107 },
  "2025-03-07": { card: 883, cash: 210, total: 1093 },
  "2025-03-10": { card: 599, cash: 150, total: 749 },
  "2025-03-11": { card: 796, cash: 170, total: 966 },
  "2025-03-12": { card: 627, cash: 160, total: 787 },
  "2025-03-13": { card: 784, cash: 140, total: 924 },
  "2025-03-14": { card: 505, cash: 140, total: 645 },
  "2025-03-17": { card: 661, cash: 130, total: 791 },
  "2025-03-18": { card: 782, cash: 110, total: 892 },
  "2025-03-19": { card: 486, cash: 180, total: 666 },
  "2025-03-20": { card: 635, cash: 190, total: 825 },
  "2025-03-21": { card: 512, cash: 120, total: 632 },
  "2025-03-24": { card: 492, cash: 210, total: 702 },
  "2025-03-25": { card: 626, cash: 210, total: 836 },
  "2025-03-26": { card: 749, cash: 180, total: 929 },
  "2025-03-27": { card: 610, cash: 180, total: 790 },
  "2025-03-28": { card: 673, cash: 220, total: 893 },
  "2025-03-31": { card: 640, cash: 220, total: 860 },
  "2025-04-01": { card: 717, cash: 210, total: 927 },
  "2025-04-02": { card: 488, cash: 190, total: 678 },
  "2025-04-03": { card: 601, cash: 170, total: 771 },
  "2025-04-04": { card: 639, cash: 240, total: 879 },
  "2025-04-07": { card: 588, cash: 190, total: 778 },
  "2025-04-08": { card: 738, cash: 200, total: 938 },
  "2025-04-09": { card: 764, cash: 200, total: 964 },
  "2025-04-10": { card: 467, cash: 110, total: 577 },
  "2025-04-11": { card: 595, cash: 150, total: 745 },
  "2025-04-14": { card: 288, cash: 100, total: 388 },
  "2025-04-15": { card: 629, cash: 150, total: 779 }
};



   let salesData = { ...initialSalesData };
console.log('Tentative de chargement des donn√©es...');
try {
    const storedData = localStorage.getItem('salesData');
    console.log('Contenu brut de localStorage:', storedData);
    if (storedData) {
        try {
            const parsedData = JSON.parse(storedData);
            console.log('Donn√©es pars√©es de localStorage:', parsedData);
            const normalizedData = {};
            for (const key in parsedData) {
                const dateMatch = key.match(/^(\d{4}-\d{2}-\d{2})/);
                if (dateMatch) {
                    const normalizedKey = dateMatch[1];
                    normalizedData[normalizedKey] = parsedData[key];
                } else {
                    console.warn(`Cl√© invalide ignor√©e: ${key}`);
                }
            }
            salesData = { ...initialSalesData, ...normalizedData };
            console.log('Donn√©es fusionn√©es (cl√©s):', Object.keys(salesData));
        } catch (parseError) {
            console.error('Erreur lors du parsing de localStorage:', parseError);
            console.log('Utilisation des donn√©es initiales uniquement');
        }
    } else {
        console.log('Aucune donn√©e dans localStorage, initialisation avec initialSalesData');
        localStorage.setItem('salesData', JSON.stringify(salesData));
    }
} catch (e) {
    console.error('Erreur d\'acc√®s √† localStorage:', e);
    console.log('localStorage inaccessible, utilisation des donn√©es initiales uniquement');
    alert('Impossible d\'acc√©der au stockage local. Seules les donn√©es initiales sont utilis√©es.');
}
    const cardInput = document.getElementById('cardInput');
    const cashInput = document.getElementById('cashInput');
    const totalInput = document.getElementById('totalInput');
    const saveRecipeBtn = document.getElementById('saveRecipeBtn');
    const prevDay = document.getElementById('prevDay');
    const nextDay = document.getElementById('nextDay');
    const currentDateSpan = document.getElementById('currentDate');

    function formatRecipeDate(date) {
        return date.toLocaleDateString('fr-FR', { weekday: 'long'  ,  day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getISODate(date) {
    let dateObj;
    if (typeof date === 'string') {
        dateObj = new Date(date);
    } else if (date instanceof Date) {
        dateObj = date;
    } else {
        console.warn('Entr√©e de date invalide:', date);
        return null;
    }
    if (isNaN(dateObj)) {
        console.warn('Date invalide:', date);
        return null;
    }
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

    function updateRecipeDisplay() {
    const dayName = recipeCurrentDate.toLocaleDateString('fr-FR', { weekday: 'long' });
    const formattedDate = recipeCurrentDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    currentDateSpan.textContent = `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${formattedDate}`;
    const dateKey = getISODate(recipeCurrentDate);
    const data = salesData[dateKey] || { card: 0, cash: 0, total: 0 };
    cardInput.value = data.card || '';
    cashInput.value = data.cash || '';
    totalInput.value = data.total || '';
}

    function calculateRecipeTotal() {
        const card = parseFloat(cardInput.value) || 0;
        const cash = parseFloat(cashInput.value) || 0;
        const total = card + cash;
        totalInput.value = total.toFixed(2);
        return total;
    }

    cardInput.addEventListener('input', calculateRecipeTotal);
    cashInput.addEventListener('input', calculateRecipeTotal);

 saveRecipeBtn.addEventListener('click', () => {
    console.log('recipeCurrentDate:', recipeCurrentDate, 'Type:', typeof recipeCurrentDate);
    
    // Forcer recipeCurrentDate en objet Date
    const dateObj = typeof recipeCurrentDate === 'string' ? new Date(recipeCurrentDate) : recipeCurrentDate;
    
    if (isNaN(dateObj)) {
        alert('Date invalide. Veuillez v√©rifier la date s√©lectionn√©e.');
        return;
    }
    
    // G√©n√©rer la cl√© au format YYYY-MM-DD
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    const dateKey = `${year}-${month}-${day}`;
    
    console.log('dateKey g√©n√©r√©:', dateKey);
    
    salesData[dateKey] = {
        card: parseFloat(cardInput.value) || 0,
        cash: parseFloat(cashInput.value) || 0,
        total: parseFloat(totalInput.value) || 0
    };
    
    try {
        localStorage.setItem('salesData', JSON.stringify(salesData));
        console.log('Donn√©es enregistr√©es, cl√©s:', Object.keys(salesData));
        alert('Donn√©es enregistr√©es avec succ√®s !');
    } catch (e) {
        console.error('Erreur lors de la sauvegarde dans localStorage:', e);
        alert('Erreur lors de la sauvegarde.');
    }
    
    updateRecipeDisplay();
    filterRecipes(); // Rafra√Æchir le tableau
});

    const deleteRecipeBtn = document.getElementById('deleteRecipeBtn');
    if (deleteRecipeBtn) {
        deleteRecipeBtn.addEventListener('click', () => {
            const dateKey = getISODate(recipeCurrentDate);
            if (salesData[dateKey]) {
                if (confirm(`Voulez-vous vraiment supprimer les ventes pour le ${formatRecipeDate(recipeCurrentDate)} ?`)) {
                    delete salesData[dateKey];
                    try {
                        localStorage.setItem('salesData', JSON.stringify(salesData));
                        
                    } catch (e) {
                        console.error('Erreur lors de la suppression dans localStorage:', e);
                        alert('Erreur lors de la suppression.');
                    }
                    updateRecipeDisplay();
                    filterRecipes();
                }
            } else {
                alert('Aucune vente √† supprimer pour cette date.');
            }
        });
    }

    prevDay.addEventListener('click', () => {
        recipeCurrentDate.setDate(recipeCurrentDate.getDate() - 1);
        updateRecipeDisplay();
    });

    nextDay.addEventListener('click', () => {
        recipeCurrentDate.setDate(recipeCurrentDate.getDate() + 1);
        updateRecipeDisplay();
    });

  function exportRecipeToPdf() {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 10;
    let y = margin;

    const colWidths = [30, 35, 35, 35, 60];
    const rowHeight = 8;
    const tableX = margin;

    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

    const dataByMonth = {};
    Object.keys(salesData).forEach(dateKey => {
        const [year, month] = dateKey.split('-');
        const monthYear = `${year}-${month}`;
        if (!dataByMonth[monthYear]) {
            dataByMonth[monthYear] = [];
        }
        dataByMonth[monthYear].push({
            date: dateKey,
            ...salesData[dateKey]
        });
    });

    const drawTableHeader = (x, y, month, year) => {
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.rect(margin, y, pageWidth - 2 * margin, 20);
        doc.text(`LIVRE DES RECETTES ${month} ${year}`, pageWidth / 2, y + 8, { align: 'center' });
        doc.text('Chez BARTH 16 place des Pr√™cheurs 13100 Aix en Provence SIRET : 93253222900014', pageWidth / 2, y + 16, { align: 'center' });
        y += 25;
        doc.setFontSize(10);
        doc.rect(x, y, colWidths[0], rowHeight); doc.text('Date', x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte B', x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Esp√®ce', x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TOTAL Ventes', x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Origine', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTableRow = (x, y, date, card, cash, total) => {
        doc.setFont('helvetica', 'normal');
        const cleanDate = date.split('T')[0];
        const dateParts = cleanDate.split('-');
        const dateStr = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(dateStr, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${card} ‚Ç¨`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${cash} ‚Ç¨`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${total} ‚Ç¨`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight);
        doc.text('Vente Sandwichs √† emporter', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTotalRow = (x, y, totalCard, totalCash, totalSales, month) => {
        doc.setFont('helvetica', 'bold');
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(`Total ${month}`, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${totalCard} ‚Ç¨`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalCash} ‚Ç¨`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalSales} ‚Ç¨`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const sortedMonths = Object.keys(dataByMonth).sort((a, b) => {
        const [yearA, monthA] = a.split('-');
        const [yearB, monthB] = b.split('-');
        return yearA.localeCompare(yearB) || monthA.localeCompare(monthB);
    });

    sortedMonths.forEach(monthYear => {
        const [year, month] = monthYear.split('-');
        const monthName = monthNames[parseInt(month) - 1];
        let totalCard = 0;
        let totalCash = 0;
        let totalSales = 0;

        y = drawTableHeader(tableX, y, monthName, year);

        const monthData = dataByMonth[monthYear].sort((a, b) => a.date.localeCompare(b.date));
        monthData.forEach(data => {
            y = drawTableRow(tableX, y, data.date, data.card, data.cash, data.total);
            totalCard += data.card;
            totalCash += data.cash;
            totalSales += data.total;

            if (y > doc.internal.pageSize.getHeight() - 20) {
                doc.addPage();
                y = margin;
                y = drawTableHeader(tableX, y, monthName, year);
            }
        });

        y += 5;
        y = drawTotalRow(tableX, y, totalCard, totalCash, totalSales, monthName);
        doc.addPage();
        y = margin;
    });

    if (doc.getNumberOfPages() > 1 && y === margin) {
        doc.deletePage(doc.getNumberOfPages());
    }

    const fileName = 'Perso_Livre_des_Recettes_Chez_Barth.pdf';
    doc.save(fileName);

// Message de confirmation
setTimeout(() => {
    alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);

    // üß™ Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
}, 500);
}


function exportRecipeToPdfofficiel() {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 10;
    let y = margin;

    const colWidths = [30, 35, 35, 35, 60];
    const rowHeight = 8;
    const tableX = margin;

    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

    const dataByMonth = {};
    Object.keys(salesData).forEach(dateKey => {
        const [year, month] = dateKey.split('-');
        const monthYear = `${year}-${month}`;
        if (!dataByMonth[monthYear]) {
            dataByMonth[monthYear] = [];
        }
        dataByMonth[monthYear].push({
            date: dateKey,
            ...salesData[dateKey]
        });
    });

    const drawTableHeader = (x, y, month, year) => {
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.rect(margin, y, pageWidth - 2 * margin, 20);
        doc.text(`LIVRE DES RECETTES ${month} ${year}`, pageWidth / 2, y + 8, { align: 'center' });
        doc.text('Chez BARTH 16 place des Pr√™cheurs 13100 Aix en Provence SIRET : 93253222900014', pageWidth / 2, y + 16, { align: 'center' });
        y += 25;
        doc.setFontSize(10);
        doc.rect(x, y, colWidths[0], rowHeight); doc.text('Date', x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte B', x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Esp√®ce', x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TOTAL Ventes', x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Origine', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTableRow = (x, y, date, card, cash, total) => {
        doc.setFont('helvetica', 'normal');
        // Extract only YYYY-MM-DD from date string
        const cleanDate = date.split('T')[0];
        const dateParts = cleanDate.split('-');
        const dateStr = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        const adjustedCash = Math.floor(cash / 2);
        const adjustedTotal = card + adjustedCash;
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(dateStr, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${card} ‚Ç¨`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${adjustedCash} ‚Ç¨`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${adjustedTotal} ‚Ç¨`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight);
        doc.text('Vente Sandwichs √† emporter', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTotalRow = (x, y, totalCard, totalAdjustedCash, totalSales, month) => {
        doc.setFont('helvetica', 'bold');
        const adjustedTotalSales = totalCard + totalAdjustedCash;
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(`Total ${month}`, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${totalCard} ‚Ç¨`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalAdjustedCash} ‚Ç¨`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${adjustedTotalSales} ‚Ç¨`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const sortedMonths = Object.keys(dataByMonth).sort((a, b) => {
        const [yearA, monthA] = a.split('-');
        const [yearB, monthB] = b.split('-');
        return yearA.localeCompare(yearB) || monthA.localeCompare(monthB);
    });

    sortedMonths.forEach(monthYear => {
        const [year, month] = monthYear.split('-');
        const monthName = monthNames[parseInt(month) - 1];
        let totalCard = 0;
        let totalAdjustedCash = 0;

        y = drawTableHeader(tableX, y, monthName, year);

        const monthData = dataByMonth[monthYear].sort((a, b) => a.date.localeCompare(b.date));
        monthData.forEach(data => {
            const adjustedCash = Math.floor(data.cash / 2);
            y = drawTableRow(tableX, y, data.date, data.card, data.cash, data.total);
            totalCard += data.card;
            totalAdjustedCash += adjustedCash;

            if (y > doc.internal.pageSize.getHeight() - 20) {
                doc.addPage();
                y = margin;
                y = drawTableHeader(tableX, y, monthName, year);
            }
        });

        y += 5;
        y = drawTotalRow(tableX, y, totalCard, totalAdjustedCash, 0, monthName);
        doc.addPage();
        y = margin;
    });

    if (doc.getNumberOfPages() > 1 && y === margin) {
        doc.deletePage(doc.getNumberOfPages());
    }

    const fileName = 'Livre_des_Recettes_officiel_Chez_Barth.pdf'; 
    doc.save(fileName);

    // Message de confirmation
    setTimeout(() => {
    alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);

    // Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
    }, 500);

}

let selectedRecipeDate = null;

function showRecipeDetail(date) {
    selectedRecipeDate = date;
    const data = salesData[date];

    if (!data) return;

    const cashRate = data.total > 0 ? Math.round(data.cash / data.total * 100) : '';

    document.getElementById('recipeDetailDate').textContent = `Date : ${formatRecipeDate(new Date(date))}`;
    document.getElementById('recipeDetailCard').textContent = `Carte : ${data.card} ‚Ç¨`;
    document.getElementById('recipeDetailCash').textContent = `Esp√®ces : ${data.cash} ‚Ç¨`;
    document.getElementById('recipeDetailTotal').textContent = `Total : ${data.total} ‚Ç¨`;
    document.getElementById('recipeDetailCashRate').textContent = `Taux de cash : ${cashRate ? cashRate + ' %' : ''}`;

    document.getElementById('recipeDetailPopup').classList.remove('hidden');
}

function closeRecipeDetail() {
    document.getElementById('recipeDetailPopup').classList.add('hidden');
    selectedRecipeDate = null;
}

function deleteSelectedRecipe() {
    if (selectedRecipeDate && salesData[selectedRecipeDate]) {
        if (confirm("Supprimer cette vente ?")) {
            delete salesData[selectedRecipeDate];
            localStorage.setItem('salesData', JSON.stringify(salesData));
            closeRecipeDetail();
            filterRecipes(); // met √† jour la liste
            alert("Vente supprim√©e !");
        }
    }
}


function filterRecipes() {
    try {
        const startInput = document.getElementById('recipeStartDate');
        const endInput = document.getElementById('recipeEndDate');
        const list = document.getElementById('recipeList');

        if (!startInput || !endInput || !list) {
            console.error('√âl√©ments HTML manquants pour filterRecipes');
            list.innerHTML = '<p>Erreur : √âl√©ments de la page introuvables.</p>';
            return;
        }

        if (!salesData) {
            console.error('salesData non d√©fini');
            list.innerHTML = '<p>Erreur : Donn√©es de ventes non disponibles.</p>';
            return;
        }

        const start = startInput.value;
        const end = endInput.value;
        const startDate = start ? new Date(start + 'T00:00:00') : new Date('2024-12-11');
        const endDate = end ? new Date(end + 'T23:59:59') : new Date();

        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            list.innerHTML = '<p>Erreur : Dates invalides.</p>';
            alert('La date de d√©but doit √™tre ant√©rieure √† la date de fin.');
            return;
        }

        function formatRecipeDate(date) {
            const jours = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];
            const jour = jours[date.getDay()];
            const dateString = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `${jour} ${dateString}`;
        }

        list.innerHTML = `<h3>Liste des ventes du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>`;

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th style="min-width: 100px;">Date</th>
                <th style="width: 70px;">Carte(‚Ç¨)</th>
                <th style="width: 70px;">Cash(‚Ç¨)</th>
                <th style="width: 70px;">Total(‚Ç¨)</th>
                <th style="width: 60px;">Taux de cash(%)</th>
            </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        let totalCard = 0;
        let totalCash = 0;
        let totalGeneral = 0;

        const monthlyData = {};
        const monthlyPurchaseData = {};

        let purchases = [];
        try {
            const storedPurchases = localStorage.getItem('purchases');
            if (storedPurchases && storedPurchases !== '[]') {
                purchases = JSON.parse(storedPurchases).map(p => ({ ...p, date: p.date.split('T')[0] }));
            }
        } catch (e) {
            console.error('Erreur lors du chargement des achats:', e);
            list.innerHTML = '<p>Erreur lors du chargement des achats.</p>';
            return;
        }

        purchases.forEach(p => {
            const date = new Date(p.date);
            if (date < startDate || date > endDate) return;
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyPurchaseData[key]) {
                monthlyPurchaseData[key] = { Pain: 0 };
            }
            if (p.type === 'Pain') {
                monthlyPurchaseData[key].Pain += p.amountTTC;
            }
        });

        const rows = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;
            const data = salesData[dateKey] || { card: 0, cash: 0, total: 0 };

            const cashRate = data.total > 0 ? Math.round(data.cash / data.total * 100) : '';

            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onclick = () => showRecipeDetail(dateKey);
            row.innerHTML = `
                <td>${formatRecipeDate(new Date(d))}</td>
                <td>${data.card ? Math.round(data.card) + ' ‚Ç¨' : ''}</td>
                <td>${data.cash ? Math.round(data.cash) + ' ‚Ç¨' : ''}</td>
                <td>${data.total ? Math.round(data.total) + ' ‚Ç¨' : ''}</td>
                <td>${cashRate ? cashRate + ' %' : ''}</td>
            `;
            rows.push({ date: new Date(d), row });

            if (salesData[dateKey]) {
                totalCard += data.card;
                totalCash += data.cash;
                totalGeneral += data.total;

                const monthKey = `${year}-${month}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { total: 0, card: 0, cash: 0, activeDays: 0 };
                }
                monthlyData[monthKey].total += data.total;
                monthlyData[monthKey].card += data.card;
                monthlyData[monthKey].cash += data.cash;
                monthlyData[monthKey].activeDays += 1;
            }
        }

        rows.sort((a, b) => a.date - b.date);
        rows.forEach(({ row }) => tbody.appendChild(row));

        table.appendChild(tbody);

        const tfoot = document.createElement('tfoot');
        const totalCashRate = totalGeneral > 0 ? Math.round(totalCash / totalGeneral * 100) : '';
        tfoot.innerHTML = `
            <tr>
                <th>Total</th>
                <th>${Math.round(totalCard)} ‚Ç¨</th>
                <th>${Math.round(totalCash)} ‚Ç¨</th>
                <th>${Math.round(totalGeneral)} ‚Ç¨</th>
                <th>${totalCashRate ? totalCashRate + ' %' : ''}</th>
            </tr>
        `;
        table.appendChild(tfoot);

        list.appendChild(table);

        let spacer = document.createElement('div');
        spacer.style.height = '20px';
        list.appendChild(spacer);

        const summaryTable = document.createElement('table');
        const summaryThead = document.createElement('thead');
        summaryThead.innerHTML = `
            <tr style="background-color: #ccc;">
                <th>Mois</th>
                <th style="width: 120px;">CA/Mois</th>
                <th style="width: 120px;">CA/Jour</th>
                <th style="width: 80px;">Taux de cash (%)</th>
                <th style="width: 80px;">Nb Jours travaill√©s</th>
                <th style="width: 80px;">Nb Paniers/J</th>
                <th>Prix Vente Panier Moy</th>
                <th style="width: 120px; background-color: #e0e0e0;">CA TTC/mois retenu</th>
                <th style="width: 120px; background-color: #e0e0e0;">TVA collect√©e √† d√©clarer</th>
               
            </tr>
        `;
        summaryTable.appendChild(summaryThead);

        const summaryTbody = document.createElement('tbody');

        for (const key in monthlyData) {
            const [year, month] = key.split('-');
            const mois = new Date(`${year}-${month}-01`).toLocaleString('fr-FR', { month: 'long' });
            const label = `${mois.charAt(0).toUpperCase() + mois.slice(1)} ${year}`;
            const ca = monthlyData[key].total;
            const jours = monthlyData[key].activeDays;
            const caParJour = jours > 0 ? Math.round(ca / jours) : 0;
            const cashRate = ca > 0 ? Math.round(monthlyData[key].cash / ca * 100) : '';
            const facteur = (month === '12' && year === '2024') || (['01', '02'].includes(month) && year === '2025') ? 0.7 : 0.56;

            let panierJour = 0;
            if (jours > 0 && monthlyPurchaseData[key]?.Pain) {
                const coef = (month === '12' && year === '2024') ? 0.95 :
                             (month === '01' && year === '2025') ? 0.96 :
                             (month === '02' && year === '2025') ? 0.90 :
                             (month === '03' && year === '2025') ? 0.85 :
                             (month === '04' && year === '2025') ? 0.85 : 
                             (month === '05' && year === '2025') ? 0.80 :
                             (month === '06' && year === '2025') ? 0.90 : 
                             (month === '07' && year === '2025') ? 0.62 :
                             (month === '08' && year === '2025') ? 0.87 :
                             (month === '09' && year === '2025') ? 0.6 : 0.92;

                panierJour = monthlyPurchaseData[key].Pain * coef / (jours * facteur);
            }

            const panierJourArrondi = Math.round(panierJour);
            const prixPanierJour = (jours > 0 && panierJourArrondi > 0) ? (caParJour / panierJourArrondi) : 0;

            const caAjuste = monthlyData[key].card + monthlyData[key].cash / 2;
            const tvaCollecteeDeclarer = caAjuste * 0.1 / 1.1;

            let impotUrssaf = 0;
            const yearNum = parseInt(year);
            const monthNum = parseInt(month);
            const isBeforeOct2025 = (yearNum < 2025) || (yearNum === 2025 && monthNum <= 9);
            if (isBeforeOct2025) {
                impotUrssaf = caAjuste * 0.075;
            } else {
                impotUrssaf = caAjuste * 0.13715 / 1.1;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${label}</td>
                <td>${Math.round(ca)} ‚Ç¨</td>
                <td>${caParJour} ‚Ç¨</td>
                <td>${cashRate ? cashRate + ' %' : ''}</td>
                <td>${jours}</td>
                <td>${panierJourArrondi}</td>
                <td>${prixPanierJour.toFixed(2)}‚Ç¨</td>
                <td style="background-color: #e0e0e0;">${Math.round(caAjuste)}‚Ç¨</td>
                <td style="background-color: #e0e0e0;">${Math.round(tvaCollecteeDeclarer)} ‚Ç¨</td>
             
            `;
            summaryTbody.appendChild(row);
        }

        summaryTable.appendChild(summaryTbody);

        const summaryContainer = document.createElement('div');
        summaryContainer.style.maxWidth = '100%';
        summaryContainer.style.overflowX = 'auto';
        summaryContainer.appendChild(summaryTable);
        list.appendChild(summaryContainer);

        // Calcul des moyennes du CA par jour de la semaine
        const joursSemaine = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        const caParJourSemaine = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;
            const dayIndex = d.getDay() === 0 ? 6 : d.getDay() - 1;
            if (salesData[dateKey]) {
                caParJourSemaine[dayIndex].total += salesData[dateKey].total;
                caParJourSemaine[dayIndex].count += 1;
            }
        }

        // Cr√©ation du tableau des moyennes par jour de la semaine
        spacer = document.createElement('div');
        spacer.style.height = '20px';
        list.appendChild(spacer);

        const weekdayTable = document.createElement('table');
        weekdayTable.className = 'weekday-table';
        const weekdayThead = document.createElement('thead');
        weekdayThead.innerHTML = `
            <tr>
                <th>Jour</th>
                <th>CA Moyen (‚Ç¨)</th>
            </tr>
        `;
        weekdayTable.appendChild(weekdayThead);

        const weekdayTbody = document.createElement('tbody');
        joursSemaine.forEach((jour, index) => {
            const moyenne = caParJourSemaine[index].count > 0
                ? Math.round(caParJourSemaine[index].total / caParJourSemaine[index].count)
                : 0;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${jour}</td>
                <td>${moyenne} ‚Ç¨</td>
            `;
            weekdayTbody.appendChild(row);
        });
        weekdayTable.appendChild(weekdayTbody);

        list.appendChild(weekdayTable);

    } catch (error) {
        console.error('Erreur dans filterRecipes:', error);
        const list = document.getElementById('recipeList');
        if (list) {
            list.innerHTML = '<p>Erreur lors du chargement des donn√©es. V√©rifiez la console pour plus de d√©tails.</p>';
        }
    }
}


function saveSalesData() {
    try {
        localStorage.setItem('salesData', JSON.stringify(salesData));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des ventes:', e);
        alert('Erreur lors de la sauvegarde des ventes.');
    }
}

function deleteSale(date) {
    if (confirm('Voulez-vous vraiment supprimer cette entr√©e de vente ?')) {
        delete salesData[date]; // Supprime l'entr√©e pour la date donn√©e
        saveSalesData(); // Sauvegarde les modifications
        filterRecipes(); // Met √† jour l'affichage
    }
}

function printAllRecipes() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Erreur : La biblioth√®que jsPDF n'est pas charg√©e.");
        return;
    }
    if (!salesData || typeof salesData !== 'object') {
        alert("Erreur : Les donn√©es des ventes ne sont pas disponibles.");
        return;
    }

    const startDateInput = document.getElementById('recipeStartDate').value;
    const endDateInput = document.getElementById('recipeEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("Erreur : Dates invalides.");
        return;
    }

    // Generate all dates in the range
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d));
    }

    const filteredSales = Object.entries(salesData).filter(([date]) => {
        const saleDate = new Date(date);
        return saleDate >= startDate && saleDate <= endDate;
    }).sort((a, b) => new Date(a[0]) - new Date(b[0]));

    if (allDates.length === 0) {
        alert("Aucune vente √† t√©l√©charger dans cette p√©riode.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;
    const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

    doc.setFontSize(12);
    doc.text(`Chez Barth-Liste des ventes du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Esp√®ce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    allDates.forEach(date => {
        const dateStr = `${dayAbbreviations[date.getDay()]} ${date.toLocaleDateString('fr-FR')}`;
        const saleForDate = filteredSales.find(([saleDate]) => new Date(saleDate).toDateString() === date.toDateString());

        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Liste des ventes du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Esp√®ce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }

        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(saleForDate ? `${Math.round(saleForDate[1].card)}‚Ç¨` : '', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(saleForDate ? `${Math.round(saleForDate[1].cash)}‚Ç¨` : '', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(saleForDate ? `${Math.round(saleForDate[1].total)}‚Ç¨` : '', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        y += rowHeight;
    });

    if (y > doc.internal.pageSize.getHeight() - margin - 20) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    let totalCard = 0, totalCash = 0, totalSales = 0;
    filteredSales.forEach(([_, data]) => {
        totalCard += data.card;
        totalCash += data.cash;
        totalSales += data.total;
    });
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${Math.round(totalCard)}‚Ç¨`, tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${Math.round(totalCash)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${Math.round(totalSales)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);

    window.open(doc.output('bloburl'), '_blank');
}

function downloadRecipesPDF() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Erreur : La biblioth√®que jsPDF n'est pas charg√©e.");
        return;
    }
    if (!salesData || typeof salesData !== 'object') {
        alert("Erreur : Les donn√©es des ventes ne sont pas disponibles.");
        return;
    }

    const startDateInput = document.getElementById('recipeStartDate').value;
    const endDateInput = document.getElementById('recipeEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("Erreur : Dates invalides.");
        return;
    }

    // Generate all dates in the range
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d));
    }

    const filteredSales = Object.entries(salesData).filter(([date]) => {
        const saleDate = new Date(date);
        return saleDate >= startDate && saleDate <= endDate;
    }).sort((a, b) => new Date(a[0]) - new Date(b[0]));

    if (allDates.length === 0) {
        alert("Aucune vente √† t√©l√©charger dans cette p√©riode.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;
    const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

    doc.setFontSize(12);
    doc.text(`Chez Barth-Liste des ventes du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Esp√®ce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    allDates.forEach(date => {
        const dateStr = `${dayAbbreviations[date.getDay()]} ${date.toLocaleDateString('fr-FR')}`;
        const saleForDate = filteredSales.find(([saleDate]) => new Date(saleDate).toDateString() === date.toDateString());

        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Liste des ventes du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Esp√®ce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }

        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(saleForDate ? `${Math.round(saleForDate[1].card)}‚Ç¨` : '', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(saleForDate ? `${Math.round(saleForDate[1].cash)}‚Ç¨` : '', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(saleForDate ? `${Math.round(saleForDate[1].total)}‚Ç¨` : '', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        y += rowHeight;
    });

    if (y > doc.internal.pageSize.getHeight() - margin - 20) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    let totalCard = 0, totalCash = 0, totalSales = 0;
    filteredSales.forEach(([_, data]) => {
        totalCard += data.card;
        totalCash += data.cash;
        totalSales += data.total;
    });
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${Math.round(totalCard)}‚Ç¨`, tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${Math.round(totalCash)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${Math.round(totalSales)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);

    const startStr = startDate.toLocaleDateString('fr-CA');
    const endStr = endDate.toLocaleDateString('fr-CA');
    const fileName = `Chez_Barth_Ventes_${startStr}_au_${endStr}.pdf`;
    doc.save(fileName);

    setTimeout(() => {
        alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);
    }, 500);

 window.open(doc.output('bloburl'), '_blank');
}

    // --- Facture ---
    function loadMenuFromStorage() {
    try {
        const storedMenu = localStorage.getItem('menu');
        if (storedMenu) {
            menu = JSON.parse(storedMenu);
        } else {
            menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato √† la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre √©tudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
            ];
            saveMenuToStorage();
        }
        updateMenuTvaRates(); // Initialiser les taux au chargement
    } catch (e) {
        console.error('Erreur lors du chargement du menu:', e);
        menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato √† la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre √©tudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
        ];
        updateMenuTvaRates(); // Initialiser les taux au chargement
    }
}

    

    function saveCAStatus() {
        const caBelow = document.getElementById('caBelow101000').checked;
        localStorage.setItem('caStatus', caBelow ? 'below' : 'above');
    }

   function toggleCA(checkbox) {
    const belowCheckbox = document.getElementById('caBelow101000');
    const aboveCheckbox = document.getElementById('caAbove101000');

    // S'assurer qu'une seule case est coch√©e √† la fois
    if (checkbox.id === 'caBelow101000' && checkbox.checked) {
        aboveCheckbox.checked = false;
        caBelow101000 = true;
    } else if (checkbox.id === 'caAbove101000' && checkbox.checked) {
        belowCheckbox.checked = false;
        caBelow101000 = false;
    } else if (!belowCheckbox.checked && !aboveCheckbox.checked) {
        // Si aucune case n'est coch√©e, on coche par d√©faut CA > 101000‚Ç¨
        aboveCheckbox.checked = true;
        caBelow101000 = false;
    }

    // Sauvegarder l'√©tat dans localStorage
    localStorage.setItem('caBelow101000', JSON.stringify(caBelow101000));

    // Mettre √† jour les taux de TVA et recalculer les prix
    updateMenuTvaRates();
}





function addNewProduct() {
    const name = document.getElementById('newProductName').value.trim();
    const priceTTC = parseFloat(document.getElementById('newProductPriceTTC').value);
    const type = document.getElementById('newProductType').value;

    if (!name || isNaN(priceTTC) || priceTTC <= 0) {
        alert('Veuillez entrer un nom valide et un prix TTC sup√©rieur √† 0.');
        return;
    }

    if (menu.some(item => item.name === name)) {
        alert('Ce produit existe d√©j√†.');
        return;
    }

    const tvaRate = type === 'S' ? 0.1 : 0.055;
    const priceHT = priceTTC / (1 + tvaRate);

    const newProduct = {
        name: name,
        priceTTC: priceTTC,
        priceHT: parseFloat(priceHT.toFixed(2)),
        type: type,
        tvaRate: tvaRate
    };

    menu.push(newProduct);
    saveMenuToStorage();
    updateProductList(); // Mettre √† jour la liste dans "COMMANDE A FACTURER"
    document.getElementById('menuActionArea').innerHTML = '';
    document.getElementById('menuDropdown').classList.remove('show');
    alert(`Produit "${name}" ajout√© avec succ√®s !`);
}

// Conserver cette fonction pour r√©f√©rence future, mais elle n'est pas utilis√©e ici
function addProduct() {
    const productSelect = document.getElementById('productSelect');
    const selectedProductName = productSelect.value;
    const product = menu.find(p => p.name === selectedProductName);
    if (product) {
        order.push({ ...product });
        updateOrderList();
        document.getElementById('menuActionArea').innerHTML = '';
        document.getElementById('menuDropdown').classList.remove('show');
    }
}

function deleteProduct() {
    const productSelectDelete = document.getElementById('productSelectDelete');
    const selectedProductName = productSelectDelete.value;
    const index = menu.findIndex(p => p.name === selectedProductName);
    if (index !== -1 && confirm(`Voulez-vous vraiment supprimer ${selectedProductName} du menu ?`)) {
        menu.splice(index, 1);
        saveMenuToStorage();
        document.getElementById('menuActionArea').innerHTML = '';
        document.getElementById('menuDropdown').classList.remove('show');
    }
}

// Fonction existante pour mettre √† jour le menu d√©roulant et la liste des produits
function updateProductList() {
    const productSelect = document.getElementById('productSelect');
    const productList = document.getElementById('productList');
    
    // Mise √† jour du menu d√©roulant
    productSelect.innerHTML = menu.map(item => 
        `<option value="${item.name}">${item.name} (${item.priceTTC.toFixed(2)}‚Ç¨)</option>`
    ).join('');
    
    // Mise √† jour de la liste des produits dans COMMANDE-FACTURE
    productList.innerHTML = menu.map(item => 
        `<li><input type="checkbox" value="${item.name}"> ${item.name} (${item.priceTTC.toFixed(2)}‚Ç¨)</li>`
    ).join('');
}

// Nouvelle fonction pour supprimer un produit
function deleteProductFromMenu() {
    const selectedProduct = document.getElementById('productSelect').value;
    if (!selectedProduct) {
        alert("Veuillez s√©lectionner un produit √† supprimer.");
        return;
    }

    if (confirm(`Tu veux supprimer le produit "${selectedProduct}" ?`)) {
        // Supprimer le produit de la liste menu
        menu = menu.filter(item => item.name !== selectedProduct);
        
        // Sauvegarder dans localStorage
        saveMenuToStorage();
        
        // Mettre √† jour imm√©diatement les affichages
        updateProductList();
        updateOrderList(); // Si un produit supprim√© est dans la commande en cours
        alert(`Le produit "${selectedProduct}" a √©t√© supprim√© avec succ√®s.`);
    } else {
        // Ne rien faire si "Non" est choisi
        return;
    }
}

// Modification de la fonction showMenuAction pour l'ajout
function showMenuAction(action) {
    const menuActionArea = document.getElementById('menuActionArea');
    if (action === 'add') {
        menuActionArea.innerHTML = `
            <input type="text" id="newProductName" placeholder="Nom du produit">
            <input type="number" id="newProductPrice" placeholder="Prix TTC (‚Ç¨)" step="0.01" min="0">
            <select id="newProductType">
                <option value="S">Sandwich/Dessert</option>
                <option value="B">Boisson</option>
            </select>
            <button onclick="confirmAddProduct()">Confirmer l'ajout du produit</button>
        `;
    } else {
        menuActionArea.innerHTML = '';
    }
}

// Nouvelle fonction pour confirmer l'ajout d'un produit
function confirmAddProduct() {
    const name = document.getElementById('newProductName').value.trim();
    const priceTTC = parseFloat(document.getElementById('newProductPrice').value);
    const type = document.getElementById('newProductType').value;

    if (!name || isNaN(priceTTC) || priceTTC <= 0) {
        alert("Veuillez entrer un nom valide et un prix sup√©rieur √† 0.");
        return;
    }

    // Calculer le prix HT selon le type et le statut CA
    const tvaRate = caBelow101000 ? 0 : (type === "B" ? 0.055 : 0.1);
    const priceHT = priceTTC / (1 + tvaRate);

    const newProduct = {
        name: name,
        priceTTC: priceTTC,
        priceHT: priceHT,
        type: type,
        tvaRate: tvaRate
    };

    // Ajouter le produit au menu
    menu.push(newProduct);
    
    // Sauvegarder dans localStorage
    saveMenuToStorage();
    
    // Mettre √† jour imm√©diatement les affichages
    updateProductList();
    document.getElementById('menuActionArea').innerHTML = ''; // Vider la zone d'ajout
    
    // Message de confirmation
    alert(`Ton produit "${name}" est bien ajout√© !`);
}

// Fonction existante pour sauvegarder le menu dans localStorage
function saveMenuToStorage() {
    try {
        localStorage.setItem('menu', JSON.stringify(menu));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde du menu:', e);
        alert('Erreur lors de la sauvegarde du menu.');
    }
}

// Fonction existante pour g√©rer le dropdown
function toggleDropdown(dropdownId) {
    document.getElementById(dropdownId).classList.toggle('show');
}

function toggleProduct(productName) {
    // Ne plus ajouter ou supprimer de order ici pour √©viter les doublons
    // Cette fonction ne g√®re que l'√©tat visuel des cases
    updateOrderList(); // Optionnel : mettre √† jour si besoin, mais pas n√©cessaire ici
}

function addSelectedToOrder() {
    const checkboxes = document.querySelectorAll('#productList input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        alert('Veuillez s√©lectionner au moins un produit.');
        return;
    }
    checkboxes.forEach(checkbox => {
        const productName = checkbox.value;
        const product = menu.find(p => p.name === productName);
        if (product) {
            order.push({ ...product });
        }
    });

// Ajout : Mettre √† jour le mode de paiement global
    currentPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'Non sp√©cifi√©';

    updateOrderList();
    // D√©cocher toutes les cases apr√®s ajout
    document.querySelectorAll('#productList input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('commandeDropdown').classList.remove('show');
}

function updateOrderList() {
    const orderList = document.getElementById('orderList');
    const orderTotal = document.getElementById('orderTotal');
    const invoiceHeader = document.getElementById('invoiceHeader');
    const caBelow = document.getElementById('caBelow101000').checked;
    const customerName = document.getElementById('customerNameInput') ? document.getElementById('customerNameInput').value.trim() : '';

    const lineHeightOrderList = "normal"; 
    const lineHeightOrderTotal = "normal"; 

    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    invoiceHeader.innerHTML = `
    <table style="width: 100%; max-width: 600px; margin: 0 auto 4px auto; font-size: 12px; border-collapse: collapse;">
        <tr>
            <td style="text-align: center; padding: 2px;">
                <div style="margin: 0; padding: 0; line-height: 1.2;">
                    <div style="margin: 0; padding: 0;">CHEZ BARTH</div>
                    <div style="margin: 0; padding: 0;">16 place des Pr√™cheurs 13100 Aix en Provence</div>
                    <div style="margin: 0; padding: 0;">T√©l√©phone : 09 77 53 78 71</div>
                    <div style="margin: 0; padding: 0;">Ent Indiv SIRET : 93253222900014 - APE : 56.10C</div>
                </div>
            </td>
        </tr>
        <tr>
            <td style="text-align: center; padding: 3px 0;">
                Fact N¬∞ ${invoiceCounter + 1} Facture du ${new Date().toLocaleDateString('fr-FR')}
                ${caBelow ? '<div style="margin-top: 2px; font-weight: bold;">(TVA non applicable art 293B du CGI)</div>' : ''}
            </td>
        </tr>
        ${customerName ? `
        <tr>
            <td style="text-align: left; padding: 3px 0;">
                <strong>Client : ${customerName}</strong>
            </td>
        </tr>` : ''}
    </table>
`;


    orderList.innerHTML = caBelow ? `
        <table style="width: 100%; max-width: 600px; margin: 0 auto 2px auto; font-size: 12px; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid #000;">
                <th style="text-align: left; padding-bottom: 1px;">Produits</th>
                <th style="text-align: right; padding-bottom: 1px;">Prix TTC</th>
            </tr>
            ${order.map(item => `
                <tr>
                    <td style="padding: 0.5px 10px 0.5px 0; line-height: ${lineHeightOrderList};">${item.name}</td>
                    <td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderList};">${item.priceTTC.toFixed(2)}‚Ç¨</td>
                </tr>
            `).join('')}
        </table>
    ` : `
        <table style="width: 100%; max-width: 600px; margin: 0 auto 4px auto; font-size: 12px; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid #000;">
                <th style="text-align: left; padding-bottom: 1px;">Produits</th>
                <th style="text-align: right; padding-bottom: 1px;">Prix HT</th>
                <th style="text-align: right; padding-bottom: 1px;">Prix TTC</th>
            </tr>
            ${order.map(item => `
                <tr>
                    <td style="padding: 0.5px 10px 0.5px 0; line-height: ${lineHeightOrderList};">${item.name}</td>
                    <td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderList};">${item.priceHT.toFixed(2)}‚Ç¨</td>
                    <td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderList};">${item.priceTTC.toFixed(2)}‚Ç¨</td>
                </tr>
            `).join('')}
        </table>
    `;

    orderTotal.innerHTML = caBelow ? `
        <table style="width: 100%; max-width: 600px; margin: 0 auto; font-size: 12px; border-collapse: collapse;">
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};"><strong>Total TTC:</strong></td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};"><strong>${totalTTC.toFixed(2)}‚Ç¨</strong></td></tr>
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">Paiement</td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">${currentPaymentMethod}</td></tr>
            <tr>
                <td colspan="2" style="text-align: left; font-style: italic; padding-top: 2px;">
                    Chez Barth vous remercie de votre visite.<br>A bient√¥t !
                </td>
            </tr>
        </table>
    ` : `
        <table style="width: 100%; max-width: 600px; margin: 0 auto; font-size: 12px; border-collapse: collapse;">
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">Total HT:</td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">${totalHT.toFixed(2)}‚Ç¨</td></tr>
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">TVA 5.5%:</td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">${totalTVA55.toFixed(2)}‚Ç¨</td></tr>
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">TVA 10%:</td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">${totalTVA10.toFixed(2)}‚Ç¨</td></tr>
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};"><strong>Total TTC:</strong></td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};"><strong>${totalTTC.toFixed(2)}‚Ç¨</strong></td></tr>
            <tr><td style="padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">Paiement</td><td style="text-align: right; padding: 0.5px 0; line-height: ${lineHeightOrderTotal};">${currentPaymentMethod}</td></tr>
            <tr>
                <td colspan="2" style="text-align: left; font-style: italic; padding-top: 2px;">
                    Chez Barth vous remercie de votre visite.<br>A bient√¥t !
                </td>
            </tr>
        </table>
    `;
}









function clearOrder() {
    order = [];

    const customerNameInput = document.getElementById('customerNameInput');
    if (customerNameInput) {
        customerNameInput.value = '';
    }

    updateOrderList();
}



function saveInvoice() {
    if (order.length === 0) {
        alert("Veuillez ajouter des produits √† la facture avant d'enregistrer");
        return;
    }

    invoiceCounter++;
    const invoiceNumber = invoiceCounter;
    const timestamp = new Date().toISOString();
    const caBelow = document.getElementById('caBelow101000').checked;
    const customerName = document.getElementById('customerNameInput') ? document.getElementById('customerNameInput').value.trim() : '';

    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    const invoice = {
        number: invoiceNumber,
        date: timestamp,
        items: [...order],
        caBelow: caBelow,
        totalHT: totalHT,
        totalTVA55: totalTVA55,
        totalTVA10: totalTVA10,
        totalTTC: totalTTC,
        paymentMethod: currentPaymentMethod,
        customerName: customerName // üî• Nouveau champ ajout√© ici
    };

    invoices.push(invoice);
    saveInvoicesToStorage();

    const invoiceHeader = document.getElementById('invoiceHeader');
    invoiceHeader.innerHTML = `
        <table style="width: 100%; max-width: 600px; margin: 0 auto; font-size: 12px; border-collapse: collapse; box-sizing: border-box;">
            <tr>
                <td style="text-align: center;">
                    <div style="text-align: center;">
                        <div>CHEZ BARTH</div>
                        <div>16 place des Pr√™cheurs 13100 Aix en Provence</div>
                        <div>T√©l√©phone : 09 77 53 78 71</div>
                        <div>Ent Indiv SIRET : 93253222900014 - APE : 56.10C</div>
                    </div>
                </td>
            </tr>
            <tr>
                <td style="text-align: center;">
                    Fact N¬∞ ${invoiceNumber} Facture du ${new Date().toLocaleDateString('fr-FR')}
                    ${caBelow ? '<div style="margin-top: 10px; font-weight: bold;">(TVA non applicable art 293B du CGI)</div>' : ''}
                    ${customerName ? `<div style="text-align: left; margin-top: 10px;"><strong>Client : ${customerName}</strong></div>` : ''}
                </td>
            </tr>
        </table>
    `;

    alert(`Facture enregistr√©e avec succ√®s sous le num√©ro ${invoiceNumber}`);
}


function exportInvoiceToPdf() {
    const invoiceContainer = document.getElementById('invoiceContainer');

    // 1. Extraction du num√©ro de facture depuis l'√©l√©ment affich√©
    // Supposons que tu as quelque part dans l'invoiceContainer du texte comme "Fact N¬∞12345"
    const invoiceNumberMatch = invoiceContainer.innerText.match(/Fact(?:ure)? N¬∞\s*(\d+)/i);
    const invoiceNumber = invoiceNumberMatch ? invoiceNumberMatch[1] : 'Inconnue';

    // 2. G√©n√©rer un nom de fichier avec date + num√©ro de facture
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Fact_N¬∞${invoiceNumber}_${dateStr}_Facture_Chez_Barth.pdf`;

    // 3. G√©n√©ration du PDF
    html2canvas(invoiceContainer, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#FFFFFF'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });

        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        pdf.save(fileName);

        // Message et ouverture
        setTimeout(() => {
            alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);

            const blob = pdf.output('blob');
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        }, 500);
    });
}



function printInvoice() {
    const invoiceContainer = document.getElementById('invoiceContainer');
    html2canvas(invoiceContainer, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#FFFFFF'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        window.open(pdf.output('bloburl'), '_blank');
    });
}

function sendInvoiceBySms() {
    if (order.length === 0) {
        alert("Veuillez ajouter des produits √† la facture avant d'envoyer par SMS");
        return;
    }

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const date = new Date();
    const customerName = document.getElementById('customerNameInput') ? document.getElementById('customerNameInput').value.trim() : '';

    const preventAutoLink = str => str.split('').join('\u200C');
    const formattedDate = preventAutoLink(date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }));

    let smsText = "Facture Chez Barth - " + formattedDate + "\n\n";
    smsText += "CHEZ BARTH\n";
    smsText += "16\u200B place\u200B des\u200B Pr√™cheurs\n";
    smsText += preventAutoLink("13100") + "\u200B Aix\u200B en\u200B Provence\n";
    smsText += "Tel: 09\u200B77\u200B53\u200B78\u200B71\n";
    smsText += "SIRET: " + preventAutoLink("93253222900014") + "\n";
    smsText += "APE: 56.10C\nEntreprise Individuelle\n\n";

    const caBelow = document.getElementById('caBelow101000').checked;
    smsText += `Fact N¬∞ ${invoiceCounter} du ${formattedDate}\n`;
    if (customerName) {
        smsText += `Client : ${customerName}\n`;
    }
    if (caBelow) {
        smsText += "TVA non applicable art 293B du CGI\n\n";
        smsText += "Produits:\n";
        order.forEach(item => {
            smsText += `${item.name}: ${item.priceTTC.toFixed(2)}‚Ç¨ TTC\n`;
        });
    } else {
        smsText += "\nProduits:\n";
        order.forEach(item => {
            smsText += `${item.name}: ${item.priceHT.toFixed(2)}‚Ç¨ HT / ${item.priceTTC.toFixed(2)}‚Ç¨ TTC\n`;
        });
    }

    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    if (caBelow) {
        smsText += `\nTotal TTC: ${totalTTC.toFixed(2)}‚Ç¨\n`;
        smsText += `Paiement: ${currentPaymentMethod}\n\n`;
    } else {
        smsText += `\nTotal HT: ${totalHT.toFixed(2)}‚Ç¨\n`;
        smsText += `TVA 5.5%: ${totalTVA55.toFixed(2)}‚Ç¨\n`;
        smsText += `TVA 10%: ${totalTVA10.toFixed(2)}‚Ç¨\n`;
        smsText += `Total TTC: ${totalTTC.toFixed(2)}‚Ç¨\n`;
        smsText += `Paiement: ${currentPaymentMethod}\n\n`;
    }

    smsText += "Chez Barth vous remercie de votre visite.\nA bient√¥t !";

    const phoneNumber = prompt("Entrez le num√©ro de t√©l√©phone (ex: 06....):");
    if (!phoneNumber) return;

    const cleanNumber = phoneNumber.replace(/\s/g, '').replace(/-/g, '');
    const smsUrl = `sms:${cleanNumber}?body=${encodeURIComponent(smsText)}`;

    if (isMobile) {
        window.location.href = smsUrl;
    } else {
        try {
            window.location.href = smsUrl;
        } catch (e) {
            alert("Impossible d'ouvrir l'application SMS.\n\nCopiez ce texte :\n\n" + smsText);
            navigator.clipboard.writeText(smsText);
        }
    }
}



function sendInvoiceByEmail() {
    const caBelow = document.getElementById('caBelow101000').checked;
    const customerName = document.getElementById('customerNameInput') ? document.getElementById('customerNameInput').value.trim() : '';

    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    const date = new Date();
    const formattedDate = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

    let emailBody = "Facture Chez BARTH\n";
    emailBody += "16\u200B place\u200B des\u200B Pr√™cheurs,\u200B 13100\u200B Aix\u200B en\u200B Provence\n";
    emailBody += "Tel: 09\u200B77\u200B53\u200B78\u200B71\n";
    emailBody += "Ent. Indiv. SIRET: 932\u200B532\u200B229\u200B00014 - APE: 56.10C\n";
    emailBody += `Fact N¬∞ ${invoiceCounter} - ${formattedDate}${caBelow ? ' (TVA non applicable)' : ''}\n`;
    if (customerName) {
        emailBody += `Client : ${customerName}\n`;
    }
    emailBody += "----------------------------\n";
    emailBody += "Produits\n";
    order.forEach(item => {
        if (caBelow) {
            emailBody += `${item.name}: ${item.priceTTC.toFixed(2)}‚Ç¨\n`;
        } else {
            emailBody += `${item.name}: ${item.priceHT.toFixed(2)}‚Ç¨ HT / ${item.priceTTC.toFixed(2)}‚Ç¨ TTC\n`;
        }
    });
    emailBody += "----------------------------\n";
    if (!caBelow) {
        emailBody += `Total HT: ${totalHT.toFixed(2)}‚Ç¨\n`;
        emailBody += `TVA 5.5%: ${totalTVA55.toFixed(2)}‚Ç¨\n`;
        emailBody += `TVA 10%: ${totalTVA10.toFixed(2)}‚Ç¨\n`;
    }
    emailBody += `Total TTC: ${totalTTC.toFixed(2)}‚Ç¨\n`;
    emailBody += `Paiement: ${currentPaymentMethod}\n`;
    emailBody += "\nChez Barth vous remercie de votre visite.\nA Bient√¥t !";

    const emailUrl = `mailto:?subject=Facture Chez BARTH&body=${encodeURIComponent(emailBody)}`;
    window.open(emailUrl);
}


async function printToBluetoothThermal() {
    if (!navigator.bluetooth) {
        alert("Web Bluetooth API n'est pas disponible.");
        return;
    }

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        const customerNameInput = document.getElementById('customerNameInput');
        const customerName = customerNameInput ? customerNameInput.value.trim() : '';
        const caBelow = document.getElementById('caBelow101000').checked;
        const date = new Date().toLocaleDateString('fr-FR');

        let text = "";

        // En-t√™te
        text += "CHEZ BARTH\n";
        text += "16 place des Precheurs\n";
        text += "13100 Aix en Provence\n";
        text += "T√©l√©phone : 09 77 53 78 71\n";
        text += "Ent. Indiv. SIRET : 93253222900014\n";
        text += "APE : 56.10C\n";
        text += "\n";

        // Facture
        text += `Fact N¬∞ ${invoiceCounter} du ${date}\n`;
        if (customerName) {
            text += `Client : ${customerName}\n`;
        }
        if (caBelow) {
            text += "(TVA non applicable art 293B du CGI)\n";
        }
        text += "\n";

        // Produits
        text += "-------------------------------\n";
        text += "Produits\n";
        text += "-------------------------------\n";
        if (caBelow) {
            order.forEach(item => {
                text += `${item.name.padEnd(20)} ${item.priceTTC.toFixed(2)}‚Ç¨ TTC\n`;
            });
        } else {
            order.forEach(item => {
                text += `${item.name.padEnd(20)} ${item.priceHT.toFixed(2)}‚Ç¨ HT / ${item.priceTTC.toFixed(2)}‚Ç¨ TTC\n`;
            });
        }
        text += "-------------------------------\n";

        // Totaux
        let totalHT = 0;
        let totalTVA55 = 0;
        let totalTVA10 = 0;
        order.forEach(item => {
            totalHT += item.priceHT;
            if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
            else totalTVA10 += item.priceTTC - item.priceHT;
        });
        const totalTTC = (totalHT + totalTVA55 + totalTVA10).toFixed(2);

        if (caBelow) {
            text += `Total TTC: ${totalTTC}‚Ç¨\n`;
        } else {
            text += `Total HT: ${totalHT.toFixed(2)}‚Ç¨\n`;
            text += `TVA 5.5%: ${totalTVA55.toFixed(2)}‚Ç¨\n`;
            text += `TVA 10%: ${totalTVA10.toFixed(2)}‚Ç¨\n`;
            text += `Total TTC: ${totalTTC}‚Ç¨\n`;
        }

        // Paiement
        text += `Paiement: ${currentPaymentMethod}\n`;

        // Remerciement
        text += "\nMerci de votre visite !\nA bient√¥t !\n\n";

        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\x1B\x64\x02\x1D\x56\x00'); // commandes ESC/POS pour d√©coupe
        await characteristic.writeValue(data);

        alert("Impression Bluetooth r√©ussie !");
        server.disconnect();
    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de l'impression Bluetooth : " + error.message);
    }
}


function filterInvoices() {
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredInvoices = invoices.filter(invoice => {
        const invoiceDate = new Date(invoice.date);
        return invoiceDate >= startDate && invoiceDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calcul des totaux par m√©thode de paiement
    let totalHTCard = 0, totalTVA55Card = 0, totalTVA10Card = 0, totalTTCCard = 0;
    let totalHTCash = 0, totalTVA55Cash = 0, totalTVA10Cash = 0, totalTTCCash = 0;
    let totalHT = 0, totalTVA55 = 0, totalTVA10 = 0, totalTTC = 0;

    filteredInvoices.forEach(invoice => {
        const ht = invoice.items.reduce((sum, item) => sum + item.priceHT, 0);
        const tva55 = invoice.items
            .filter(item => item.tvaRate === 0.055)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const tva10 = invoice.items
            .filter(item => item.tvaRate === 0.1)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const ttc = invoice.totalTTC;

        if (invoice.paymentMethod === 'Carte') {
            totalHTCard += ht;
            totalTVA55Card += tva55;
            totalTVA10Card += tva10;
            totalTTCCard += ttc;
        } else if (invoice.paymentMethod === 'Esp√®ce') {
            totalHTCash += ht;
            totalTVA55Cash += tva55;
            totalTVA10Cash += tva10;
            totalTTCCash += ttc;
        }

        totalHT += ht;
        totalTVA55 += tva55;
        totalTVA10 += tva10;
        totalTTC += ttc;
    });

    const invoiceList = document.getElementById('invoiceList');
    invoiceList.innerHTML = `
        <h3>Liste des Commandes factures du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
        <div style="overflow-x: auto; width: 100%;">
            <table style="width: 100%; max-width: 100%; table-layout: auto; border-collapse: collapse; font-size: 14px;">
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 5px; text-align: left;">Fact N¬∞</th>
                    <th style="padding: 5px; text-align: left;">Date</th>
                    <th style="padding: 5px; text-align: right;">Total HT</th>
                    <th style="padding: 5px; text-align: right;">TVA 5,5%</th>
                    <th style="padding: 5px; text-align: right;">TVA 10%</th>
                    <th style="padding: 5px; text-align: right;">Total TTC</th>
                    <th style="padding: 5px; text-align: left;">Paiement</th>
                </tr>
                ${filteredInvoices.map(invoice => `
                    <tr onclick="viewInvoiceDetail(${invoice.number})" style="cursor: pointer;">
                        <td style="padding: 5px;">${invoice.number}</td>
                        <td style="padding: 5px;">${new Date(invoice.date).toLocaleDateString('fr-FR')}</td>
                        <td style="padding: 5px; text-align: right;">${invoice.items.reduce((sum, item) => sum + item.priceHT, 0).toFixed(2)}‚Ç¨</td>
                        <td style="padding: 5px; text-align: right;">${invoice.items.filter(item => item.tvaRate === 0.055).reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0).toFixed(2)}‚Ç¨</td>
                        <td style="padding: 5px; text-align: right;">${invoice.items.filter(item => item.tvaRate === 0.1).reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0).toFixed(2)}‚Ç¨</td>
                        <td style="padding: 5px; text-align: right;">${invoice.totalTTC.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 5px;">${invoice.paymentMethod || 'Non sp√©cifi√©'}</td>
                    </tr>
                `).join('')}
                <tr style="height: 10px;"><td colspan="7"></td></tr>
                <tr style="background-color: #f9f9f9;">
                    <td colspan="2" style="padding: 5px;"><strong>Total Carte</strong></td>
                    <td style="padding: 5px; text-align: right;">${totalHTCard.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA55Card.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA10Card.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px; text-align: right;">${totalTTCCard.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px;"></td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td colspan="2" style="padding: 5px;"><strong>Total Esp√®ce</strong></td>
                    <td style="padding: 5px; text-align: right;">${totalHTCash.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA55Cash.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA10Cash.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px; text-align: right;">${totalTTCCash.toFixed(2)}‚Ç¨</td>
                    <td style="padding: 5px;"></td>
                </tr>
                <tr style="background-color: #f2f2f2;">
                    <td colspan="2" style="padding: 5px;"><strong>Total G√©n√©ral</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalHT.toFixed(2)}‚Ç¨</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalTVA55.toFixed(2)}‚Ç¨</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalTVA10.toFixed(2)}‚Ç¨</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalTTC.toFixed(2)}‚Ç¨</strong></td>
                    <td style="padding: 5px;"></td>
                </tr>
            </table>
        </div>
    `;
}

function viewInvoiceDetail(number) {
    const invoice = invoices.find(i => i.number === number);
    if (!invoice) return;

    showInvoiceDetail();
    const invoiceDetailContainer = document.getElementById('invoiceDetailContainer');

    // Appliquer styles fixes pour un rendu homog√®ne
    invoiceDetailContainer.style.fontFamily = 'Arial, sans-serif';
    invoiceDetailContainer.style.fontSize = '12px';
    invoiceDetailContainer.style.lineHeight = '1.1';
    invoiceDetailContainer.style.color = '#000';

    invoiceDetailContainer.dataset.invoiceNumber = invoice.number;
    const date = new Date(invoice.date).toLocaleDateString('fr-FR');
    
    invoiceDetailContainer.innerHTML = `
        <div id="invoiceHeader">
            CHEZ BARTH<br>
            16 place des Pr√™cheurs<br>
            13100 Aix en Provence<br>
            T√©l√©phone : 09 77 53 78 71<br>
            Ent Indiv SIRET : 93253222900014<br>
            APE : 56.10C
            <div style="height: 6px;"></div>
            <div class="invoice-number">Fact N¬∞ ${invoice.number} Facture du ${date}</div>
            ${invoice.customerName ? `<div style="text-align: left; margin-top: 6px;"><strong>Client : ${invoice.customerName}</strong></div>` : ''}
            <div class="invoice-number" style="margin-top: 6px; font-weight: bold;">
                ${invoice.caBelow ? '(TVA non applicable art 293B du CGI)' : ''}
            </div>
            <div style="height: 6px;"></div>
        </div>
        <div id="orderList">
            ${invoice.caBelow ? `
                <table>
                    <tr><th style="text-align: left;">Produits</th><th>Prix TTC</th></tr>
                    ${invoice.items.map(item => `
                        <tr>
                            <td style="padding-right: 22px;">${item.name}</td>
                            <td>${item.priceTTC.toFixed(2)}‚Ç¨</td>
                        </tr>
                    `).join('')}
                </table>
            ` : `
                <table>
                    <tr><th style="text-align: left;">Produits</th><th>Prix HT</th><th>Prix TTC</th></tr>
                    ${invoice.items.map(item => `
                        <tr>
                            <td style="padding-right: 22px;">${item.name}</td>
                            <td>${item.priceHT.toFixed(2)}‚Ç¨</td>
                            <td>${item.priceTTC.toFixed(2)}‚Ç¨</td>
                        </tr>
                    `).join('')}
                </table>
            `}
            <div style="height: 6px;"></div>
        </div>
        <div id="orderTotal">
            ${invoice.caBelow ? `
                <table class="total-table">
                    <tr><td><strong>Total TTC:</strong></td><td><strong>${invoice.totalTTC.toFixed(2)}‚Ç¨</strong></td></tr>
                </table>
            ` : `
                <table class="total-table">
                    <tr><td>Total HT:</td><td>${invoice.totalHT.toFixed(2)}‚Ç¨</td></tr>
                    <tr><td>TVA 5.5%:</td><td>${invoice.totalTVA55.toFixed(2)}‚Ç¨</td></tr>
                    <tr><td>TVA 10%:</td><td>${invoice.totalTVA10.toFixed(2)}‚Ç¨</td></tr>
                    <tr><td><strong>Total TTC:</strong></td><td><strong>${invoice.totalTTC.toFixed(2)}‚Ç¨</strong></td></tr>
                    <tr><td>Paiement :</td><td>${invoice.paymentMethod || 'Non sp√©cifi√©'}</td></tr>
                </table>
            `}
        </div>
        <div id="invoiceFooter" style="text-align: left; margin-top: 6px; font-style: italic;">
            Chez Barth vous remercie de votre visite.<br>A bient√¥t !
        </div>
    `;
}



function printInvoiceDetail() {
    const element = document.getElementById('invoiceDetailContainer');
    html2canvas(element, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#FFFFFF'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        window.open(pdf.output('bloburl'), '_blank');
    });
}

function deleteInvoiceDetail() {
    const invoiceDetailContainer = document.getElementById('invoiceDetailContainer');
    const invoiceNumber = invoiceDetailContainer.dataset.invoiceNumber;

    if (!invoiceNumber) {
        alert("Erreur : Aucune facture s√©lectionn√©e.");
        return;
    }

    const invoiceNumberParsed = parseInt(invoiceNumber, 10);
    const index = invoices.findIndex(i => i.number === invoiceNumberParsed);

    if (index === -1) {
        alert("Erreur : Facture non trouv√©e dans la liste.");
        return;
    }

    if (confirm("Voulez-vous vraiment supprimer cette facture ? Cette action est irr√©versible.")) {
        invoices.splice(index, 1);
        saveInvoicesToStorage();
        console.log('Apr√®s suppression - invoices:', invoices);
     
        showInvoiceManagement();
        filterInvoices();
    }
}

function printAllInvoices() {
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredInvoices = invoices.filter(invoice => {
        const invoiceDate = new Date(invoice.date);
        return invoiceDate >= startDate && invoiceDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (filteredInvoices.length === 0) {
        alert("Aucune facture √† imprimer dans cette p√©riode.");
        return;
    }

    // Calcul des totaux par m√©thode de paiement
    let totalHTCard = 0, totalTVA55Card = 0, totalTVA10Card = 0, totalTTCCard = 0;
    let totalHTCash = 0, totalTVA55Cash = 0, totalTVA10Cash = 0, totalTTCCash = 0;
    let totalHT = 0, totalTVA55 = 0, totalTVA10 = 0, totalTTC = 0;

    filteredInvoices.forEach(invoice => {
        const ht = invoice.items.reduce((sum, item) => sum + item.priceHT, 0);
        const tva55 = invoice.items
            .filter(item => item.tvaRate === 0.055)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const tva10 = invoice.items
            .filter(item => item.tvaRate === 0.1)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const ttc = invoice.totalTTC;

        if (invoice.paymentMethod === 'Carte') {
            totalHTCard += ht;
            totalTVA55Card += tva55;
            totalTVA10Card += tva10;
            totalTTCCard += ttc;
        } else if (invoice.paymentMethod === 'Esp√®ce') {
            totalHTCash += ht;
            totalTVA55Cash += tva55;
            totalTVA10Cash += tva10;
            totalTTCCash += ttc;
        }

        totalHT += ht;
        totalTVA55 += tva55;
        totalTVA10 += tva10;
        totalTTC += ttc;
    });

    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = [15, 30, 30, 30, 30, 30, 20]; // Current widths
    const rowHeight = 10;
    const tableX = margin;

    doc.setFontSize(12);
    doc.text(`Chez Barth-Liste des Commandes factures du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Fact N¬∞', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Date', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Total HT', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TVA 5,5%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('TVA 10%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text('Total TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    filteredInvoices.forEach(invoice => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Liste des Commandes factures du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Fact N¬∞', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Date', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Total HT', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TVA 5,5%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('TVA 10%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text('Total TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(`${invoice.number}`, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(new Date(invoice.date).toLocaleDateString('fr-FR'), tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${invoice.totalHT.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${invoice.totalTVA55.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${invoice.totalTVA10.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${invoice.totalTTC.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text(`${invoice.paymentMethod || 'Non sp√©cifi√©'}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
        y += rowHeight;
    });

    // Ajout d'une ligne vide
    y += rowHeight;

    // Ajout des totaux
    if (y > doc.internal.pageSize.getHeight() - margin - 40) {
        doc.addPage();
        y = margin;
    }

    // Total par Carte
    doc.setFont('helvetica', 'normal');
    doc.rect(tableX, y, colWidths[0] + colWidths[1], rowHeight); doc.text('Total Carte', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalHTCard.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalTVA55Card.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${totalTVA10Card.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${totalTTCCard.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    // Total par Esp√®ce
    doc.rect(tableX, y, colWidths[0] + colWidths[1], rowHeight); doc.text('Total Esp√®ce', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalHTCash.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalTVA55Cash.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${totalTVA10Cash.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${totalTTCCash.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    // Total G√©n√©ral
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0] + colWidths[1], rowHeight); doc.text('Total G√©n√©ral', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalHT.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalTVA55.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${totalTVA10.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${totalTTC.toFixed(2)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    window.open(doc.output('bloburl'), '_blank');
}

 // --- Achats ---
let purchaseCurrentDate = new Date();
let purchases = [];

const initialPurchases = [
    { "date": "2024-12-09T00:00:00Z", "amountTTC": 940, "type": "Autre", "payment": "Esp√®ce", "comment": "" },
    { "date": "2024-12-10T00:00:00Z", "amountTTC": 1747, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2024-12-11T00:00:00Z", "amountTTC": 35, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-11T00:00:00Z", "amountTTC": 122, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-12T00:00:00Z", "amountTTC": 17, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-12T00:00:00Z", "amountTTC": 259, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-13T00:00:00Z", "amountTTC": 14, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-14T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-16T00:00:00Z", "amountTTC": 32, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-16T00:00:00Z", "amountTTC": 226, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-17T00:00:00Z", "amountTTC": 22, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-18T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-18T00:00:00Z", "amountTTC": 192, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-19T00:00:00Z", "amountTTC": 24, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-19T00:00:00Z", "amountTTC": 114, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-20T00:00:00Z", "amountTTC": 13, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-21T00:00:00Z", "amountTTC": 21, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-23T00:00:00Z", "amountTTC": 16, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-23T00:00:00Z", "amountTTC": 292, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-24T00:00:00Z", "amountTTC": 15, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-27T00:00:00Z", "amountTTC": 6, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-27T00:00:00Z", "amountTTC": 263, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-28T00:00:00Z", "amountTTC": 17, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-30T00:00:00Z", "amountTTC": 21, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-30T00:00:00Z", "amountTTC": 407, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-31T00:00:00Z", "amountTTC": 18, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-02T00:00:00Z", "amountTTC": 14, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-03T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-03T00:00:00Z", "amountTTC": 233, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-04T00:00:00Z", "amountTTC": 16, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-06T00:00:00Z", "amountTTC": 10, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-06T00:00:00Z", "amountTTC": 297, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-07T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-08T00:00:00Z", "amountTTC": 26, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-08T00:00:00Z", "amountTTC": 519, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-09T00:00:00Z", "amountTTC": 22, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-10T00:00:00Z", "amountTTC": 33, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-10T00:00:00Z", "amountTTC": 381, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-11T00:00:00Z", "amountTTC": 23, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-13T00:00:00Z", "amountTTC": 29, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-14T00:00:00Z", "amountTTC": 17, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-15T00:00:00Z", "amountTTC": 26, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-15T00:00:00Z", "amountTTC": 301, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-16T00:00:00Z", "amountTTC": 24, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-17T00:00:00Z", "amountTTC": 30, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-18T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-20T00:00:00Z", "amountTTC": 25, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-20T00:00:00Z", "amountTTC": 371, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-21T00:00:00Z", "amountTTC": 27, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-22T00:00:00Z", "amountTTC": 28, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-22T00:00:00Z", "amountTTC": 404, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-23T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-24T00:00:00Z", "amountTTC": 47, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-25T00:00:00Z", "amountTTC": 43, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-27T00:00:00Z", "amountTTC": 50, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-27T00:00:00Z", "amountTTC": 758, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-28T00:00:00Z", "amountTTC": 22, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-28T00:00:00Z", "amountTTC": 344, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-29T00:00:00Z", "amountTTC": 49, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-30T00:00:00Z", "amountTTC": 29, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-31T00:00:00Z", "amountTTC": 44, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-31T00:00:00Z", "amountTTC": 134, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-01T00:00:00Z", "amountTTC": 27, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-01T00:00:00Z", "amountTTC": 502, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-03T00:00:00Z", "amountTTC": 31, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-03T00:00:00Z", "amountTTC": 286, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-04T00:00:00Z", "amountTTC": 25, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-05T00:00:00Z", "amountTTC": 42, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-05T00:00:00Z", "amountTTC": 380, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-06T00:00:00Z", "amountTTC": 48, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-07T00:00:00Z", "amountTTC": 41, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-07T00:00:00Z", "amountTTC": 473, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-08T00:00:00Z", "amountTTC": 30, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-10T00:00:00Z", "amountTTC": 53, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-10T00:00:00Z", "amountTTC": 930, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-10T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-02-11T00:00:00Z", "amountTTC": 89, "type": "Pain", "payment": "Esp√®ce", "comment": "" },
    { "date": "2025-02-11T00:00:00Z", "amountTTC": 270, "type": "Alimentaire", "payment": "Esp√®ce", "comment": "" },
    { "date": "2025-02-11T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-02-12T00:00:00Z", "amountTTC": 124, "type": "Pain", "payment": "Esp√®ce", "comment": "" },
    { "date": "2025-02-12T00:00:00Z", "amountTTC": 845, "type": "Alimentaire", "payment": "Esp√®ce", "comment": "" },
    { "date": "2025-02-12T00:00:00Z", "amountTTC": 400, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-02-13T00:00:00Z", "amountTTC": 129, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-13T00:00:00Z", "amountTTC": 376, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-13T00:00:00Z", "amountTTC": 570, "type": "Autre", "payment": "Carte", "comment": "enseigne carte" },
    { "date": "2025-02-14T00:00:00Z", "amountTTC": 113, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-14T00:00:00Z", "amountTTC": 100, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-02-15T00:00:00Z", "amountTTC": 900, "type": "Autre", "payment": "Esp√®ce", "comment": "Ran√ßon et enseigne" },
    { "date": "2025-02-17T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-17T00:00:00Z", "amountTTC": 1206, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-18T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-18T00:00:00Z", "amountTTC": 258, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-18T00:00:00Z", "amountTTC": 44, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-02-19T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-19T00:00:00Z", "amountTTC": 48, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-20T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-20T00:00:00Z", "amountTTC": 369, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-21T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-23T00:00:00Z", "amountTTC": 259, "type": "Mat√©riel", "payment": "Carte", "comment": "Frigo" },
    { "date": "2025-02-25T00:00:00Z", "amountTTC": 84, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-25T00:00:00Z", "amountTTC": 397, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-25T00:00:00Z", "amountTTC": 82, "type": "Mat√©riel", "payment": "Carte", "comment": "Action" },
    { "date": "2025-02-26T00:00:00Z", "amountTTC": 84, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-26T00:00:00Z", "amountTTC": 29, "type": "Mat√©riel", "payment": "Carte", "comment": "Tampon" },
    { "date": "2025-02-27T00:00:00Z", "amountTTC": 84, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-27T00:00:00Z", "amountTTC": 327, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-01T00:00:00Z", "amountTTC": 404, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-02T00:00:00Z", "amountTTC": 353, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-03T00:00:00Z", "amountTTC": 960, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-04T00:00:00Z", "amountTTC": 72, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-04T00:00:00Z", "amountTTC": 100, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-05T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-05T00:00:00Z", "amountTTC": 95, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-06T00:00:00Z", "amountTTC": 83, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-06T00:00:00Z", "amountTTC": 201, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-07T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-07T00:00:00Z", "amountTTC": 266, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-09T00:00:00Z", "amountTTC": 12, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-10T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-10T00:00:00Z", "amountTTC": 207, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-11T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-11T00:00:00Z", "amountTTC": 131, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-11T00:00:00Z", "amountTTC": 41, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-12T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-12T00:00:00Z", "amountTTC": 148, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-13T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-13T00:00:00Z", "amountTTC": 117, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-13T00:00:00Z", "amountTTC": 140, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-14T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-14T00:00:00Z", "amountTTC": 17, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-16T00:00:00Z", "amountTTC": 254, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-17T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-17T00:00:00Z", "amountTTC": 155, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-18T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-18T00:00:00Z", "amountTTC": 167, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-19T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-19T00:00:00Z", "amountTTC": 25, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-19T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-03-20T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-20T00:00:00Z", "amountTTC": 170, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-21T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-24T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-24T00:00:00Z", "amountTTC": 256, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-25T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-25T00:00:00Z", "amountTTC": 441, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-25T00:00:00Z", "amountTTC": 30, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-26T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-26T00:00:00Z", "amountTTC": 204, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 334, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 18, "type": "Mat√©riel", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-03-28T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-28T00:00:00Z", "amountTTC": 292, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-28T00:00:00Z", "amountTTC": 193, "type": "Mat√©riel", "payment": "Carte", "comment": "" },
    { "date": "2025-03-29T00:00:00Z", "amountTTC": 432, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-31T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-01T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-01T00:00:00Z", "amountTTC": 420, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-02T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-03T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-03T00:00:00Z", "amountTTC": 456, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-04T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-04T00:00:00Z", "amountTTC": 5, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-07T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-07T00:00:00Z", "amountTTC": 108, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-08T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-08T00:00:00Z", "amountTTC": 631, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-09T00:00:00Z", "amountTTC": 438, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-10T00:00:00Z", "amountTTC": 44, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-11T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-11T00:00:00Z", "amountTTC": 185, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-14T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-14T00:00:00Z", "amountTTC": 267, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-15T00:00:00Z", "amountTTC": 45, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-15T00:00:00Z", "amountTTC": 239, "type": "Alimentaire", "payment": "Carte", "comment": "" }
];



function loadPurchases() {
    try {
        const storedPurchases = localStorage.getItem('purchases');
        if (!storedPurchases || storedPurchases === '[]') {
            // Si le localStorage est vide ou contient un tableau vide, on charge les donn√©es initiales
            purchases = [...initialPurchases];
            localStorage.setItem('purchases', JSON.stringify(purchases));
            console.log('Donn√©es initiales charg√©es :', purchases);
        } else {
            purchases = JSON.parse(storedPurchases);
            console.log('Donn√©es charg√©es depuis localStorage :', purchases);
        }
    } catch (e) {
        console.error('Erreur avec localStorage pour les achats:', e);
        // En cas d'erreur, on charge les donn√©es initiales par d√©faut
        purchases = [...initialPurchases];
        localStorage.setItem('purchases', JSON.stringify(purchases));
    }
}

function savePurchases() {
    try {
        localStorage.setItem('purchases', JSON.stringify(purchases));
        console.log('Donn√©es sauvegard√©es dans localStorage :', purchases);
        alert('Donn√©es enregistr√©es avec succ√®s !');
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des achats:', e);
        alert('Erreur lors de la sauvegarde des achats.');
    }
}

function formatRecipeDate(date) {
    const dayName = date.toLocaleDateString('fr-FR', { weekday: 'long' });
    const formattedDate = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${formattedDate}`;
}

function getISODate(date) {
    // Convertir la date en heure de Paris
    const parisDate = new Date(date.toLocaleString('en-US', { timeZone: 'Europe/Paris' }));
    // Formater en YYYY-MM-DD
    return parisDate.toLocaleDateString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).split('/').reverse().join('-');
}

function updatePurchaseDisplay() {
    document.getElementById('currentPurchaseDate').textContent = formatRecipeDate(purchaseCurrentDate);
    document.getElementById('purchaseAmount').value = '';
    document.querySelectorAll('input[name="purchaseType"]').forEach(input => input.checked = false);
    document.getElementById('purchaseComment').value = '';
}

function addPurchase() {
    const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
    const type = document.querySelector('input[name="purchaseType"]:checked')?.value;
    const payment = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    const comment = document.getElementById('purchaseComment').value;

    if (!amount || !type || !payment) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return;
    }

    const purchase = {
        date: getISODate(purchaseCurrentDate),
        amountTTC: amount,
        type: type,
        payment: payment,
        comment: comment
    };

    purchases.push(purchase);
    savePurchases();
    updatePurchaseDisplay();
}

document.getElementById('prevPurchaseDay').addEventListener('click', () => {
    purchaseCurrentDate.setDate(purchaseCurrentDate.getDate() - 1);
    updatePurchaseDisplay();
});

document.getElementById('nextPurchaseDay').addEventListener('click', () => {
    purchaseCurrentDate.setDate(purchaseCurrentDate.getDate() + 1);
    updatePurchaseDisplay();
});

function deletePurchase(index) {
    if (confirm('Voulez-vous vraiment supprimer cet achat ?')) {
        purchases.splice(index, 1);
        savePurchases();
        filterPurchases();
    }
}


function filterPurchases() {
    try {
        const startInput = document.getElementById('purchaseStartDate');
        const endInput = document.getElementById('purchaseEndDate');
        const showCommentsCheckbox = document.getElementById('showPurchaseComments');
        const list = document.getElementById('purchasesList');

        if (!startInput || !endInput || !showCommentsCheckbox || !list) {
            console.error('√âl√©ments HTML manquants pour filterPurchases');
            list.innerHTML = '<p>Erreur : √âl√©ments de la page introuvables.</p>';
            return;
        }

        const start = startInput.value;
        const end = endInput.value;
        const showComments = showCommentsCheckbox.checked;

        // Fonction pour formater la date en heure de Paris
        const formatRecipeDate = (date) => {
            const jours = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];
            const parisDate = new Date(date.toLocaleString('en-US', { timeZone: 'Europe/Paris' }));
            const jour = jours[parisDate.getDay()];
            return `${jour} ${parisDate.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            })}`;
        };

        // Fonction pour formater une date en YYYY-MM-DD en heure de Paris
        const getParisDateString = (date) => {
            const parisDate = new Date(date.toLocaleString('en-US', { timeZone: 'Europe/Paris' }));
            return parisDate.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).split('/').reverse().join('-');
        };

        // Construction des dates de d√©but et de fin en heure de Paris
        const startDate = start
            ? new Date(new Date(`${start}T00:00:00`).toLocaleString('en-US', { timeZone: 'Europe/Paris' }))
            : new Date(new Date('2024-12-09T00:00:00').toLocaleString('en-US', { timeZone: 'Europe/Paris' }));

        const endDate = end
            ? new Date(new Date(`${end}T23:59:59`).toLocaleString('en-US', { timeZone: 'Europe/Paris' }))
            : new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Paris' }));

        // Log pour d√©boguer les dates
        console.log('startDate:', getParisDateString(startDate), 'endDate:', getParisDateString(endDate));

        // V√©rification de validit√© des dates
        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            console.error('Dates invalides ou incoh√©rentes');
            list.innerHTML = '<p>Erreur : Dates invalides.</p>';
            return;
        }

        // Charger les achats depuis localStorage
        let purchases = [];
        try {
            const storedPurchases = localStorage.getItem('purchases');
            if (storedPurchases && storedPurchases !== '[]') {
                purchases = JSON.parse(storedPurchases).map(p => ({
                    ...p,
                    date: getParisDateString(new Date(p.date)) // Normaliser la date
                }));
                console.log('Achats charg√©s:', purchases);
            }
        } catch (e) {
            console.error('Erreur lors du chargement des achats:', e);
            list.innerHTML = '<p>Erreur lors du chargement des achats.</p>';
            return;
        }

        // V√©rifier salesData
        if (!salesData) {
            console.error('salesData non d√©fini');
            list.innerHTML = '<p>Erreur : Donn√©es de ventes non disponibles.</p>';
            return;
        }

        // Cr√©er le tableau des achats quotidiens
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>Date</th>
                <th>Montant TTC (‚Ç¨)</th>
                <th>Type</th>
                <th>Paiement</th>
                ${showComments ? '<th>Commentaire</th>' : ''}
            </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        const totalsByType = { Pain: 0, Alimentaire: 0, Mat√©riel: 0, Autre: 0 };
        const totalsByPayment = { Carte: 0, Esp√®ce: 0 };
        let grandTotal = 0;

        // Boucle sur les dates pour afficher les achats
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateKey = getParisDateString(d);
            const purchasesOnDate = purchases.filter(p => p.date === dateKey);

            console.log('Date trait√©e:', dateKey, 'Achats:', purchasesOnDate);

            if (purchasesOnDate.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td style="white-space: nowrap;">${formatRecipeDate(d)}</td><td></td><td></td><td></td>${showComments ? '<td></td>' : ''}`;
                tbody.appendChild(row);
            } else {
                purchasesOnDate.forEach(p => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => showPurchaseDetailFromIndex?.(purchases.indexOf(p));
                    row.innerHTML = `<td style="white-space: nowrap;">${formatRecipeDate(new Date(p.date))}</td><td>${Math.round(p.amountTTC)} ‚Ç¨</td><td>${p.type}</td><td>${p.payment}</td>${showComments ? `<td>${p.comment || ''}</td>` : ''}`;
                    tbody.appendChild(row);

                    totalsByType[p.type] = (totalsByType[p.type] || 0) + p.amountTTC;
                    totalsByPayment[p.payment] = (totalsByPayment[p.payment] || 0) + p.amountTTC;
                    grandTotal += p.amountTTC;
                });
            }
        }

        table.appendChild(tbody);

        // Ajouter le pied de tableau avec les totaux
        const tfoot = document.createElement('tfoot');
        tfoot.innerHTML = `
            ${Object.keys(totalsByType).filter(type => totalsByType[type] > 0).map(type => `
                <tr style="background-color: #f0f0f0;"><td style="color:#003366; font-weight:bold;">Total ${type}</td><td style="color:#003366; font-weight:bold;">${Math.round(totalsByType[type])} ‚Ç¨</td><td></td><td></td>${showComments ? '<td></td>' : ''}</tr>
            `).join('')}
            ${Object.keys(totalsByPayment).filter(p => totalsByPayment[p] > 0).map(p => `
                <tr style="background-color: #f0f0f0;"><td style="color:green; font-weight:bold;">Total ${p}</td><td style="color:green; font-weight:bold;">${Math.round(totalsByPayment[p])} ‚Ç¨</td><td></td><td></td>${showComments ? '<td></td>' : ''}</tr>
            `).join('')}
            <tr style="background-color: #f0f0f0;"><td style="font-weight:bold;">Total G√©n√©ral</td><td style="font-weight:bold;">${Math.round(grandTotal)} ‚Ç¨</td><td></td><td></td>${showComments ? '<td></td>' : ''}</tr>
        `;
        table.appendChild(tfoot);

        list.innerHTML = `<h3>Liste des achats du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>`;
        const container = document.createElement('div');
        container.className = 'table-container';
        container.appendChild(table);
        list.appendChild(container);

        // Tableau R√©sum√© par Mois
        const monthlyData = {};
        const monthlySalesData = {};

        // Calcul des donn√©es d'achats
        purchases.forEach(p => {
            const parisDate = new Date(new Date(p.date + 'T00:00:00').toLocaleString('en-US', { timeZone: 'Europe/Paris' }));
            if (parisDate < startDate || parisDate > endDate) return;

            const year = parisDate.getFullYear();
            const month = String(parisDate.getMonth() + 1).padStart(2, '0');
            const key = `${year}-${month}`;

            if (!monthlyData[key]) {
                monthlyData[key] = {
                    total: 0,
                    Pain: 0,
                    Alimentaire: 0,
                    Mat√©riel: 0,
                    Autre: 0,
                    joursPain: new Set(),
                };
            }

            monthlyData[key].total += p.amountTTC;
            monthlyData[key][p.type] = (monthlyData[key][p.type] || 0) + p.amountTTC;

            if (p.type === 'Pain') {
                monthlyData[key].joursPain.add(p.date);
            }
        });

        // Calcul des jours travaill√©s √† partir de salesData
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const parisDate = new Date(d.toLocaleString('en-US', { timeZone: 'Europe/Paris' }));
            const year = parisDate.getFullYear();
            const month = String(parisDate.getMonth() + 1).padStart(2, '0');
            const day = String(parisDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;

            if (salesData[dateKey]) {
                const monthKey = `${year}-${month}`;
                if (!monthlySalesData[monthKey]) {
                    monthlySalesData[monthKey] = { activeDays: 0 };
                }
                monthlySalesData[monthKey].activeDays += 1;
            }
        }

        const summaryTable = document.createElement('table');
        summaryTable.style.fontSize = '0.8em';
        const summaryHead = document.createElement('thead');
        summaryHead.innerHTML = `
            <tr style="background:#ccc">
                <th style="width: 50px; white-space: normal; word-wrap: break-word;">Mois</th>
                <th style="width: 110px; text-align: right;">Total</th>
                <th style="width: 70px; text-align: right;">Total Alim</th>
                <th style="width: 90px; text-align: right;">Total Mat</th>
                <th style="width: 110px; text-align: right;">Total Autre</th>
                <th style="width: 110px; text-align: right;">Total Pain</th>
                <th style="width: 50px; text-align: center;">Nb Jours travaill√©s</th>
                <th style="width: 30px; text-align: center;">Nb Paniers/J</th>
                <th style="width: 70px; text-align: right;">Co√ªt Revient Panier Moy</th>
                <th style="width: 70px; text-align: right;">TVA d√©ductible √† 5,5%</th>
                <th style="width: 70px; text-align: right;">TVA d√©ductible √† 20%</th>
                <th style="width: 70px; text-align: right;">TVA d√©ductible Total</th>
            </tr>
        `;
        summaryTable.appendChild(summaryHead);

        const summaryBody = document.createElement('tbody');
        Object.entries(monthlyData).forEach(([key, val]) => {
            const [year, month] = key.split('-');
            const moisNom = new Date(`${key}-01T00:00:00`).toLocaleDateString('fr-FR', {
                month: 'long',
                timeZone: 'Europe/Paris'
            });

            const joursTravailles = monthlySalesData[key]?.activeDays || 0;

            let panierJour = 0;
            if (joursTravailles > 0) {
                const facteur = ((month === '12' && year === '2024') || (['01', '02'].includes(month) && year === '2025')) ? 0.7 : 0.56;
                const coef = (month === '12' && year === '2024') ? 0.95 :
                             (month === '01' && year === '2025') ? 0.96 :
                             (month === '02' && year === '2025') ? 0.90 :
                             (month === '03' && year === '2025') ? 0.85 :
                             (month === '04' && year === '2025') ? 0.85 : 
                             (month === '05' && year === '2025') ? 0.80 :
                             (month === '06' && year === '2025') ? 0.90 : 
                             (month === '07' && year === '2025') ? 0.62 :
                             (month === '08' && year === '2025') ? 0.87 :
                             (month === '09' && year === '2025') ? 0.6 : 0.92;
                             

                panierJour = val.Pain * coef / (joursTravailles * facteur);
            }

            const totalAlimentaireArrondi = Math.round(val.Alimentaire);
            const totalPainArrondi = Math.round(val.Pain);
            const panierJourArrondi = Math.round(panierJour);

            let coutReviensPanierJour = 0;
            const denominateur = joursTravailles * panierJourArrondi;
            if (denominateur > 0) {
                coutReviensPanierJour = (totalAlimentaireArrondi + totalPainArrondi) / denominateur;
            }

            const tvaDeductible5_5 = (val.Alimentaire + val.Pain) * 0.055 / 1.055;
            const tvaDeductible20 = (val.Autre + val.Mat√©riel) * 0.2 / 1.2;
            const tvaDeductibleTotal = tvaDeductible5_5 + tvaDeductible20;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${moisNom.charAt(0).toUpperCase() + moisNom.slice(1)}<br>${year}</td>
                <td>${Math.round(val.total)}‚Ç¨</td>
                <td>${totalAlimentaireArrondi}‚Ç¨</td>
                <td>${Math.round(val.Mat√©riel)}‚Ç¨</td>
                <td>${Math.round(val.Autre)}‚Ç¨</td>
                <td>${totalPainArrondi}‚Ç¨</td>
                <td>${joursTravailles}</td>
                <td>${panierJourArrondi}</td>
                <td>${coutReviensPanierJour.toFixed(2)} ‚Ç¨</td>
                <td>${Math.round(tvaDeductible5_5)} ‚Ç¨</td>
                <td>${Math.round(tvaDeductible20)} ‚Ç¨</td>
                <td>${Math.round(tvaDeductibleTotal)} ‚Ç¨</td>
            `;
            summaryBody.appendChild(row);
        });

        summaryTable.appendChild(summaryBody);
        const spacing = document.createElement('div');
        spacing.style.height = '30px';
        list.appendChild(spacing);
        const summaryContainer = document.createElement('div');
        summaryContainer.style.maxWidth = '100%';
        summaryContainer.style.overflowX = 'auto';
        summaryContainer.appendChild(summaryTable);
        list.appendChild(summaryContainer);
    } catch (error) {
        console.error('Erreur dans filterPurchases:', error);
        const list = document.getElementById('purchasesList');
        if (list) {
            list.innerHTML = '<p>Erreur lors du chargement des achats. V√©rifiez la console pour plus de d√©tails.</p>';
        }
    }
}







let selectedPurchaseIndex = null;

function showPurchaseDetailFromIndex(index) {
    selectedPurchaseIndex = index;
    const purchase = purchases[index];
    if (!purchase) return;

    document.getElementById('purchaseDetailDate').textContent = `Date : ${formatRecipeDate(new Date(purchase.date))}`;
    document.getElementById('purchaseDetailAmount').textContent = `Montant : ${purchase.amountTTC.toFixed(2)} ‚Ç¨`;
    document.getElementById('purchaseDetailType').textContent = `Type : ${purchase.type}`;
    document.getElementById('purchaseDetailPayment').textContent = `Paiement : ${purchase.payment}`;
    document.getElementById('purchaseDetailComment').textContent = `Commentaire : ${purchase.comment || 'Aucun'}`;

    document.getElementById('purchaseDetailPopup').classList.remove('hidden');
}

function closePurchaseDetail() {
    document.getElementById('purchaseDetailPopup').classList.add('hidden');
    selectedPurchaseIndex = null;
}

function deleteSelectedPurchase() {
    if (selectedPurchaseIndex !== null) {
        if (confirm("Supprimer cet achat ?")) {
            purchases.splice(selectedPurchaseIndex, 1);
            savePurchases();
            filterPurchases();
            closePurchaseDetail();
            alert("Achat supprim√© !");
        }
    }
}



function printPurchases() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Erreur : La biblioth√®que jsPDF n'est pas charg√©e.");
        return;
    }
    if (!purchases || !Array.isArray(purchases)) {
        alert("Erreur : Les donn√©es des achats ne sont pas disponibles.");
        return;
    }

    const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    const showComments = document.getElementById('showPurchaseComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("Erreur : Dates invalides.");
        return;
    }

    // Generate all dates in the range
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d));
    }

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (allDates.length === 0) {
        alert("Aucune donn√©e d'achat √† t√©l√©charger.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    const pageHeight = doc.internal.pageSize.height;
    let y = margin;
    const colWidths = showComments ? [38, 38, 38, 38, 38] : [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;
    const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

    const drawHeader = () => {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Type', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
            doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        }
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text('Montant TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
    };

    // Titre
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Chez Barth-Liste des achats du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    drawHeader();
    doc.setFont('helvetica', 'normal');

    const totalsByType = { Pain: 0, Alimentaire: 0, Mat√©riel: 0, Autre: 0 };
    const totalsByPayment = { Carte: 0, Esp√®ce: 0 };
    let totalTTC = 0;

    allDates.forEach(date => {
        const dateStr = `${dayAbbreviations[date.getDay()]} ${date.toLocaleDateString('fr-FR')}`;
        const purchasesForDate = filteredPurchases.filter(purchase => new Date(purchase.date).toDateString() === date.toDateString());

        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            drawHeader();
        }

        if (purchasesForDate.length === 0) {
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            if (showComments) {
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
                doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            }
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
            doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
            y += rowHeight;
        } else {
            purchasesForDate.forEach(purchase => {
                const type = purchase.type;
                const payment = purchase.payment;
                const comment = purchase.comment || '';
                const amount = Math.round(purchase.amountTTC);

                totalsByType[type] += purchase.amountTTC;
                totalsByPayment[payment] += purchase.amountTTC;
                totalTTC += purchase.amountTTC;

                doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
                doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(type, tableX + colWidths[0] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(payment, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
                if (showComments) {
                    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
                    doc.text(comment, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
                }
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
                doc.text(`${amount}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
                y += rowHeight;
            });
        }
    });

    const printTotalRow = (label, value, color = 'black') => {
        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(color);
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(label, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text(`${Math.round(value)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
        doc.setTextColor('black');
    };

    ['Pain', 'Alimentaire', 'Mat√©riel', 'Autre'].forEach(type => {
        printTotalRow(`Total ${type}`, totalsByType[type], '#003366');
    });

    printTotalRow('Par Carte', totalsByPayment['Carte'], 'green');
    printTotalRow('Par Esp√®ce', totalsByPayment['Esp√®ce'], 'green');
    printTotalRow('Total G√©n√©ral', totalTTC, 'black');

    window.open(doc.output('bloburl'), '_blank');
}

function downloadPurchasesPDF() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Erreur : La biblioth√®que jsPDF n'est pas charg√©e.");
        return;
    }
    if (!purchases || !Array.isArray(purchases)) {
        alert("Erreur : Les donn√©es des achats ne sont pas disponibles.");
        return;
    }

    const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    const showComments = document.getElementById('showPurchaseComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("Erreur : Dates invalides.");
        return;
    }

    // Generate all dates in the range
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d));
    }

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (allDates.length === 0) {
        alert("Aucune donn√©e d'achat √† t√©l√©charger.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    const pageHeight = doc.internal.pageSize.height;
    let y = margin;
    const colWidths = showComments ? [38, 38, 38, 38, 38] : [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;
    const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

    const drawHeader = () => {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Type', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
            doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        }
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text('Montant TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
    };

    // Titre
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Chez Barth-Liste des achats du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    drawHeader();
    doc.setFont('helvetica', 'normal');

    const totalsByType = { Pain: 0, Alimentaire: 0, Mat√©riel: 0, Autre: 0 };
    const totalsByPayment = { Carte: 0, Esp√®ce: 0 };
    let totalTTC = 0;

    allDates.forEach(date => {
        const dateStr = `${dayAbbreviations[date.getDay()]} ${date.toLocaleDateString('fr-FR')}`;
        const purchasesForDate = filteredPurchases.filter(purchase => new Date(purchase.date).toDateString() === date.toDateString());

        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            drawHeader();
        }

        if (purchasesForDate.length === 0) {
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            if (showComments) {
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
                doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            }
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
            doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
            y += rowHeight;
        } else {
            purchasesForDate.forEach(purchase => {
                const type = purchase.type;
                const payment = purchase.payment;
                const comment = purchase.comment || '';
                const amount = Math.round(purchase.amountTTC);

                totalsByType[type] += purchase.amountTTC;
                totalsByPayment[payment] += purchase.amountTTC;
                totalTTC += purchase.amountTTC;

                doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
                doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(type, tableX + colWidths[0] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(payment, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
                if (showComments) {
                    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
                    doc.text(comment, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
                }
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
                doc.text(`${amount}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
                y += rowHeight;
            });
        }
    });

    const printTotalRow = (label, value, color = 'black') => {
        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(color);
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(label, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text(`${Math.round(value)}‚Ç¨`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
        doc.setTextColor('black');
    };

    ['Pain', 'Alimentaire', 'Mat√©riel', 'Autre'].forEach(type => {
        printTotalRow(`Total ${type}`, totalsByType[type], '#003366');
    });

    printTotalRow('Par Carte', totalsByPayment['Carte'], 'green');
    printTotalRow('Par Esp√®ce', totalsByPayment['Esp√®ce'], 'green');
    printTotalRow('Total G√©n√©ral', totalTTC, 'black');

    const startStr = startDate.toLocaleDateString('fr-CA');
    const endStr = endDate.toLocaleDateString('fr-CA');
    const fileName = `Chez_Barth_Achats_${startStr}_au_${endStr}.pdf`;
    doc.save(fileName);

    setTimeout(() => {
        alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);
    }, 500);

 window.open(doc.output('bloburl'), '_blank');
}



async function printPurchasesToBluetooth() {
    const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    });

    if (filteredPurchases.length === 0) {
        alert("Aucune donn√©e d'achat √† imprimer.");
        return;
    }

    if (!navigator.bluetooth) {
        alert("Web Bluetooth API n'est pas disponible.");
        return;
    }

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        let text = "CHEZ BARTH\n16 place des Precheurs\n13100 Aix en Provence\n\n";
        text += `Achats du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}\n`;
        text += "-------------------------------\n";
        text += "Date   Type   Paiement   Montant\n";
        text += "-------------------------------\n";

        // Totaux
        let totalPain = 0, totalFood = 0, totalEquipment = 0, totalOther = 0;
        let totalCard = 0, totalCash = 0;
        let grandTotal = 0;

        filteredPurchases.forEach(purchase => {
            const dateStr = new Date(purchase.date).toLocaleDateString('fr-FR').substring(0, 5);
            const typeStr = purchase.type.substring(0, 6).padEnd(6);
            const paymentStr = purchase.payment.substring(0, 6).padEnd(6);
            const amount = Math.round(purchase.amountTTC);

            text += `${dateStr} ${typeStr} ${paymentStr} ${amount}‚Ç¨\n`;

            if (purchase.type === 'Pain') totalPain += purchase.amountTTC;
            if (purchase.type === 'Alimentaire') totalFood += purchase.amountTTC;
            if (purchase.type === 'Mat√©riel') totalEquipment += purchase.amountTTC;
            if (purchase.type === 'Autre') totalOther += purchase.amountTTC;

            if (purchase.payment === 'Carte') totalCard += purchase.amountTTC;
            if (purchase.payment === 'Esp√®ce') totalCash += purchase.amountTTC;

            grandTotal += purchase.amountTTC;
        });

        text += "-------------------------------\n";
        text += `Total Pain       : ${Math.round(totalPain)}‚Ç¨\n`;
        text += `Total Alimentaire: ${Math.round(totalFood)}‚Ç¨\n`;
        text += `Total Mat√©riel   : ${Math.round(totalEquipment)}‚Ç¨\n`;
        text += `Total Autre      : ${Math.round(totalOther)}‚Ç¨\n`;
        text += `-------------------------------\n`;
        text += `Par Carte        : ${Math.round(totalCard)}‚Ç¨\n`;
        text += `Par Esp√®ce       : ${Math.round(totalCash)}‚Ç¨\n`;
        text += `-------------------------------\n`;
        text += `TOTAL G√âN√âRAL    : ${Math.round(grandTotal)}‚Ç¨\n\n`;

        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\x1B\x64\x02\x1D\x56\x00'); // Fin + d√©coupe ticket
        await characteristic.writeValue(data);

        alert("Impression Bluetooth r√©ussie !");
        server.disconnect();
    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de l'impression Bluetooth : " + error.message);
    }
}

async function printSalesToBluetooth() {
    if (!navigator.bluetooth) {
        alert("Bluetooth non support√© sur ce navigateur.");
        return;
    }

    // G√©n√©ration du texte √† imprimer
    const startDate = document.getElementById('recipeStartDate').value;
    const endDate = document.getElementById('recipeEndDate').value;
    let filtered = Object.entries(salesData)
        .filter(([date]) => {
            if (!startDate && !endDate) return true;
            const d = new Date(date);
            return (!startDate || d >= new Date(startDate)) &&
                   (!endDate || d <= new Date(endDate));
        })
        .sort(([a], [b]) => new Date(a) - new Date(b));

    let total = 0;
    let text = "BILAN DES VENTES\n";
    text += `Du ${startDate || "d√©but"} au ${endDate || "aujourd'hui"}\n\n`;

    filtered.forEach(([date, data]) => {
        const jour = new Date(date).toLocaleDateString('fr-FR');
        const montant = Math.round(data.total);
        total += montant;
        text += `${jour} : ${montant}‚Ç¨\n`;
    });

    text += `\nTOTAL G√âN√âRAL : ${Math.round(total)}‚Ç¨\n`;

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] // ou le bon UUID de ton imprimante
        });

        console.log("Imprimante s√©lectionn√©e :", device.name);

        // üîß √Ä adapter selon ton imprimante : ici, on alerte seulement
        alert("Texte √† imprimer :\n\n" + text);

        // üëâ Si tu as d√©j√† une fonction `sendTextToPrinter(text, device)` comme pour les achats,
        // tu peux l'appeler ici :
        // await sendTextToPrinter(text, device);

    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de la connexion √† l'imprimante Bluetooth.");
    }
}


// Initialisation au d√©marrage
loadPurchases();
updatePurchaseDisplay();

// --- Personnel ---
let personnelCurrentDate = new Date();
let personnelRecords = [];
let employees = ["Tom", "Marylou", "Florentin"]; // Ajout de Florentin comme employ√© existant

const initialPersonnelRecords = [
    { date: "2024-12-09T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-10T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-11T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-12T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-14T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-15T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-16T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-17T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-18T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-19T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-20T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-21T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-22T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-23T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-24T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-25T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-26T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-28T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-29T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2024-12-30T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "20", hours: 2.67 },
    { date: "2024-12-31T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "20", hours: 3 },
    { date: "2025-01-01T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-02T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-03T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-04T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-05T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-06T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-07T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-08T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-09T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-10T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-11T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-12T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-14T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-15T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-16T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-17T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-18T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-19T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-20T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-21T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-22T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-23T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-24T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-25T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-26T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-28T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-29T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-30T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-31T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-02-01T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-02T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-03T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "60", hours: 2.67 },
    { date: "2025-02-04T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-05T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "60", hours: 2.67 },
    { date: "2025-02-06T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "60", hours: 2.67 },
    { date: "2025-02-07T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-08T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-09T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-10T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-11T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-12T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "90", hours: 2.67 },
    { date: "2025-02-14T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-15T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-16T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-17T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-18T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-19T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-20T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "90", hours: 2.67 },
    { date: "2025-02-21T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-22T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-23T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-24T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-02-25T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "50", hours: 3 },
    { date: "2025-02-26T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "40", hours: 2.67 },
    { date: "2025-02-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "40", hours: 2.67 },
    { date: "2025-02-28T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "180", hours: 3 },
    { date: "2025-03-01T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-02T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-03T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "10", hours: 2.67 },
    { date: "2025-03-04T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-05T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "50", hours: 2.67 },
    { date: "2025-03-06T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-07T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-08T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-09T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-10T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-03-11T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-12T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "40", hours: 2.67 },
    { date: "2025-03-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2025-03-14T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "80", hours: 3 },
    { date: "2025-03-15T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-16T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-17T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-03-18T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-19T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-03-20T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "90", hours: 2.67 },
    { date: "2025-03-21T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2025-03-22T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-23T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-24T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-03-25T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-26T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2025-03-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "148", hours: 2.67 },
    { date: "2025-03-28T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "65", hours: 3 },
    { date: "2025-03-29T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-30T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-31T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "200", hours: 2.67 },
    { date: "2025-04-01T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-02T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-03T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-04T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-05T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-06T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-07T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-08T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-09T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-10T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-11T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-12T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-13T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-14T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 }
];

function loadEmployees() {
    try {
        const storedEmployees = localStorage.getItem('employees');
        if (storedEmployees) {
            employees = JSON.parse(storedEmployees);
        } else {
            employees = ["Tom", "Marylou", "Florentin"];
            localStorage.setItem('employees', JSON.stringify(employees));
        }
    } catch (e) {
        console.error('Erreur avec localStorage pour les employ√©s:', e);
        employees = ["Tom", "Marylou", "Florentin"];
        localStorage.setItem('employees', JSON.stringify(employees));
    }
}

function saveEmployees() {
    try {
        localStorage.setItem('employees', JSON.stringify(employees));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des employ√©s:', e);
        alert('Erreur lors de la sauvegarde des employ√©s.');
    }
}

function loadPersonnelRecords() {
    try {
        const storedRecords = localStorage.getItem('personnelRecords');
        console.log('Stored Records from localStorage:', storedRecords);
        if (!storedRecords || storedRecords === '[]') {
            console.log('Aucun enregistrement trouv√© ou tableau vide, chargement des donn√©es initiales');
            personnelRecords = [...initialPersonnelRecords];
            localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
            console.log('Donn√©es initiales charg√©es :', personnelRecords);
        } else {
            personnelRecords = JSON.parse(storedRecords);
            console.log('Donn√©es charg√©es depuis localStorage :', personnelRecords);
        }
    } catch (e) {
        console.error('Erreur avec localStorage pour le personnel:', e);
        alert('Probl√®me de stockage des donn√©es du personnel d√©tect√©.');
        personnelRecords = [...initialPersonnelRecords];
        localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
        console.log('Donn√©es r√©initialis√©es aux valeurs initiales :', personnelRecords);
    }
}

function savePersonnelRecords() {
    try {
        localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des donn√©es du personnel:', e);
        alert('Erreur lors de la sauvegarde des donn√©es du personnel.');
    }
}

loadEmployees();
loadPersonnelRecords();

const employeeSelect = document.getElementById('employeeSelect');
const startTimeInput = document.getElementById('startTime');
const endTimeInput = document.getElementById('endTime');
const personnelCommentInput = document.getElementById('personnelComment');
const hoursTotalInput = document.getElementById('hoursTotal');
const prevPersonnelDay = document.getElementById('prevPersonnelDay');
const nextPersonnelDay = document.getElementById('nextPersonnelDay');
const currentPersonnelDateSpan = document.getElementById('currentPersonnelDate');

function updateEmployeeSelect() {
    employeeSelect.innerHTML = employees.map(emp => `<option value="${emp}">${emp}</option>`).join('');
}

function addEmployee() {
    const newEmployee = prompt("Entrez le nom du nouvel employ√© :");
    if (newEmployee && !employees.includes(newEmployee)) {
        employees.push(newEmployee);
        saveEmployees();
        updateEmployeeSelect();
    } else if (newEmployee) {
        alert("Cet employ√© existe d√©j√†.");
    }
}

function deleteEmployee() {
    const selectedEmployee = employeeSelect.value;
    if (confirm(`Voulez-vous vraiment supprimer l'employ√© ${selectedEmployee} ?`)) {
        employees = employees.filter(emp => emp !== selectedEmployee);
        saveEmployees();
        updateEmployeeSelect();
    }
}

function formatPersonnelDate(date) {
    const dayName = date.toLocaleDateString('fr-FR', { weekday: 'long' });
    const formattedDate = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${formattedDate}`;
}

function getISODate(date) {
    return date.toISOString();
}

function updatePersonnelDisplay() {
    currentPersonnelDateSpan.textContent = formatPersonnelDate(personnelCurrentDate);
    updateEmployeeSelect();
    startTimeInput.value = '';
    endTimeInput.value = '';
    personnelCommentInput.value = '';
    hoursTotalInput.value = '';
    hoursTotalConvertedInput.value = '';
}

function parseTimeInput(input) {
    let value = input.trim();
    if (!value) return '00:00';

    if (value.includes(':')) {
        const parts = value.split(':');
        let hours = parseInt(parts[0], 10) || 0;
        let minutes = parts[1] ? parseInt(parts[1], 10) || 0 : 0;
        if (hours > 23 || minutes > 59) return '00:00';
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    let num = parseInt(value, 10);
    if (isNaN(num)) return '00:00';

    let hours, minutes;
    if (value.length === 1 || value.length === 2) {
        hours = num;
        minutes = 0;
    } else if (value.length === 3) {
        hours = Math.floor(num / 100);
        minutes = num % 100;
    } else if (value.length === 4) {
        hours = Math.floor(num / 100);
        minutes = num % 100;
    } else {
        return '00:00';
    }

    if (hours > 23 || minutes > 59) return '00:00';

    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

function normalizeTimeInput(time) {
    if (!time) return '00:00';
    const parts = time.split(':');
    if (parts.length === 1) return `${parts[0].padStart(2, '0')}:00`;
    return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
}

function calculateHours() {
    console.log('Raw Start:', startTimeInput.value, 'Raw End:', endTimeInput.value);

    let start = normalizeTimeInput(parseTimeInput(startTimeInput.value));
    let end = normalizeTimeInput(parseTimeInput(endTimeInput.value));

    console.log('Formatted Start:', start, 'Formatted End:', end);

    if (start && end) {
        const startDate = new Date(`2024-01-01T${start}:00`);
        let endDate = new Date(`2024-01-01T${end}:00`);
        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }
        const diffMs = endDate - startDate;
        const hours = diffMs / (1000 * 60 * 60);
        hoursTotalInput.value = hours.toFixed(2);
        console.log('Hours:', hours);
        return hours;
    }
    hoursTotalInput.value = '0.00';
    return 0;
}

function convertToHoursMinutes(decimalHours) {
    const hours = Math.floor(decimalHours);
    const minutes = Math.round((decimalHours - hours) * 60);
    let result = `${hours} h`;
    if (minutes !== 0) {
        result += ` ${minutes.toString().padStart(2, '0')}`;
    }
    return result;
}

const hoursTotalConvertedInput = document.getElementById('hoursTotalConverted');

startTimeInput.addEventListener('blur', () => {
    startTimeInput.value = parseTimeInput(startTimeInput.value);
    const hours = calculateHours();
    hoursTotalConvertedInput.value = convertToHoursMinutes(hours);
});

endTimeInput.addEventListener('blur', () => {
    endTimeInput.value = parseTimeInput(endTimeInput.value);
    const hours = calculateHours();
    hoursTotalConvertedInput.value = convertToHoursMinutes(hours);
});

function addPersonnelHours() {
    const employee = employeeSelect.value;
    const start = normalizeTimeInput(startTimeInput.value);
    const end = normalizeTimeInput(endTimeInput.value);
    const comment = personnelCommentInput.value;
    const hours = calculateHours();

    if (!employee || !start || !end || hours <= 0) {
        alert('Veuillez remplir tous les champs correctement.');
        return;
    }

    const record = {
        date: getISODate(personnelCurrentDate),
        employee: employee,
        startTime: start,
        endTime: end,
        comment: comment,
        hours: hours
    };

    personnelRecords.push(record);
    savePersonnelRecords();
    alert('Heures de travail ajout√©es avec succ√®s !');
    updatePersonnelDisplay();
}

prevPersonnelDay.addEventListener('click', () => {
    personnelCurrentDate.setDate(personnelCurrentDate.getDate() - 1);
    updatePersonnelDisplay();
});

nextPersonnelDay.addEventListener('click', () => {
    personnelCurrentDate.setDate(personnelCurrentDate.getDate() + 1);
    updatePersonnelDisplay();
});

function deletePersonnelRecord(index) {
    if (confirm('Voulez-vous vraiment supprimer cette entr√©e ?')) {
        personnelRecords.splice(index, 1);
        savePersonnelRecords();
        filterPersonnel();
    }
}


        function filterPersonnel() {
            const startDateInput = document.getElementById('personnelStartDate').value;
            const endDateInput = document.getElementById('personnelEndDate').value;
            const showComments = document.getElementById('showComments').checked;

            let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-12-11');
            let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

            if (isNaN(startDate) || isNaN(endDate)) {
                document.getElementById('personnelList').innerHTML = '<p>Erreur : Dates invalides.</p>';
                return;
            }

            const allDates = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                allDates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            filteredPersonnelRecords = personnelRecords.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= startDate && recordDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const personnelList = document.getElementById('personnelList');
            if (!personnelList) {
                console.error("Erreur : L'√©l√©ment 'personnelList' n'existe pas.");
                return;
            }

            if (allDates.length === 0) {
                personnelList.innerHTML = '<p>Aucune donn√©e √† afficher pour cette p√©riode.</p>';
                return;
            }

            const totals = {};
            const commentTotals = {};
            const monthlyTotals = {};
            window.hourlyRatesHistory = JSON.parse(localStorage.getItem('hourlyRatesHistory')) || {};

            filteredPersonnelRecords.forEach(record => {
                if (!record.employee || record.employee.trim() === '') return;

                const employee = record.employee;
                if (!totals[employee]) {
                    totals[employee] = { hours: 0, minutes: 0 };
                    commentTotals[employee] = 0;
                }

                const rawHours = parseFloat(record.hours);
                const hours = Math.floor(rawHours || 0);
                const minutes = Math.round(((rawHours || 0) - hours) * 60);
                if (!isNaN(rawHours)) {
                    totals[employee].hours += hours;
                    totals[employee].minutes += minutes;
                    if (totals[employee].minutes >= 60) {
                        totals[employee].hours += Math.floor(totals[employee].minutes / 60);
                        totals[employee].minutes %= 60;
                    }
                }

                const commentValue = parseFloat(record.comment);
                if (!isNaN(commentValue)) {
                    commentTotals[employee] += commentValue;
                }

                const recordDate = new Date(record.date);
                const monthKey = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlyTotals[monthKey]) monthlyTotals[monthKey] = {};
                if (!monthlyTotals[monthKey][employee]) {
                    monthlyTotals[monthKey][employee] = { hours: 0, minutes: 0, comments: 0 };
                }

                if (!isNaN(rawHours)) {
                    monthlyTotals[monthKey][employee].hours += hours;
                    monthlyTotals[monthKey][employee].minutes += minutes;
                    if (monthlyTotals[monthKey][employee].minutes >= 60) {
                        monthlyTotals[monthKey][employee].hours += Math.floor(monthlyTotals[monthKey][employee].minutes / 60);
                        monthlyTotals[monthKey][employee].minutes %= 60;
                    }
                }

                if (!isNaN(commentValue)) {
                    monthlyTotals[monthKey][employee].comments += commentValue;
                }
            });

            function getEffectiveHourlyRate(employee, monthKey) {
                if (!window.hourlyRatesHistory[employee]) return 11.88;
                const months = Object.keys(window.hourlyRatesHistory[employee]).sort();
                let rate = 11.88;
                for (let m of months) {
                    if (m <= monthKey) {
                        rate = window.hourlyRatesHistory[employee][m];
                    } else {
                        break;
                    }
                }
                return rate;
            }

            function convertToHoursMinutes(decimal) {
                const h = Math.floor(decimal);
                const m = Math.round((decimal - h) * 60);
                return (h === 0 && m === 0) ? '' : `${h}${m ? 'h' + m.toString().padStart(2, '0') : 'h'}`;
            }

            let tableRows = '';
            const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

            allDates.forEach(date => {
                const dateRecords = filteredPersonnelRecords.filter(record =>
                    new Date(record.date).toDateString() === date.toDateString()
                );

                if (dateRecords.length === 0) {
                    const dayAbbr = dayAbbreviations[date.getDay()];
                    tableRows += `
                        <tr>
                            <td style="white-space: nowrap;">${dayAbbr} ${date.toLocaleDateString('fr-FR')}</td>
                            <td></td><td></td><td></td><td></td>
                            ${showComments ? '<td></td>' : ''}
                        </tr>`;
                } else {
                    tableRows += dateRecords.map(record => {
                        const dayAbbr = dayAbbreviations[new Date(record.date).getDay()];
                        const index = filteredPersonnelRecords.indexOf(record);
                        return `
                            <tr style="cursor:pointer" onclick="showPersonnelDetailFromIndex(${index})">
                                <td>${dayAbbr} ${new Date(record.date).toLocaleDateString('fr-FR')}</td>
                                <td>${record.employee || ''}</td>
                                <td>${record.startTime || ''}</td>
                                <td>${record.endTime || ''}</td>
                                <td>${convertToHoursMinutes(record.hours || 0)}</td>
                                ${showComments ? `<td>${record.comment || ''}</td>` : ''}
                            </tr>`;
                    }).join('');
                }
            });

            tableRows += Object.keys(totals).map(employee => {
                const t = totals[employee];
                const timeDisplay = convertToHoursMinutes(t.hours + t.minutes / 60);
                return `
                    <tr style="font-weight: bold; background-color: #f0f0f0;">
                        <td>Total ${employee}</td><td></td><td></td><td></td>
                        <td>${timeDisplay}</td>
                        ${showComments ? `<td>${commentTotals[employee] ? Math.round(commentTotals[employee]) : ''}</td>` : ''}
                    </tr>`;
            }).join('');

            const totalHours = Object.values(totals).reduce((sum, t) => sum + t.hours, 0);
            const totalMinutes = Object.values(totals).reduce((sum, t) => sum + t.minutes, 0);
            const totalComments = Math.round(Object.values(commentTotals).reduce((sum, c) => sum + c, 0));

            tableRows += `
                <tr style="font-weight: bold; font-size: 16px; background-color: #f0f0f0;">
                    <td>Total G√©n√©ral</td><td></td><td></td><td></td>
                    <td>${convertToHoursMinutes(totalHours + totalMinutes / 60)}</td>
                    ${showComments ? `<td>${totalComments || ''}</td>` : ''}
                </tr>`;

function updateMonthlyTable() {
    let monthlyTableRows = '';
    let grandTotalHours = 0, grandTotalMinutes = 0, grandTotalComments = 0, grandTotalEstimated = 0;

    const startConditionalDate = new Date('2024-12-11');
    const endConditionalDate = new Date('2025-03-31');

    const months = Object.keys(monthlyTotals).sort();
    const personnelByMonthFinal = {};
    const globalEmployeeTotals = {};

    const monthMapShort = ["janv", "f√©vr", "mars", "avr", "mai", "juin", "juil", "ao√ªt", "sept", "oct", "nov", "d√©c"];

    months.forEach(month => {
        let monthHours = 0, monthMinutes = 0, monthComments = 0, monthEstimated = 0;

        const [year, monthNum] = month.split('-').map(Number);
        const monthDate = new Date(year, monthNum - 1, 1);
        const monthLabel = `${monthMapShort[monthDate.getMonth()]}-${String(year).slice(-2)}`;

        Object.keys(monthlyTotals[month]).forEach(employee => {
            const { hours, minutes, comments } = monthlyTotals[month][employee];
            const totalHoursDecimal = hours + minutes / 60;
            const rate = getEffectiveHourlyRate(employee, month);

            let estimated;
            if (monthDate >= startConditionalDate && monthDate <= endConditionalDate) {
                estimated = Math.round(totalHoursDecimal * rate * 1.07 + comments);
            } else if (monthDate > endConditionalDate) {
                estimated = Math.round(totalHoursDecimal * rate * 1.07);
            } else {
                estimated = Math.round(totalHoursDecimal * rate * 1.07 + comments);
            }

            monthlyTableRows += `
                <tr>
                    <td>${monthLabel}</td>
                    <td>${employee}</td>
                    <td><input type="number" step="0.01" inputmode="decimal"
                        value="${rate.toFixed(2)}"
                        onchange="updateHourlyRate('${employee}', '${month}', this.value)"
                        style="width:70px; padding: 4px;"></td>
                    <td>${convertToHoursMinutes(totalHoursDecimal)}</td>
                    ${showComments ? `<td>${comments ? Math.round(comments) : ''}</td>` : ''}
                    <td>${estimated} ‚Ç¨</td>
                </tr>`;

            if (!globalEmployeeTotals[employee]) {
                globalEmployeeTotals[employee] = { hours: 0, minutes: 0, comments: 0, estimated: 0 };
            }
            globalEmployeeTotals[employee].hours += hours;
            globalEmployeeTotals[employee].minutes += minutes;
            globalEmployeeTotals[employee].comments += comments;
            globalEmployeeTotals[employee].estimated += estimated;

            monthHours += hours;
            monthMinutes += minutes;
            monthComments += comments;
            monthEstimated += estimated;
        });

        monthHours += Math.floor(monthMinutes / 60);
        monthMinutes %= 60;

        monthlyTableRows += `
    <tr style="font-weight: bold; background-color: #f0f0f0;">
        <td>Total ${monthLabel}</td><td></td><td></td>
        <td>${convertToHoursMinutes(monthHours + monthMinutes / 60)}</td>
        ${showComments ? `<td>${monthComments ? Math.round(monthComments) : ''}</td>` : ''}
        <td>${Math.round(monthEstimated)} ‚Ç¨</td>
    </tr>
    <tr style="height: 20px;"><td colspan="${showComments ? '6' : '5'}"></td></tr>`;

        grandTotalHours += monthHours;
        grandTotalMinutes += monthMinutes;
        grandTotalComments += monthComments;
        grandTotalEstimated += monthEstimated;

        // Enregistrement au bon format dans le localStorage
        personnelByMonthFinal[monthLabel] = Math.round(monthEstimated);
    });

    // Totaux globaux par employ√©
    Object.entries(globalEmployeeTotals).forEach(([employee, totals]) => {
        const totalDecimal = totals.hours + totals.minutes / 60;
        monthlyTableRows += `
            <tr style="font-style: italic; background-color: #e9e9e9;">
                <td>Total</td>
                <td>${employee}</td><td></td>
                <td>${convertToHoursMinutes(totalDecimal)}</td>
                ${showComments ? `<td>${totals.comments ? Math.round(totals.comments) : ''}</td>` : ''}
                <td>${Math.round(totals.estimated)} ‚Ç¨</td>
            </tr>`;
    });

    grandTotalHours += Math.floor(grandTotalMinutes / 60);
    grandTotalMinutes %= 60;

    monthlyTableRows += `
        <tr style="font-weight: bold; font-size: 16px; background-color: #f0f0f0;">
            <td>TOTAL</td><td></td><td></td>
            <td>${convertToHoursMinutes(grandTotalHours + grandTotalMinutes / 60)}</td>
            ${showComments ? `<td>${grandTotalComments ? Math.round(grandTotalComments) : ''}</td>` : ''}
            <td>${Math.round(grandTotalEstimated)}‚Ç¨</td>
        </tr>`;

    const monthlyTable = `
        <div style="margin-top: 20px;">
            <h3>R√©capitulatif Mensuel</h3>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Mois</th>
                        <th>Employ√©</th>
                        <th>Taux horaire</th>
                        <th>Total Heures</th>
                        ${showComments ? '<th>Total Commentaires</th>' : ''}
                        <th>Co√ªt salarial</th>
                    </tr>
                    ${monthlyTableRows}
                </table>
            </div>
        </div>`;

    const monthlyTableDiv = document.getElementById('monthlyTable');
    if (monthlyTableDiv) {
        monthlyTableDiv.innerHTML = monthlyTable;
    }

    localStorage.setItem("personnelTotalMensuel", JSON.stringify(personnelByMonthFinal));
}





            window.updateHourlyRate = function(employee, month, value) {
    const rate = parseFloat(value);
    if (!window.hourlyRatesHistory[employee]) {
        window.hourlyRatesHistory[employee] = {};
    }
    window.hourlyRatesHistory[employee][month] = !isNaN(rate) && rate >= 0 ? rate : 11.88;

    // üîΩ Sauvegarder dans le localStorage
    localStorage.setItem('hourlyRatesHistory', JSON.stringify(window.hourlyRatesHistory));

    updateMonthlyTable();
};


            const mainTable = `
                <div class="table-container">
                    <table>
                        <tr>
                            <th>Date</th><th>Employ√©</th><th>D√©but</th><th>Fin</th><th>Heures</th>
                            ${showComments ? '<th>Commentaire</th>' : ''}
                        </tr>
                        ${tableRows}
                    </table>
                </div>`;

            personnelList.innerHTML = `
                <h3>Activit√© du personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
                ${mainTable}
                <div id="monthlyTable"></div>`;

            updateMonthlyTable();
        }

        function showPersonnelDetailFromIndex(index) {
            const record = filteredPersonnelRecords[index];
            if (!record) {
                console.error("Erreur : Enregistrement non trouv√© pour l'index", index);
                return;
            }
            selectedPersonnelRecord = record;

            document.getElementById('personnelDetailDate').textContent = `Date : ${formatPersonnelDate(new Date(record.date))}`;
            document.getElementById('personnelDetailEmployee').textContent = `Employ√© : ${record.employee}`;
            document.getElementById('personnelDetailStartTime').textContent = `D√©but : ${record.startTime || ''}`;
            document.getElementById('personnelDetailEndTime').textContent = `Fin : ${record.endTime || ''}`;
            document.getElementById('personnelDetailHours').textContent = `Heures : ${formatHours(record.hours)}`;
            document.getElementById('personnelDetailComment').textContent = `Commentaire : ${record.comment || ''}`;

            const popup = document.getElementById('personnelDetailPopup');
            if (popup) {
                popup.classList.remove('hidden');
            } else {
                console.error("Erreur : L'√©l√©ment 'personnelDetailPopup' n'existe pas.");
            }
        }

        function closePersonnelDetail() {
            const popup = document.getElementById('personnelDetailPopup');
            if (popup) {
                popup.classList.add('hidden');
            }
            selectedPersonnelRecord = null;
        }

        function deleteSelectedPersonnel() {
            if (selectedPersonnelRecord) {
                if (confirm("Supprimer cet enregistrement ?")) {
                    const idx = personnelRecords.findIndex(p =>
                        p.date === selectedPersonnelRecord.date &&
                        p.employee === selectedPersonnelRecord.employee &&
                        p.hours === selectedPersonnelRecord.hours
                    );

                    if (idx !== -1) {
                        personnelRecords.splice(idx, 1);
                        localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
                        closePersonnelDetail();
                        filterPersonnel();
                        alert("Enregistrement supprim√© !");
                    }
                }
            }
        }

        // Initialize the table on page load
        window.onload = filterPersonnel;
    


// Fonction utilitaire pour formater les heures
function formatHours(hours) {
    const totalMinutes = Math.round(hours * 60); // Convertir en minutes et arrondir
    const h = Math.floor(totalMinutes / 60);
    const min = totalMinutes % 60;
    if (min === 0) {
        return `${h}h`;
    }
    return `${h}h${min.toString().padStart(2, '0')}min`;
}

function printPersonnel() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Erreur : La biblioth√®que jsPDF n'est pas charg√©e.");
        return;
    }
    if (!personnelRecords || !Array.isArray(personnelRecords)) {
        alert("Erreur : Les donn√©es du personnel ne sont pas disponibles.");
        return;
    }

    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    const showComments = document.getElementById('showComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("Erreur : Dates invalides.");
        return;
    }

    // Generate all dates in the range
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d));
    }

    const filteredRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (allDates.length === 0) {
        alert("Aucune donn√©e du personnel √† imprimer.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = showComments ? [28, 38, 28, 28, 28, 38] : [28, 38, 28, 28, 28];
    const rowHeight = 10;
    const tableX = margin;
    const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

    doc.setFontSize(12);
    doc.text(`Chez Barth-Activit√© du personnel du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employ√©', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('D√©but', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    if (showComments) {
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
        doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    }
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    allDates.forEach(date => {
        const dateStr = `${dayAbbreviations[date.getDay()]} ${date.toLocaleDateString('fr-FR')}`;
        const recordsForDate = filteredRecords.filter(record => new Date(record.date).toDateString() === date.toDateString());

        if (y > doc.internal.pageSize.getHeight() - margin - 40) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Activit√© du personnel du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employ√©', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('D√©but', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            if (showComments) {
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
                doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            }
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }

        if (recordsForDate.length === 0) {
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            if (showComments) {
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
                doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            }
            y += rowHeight;
        } else {
            recordsForDate.forEach(record => {
                const hourLabel = record.employee && record.employee.trim() !== '' 
                    ? `${Math.floor(record.hours)}h${Math.round((record.hours - Math.floor(record.hours)) * 60).toString().padStart(2, '0')}` 
                    : '';
                doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
                doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(record.employee || '', tableX + colWidths[0] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(record.startTime, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(record.endTime, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
                if (showComments) {
                    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
                    doc.text(record.comment || '', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
                }
                y += rowHeight;
            });
        }
    });

    y += 5;
    if (y > doc.internal.pageSize.getHeight() - margin - 40) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    const totals = {};
    const commentTotals = {};
    filteredRecords.forEach(record => {
        if (record.employee && record.employee.trim() !== '') {
            if (!totals[record.employee]) totals[record.employee] = 0;
            if (!commentTotals[record.employee]) commentTotals[record.employee] = 0;
            totals[record.employee] += record.hours;
            if (showComments && record.comment && !isNaN(parseFloat(record.comment))) commentTotals[record.employee] += parseFloat(record.comment);
        }
    });
    const totalHours = Object.values(totals).reduce((sum, hours) => sum + hours, 0);
    const totalComments = Object.values(commentTotals).reduce((sum, comments) => sum + comments, 0);

    Object.keys(totals).forEach(employee => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
        }
        const hours = Math.floor(totals[employee]);
        const minutes = Math.round((totals[employee] - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(`Total ${employee}`, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
            doc.text(`${commentTotals[employee].toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        }
        y += rowHeight;
    });

    if (Object.keys(totals).length > 0) {
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total G√©n√©ral', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
            doc.text(`${totalComments.toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        }
    }

    window.open(doc.output('bloburl'), '_blank');
}

function downloadPersonnelPDF() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Erreur : La biblioth√®que jsPDF n'est pas charg√©e.");
        return;
    }
    if (!personnelRecords || !Array.isArray(personnelRecords)) {
        alert("Erreur : Les donn√©es du personnel ne sont pas disponibles.");
        return;
    }

    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    const showComments = document.getElementById('showComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("Erreur : Dates invalides.");
        return;
    }

    // Generate all dates in the range
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d));
    }

    const filteredRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (allDates.length === 0) {
        alert("Aucune donn√©e du personnel √† t√©l√©charger.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = showComments ? [28, 38, 28, 28, 28, 38] : [28, 38, 28, 28, 28];
    const rowHeight = 10;
    const tableX = margin;
    const dayAbbreviations = ['D', 'L', 'M', 'Me', 'J', 'V', 'S'];

    doc.setFontSize(12);
    doc.text(`Chez Barth-Activit√© du personnel du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employ√©', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('D√©but', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    if (showComments) {
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
        doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    }
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    allDates.forEach(date => {
        const dateStr = `${dayAbbreviations[date.getDay()]} ${date.toLocaleDateString('fr-FR')}`;
        const recordsForDate = filteredRecords.filter(record => new Date(record.date).toDateString() === date.toDateString());

        if (y > doc.internal.pageSize.getHeight() - margin - 40) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Activit√© du personnel du ${dayAbbreviations[startDate.getDay()]} ${startDate.toLocaleDateString('fr-FR')} au ${dayAbbreviations[endDate.getDay()]} ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employ√©', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('D√©but', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            if (showComments) {
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
                doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            }
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }

        if (recordsForDate.length === 0) {
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            if (showComments) {
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
                doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            }
            y += rowHeight;
        } else {
            recordsForDate.forEach(record => {
                const hourLabel = record.employee && record.employee.trim() !== '' 
                    ? `${Math.floor(record.hours)}h${Math.round((record.hours - Math.floor(record.hours)) * 60).toString().padStart(2, '0')}` 
                    : '';
                doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
                doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(record.employee || '', tableX + colWidths[0] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(record.startTime, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(record.endTime, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
                doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
                if (showComments) {
                    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
                    doc.text(record.comment || '', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
                }
                y += rowHeight;
            });
        }
    });

    y += 5;
    if (y > doc.internal.pageSize.getHeight() - margin - 40) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    const totals = {};
    const commentTotals = {};
    filteredRecords.forEach(record => {
        if (record.employee && record.employee.trim() !== '') {
            if (!totals[record.employee]) totals[record.employee] = 0;
            if (!commentTotals[record.employee]) commentTotals[record.employee] = 0;
            totals[record.employee] += record.hours;
            if (showComments && record.comment && !isNaN(parseFloat(record.comment))) commentTotals[record.employee] += parseFloat(record.comment);
        }
    });
    const totalHours = Object.values(totals).reduce((sum, hours) => sum + hours, 0);
    const totalComments = Object.values(commentTotals).reduce((sum, comments) => sum + comments, 0);

    Object.keys(totals).forEach(employee => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
        }
        const hours = Math.floor(totals[employee]);
        const minutes = Math.round((totals[employee] - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(`Total ${employee}`, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
            doc.text(`${commentTotals[employee].toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        }
        y += rowHeight;
    });

    if (Object.keys(totals).length > 0) {
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total G√©n√©ral', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight);
            doc.text(`${totalComments.toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        }
    }

    const fileName = `Activit√©_du_personnel_Chez_Barth_${startDate.toLocaleDateString('fr-CA')}_au_${endDate.toLocaleDateString('fr-CA')}.pdf`;
    doc.save(fileName);

    setTimeout(() => {
        alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);
    }, 500);

 window.open(doc.output('bloburl'), '_blank');
}

async function printPersonnelToBluetooth() {
    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    });

    if (filteredRecords.length === 0) {
        alert("Aucune donn√©e du personnel √† imprimer.");
        return;
    }

    if (!navigator.bluetooth) {
        alert("Web Bluetooth API n'est pas disponible.");
        return;
    }

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        let text = "CHEZ BARTH\n16 place des Precheurs\n13100 Aix en Provence\n\n";
        text += `Personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}\n\n`;
        text += "-------------------------------\n";
        text += "Date   Employ√©   Heures\n";
        text += "-------------------------------\n";

        filteredRecords.forEach(record => {
            const dateStr = new Date(record.date).toLocaleDateString('fr-FR').substring(0, 5);
            const employeeStr = (record.employee || '').substring(0, 8).padEnd(8);
            const hourLabel = record.employee && record.employee.trim() !== '' 
                ? `${Math.floor(record.hours)}h${Math.round((record.hours - Math.floor(record.hours)) * 60).toString().padStart(2, '0')}` 
                : '';
            text += `${dateStr} ${employeeStr} ${hourLabel}\n`;
        });

        text += "-------------------------------\n";
        const totals = {};
        filteredRecords.forEach(record => {
            if (record.employee && record.employee.trim() !== '') {
                if (!totals[record.employee]) totals[record.employee] = 0;
                totals[record.employee] += record.hours;
            }
        });
        const totalHours = Object.values(totals).reduce((sum, hours) => sum + hours, 0);

        for (const employee in totals) {
            const hours = Math.floor(totals[employee]);
            const minutes = Math.round((totals[employee] - hours) * 60);
            const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
            text += `Total ${employee}: ${hourLabel}\n`;
        }

        if (Object.keys(totals).length > 0) {
            const hours = Math.floor(totalHours);
            const minutes = Math.round((totalHours - hours) * 60);
            const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
            text += `Total G√©n√©ral: ${hourLabel}\n`;
        }

        text += "\nBilan du personnel termin√© !\n\n";

        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\x1B\x64\x02\x1D\x56\x00');
        await characteristic.writeValue(data);

        alert("Impression Bluetooth r√©ussie !");
        server.disconnect();
    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de l'impression Bluetooth : " + error.message);
    }
}

// Gestion des clics hors dropdown
window.onclick = function(event) {
    if (!event.target.matches('.dropdown button')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
}



// D√©sactiver le pull to refresh
document.addEventListener('touchstart', function(e) {
    // Stocker la position initiale du toucher
    window.touchStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchmove', function(e) {
    const touchY = e.touches[0].clientY;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;

    // Si on est en haut de la page et qu'on tire vers le bas
    if (scrollTop === 0 && touchY > window.touchStartY) {
        e.preventDefault(); // Emp√™che le comportement par d√©faut (refresh)
    }
}, { passive: false }); // "passive: false" est n√©cessaire pour que preventDefault fonctionne

// Initialisation
updatePersonnelDisplay();

// Red√©finir les fonctions de navigation existantes
function backToHome() { navigateTo('homePage'); }
function backToRecipeBook() { navigateTo('recipeBookPage'); }
function backToPurchases() { navigateTo('purchasesPage'); }
function backToPersonnel() { navigateTo('personnelPage'); }
function backToInvoice() { navigateTo('invoicePage'); }
function backToInvoiceManagement() { navigateTo('invoiceManagementPage'); }
function showRecipeBook() { navigateTo('recipeBookPage'); }
function showPurchases() { navigateTo('purchasesPage'); }
function showPersonnel() { navigateTo('personnelPage'); }
function showInvoice() { navigateTo('invoicePage'); }
function showRecipeManagement() { navigateTo('recipeManagementPage'); }
function showPurchasesManagement() { navigateTo('purchasesManagementPage'); }
function showPersonnelManagement() { navigateTo('personnelManagementPage'); }
function showInvoiceManagement() { navigateTo('invoiceManagementPage'); }

// G√©rer le bouton "Retour" (Android et iOS via popstate)
window.addEventListener('popstate', function(event) {
    const pages = [
        'homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage',
        'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage',
        'purchasesManagementPage', 'personnelPage', 'personnelManagementPage',
        'passwordPage', 'budgetPage', 'settingsPage', 'indicatorsPage', 'fiscalPage' , 'bilanPage'
    ];

    const homePage = document.getElementById('homePage');

    if (event.state && event.state.page) {
        const currentPage = event.state.page;
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(currentPage).classList.remove('hidden');

        if (currentPage === 'recipeBookPage') updateRecipeDisplay();
        if (currentPage === 'purchasesPage') updatePurchaseDisplay();
        if (currentPage === 'personnelPage') updatePersonnelDisplay();
        if (currentPage === 'recipeManagementPage') filterRecipes();
        if (currentPage === 'invoiceManagementPage') filterInvoices();
        if (currentPage === 'purchasesManagementPage') filterPurchases();
        if (currentPage === 'personnelManagementPage') filterPersonnel();
        if (currentPage === 'fiscalPage') displayFiscalTable();
        if (currentPage === 'bilanPage') displayBilan();

        if (currentPage === 'homePage') {
            history.replaceState(null, '', '#');
        }
    } else {
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        homePage.classList.remove('hidden');
        history.replaceState(null, '', '#');
    }
});

function showIndicators() {
    const pages = ['homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 'purchasesManagementPage', 'personnelPage', 'personnelManagementPage', 'passwordPage', 'budgetPage', 'settingsPage', 'indicatorsPage' , 'fiscalPage' , 'bilanPage'];
    pages.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('indicatorsPage').classList.remove('hidden');
    displayIndicatorsTable();
    history.pushState({ page: 'indicatorsPage' }, '', '#indicators');
}


function displayIndicatorsTable() {
    try {
        const tableContainer = document.getElementById('indicatorsTable');
        const startInput = document.getElementById('indicatorsStartDate');
        const endInput = document.getElementById('indicatorsEndDate');
        if (!tableContainer || !startInput || !endInput) {
            console.error('√âl√©ments HTML manquants pour displayIndicatorsTable');
            if (tableContainer) {
                tableContainer.innerHTML = '<p>Erreur : √âl√©ments de la page introuvables.</p>';
            }
            return;
        }
        if (!startInput.value) {
            const defaultStartDate = new Date('2024-12-01');
            startInput.value = defaultStartDate.toISOString().split('T')[0];
        }
        if (!endInput.value) {
            const defaultEndDate = new Date();
            endInput.value = defaultEndDate.toISOString().split('T')[0];
        }
        const updateTable = () => {
            displayIndicatorsTable();
        };
        startInput.removeEventListener('input', updateTable);
        endInput.removeEventListener('input', updateTable);
        startInput.addEventListener('input', updateTable);
        endInput.addEventListener('input', updateTable);
        if (!salesData) {
            console.error('salesData non d√©fini');
            tableContainer.innerHTML = '<p>Erreur : Donn√©es de ventes non disponibles.</p>';
            return;
        }
        const start = startInput.value;
        const end = endInput.value;
        const startDate = start ? new Date(start) : new Date('2024-12-01');
        const endDate = end ? new Date(end) : new Date();
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            console.error('Dates invalides ou incoh√©rentes');
            tableContainer.innerHTML = '<p>Erreur : Dates invalides.</p>';
            return;
        }
        let purchases = [];
        try {
            const storedPurchases = localStorage.getItem('purchases');
            if (storedPurchases && storedPurchases !== '[]') {
                purchases = JSON.parse(storedPurchases).map(p => ({ ...p, date: p.date.split('T')[0] }));
            }
        } catch (e) {
            console.error('Erreur lors du chargement des achats:', e);
            tableContainer.innerHTML = '<p>Erreur lors du chargement des achats.</p>';
            return;
        }
        const monthlyPurchaseData = {};
        purchases.forEach(p => {
            const date = new Date(p.date);
            date.setHours(0, 0, 0, 0);
            if (date < startDate || date > endDate) return;
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyPurchaseData[key]) {
                monthlyPurchaseData[key] = { Pain: 0, Alimentaire: 0, joursPain: new Set() };
            }
            if (p.type === 'Pain') monthlyPurchaseData[key].Pain += p.amountTTC;
            if (p.type === 'Alimentaire') monthlyPurchaseData[key].Alimentaire += p.amountTTC;
            if (p.type === 'Pain') monthlyPurchaseData[key].joursPain.add(p.date);
        });
        const monthlySalesData = {};
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;
            if (salesData[dateKey]) {
                const monthKey = `${year}-${month}`;
                if (!monthlySalesData[monthKey]) {
                    monthlySalesData[monthKey] = { total: 0, card: 0, cash: 0, activeDays: 0 };
                }
                monthlySalesData[monthKey].total += salesData[dateKey].total;
                monthlySalesData[monthKey].card += salesData[dateKey].card;
                monthlySalesData[monthKey].cash += salesData[dateKey].cash;
                monthlySalesData[monthKey].activeDays += 1;
            }
        }
        let tableHTML = `
            <h3>Indicateurs du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
            <table>
                <thead>
                    <tr>
                        <th>Mois</th>
                        <th>Co√ªt de revient Panier Moyen</th>
                        <th>Prix de vente Panier Moy</th>
                        <th>Coef de vente (objectif 3)</th>
                    </tr>
                </thead>
                <tbody>
        `;
        const currentDate = new Date();
        const currentYearMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        const isAfter15th = currentDate.getDate() >= 15;
        const chartLabels = [];
        const coefVenteData = [];
        const coutReviensData = [];
        const prixVenteData = [];
        const margeBruteData = [];
        const caMensuelData = [];
        const caParJourData = [];
        const cashRateData = [];
        Object.keys(monthlyPurchaseData).sort().forEach(key => {
            if (key === currentYearMonth && !isAfter15th) return;
            const [year, month] = key.split('-');
            const moisNom = new Date(`${key}-01`).toLocaleDateString('fr-FR', { month: 'long' });
            const moisNomCourt = new Date(`${key}-01`).toLocaleDateString('fr-FR', { month: 'short' });
            const joursTravailles = monthlySalesData[key]?.activeDays || 0;
            const facteur = (month === '12' && year === '2024') || (['01', '02'].includes(month) && year === '2025') ? 0.7 : 0.56;
            const coef = (month === '12' && year === '2024') ? 0.95 :
                             (month === '01' && year === '2025') ? 0.96 :
                             (month === '02' && year === '2025') ? 0.90 :
                             (month === '03' && year === '2025') ? 0.85 :
                             (month === '04' && year === '2025') ? 0.85 :
                             (month === '05' && year === '2025') ? 0.80 :
                             (month === '06' && year === '2025') ? 0.90 :
                             (month === '07' && year === '2025') ? 0.62 :
                             (month === '08' && year === '2025') ? 0.87 :
                             (month === '09' && year === '2025') ? 0.6 : 0.92;
                           
            let panierJour = 0;
            if (joursTravailles > 0) {
                panierJour = monthlyPurchaseData[key].Pain * coef / (joursTravailles * facteur);
            }
            const totalAlimentaireArrondi = Math.round(monthlyPurchaseData[key].Alimentaire);
            const totalPainArrondi = Math.round(monthlyPurchaseData[key].Pain);
            const panierJourArrondi = Math.round(panierJour);
            let coutReviensPanierJour = 0;
            const denominateur = joursTravailles * panierJourArrondi;
            if (denominateur > 0) {
                coutReviensPanierJour = (totalAlimentaireArrondi + totalPainArrondi) / denominateur;
            }
            const ca = monthlySalesData[key]?.total || 0;
            const caParJour = joursTravailles > 0 ? Math.round(ca / joursTravailles) : 0;
            const prixPanierJour = (joursTravailles > 0 && panierJourArrondi > 0) ? (caParJour / panierJourArrondi) : 0;
            const coefVente = prixPanierJour > 0 && coutReviensPanierJour > 0 ? (prixPanierJour / coutReviensPanierJour).toFixed(1) : 0;
            const margeBrute = prixPanierJour > 0 && coutReviensPanierJour > 0 ? (prixPanierJour - coutReviensPanierJour) : 0;
            const cashRate = ca > 0 ? Math.round(monthlySalesData[key].cash / ca * 100) : 0;
            let coefClass = '';
            if (coefVente < 2.3) coefClass = 'coef-low';
            else if (coefVente >= 2.3 && coefVente <= 2.6) coefClass = 'coef-medium';
            else if (coefVente > 2.6 && coefVente <= 3) coefClass = 'coef-high';
            else if (coefVente > 3) coefClass = 'coef-champagne';
            tableHTML += `
                <tr>
                    <td>${moisNom.charAt(0).toUpperCase() + moisNom.slice(1)} ${year}</td>
                    <td>${coutReviensPanierJour.toFixed(2)} ‚Ç¨</td>
                    <td>${prixPanierJour.toFixed(2)} ‚Ç¨</td>
                    <td class="${coefClass}"><strong>${coefVente}</strong></td>
                </tr>
            `;
            chartLabels.push(`${moisNomCourt} ${year}`);
            coefVenteData.push(parseFloat(coefVente));
            coutReviensData.push(Number(coutReviensPanierJour.toFixed(2)));
            prixVenteData.push(Number(prixPanierJour.toFixed(2)));
            margeBruteData.push(Number(margeBrute.toFixed(2)));
            caMensuelData.push(Math.round(ca));
            caParJourData.push(caParJour);
            cashRateData.push(cashRate);
        });
        tableHTML += `
                </tbody>
            </table>
        `;
        tableContainer.innerHTML = tableHTML;
        const joursSemaine = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        const caParJourSemaine = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;
            const dayIndex = d.getDay() === 0 ? 6 : d.getDay() - 1;
            if (salesData[dateKey]) {
                caParJourSemaine[dayIndex].total += salesData[dateKey].total;
                caParJourSemaine[dayIndex].count += 1;
            }
        }
        const weekdayCaData = caParJourSemaine.map(day => day.count > 0 ? Math.round(day.total / day.count) : 0);
        const createChart = (canvasId, label, data, yAxisTitle, yMin, yMax, color, type = 'line', labels = chartLabels) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`Canvas ${canvasId} non trouv√©, graphique non affich√©`);
                return;
            }
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) existingChart.destroy();
            let wrapper = canvas.parentElement;
            if (!wrapper.classList.contains('chart-wrapper')) {
                wrapper = document.createElement('div');
                wrapper.className = 'chart-wrapper';
                wrapper.style.width = '100%';
                wrapper.style.overflowX = 'auto';
                wrapper.style.overflowY = 'hidden';
                canvas.parentNode.insertBefore(wrapper, canvas);
                wrapper.appendChild(canvas);
            }
            const minWidthPerLabel = type === 'bar' ? 80 : 60;
            const chartWidth = Math.max(400, labels.length * minWidthPerLabel);
            canvas.setAttribute('width', chartWidth);
            canvas.setAttribute('height', 400);
            canvas.style.width = `${chartWidth}px`;
            canvas.style.height = '400px';
            const ctx = canvas.getContext('2d');
            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: type === 'bar' ? color : `${color}33`,
                        fill: type === 'line' ? false : true,
                        tension: type === 'line' ? 0 : undefined,
                        pointBackgroundColor: type === 'line' ? color : undefined,
                        pointBorderColor: type === 'line' ? color : undefined,
                        pointRadius: type === 'line' ? 5 : undefined
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 5
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: type === 'bar' ? true : false,
                            min: yMin,
                            max: yMax,
                            ticks: {
                                stepSize: canvasId === 'coefVenteChart' ? 0.5 : undefined
                            },
                            title: {
                                display: true,
                                text: yAxisTitle
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: canvasId === 'weekdayCaChart' ? 'Jour de la semaine' : 'Mois'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        },
                        datalabels: {
                            display: true,
                            align: 'top',
                            offset: 5,
                            formatter: (value) => {
                                if (canvasId === 'coefVenteChart') return `${value.toFixed(1)}`;
                                if (canvasId === 'caMensuelChart' || canvasId === 'caParJourChart' || canvasId === 'weekdayCaChart') return `${Math.round(value)}‚Ç¨`;
                                if (canvasId === 'cashRateChart') return `${Math.round(value)}%`;
                                return `${value.toFixed(2)}‚Ç¨`;
                            },
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: '#000'
                        }
                    }
                },
                plugins: [{
                    id: 'chartjs-plugin-datalabels',
                    afterDatasetsDraw: (chart) => {
                        const { ctx } = chart;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((point, index) => {
                                const value = dataset.data[index];
                                ctx.save();
                                ctx.font = 'bold 12px Arial';
                                ctx.fillStyle = '#000';
                                ctx.textAlign = 'center';
                                let label;
                                if (canvasId === 'coefVenteChart') {
                                    label = `${value.toFixed(1)}`;
                                } else if (canvasId === 'caMensuelChart' || canvasId === 'caParJourChart' || canvasId === 'weekdayCaChart') {
                                    label = `${Math.round(value)}‚Ç¨`;
                                } else if (canvasId === 'cashRateChart') {
                                    label = `${Math.round(value)}%`;
                                } else {
                                    label = `${value.toFixed(2)}‚Ç¨`;
                                }
                                if (canvasId === 'caMensuelChart') {
                                    ctx.translate(point.x, point.y - 15); // Increased offset to -15 for more space
                                    ctx.rotate(-45 * Math.PI / 180); // Rotate -45 degrees for diagonal upward
                                    ctx.fillText(label, 0, 0);
                                } else {
                                    ctx.fillText(label, point.x, point.y - 10);
                                }
                                ctx.restore();
                            });
                        });
                    }
                }]
            };
            if (canvasId === 'coefVenteChart') {
                config.plugins.push({
                    id: 'backgroundZones',
                    beforeDraw: (chart) => {
                        const { ctx, chartArea, scales } = chart;
                        const { top, bottom } = chartArea;
                        const { y } = scales;
                        ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                        ctx.fillRect(chartArea.left, y.getPixelForValue(2.2), chartArea.right - chartArea.left, bottom - y.getPixelForValue(2.2));
                        ctx.fillStyle = 'rgba(255, 165, 0, 0.3)';
                        ctx.fillRect(chartArea.left, y.getPixelForValue(2.5), chartArea.right - chartArea.left, y.getPixelForValue(2.2) - y.getPixelForValue(2.5));
                        ctx.fillStyle = 'rgba(0, 128, 0, 0.3)';
                        ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, y.getPixelForValue(2.5) - top);
                    }
                });
            }
            new Chart(ctx, config);
        };
        createChart('coefVenteChart', 'Coefficient de vente', coefVenteData, 'Coefficient de vente', 2, 4, '#0000FF', 'line');
        createChart('coutReviensChart', 'Co√ªt de revient Panier Moyen', coutReviensData, 'Co√ªt de revient (‚Ç¨)', 3, 6, '#000000', 'line');
        createChart('prixVenteChart', 'Prix de vente Panier Moyen', prixVenteData, 'Prix de vente (‚Ç¨)', 8, 13, '#800080', 'line');
        createChart('margeBruteChart', 'Marge Brute Panier Moyen', margeBruteData, 'Marge Brute (‚Ç¨)', 4, 9, '#8B4513', 'line');
        createChart('caMensuelChart', 'Chiffre d\'affaire mensuel', caMensuelData, 'Chiffre d\'affaire (‚Ç¨)', 0, 30000, '#000066', 'bar');
        createChart('caParJourChart', 'Ventes par jour en moyenne', caParJourData, 'Ventes par jour (‚Ç¨)', 0, 1600, '#006600', 'bar');
        createChart('weekdayCaChart', 'CA moyen des jours de semaine', weekdayCaData, 'CA moyen (‚Ç¨)', 0, 1200, '#C71585', 'bar', joursSemaine);
        createChart('cashRateChart', 'Taux de cash', cashRateData, 'Taux de cash (%)', 10, 40, '#FF4500', 'line');
    } catch (error) {
        console.error('Erreur dans displayIndicatorsTable:', error);
        const tableContainer = document.getElementById('indicatorsTable');
        if (tableContainer) {
            tableContainer.innerHTML = '<p>Erreur lors du chargement des indicateurs. V√©rifiez la console pour plus de d√©tails.</p>';
        }
    }
}




function showFiscal() {
    const pages = ['homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 'purchasesManagementPage', 'personnelPage', 'personnelManagementPage', 'passwordPage', 'budgetPage', 'settingsPage', 'indicatorsPage', 'fiscalPage' , 'bilanPage'];
    pages.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('fiscalPage').classList.remove('hidden');
    displayFiscalTable();
    history.pushState({ page: 'fiscalPage' }, '', '#fiscal');
}

function displayFiscalTable() {
    try {
        const tableContainer = document.getElementById('fiscalTable');
        const startInput = document.getElementById('fiscalStartDate');
        const endInput = document.getElementById('fiscalEndDate');
        if (!tableContainer || !startInput || !endInput) {
            console.error('√âl√©ments fiscalTable, fiscalStartDate ou fiscalEndDate non trouv√©s');
            tableContainer.innerHTML = '<p>Erreur : √âl√©ments de la page introuvables.</p>';
            return;
        }

        // Charger les donn√©es (inchang√©)
        let salesData = {};
        let purchases = [];
        let invoices = [];
        try {
            salesData = JSON.parse(localStorage.getItem('salesData')) || {};
            purchases = JSON.parse(localStorage.getItem('purchases')) || [];
            invoices = JSON.parse(localStorage.getItem('savedInvoices')) || [];
        } catch (e) {
            console.error('Erreur lors du chargement des donn√©es:', e);
            tableContainer.innerHTML = '<p>Erreur lors du chargement des donn√©es.</p>';
            return;
        }

        // Param√®tres fiscaux (inchang√©)
        const today = new Date();
        const urssafCutoffDate = new Date('2025-10-01');
        const tvaRate = parseFloat(document.getElementById('tva')?.value || 10) / 100;

        // Set end date to today in DD/MM/YYYY format (inchang√©)
        const todayFormatted = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        endInput.value = endInput.value || todayFormatted;

        // Dates de filtrage (inchang√©)
        const start = startInput.value;
        const end = endInput.value;

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        };

        const startDate = start ? parseDate(start) : parseDate('09/12/2024');
        const endDate = end ? parseDate(end) : today;

        if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
            tableContainer.innerHTML = '<p>Erreur : Dates invalides.</p>';
            alert('La date de d√©but doit √™tre ant√©rieure √† la date de fin.');
            return;
        }

        // Agr√©ger les donn√©es par mois (inchang√© pour sales)
        const monthlyData = {};
        Object.keys(salesData).forEach(dateKey => {
            const date = new Date(dateKey);
            if (date >= startDate && date <= endDate) {
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[key]) {
                    monthlyData[key] = { 
                        caTTC: 0,  
                        caHT: 0,   
                        tvaCollectee: 0, 
                        tvaDeductible: 0, 
                        achatsHT_5_5: 0, 
                        tvaDed_5_5: 0, 
                        achatsHT_20: 0, 
                        tvaDed_20: 0, 
                        purchases: [], 
                        days: 0 
                    };
                }
                monthlyData[key].caTTC += (salesData[dateKey].card || 0) + (salesData[dateKey].cash || 0) / 2;  
                monthlyData[key].days += 1;
            }
        });

        // Achats (TVA d√©ductible) : inchang√©
        purchases.forEach(p => {
            const date = new Date(p.date);
            if (date >= startDate && date <= endDate) {
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[key]) {
                    monthlyData[key] = { 
                        caTTC: 0, 
                        caHT: 0, 
                        tvaCollectee: 0, 
                        tvaDeductible: 0, 
                        achatsHT_5_5: 0, 
                        tvaDed_5_5: 0, 
                        achatsHT_20: 0, 
                        tvaDed_20: 0, 
                        purchases: [], 
                        days: 0 
                    };
                }
                monthlyData[key].purchases.push(p);

                if (p.type === 'Pain' || p.type === 'Alimentaire') {
                    const ht = p.amountTTC / 1.055;
                    const tva = ht * 0.055;
                    monthlyData[key].achatsHT_5_5 += ht;
                    monthlyData[key].tvaDed_5_5 += tva;
                } else {
                    const ht = p.amountTTC / 1.2;
                    const tva = ht * 0.2;
                    monthlyData[key].achatsHT_20 += ht;
                    monthlyData[key].tvaDed_20 += tva;
                }

                monthlyData[key].tvaDeductible = monthlyData[key].tvaDed_5_5 + monthlyData[key].tvaDed_20;
            }
        });

        // Calcul du CA HT bas√© sur le cumul du CA TTC (inchang√©)
        let cumulativeCATTC = 0;
        const sortedKeys = Object.keys(monthlyData).sort();
        sortedKeys.forEach(key => {
            cumulativeCATTC += monthlyData[key].caTTC;
            if (cumulativeCATTC <= 101000) {
                monthlyData[key].caHT = monthlyData[key].caTTC;  
            } else {
                monthlyData[key].caHT = monthlyData[key].caTTC / (1 + tvaRate);  
            }
        });

        // Calcul du cumul CA HT pour la coloration
        let cumulativeCAHT = 0;
        sortedKeys.forEach(key => {
            cumulativeCAHT += monthlyData[key].caHT;
            monthlyData[key].cumulCAHT = cumulativeCAHT;  // Stocker pour utilisation dans l'affichage
        });

        // TVA collect√©e corrig√©e : 0.1 * CA HT (tvaRate * caHT)
        Object.keys(monthlyData).forEach(key => {
            monthlyData[key].tvaCollectee = monthlyData[key].caHT * tvaRate;
        });

let tableHTML = `
    <style>
        /* ‚úÖ Tout le style fiscal est maintenant isol√© dans #fiscalTableContainer */

        #fiscalTableContainer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }

        #fiscalTableContainer h3 {
            text-align: center;
            margin-bottom: 10px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        #fiscalTableContainer .table-container {
            width: 100%;
            overflow-x: auto; /* ‚úÖ Scroll horizontal si n√©cessaire */
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
            padding: 0 5px; /* √©vite les coupures sur les bords */
        }

        #fiscalTableContainer table {
            border-collapse: collapse;
            margin: 0 auto;
            width: 100%;
            max-width: 100%;
            text-align: center;
            box-sizing: border-box;
        }

        #fiscalTableContainer th,
        #fiscalTableContainer td {
            padding: 6px;
            border: 1px solid #ccc;
            text-align: center;
        }

        #fiscalTableContainer th {
            white-space: nowrap; /* ‚úÖ garde lisible les ent√™tes sans casser la mise en page */
        }

        /* ‚úÖ Colonne "Mois" fig√©e */
        #fiscalTableContainer td:first-child,
        #fiscalTableContainer th:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2; /* s‚Äôassure qu‚Äôelle reste au-dessus des autres colonnes */
            box-shadow: 2px 0 2px rgba(0,0,0,0.1); /* petite ombre pour la lisibilit√© */
        }
    </style>

    <div id="fiscalTableContainer">
        <h4>du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Mois</th>
                        <th>CA TTC</th>  
                        <th>CA HT √† d√©clarer</th>
                        <th style="background-color: #FF6666;">Imp√¥ts et Urssaf √† payer</th>
                        <th>Achats HT √† TVA 20%</th>
                        <th>TVA d√©ductible 20%</th>
                        <th>Achats HT √† TVA 5.5%</th>
                        <th>TVA d√©ductible 5.5%</th>
                        <th>TVA collect√©e</th>
                        <th>TVA d√©ductible</th>
                        <th style="background-color: #FF6666;">TVA √† payer</th>
                    </tr>
                </thead>
                <tbody>
`;





        sortedKeys.forEach(key => {
            const [year, month] = key.split('-');
            const moisDate = new Date(`${key}-01`);
            const moisNom = moisDate.toLocaleDateString('fr-FR', { month: 'long' });
            const caTTC = Math.round(monthlyData[key].caTTC);
            const caHT = Math.round(monthlyData[key].caHT);

            // URSSAF : bas√© sur CA HT (inchang√©)
            const urssafRateForMonth = moisDate < urssafCutoffDate ? 0.075 : 0.13715;
            const urssaf = Math.round(caHT * urssafRateForMonth);

            const achatsHT_20 = Math.round(monthlyData[key].achatsHT_20);
            const tvaDed_20 = Math.round(monthlyData[key].tvaDed_20);
            const achatsHT_5_5 = Math.round(monthlyData[key].achatsHT_5_5);
            const tvaDed_5_5 = Math.round(monthlyData[key].tvaDed_5_5);

            const tvaCollectee = Math.round(monthlyData[key].tvaCollectee);
            const tvaDeductible = Math.round(monthlyData[key].tvaDeductible);
            const tvaAPayer = Math.round(tvaCollectee - tvaDeductible);

            // Coloration pour TVA √† payer
            const isBelowThreshold = monthlyData[key].cumulCAHT < 101000;
            const tvaPayerBgColor = isBelowThreshold ? 'gray' : '#FF6666';

            tableHTML += `
                <tr>
                    <td>${moisNom.charAt(0).toUpperCase() + moisNom.slice(1)} ${year}</td>
                    <td>${caTTC}‚Ç¨</td>
                    <td>${caHT}‚Ç¨</td>
                    <td style="background-color: #FF6666; font-weight: bold;">${urssaf}‚Ç¨</td>
                    <td>${achatsHT_20}‚Ç¨</td>
                    <td>${tvaDed_20}‚Ç¨</td>
                    <td>${achatsHT_5_5}‚Ç¨</td>
                    <td>${tvaDed_5_5}‚Ç¨</td>
                    <td>${tvaCollectee}‚Ç¨</td>
                    <td>${tvaDeductible}‚Ç¨</td>
                    <td style="background-color: ${tvaPayerBgColor}; font-weight: bold;">${tvaAPayer}‚Ç¨</td>
                </tr>
            `;
        });

        tableHTML += `
                    </tbody>
                </table>
            </div>
        `;
        tableContainer.innerHTML = tableHTML;

    } catch (error) {
        console.error('Erreur dans displayFiscalTable:', error);
        const tableContainer = document.getElementById('fiscalTable');
        if (tableContainer) {
            tableContainer.innerHTML = '<p>Erreur lors du chargement des donn√©es fiscales. V√©rifiez la console pour plus de d√©tails.</p>';
        }
    }
}


function showBilan() {
    const pages = ['homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 'purchasesManagementPage', 'personnelPage', 'personnelManagementPage', 'passwordPage', 'budgetPage', 'settingsPage', 'indicatorsPage', 'fiscalPage', 'bilanPage'];
    pages.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('bilanPage').classList.remove('hidden');

    // ‚úÖ Affiche d'abord les donn√©es fiscales, puis le bilan
    displayFiscalTable();
    setTimeout(displayBilan, 100);

    history.pushState({ page: 'bilanPage' }, '', '#bilan');
}







function displayBilan() {
    const startInput = document.getElementById("bilanStartDate").value || "2024-12-09";
    let endInput = document.getElementById("bilanEndDate").value;
    if (!endInput) {
        const now = new Date();
        const parisOffsetMinutes = 120;
        const parisTime = new Date(now.getTime() + parisOffsetMinutes * 60000);
        endInput = parisTime.toISOString().split("T")[0];
        document.getElementById("bilanEndDate").value = endInput;
    }
    const startDate = new Date(startInput + "T00:00:00");
    const endDate = new Date(endInput + "T23:59:59");
    if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
        document.getElementById("bilanTable").innerHTML = "<p>Erreur : Dates invalides</p>";
        return;
    }
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDay = now.getDate();
    const showCurrentMonth = now.getDate() >= 25;
    const monthNames = ["janv", "f√©vr", "mars", "avr", "mai", "juin", "juil", "ao√ªt", "sept", "oct", "nov", "d√©c"];
    const getLabel = (date) => `${monthNames[date.getMonth()]}-${date.getFullYear().toString().slice(-2)}`;
    const monthLabels = [], monthKeys = [];
    let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    while (currentDate <= endDate) {
        const isCurrentMonth = currentDate.getFullYear() === currentYear && currentDate.getMonth() === currentMonth;
        if (!isCurrentMonth || (isCurrentMonth && showCurrentMonth)) {
            monthLabels.push(getLabel(currentDate));
            monthKeys.push(`${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, "0")}`);
        }
        currentDate.setMonth(currentDate.getMonth() + 1);
    }
    monthLabels.push("CUMUL");
    const defaultCharges = {
        "d√©c-24": 1925, "janv-25": 2372, "f√©vr-25": 1952,
        "mars-25": 1908, "avr-25": 2092, "mai-25": 2000
    };
    let chargesMensuelles = JSON.parse(localStorage.getItem("chargesMensuelles") || "{}");
    const sales = JSON.parse(localStorage.getItem("salesData") || "{}");
    const purchases = JSON.parse(localStorage.getItem("purchases") || "[]");
    const personnelMensuel = JSON.parse(localStorage.getItem("personnelTotalMensuel") || "{}");
    const lignes = {
        "Chiffre d'affaire TTC": [], "Achats": [], "Charges": [],
        "Personnel": [], "Imp√¥t et Urssaf": [], "TVA": [],
        "B√©n√©fice Net": [], "Rentabilit√© %": []
    };
    let totalCA = 0, totalNet = 0;
    const fiscalUrssafData = {}, fiscalTvaData = {};
    const tbl = document.getElementById("fiscalTable");
    if (tbl) {
        const monthMap = {
            janvier: "janv", f√©vrier: "f√©vr", mars: "mars", avril: "avr", mai: "mai",
            juin: "juin", juillet: "juil", ao√ªt: "ao√ªt", septembre: "sept",
            octobre: "oct", novembre: "nov", d√©cembre: "d√©c"
        };
        tbl.querySelectorAll("tr").forEach(row => {
            const c = row.querySelectorAll("td");
            if (c.length >= 11) {  // Adjusted for new column count (11 columns)
                const parts = c[0].innerText.trim().split(" ");
                const ml = parts[0].toLowerCase(), yy = parts[1]?.slice(-2);
                const lbl = ml in monthMap && yy ? `${monthMap[ml]}-${yy}` : null;
                if (!lbl) return;
                fiscalUrssafData[lbl] = parseInt(c[3].innerText.replace(/\D/g, "")) || 0;  // Changed from c[2] to c[3]
                fiscalTvaData[lbl] = c[10].style.backgroundColor === 'gray'  // Changed condition from .crossed to background gray
                    ? 0
                    : parseInt(c[10].innerText.replace(/\D/g, "")) || 0;  // Changed from c[5] to c[10]
            }
        });
    }
    monthLabels.slice(0, -1).forEach((lbl, i) => {
        const key = monthKeys[i];
        let ca = 0;
        for (const [d, val] of Object.entries(sales)) {
            if (d.startsWith(key)) ca += parseFloat(val.total || 0);
        }
        ca = Math.round(ca);
        totalCA += ca;
        lignes["Chiffre d'affaire TTC"].push(ca);
        let ach = 0;
        if (lbl === "d√©c-24") {
            ach = 2184;
        } else {
            ach = purchases.filter(p => p.date?.startsWith(key))
                .reduce((s, a) => s + (parseFloat(a.amountTTC) || 0), 0);
            ach = Math.round(ach);
        }
        lignes["Achats"].push(ach);
        let ch = chargesMensuelles[lbl];
        if (ch == null) {
            if (defaultCharges[lbl] != null) {
                ch = defaultCharges[lbl];
            } else {
                const [year, month] = key.split("-").map(Number);
                const daysInMonth = new Date(year, month, 0).getDate();
                if (year === currentYear && month === currentMonth + 1) {
                    // Mois en cours ‚Üí prorata sur jours √©coul√©s
                    ch = Math.round(2000 * (currentDay / daysInMonth));
                } else {
                    ch = 2000;
                }
            }
            chargesMensuelles[lbl] = ch;
        }
        lignes["Charges"].push(
            `<input type="number" value="${ch}" data-month="${lbl}" onchange="updateCharge(this)" style="width:50px;"> ‚Ç¨`
        );
        const pers = Math.round(personnelMensuel[lbl] || 0);
        lignes["Personnel"].push(pers);
        const ur = fiscalUrssafData[lbl] || 0;
        lignes["Imp√¥t et Urssaf"].push(ur);
        const tv = fiscalTvaData[lbl] || 0;
        lignes["TVA"].push(tv);
        const net = ca - ach - ch - pers - ur - tv;
        totalNet += net;
        lignes["B√©n√©fice Net"].push(net);
        lignes["Rentabilit√© %"].push(ca > 0 ? Math.round((net / ca) * 100) : 0);
    });
    const cumCharges = monthLabels.slice(0, -1).reduce((sum, lbl, i) => {
        const html = lignes["Charges"][i];
        return sum + (parseInt(html.match(/value="(\d+)"/)?.[1]) || 0);
    }, 0);
    lignes["Chiffre d'affaire TTC"].push(totalCA);
    lignes["Achats"].push(lignes["Achats"].reduce((a, b) => a + b, 0));
    lignes["Charges"].push(`${cumCharges} `);
    lignes["Personnel"].push(lignes["Personnel"].reduce((a, b) => a + b, 0));
    lignes["Imp√¥t et Urssaf"].push(lignes["Imp√¥t et Urssaf"].reduce((a, b) => a + b, 0));
    lignes["TVA"].push(lignes["TVA"].reduce((a, b) => a + b, 0));
    lignes["B√©n√©fice Net"].push(totalNet);
    lignes["Rentabilit√© %"].push(totalCA > 0 ? Math.round((totalNet / totalCA) * 100) : 0);
    localStorage.setItem("chargesMensuelles", JSON.stringify(chargesMensuelles));
    let html = `<div style="overflow-x:auto;"><table style="border-collapse:collapse;width:100%;"><thead><tr><th style="position:sticky;left:0;background:white;border:1px solid #ddd;"></th>`;
    monthLabels.forEach((m, i) => {
        const isCumul = m === "CUMUL" ? 'background-color:#f0f0f0;' : '';
        html += `<th style="border:1px solid #ddd;${isCumul}">${m}</th>`;
    });
    html += `</tr></thead><tbody>`;
    for (const [label, vals] of Object.entries(lignes)) {
        const bold = (label === "Chiffre d'affaire TTC" || label === "B√©n√©fice Net") ? "font-weight:bold;" : "";
        html += `<tr><td style="position:sticky;left:0;background:white;border:1px solid #ddd;${bold}">${label}</td>`;
        vals.forEach((val, i) => {
            let cell;
            if (typeof val === "string" && /</.test(val)) cell = val;
            else if (label === "Rentabilit√© %") cell = `${val}%`;
            else cell = `${val} ‚Ç¨`;
            const isCumul = i === vals.length - 1 ? 'background-color:#f0f0f0;' : '';
            html += `<td style="border:1px solid #ddd;text-align:center;${bold}${isCumul}">${cell}</td>`;
        });
        html += `</tr>`;
    }
    html += `</tbody></table></div>`;
    document.getElementById("bilanTable").innerHTML = html;
}

function updateCharge(input) {
    const lbl = input.dataset.month;
    const val = parseInt(input.value) || 0;
    const ch = JSON.parse(localStorage.getItem("chargesMensuelles") || "{}");
    ch[lbl] = val;
    localStorage.setItem("chargesMensuelles", JSON.stringify(ch));
    displayBilan();
}



// Mettre √† jour l'√©couteur popstate
window.addEventListener('popstate', function(event) {
    const pages = [
        'homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage',
        'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage',
        'purchasesManagementPage', 'personnelPage', 'personnelManagementPage',
        'passwordPage', 'budgetPage', 'settingsPage', 'indicatorsPage', 'fiscalPage' , 'bilanPage'
    ];

    const homePage = document.getElementById('homePage');

    if (event.state && event.state.page) {
        const currentPage = event.state.page;
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(currentPage).classList.remove('hidden');

        if (currentPage === 'recipeBookPage') updateRecipeDisplay();
        if (currentPage === 'purchasesPage') updatePurchaseDisplay();
        if (currentPage === 'personnelPage') updatePersonnelDisplay();
        if (currentPage === 'recipeManagementPage') filterRecipes();
        if (currentPage === 'invoiceManagementPage') filterInvoices();
        if (currentPage === 'purchasesManagementPage') filterPurchases();
        if (currentPage === 'personnelManagementPage') filterPersonnel();
        if (currentPage === 'fiscalPage') displayFiscalTable();
        if (currentPage === 'bilanPage') displayBilan();

        if (currentPage === 'homePage') {
            history.replaceState(null, '', '#');
        }
    } else {
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        homePage.classList.remove('hidden');
        history.replaceState(null, '', '#');
    }
});








// Fonction pour afficher la page Budget
function showBudget() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.add('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.add('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');
    document.getElementById('budgetPage').classList.remove('hidden');
    calculerResultat(); // Calculer les r√©sultats initiaux lors de l'affichage
}

// Fonction pour g√©rer la s√©lection des checkboxes
function toggleBudgetType() {
    var annee0 = document.getElementById('budgetAnnee0');
    var anneesSuivantes = document.getElementById('budgetAnneesSuivantes');
    var urssafInput = document.getElementById('urssaf');

    // Assurer qu'une seule case est coch√©e
    if (annee0.checked && anneesSuivantes.checked) {
        if (event.target.id === 'budgetAnnee0') {
            anneesSuivantes.checked = false;
        } else {
            annee0.checked = false;
        }
    }

    // Mettre √† jour le taux de cotisations sociales
    urssafInput.value = anneesSuivantes.checked ? 13.715 : 7.5;

    calculerResultat(); // Recalculer les r√©sultats
}

function calculerResultat() {
    // R√©cup√©ration des valeurs des inputs
    var prix = parseFloat(document.getElementById('prix').value);
    var cout = parseFloat(document.getElementById('cout').value);
    var panier = parseFloat(document.getElementById('panier').value);
    var jours = parseFloat(document.getElementById('jours').value);
    var semaines = parseFloat(document.getElementById('semaines').value);
    var loyerMensuel = parseFloat(document.getElementById('loyer').value);
    var charges = parseFloat(document.getElementById('charges').value);
    var externes = parseFloat(document.getElementById('externes').value);
    var salaire = parseFloat(document.getElementById('salaire').value);
    var patronales = parseFloat(document.getElementById('patronales').value) / 100;
    var urssaf = parseFloat(document.getElementById('urssaf').value) / 100;
    var tva = parseFloat(document.getElementById('tva').value) / 100;
    var apport = parseFloat(document.getElementById('apport').value);

    // Calcul du chiffre d'affaires annuel
    var chiffreAffaires = prix * panier * jours * semaines;

    // Calcul des charges fixes utilis√©es dans plusieurs calculs
    var loyerAnnuel = loyerMensuel * 12;
    var coutMatieres = cout * panier * jours * semaines;

    // Calcul de la TVA (condition selon le type de budget)
    var isAnneesSuivantes = document.getElementById('budgetAnneesSuivantes').checked;
    var tvaCalcul = isAnneesSuivantes ?
        chiffreAffaires * (
            (tva / (1 + tva)) - 
            (cout / prix) * (0.055 / (1 + 0.055)) - 
            ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))
        ) :
        (chiffreAffaires > 101000) ?
        (chiffreAffaires - 101000) * (
            (tva / (1 + tva)) - 
            (cout / prix) * (0.055 / (1 + 0.055)) - 
            ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))
        ) : 0;

    // Calcul des charges de personnel (salaire brut annuel + charges patronales)
    var chargesPersonnel = salaire * 12 * (1 + patronales);

    // Calcul des charges d'exploitation
    var chargesExploitation = loyerAnnuel + charges + chargesPersonnel + coutMatieres + externes;

    // Calcul des charges sociales et imp√¥ts
    var chargesUrssaf = chiffreAffaires * urssaf;

    // Calcul du b√©n√©fice net
    var beneficeNet = chiffreAffaires - (chargesExploitation + tvaCalcul + chargesUrssaf);

    // Calcul de l'amortissement annuel
    var amortissement = apport / 7;

    // Calcul du r√©sultat financier
    var resultatFinancier = beneficeNet - amortissement;

    // Calcul de la rentabilit√© √©conomique minimum (Nb ventes pour b√©n√©fice net > 0)
    var nbVentesEconomique = calculerRentabiliteMinimum('economique', prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva);

    // Calcul de la rentabilit√© financi√®re minimum (Nb ventes pour r√©sultat financier > 0)
    var nbVentesFinanciere = calculerRentabiliteMinimum('financiere', prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva);

    // Affichage des r√©sultats avec formatage et v√©rification des valeurs n√©gatives
    var resultat = document.getElementById('resultat');
    var beneficeNetClass = beneficeNet < 0 ? 'negative' : '';

    resultat.innerHTML = `
        <p><strong>RESULTATS</strong> (calcul√©s automatiquement) : </p>
        <p><strong>   </p>
        <h2 style="text-align: center;">COMPTE DE RESULTAT PREVISIONNEL</h2>
        <p><strong>   </p>
        <p><strong>* CHIFFRE D'AFFAIRES ANNUEL: ${chiffreAffaires.toFixed(0)} ‚Ç¨ (CA)</strong></p>

        <ul>
            <p>D√©tail charges annuelles d'exploitation:</p>
            <ul>
                <li style="font-weight: normal;">Loyer :  ${loyerAnnuel.toFixed(0)} ‚Ç¨</li>
                <li style="font-weight: normal;">Salaires et charges du personnel: ${chargesPersonnel.toFixed(0)} ‚Ç¨</li>
                <li style="font-weight: normal;">Achats alimentaires (Co√ªt de revient mati√®res): ${coutMatieres.toFixed(0)} ‚Ç¨</li>
                <li style="font-weight: normal;">Charges externes (compta, pub, banque...): ${externes.toFixed(0)} ‚Ç¨</li>
                <li style="font-weight: normal;">Charges √©lectricit√© gaz eau t√©l√©phone assurance: ${charges.toFixed(0)} ‚Ç¨</li>
            </ul>
        </ul>
        <p><strong>* Total charges annuelles d'exploitation: ${chargesExploitation.toFixed(0)} ‚Ç¨ (C)</strong></p>
        <p><strong>* TVA-TVA d√©ductible: ${tvaCalcul.toFixed(0)} ‚Ç¨ (T)</strong></p>
        <p><strong>* Imp√¥ts Cotisations sociales Mathis: ${chargesUrssaf.toFixed(0)} ‚Ç¨ (I)</strong></p>
        <p><strong>* BENEFICE NET ANNUEL: <span class="${beneficeNetClass}">${beneficeNet.toFixed(0)} ‚Ç¨ (CA-C-T-I)</span></strong></p>

        <p><strong>Rentabilit√© √©conomique mini (point mort) :</strong> Nb ventes mini journalier √† faire pour couvrir les charges et imp√¥ts : <strong>${nbVentesEconomique}</strong> ; soit chiffre d'affaire mini/jour : <strong>${(nbVentesEconomique * prix).toFixed(0)} ‚Ç¨</strong></p>
        <p>  </p>`;

    // Appel pour calculer et afficher le tableau des b√©n√©fices nets mensuels
    afficherTableauBenefices(prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva);
}

function calculerRentabiliteMinimum(type, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva, amortissement = 0) {
    var isAnneesSuivantes = document.getElementById('budgetAnneesSuivantes').checked;
    for (let i = 1; i <= 300; i++) {
        var chiffreAffaires = prix * i * jours * semaines;
        var chargesPersonnel = salaire * 12 * (1 + patronales);
        var loyerAnnuel = loyerMensuel * 12;
        var coutMatieres = cout * i * jours * semaines;
        var chargesExploitation = loyerAnnuel + charges + chargesPersonnel + coutMatieres + externes;
        var chargesUrssaf = chiffreAffaires * urssaf;

        // Calcul de la TVA selon le type de budget
        var tvaCalcul = isAnneesSuivantes ?
            chiffreAffaires * (
                (tva / (1 + tva)) - 
                (cout / prix) * (0.055 / (1 + 0.055)) - 
                ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))
            ) :
            (chiffreAffaires > 101000) ?
            (chiffreAffaires - 101000) * (
                (tva / (1 + tva)) - 
                (cout / prix) * (0.055 / (1 + 0.055)) - 
                ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))
            ) : 0;

        // Calcul du b√©n√©fice net
        var beneficeNet = chiffreAffaires - (chargesExploitation + tvaCalcul + chargesUrssaf);

        // V√©rification de la rentabilit√© en fonction du type
        if (type === 'economique' && beneficeNet >= 0) {
            console.log(`Rentabilit√© atteinte √† l'it√©ration ${i} avec un b√©n√©fice net de ${beneficeNet}`);
            return i;  // Retourne l'it√©ration d√®s que rentabilit√© atteinte
        } else if (type === 'financiere' && beneficeNet >= amortissement) {
            console.log(`Rentabilit√© atteinte √† l'it√©ration ${i} avec un b√©n√©fice net de ${beneficeNet}`);
            return i;  // Retourne l'it√©ration d√®s que rentabilit√© atteinte
        }
    }
    return 300; // Valeur par d√©faut si aucune rentabilit√© n'est trouv√©e
}

function afficherTableauBenefices(prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva) {
    var tableau = document.getElementById('tableauBenefices');
    
    // Cr√©ation du tableau des b√©n√©fices
    tableau.innerHTML = `
    <tr>
        <th>Revenu net moyen mensuel Mathis sur 12 mois (cong√©s compris)</th>
        <th>1000‚Ç¨</th>
        <th>2000‚Ç¨</th>
        <th>3000‚Ç¨</th>
        <th>4000‚Ç¨</th>
    </tr>
    <tr>
        <td>Nombre de ventes journali√®res n√©cessaire</td>
        ${calculerVentesPourBenefices(1000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva)}
        ${calculerVentesPourBenefices(2000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva)}
        ${calculerVentesPourBenefices(3000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva)}
        ${calculerVentesPourBenefices(4000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva)}
    </tr>`;
}

function calculerVentesPourBenefices(beneficeMensuel, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva) {
    var isAnneesSuivantes = document.getElementById('budgetAnneesSuivantes').checked;
    var targetProfit = beneficeMensuel * 12;
    
    for (let i = 0; i <= 2000; i++) {
        var loyerAnnuel = loyerMensuel * 12;
        var chiffreAffaires = prix * i * jours * semaines;

        // Calcul des termes de TVA avec protection contre la division par z√©ro
        var tvaTerms = (chiffreAffaires > 0) ?
            ((tva / (1 + tva)) - 
             (cout / prix) * (0.055 / (1 + 0.055)) - 
             ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))) : 0;

        var tvaCalcul = isAnneesSuivantes ?
            chiffreAffaires * tvaTerms :
            (chiffreAffaires > 101000) ? (chiffreAffaires - 101000) * tvaTerms : 0;

        var chargesPersonnel = salaire * 12 * (1 + patronales);
        var coutMatieres = cout * i * jours * semaines;
        var chargesExploitation = loyerAnnuel + charges + chargesPersonnel + coutMatieres + externes;
        var chargesUrssaf = chiffreAffaires * urssaf;
        var beneficeNet = chiffreAffaires - (chargesExploitation + tvaCalcul + chargesUrssaf);

        // Debugging logs pour suivre les calculs
        if (i % 100 === 0 || beneficeNet >= targetProfit) {
            console.log(`i=${i}, CA=${chiffreAffaires.toFixed(2)}, tva=${tvaCalcul.toFixed(2)}, urssaf=${chargesUrssaf.toFixed(2)}, beneficeNet=${beneficeNet.toFixed(2)}, target=${targetProfit}`);
        }

        if (beneficeNet >= targetProfit) {
            console.log(`Target atteint pour beneficeMensuel=${beneficeMensuel} √† i=${i}, beneficeNet=${beneficeNet.toFixed(2)}`);
            return `<td>${i}</td>`;
        }
    }
    console.log(`Target non atteint pour beneficeMensuel=${beneficeMensuel}, max i=2000`);
    return `<td>Non atteint</td>`;
}


// Appel initial pour afficher les r√©sultats par d√©faut
calculerResultat();

// Fonction pour exporter en Word
document.getElementById('exportWord').addEventListener('click', function () {
    var header = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Export HTML To Doc</title>
        <style>
            @page { 
                size: A4; 
                margin: 1cm; /* Marges r√©duites √† 1 cm */
            }
            body { 
                font-family: Arial, sans-serif; 
                margin: 0;
                padding: 0;
                font-size: 10pt; /* R√©duction de la taille de police */
                width: 100%;
            }
            h1 { 
                text-align: center; 
                border: 2px solid #000; 
                padding: 10px; 
                margin: 10px 0; 
                font-size: 12pt; /* R√©duction de la taille de police pour le titre */
            }
            h2 { 
                text-align: center; 
                margin: 5px 0; 
                font-size: 11pt; /* R√©duction de la taille de police pour les sous-titres */
            }
            p {
                margin: 5px 0; 
            }
            table { 
                width: 100%; 
                border-collapse: collapse; 
                font-size: 9pt; /* R√©duction de la taille de police dans le tableau */
            }
            th, td { 
                border: 1px solid #000; 
                padding: 4px; 
                text-align: center;
            }
            th {
                background-color: #f2f2f2;
            }
            .revenue-net { 
                background-color: #d3d3d3; /* Gris clair pour les revenus nets */
            }
        </style>
        </head><body>
        <h1 style="text-align: center;">BUDGET PREVISIONNEL</h1>
        <h2 style="text-align: center;">Restaurant CHEZ BARTH</h2>
        <p>Entrepreneur :  Mathis MOUHOU</p>
        <p>Enseigne / nom commercial :  CHEZ BARTH</p>
        <p>Statut Juridique : Entreprise Individuelle</p>
        <p>R√©gime fiscal/social :  Micro-entrepreneur</p>
        <br><p><strong>DONNEES D'ENTREE</strong> :</p>
        <br><p><strong> </p>
    `;

    // R√©cup√©rer les donn√©es quantitatives saisies par l'utilisateur
    var data = `
        <p>Prix de vente du panier moyen (‚Ç¨): ${document.getElementById('prix').value}</p>
        <p>Co√ªt de revient mati√®re du panier moyen (‚Ç¨): ${document.getElementById('cout').value}</p>
        <p>Nombre de paniers par jour: ${document.getElementById('panier').value}</p>
        <p>Nombre de jours de travail par semaine: ${document.getElementById('jours').value}</p>
        <p>Nombre de semaines de travail par an: ${document.getElementById('semaines').value}</p>
        <p>Loyer CC mensuel (‚Ç¨): ${document.getElementById('loyer').value}</p>
        <p>Charges annuelles d'√©lectricit√©, gaz, eau, t√©l√©phone, assurance (‚Ç¨): ${document.getElementById('charges').value}</p>
        <p>Charges annuelles externes (‚Ç¨): ${document.getElementById('externes').value}</p>
        <p>Salaire du personnel brut mensuel (temps partiel ou temps plein) (‚Ç¨): ${document.getElementById('salaire').value}</p>
        <p>Taux de cotisation des charges patronales (%): ${document.getElementById('patronales').value}</p>
        <p>Taux de cotisations sociales (%): ${document.getElementById('urssaf').value}</p>
        <p>Taux de TVA (%): ${document.getElementById('tva').value}</p>
        <p>Apport financier ou emprunt (‚Ç¨): ${document.getElementById('apport').value}</p>
    `;

    // R√©cup√©rer le contenu des r√©sultats
    var results = document.getElementById('resultat').innerHTML;

    // R√©cup√©rer le contenu du tableau des b√©n√©fices
    var tableauBenefices = document.getElementById('tableauBenefices').outerHTML;

    // Ajouter une classe CSS aux cellules "Revenu net mensuel"
    tableauBenefices = tableauBenefices.replace(/<td>([^<]+ ‚Ç¨)<\/td>/g, function (match, p1) {
        return `<td class="revenue-net">${p1}</td>`;
    });

    // Construire le document Word avec des sauts de ligne et le tableau format√©
    var footer = `
       <br><p><strong> </p>
        ${results}
        <br><p><strong>TABLEAU DES BENEFICES NETS MENSUELS EN FONCTION DES VENTES QUOTIDIENES</strong> :</p>
        ${tableauBenefices}
        </body></html>
    `;

    var sourceHTML = header + data + footer;

    var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
    var fileDownload = document.createElement("a");
    document.body.appendChild(fileDownload);
    fileDownload.href = source;
    fileDownload.download = 'Budget_Barth.doc';
    fileDownload.click();
    document.body.removeChild(fileDownload);
});

document.getElementById('exportPdf').addEventListener('click', function () {
    const exportPdfBtn = document.getElementById('exportPdf');
    const exportWordBtn = document.getElementById('exportWord');
    const retourBtn = document.getElementById('retour');

    // Cibler tous les boutons potentiels √† masquer
    const allButtons = document.querySelectorAll('button, [id*="retour"], [class*="retour"], [class*="back"], [class*="return"]');

    // Masquer tous les boutons
    [exportPdfBtn, exportWordBtn, retourBtn].forEach(btn => {
        if (btn) btn.style.display = 'none';
    });
    allButtons.forEach(btn => btn.style.display = 'none');

    const element = document.querySelector('.container');
    const today = new Date().toISOString().split('T')[0];
    const fileName = `Budget_Chez_Barth_${today}.pdf`;

    const opt = {
        margin: 0.5,
        filename: fileName,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().from(element).set(opt).toPdf().get('pdf')
        .then(function (pdf) {
            const totalPages = pdf.internal.getNumberOfPages();
            if (totalPages > 3) {
                console.warn(`‚ö†Ô∏è Document g√©n√©r√© avec ${totalPages} pages. Envisagez d'ajuster le contenu.`);
            }

            // ‚úÖ Message + ouverture
            alert(`Fichier "${fileName}" t√©l√©charg√© dans le dossier T√©l√©chargements.`);
            const blob = pdf.output('blob');
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        })
        .catch(function (error) {
            console.error("‚ùå Erreur lors de la g√©n√©ration du PDF :", error);
            alert("‚ùå Une erreur est survenue lors de l'export du PDF.");
        })
        .finally(() => {
            // Toujours restaurer les boutons
            [exportPdfBtn, exportWordBtn, retourBtn].forEach(btn => {
                if (btn) btn.style.display = 'block';
            });
            allButtons.forEach(btn => btn.style.display = 'block');
        });
});


// Fonctions pour la gestion des donn√©es (remplacez les versions existantes)
    function backupData() {
        try {
            const allData = {
                salesData: JSON.parse(localStorage.getItem('salesData')) || (typeof initialSalesData !== 'undefined' ? initialSalesData : {}),
                purchases: JSON.parse(localStorage.getItem('purchases')) || (typeof initialPurchases !== 'undefined' ? initialPurchases : []),
                personnelRecords: JSON.parse(localStorage.getItem('personnelRecords')) || (typeof initialPersonnelRecords !== 'undefined' ? initialPersonnelRecords : []),
                invoices: JSON.parse(localStorage.getItem('savedInvoices')) || [], // Utiliser savedInvoices
                menu: JSON.parse(localStorage.getItem('menu')) || (typeof initialMenu !== 'undefined' ? initialMenu : [])
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chez_barth_backup.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert("Donn√©es sauvegard√©es ! V√©rifiez votre dossier T√©l√©chargements pour le fichier chez_barth_backup.json.");
        } catch (error) {
            console.error("Erreur lors de la sauvegarde des donn√©es :", error);
            alert("Une erreur s'est produite lors de la sauvegarde des donn√©es. V√©rifiez la console pour plus de d√©tails.");
        }
    }

const initialMenu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato √† la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre √©tudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
];



    function resetData() {
        if (confirm("√ätes-vous s√ªr de vouloir r√©initialiser toutes les donn√©es ? Cette action supprimera toutes les donn√©es stock√©es et restaurera les donn√©es initiales.")) {
            if (confirm("Confirmez une derni√®re fois : toutes les donn√©es seront perdues. Continuer ?")) {
                try {
                    // D√©bogage : Afficher les cl√©s actuelles
                    console.log("Cl√©s localStorage avant r√©initialisation :", Object.keys(localStorage));
                    
                    // Vider compl√®tement le localStorage
                    localStorage.clear();
                    
                    // Restaurer les donn√©es initiales
                    localStorage.setItem('salesData', JSON.stringify(typeof initialSalesData !== 'undefined' ? initialSalesData : {}));
                    localStorage.setItem('purchases', JSON.stringify(typeof initialPurchases !== 'undefined' ? initialPurchases : []));
                    localStorage.setItem('personnelRecords', JSON.stringify(typeof initialPersonnelRecords !== 'undefined' ? initialPersonnelRecords : []));
                    localStorage.setItem('savedInvoices', JSON.stringify([])); // Vider savedInvoices
                    localStorage.setItem('menu', JSON.stringify(typeof initialMenu !== 'undefined' ? initialMenu : []));
                    
                    // R√©initialiser la variable globale invoices et le compteur
                    if (typeof invoices !== 'undefined') invoices = [];
                    if (typeof invoiceCounter !== 'undefined') invoiceCounter = 0;
                    
                    // D√©bogage : Afficher les cl√©s apr√®s r√©initialisation
                    console.log("Cl√©s localStorage apr√®s r√©initialisation :", Object.keys(localStorage));
                    console.log("Contenu de 'savedInvoices' apr√®s r√©initialisation :", localStorage.getItem('savedInvoices'));
                    
                    alert("Donn√©es r√©initialis√©es avec succ√®s !");
                    
                    // Rafra√Æchir les affichages
                    if (typeof filterRecipes === 'function') filterRecipes();
                    if (typeof filterPurchases === 'function') filterPurchases();
                    if (typeof filterPersonnel === 'function') filterPersonnel();
                    if (typeof loadInvoices === 'function') loadInvoices(); // Synchroniser invoices
                    if (typeof filterInvoices === 'function') filterInvoices();
                    if (typeof updateInvoiceDisplay === 'function') updateInvoiceDisplay();
                    if (typeof showInvoice === 'function') showInvoice();
                    
                    // Forcer la navigation vers la page des factures si ouverte
                    if (document.getElementById('invoicePage') && typeof navigateTo === 'function') {
                        navigateTo('invoicePage');
                    }
                } catch (error) {
                    console.error("Erreur lors de la r√©initialisation des donn√©es :", error);
                    alert("Une erreur s'est produite lors de la r√©initialisation. V√©rifiez la console pour plus de d√©tails.");
                }
            }
        }
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.accept = '.json,application/json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Valider les donn√©es import√©es
                    if (!importedData.salesData || !importedData.purchases || !importedData.personnelRecords || !importedData.invoices || !importedData.menu) {
                        alert("Fichier invalide : structure de donn√©es incorrecte.");
                        return;
                    }
                    
                    // Mettre √† jour le localStorage
                    localStorage.setItem('salesData', JSON.stringify(importedData.salesData));
                    localStorage.setItem('purchases', JSON.stringify(importedData.purchases));
                    localStorage.setItem('personnelRecords', JSON.stringify(importedData.personnelRecords));
                    localStorage.setItem('savedInvoices', JSON.stringify(importedData.invoices)); // Utiliser savedInvoices
                    localStorage.setItem('menu', JSON.stringify(importedData.menu));
                    
                    // Synchroniser la variable globale invoices
                    if (typeof invoices !== 'undefined') invoices = importedData.invoices;
                    if (typeof invoiceCounter !== 'undefined' && Array.isArray(importedData.invoices) && importedData.invoices.length > 0) {
                        invoiceCounter = Math.max(...importedData.invoices.map(i => i.number || 0));
                    }
                    
                    // D√©bogage : Afficher le contenu import√©
                    console.log("Contenu de 'savedInvoices' apr√®s importation :", localStorage.getItem('savedInvoices'));
                    
                    alert("Donn√©es import√©es avec succ√®s !");
                    
                    // Rafra√Æchir les affichages
                    if (typeof filterRecipes === 'function') filterRecipes();
                    if (typeof filterPurchases === 'function') filterPurchases();
                    if (typeof filterPersonnel === 'function') filterPersonnel();
                    if (typeof loadInvoices === 'function') loadInvoices(); // Synchroniser invoices
                    if (typeof filterInvoices === 'function') filterInvoices();
                    if (typeof updateInvoiceDisplay === 'function') updateInvoiceDisplay();
                    if (typeof showInvoice === 'function') showInvoice();
                    
                    // Forcer la navigation vers la page des factures si ouverte
                    if (document.getElementById('invoicePage') && typeof navigateTo === 'function') {
                        navigateTo('invoicePage');
                    }
                } catch (error) {
                    console.error("Erreur lors de l'importation :", error);
                    alert("Erreur lors de l'importation : fichier JSON invalide.");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

   window.addEventListener('DOMContentLoaded', () => {
    // Obtenir la date actuelle en UTC
    const now = new Date();
    // Calculer le d√©calage horaire de Paris (CEST = UTC+2 en mai)
    const parisOffsetMinutes = 120; // CEST = +2h
    const parisTime = new Date(now.getTime() + parisOffsetMinutes * 60 * 1000);
    // Formater en 'YYYY-MM-DD' pour l'input
    const todayISO = parisTime.toISOString().split('T')[0];
    // Affecter aux champs de la page bilan
    const endInput = document.getElementById('bilanEndDate');
    if (endInput) endInput.value = todayISO;

    // D√©bogage pour v√©rifier la date
    console.log("Date d√©finie dans DOMContentLoaded:", todayISO);
});

     

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .then(() => console.log("Service Worker install√© ‚úÖ"))
          .catch(err => console.error("Erreur SW :", err));
      }
    </script>

    
    </body>
</html>
