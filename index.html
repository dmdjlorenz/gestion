<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BARTH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        touch-action: manipulation;
        overscroll-behavior-y: none;
        max-width: 100vw; /* Ajouté */
        overflow-x: hidden; /* Ajouté pour éviter le débordement horizontal */
    }
       /* Ajoute ce bloc pour forcer l'adaptation sur mobile */
    html {
    width: 100vw;
    overflow-x: hidden;
}

#invoiceDetailContainer {
    font-size: 14px; /* ou 10px selon ton besoin */
}


/* Styles spécifiques pour les boutons de la section facture */
.invoice-button-group.buttons.no-print {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px; /* Réduit l'espace vertical entre les lignes */
    width: 100%; /* S'assure que le conteneur respecte la largeur du parent */
    max-width: 100%; /* Empêche le dépassement */
    box-sizing: border-box;
}

.invoice-button-group .button-row {
    display: flex;
    flex-wrap: nowrap; /* Maintient les boutons sur une seule ligne par défaut */
    gap: 9px; /* Réduit l'espace horizontal entre les boutons */
    width: 100%; /* S'adapte à la largeur du conteneur */
    max-width: 100%; /* Empêche le dépassement */
    justify-content: center; /* Centre les boutons */
}

.invoice-button-group .button-row button {
    min-width: 110px; /* Réduit la largeur minimale pour compacter les boutons */
    text-align: center;
    padding: 8px 8px; /* Réduit le padding pour des boutons plus petits */
    font-size: 16px; /* Réduit légèrement la taille de la police */
    flex: 1; /* Permet aux boutons de s'adapter à l'espace disponible */
    max-width: 220px; /* Limite la largeur maximale */
}

/* Responsive : permet le retour à la ligne sur petits écrans si nécessaire */
@media (max-width: 480px) {
    .invoice-button-group .button-row {
        flex-wrap: wrap; /* Permet le retour à la ligne si l'espace est insuffisant */
        gap: 6px;
    }
    .invoice-button-group .button-row button {
        min-width: 80px; /* Encore plus compact sur mobile */
        font-size: 18px;
        padding: 12px 6px;
    }
}

/* S'assurer que les styles d'impression restent inchangés */
@media print {
    .invoice-button-group.buttons.no-print {
        display: none !important;
    }
}




/* Styles génériques pour les boutons dans .buttons.no-print (sauf invoicePage) */
.buttons.no-print button {
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 4px;
    white-space: nowrap;
    cursor: pointer;
    border: none;
    text-align: center;
    box-sizing: border-box;
}

.buttons.no-print {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

/* Media query pour petits écrans (sauf invoicePage) */
@media (max-width: 480px) {
    .buttons.no-print button {
        padding: 8px 12px;
        font-size: 16px;
    }
}


.button-container {
    display: flex;
    flex-wrap: nowrap; /* Empêche les boutons de passer à la ligne */
    gap: 8px; /* Espace entre les boutons */
    justify-content: center; /* Centre les boutons horizontalement */
}

#addProductBtn, #deleteProductBtn {
    padding: 6px 10px; /* Réduit le padding pour une taille compacte */
    font-size: 13px; /* Réduit la taille de la police pour smartphones */
    white-space: nowrap; /* Empêche le texte de se casser */
}

    .hidden {
    display: none !important;
}

#tableauBenefices {
  width: 100%;
  border-collapse: collapse;
  font-size: 16px; /* Garder une bonne lisibilité */
  table-layout: auto;
}

#tableauBenefices th, #tableauBenefices td {
  padding: 6px;
  border: 1px solid #ddd;
  text-align: center;
}

@media (max-width: 600px) {
  #tableauBenefices {
    font-size: 12px;
  }
}



.standard-popup {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
}


    #homePage {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
    }
    #homePage h1 {
        color: #333;
        margin-bottom: 20px;
    }
    #homePage button {
        display: block;
        width: 100%;
        max-width: 300px;
        margin: 10px auto;
        padding: 15px;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
    }
    #homePage #recipeBookBtn { /* Ventes */
        background: #32CD32; /* Vert */
    }
    #homePage #recipeBookBtn:hover {
        background: #2AB82A;
    }
    #homePage #purchasesBtn { /* Achats */
        background: #FF0000; /* Rouge */
    }
    #homePage #purchasesBtn:hover {
        background: #CC0000;
    }
    #homePage #personnelBtn { /* inchangé */
        background: #6f42c1;
    }
    #homePage #personnelBtn:hover {
        background: #5a32a3;
    }
    #homePage #invoiceBtn { /* Commande Facture */
        background: #0000FF; /* Bleu */
    }
    #homePage #invoiceBtn:hover {
        background: #0000CC;
    }
#homePage #budgetBtn {
    background: #FFA500; /* Orange */
}
#homePage #budgetBtn:hover {
    background: #E59400;
}

#passwordPage {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#passwordPage h2 {
    color: #333;
    margin-bottom: 20px;
}

#passwordPage input {
    padding: 10px;
    width: 80%;
    max-width: 300px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}

#passwordPage button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

#passwordPage button:hover {
    background: #0056b3;
}

    #recipeBookPage, #recipeManagementPage, #invoicePage, #invoiceManagementPage, #invoiceDetailPage, #purchasesPage, #purchasesManagementPage, #personnelPage, #personnelManagementPage {
        max-width: 600px;
        width: 100%; /* Ajouté */
        box-sizing: border-box; /* Ajouté */
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #recipeBookPage h1, #recipeManagementPage h1, #invoicePage h1, #invoiceManagementPage h1, #invoiceDetailPage h1, #purchasesPage h1, #purchasesManagementPage h1, #personnelPage h1, #personnelManagementPage h1 {
        text-align: center;
        font-size: 1.5em;
        margin-bottom: 20px;
        color: #333;
    }
    button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    button:hover {
        background: #0056b3;
    }
    #recipeBookPage .date-nav, #purchasesPage .date-nav, #personnelPage .date-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    #recipeBookPage .date-nav button, #purchasesPage .date-nav button, #personnelPage .date-nav button {
        background: #ddd;
        color: #333;
        padding: 8px 12px;
    }
    #recipeBookPage .date-nav button:hover, #purchasesPage .date-nav button:hover, #personnelPage .date-nav button:hover {
        background: #ccc;
    }
    /* Boutons "Ajouter" */
    #saveRecipeBtn, #addPurchaseBtn, #addPersonnelBtn, #addProductBtn {
        background: #32CD32; /* Vert */
    }
    #saveRecipeBtn:hover, #addPurchaseBtn:hover, #addPersonnelBtn:hover, #addProductBtn:hover {
        background: #2AB82A;
    }
    /* Boutons "Supprimer" et "Effacer" */
    #deleteProductBtn, #deleteRecipeBtn,#deleteDetailBtn, #clearInvoiceBtn, .delete-btn {
        background: #FF0000; /* Rouge */
    }
    #deleteProductBtn:hover, #deleteRecipeBtn:hover,#deleteDetailBtn:hover, #clearInvoiceBtn:hover, .delete-btn:hover {
        background: #CC0000;
    }
    /* Boutons "Bilan" */
    #manageRecipesBtn, #manageInvoicesBtn, #managePurchasesBtn, #managePersonnelBtn {
        background: #0000FF; /* Bleu */
    }
    #manageRecipesBtn:hover, #manageInvoicesBtn:hover, #managePurchasesBtn:hover, #managePersonnelBtn:hover {
        background: #0000CC;
    }
    /* Boutons "Imprimer" */
#printInvoiceBtn, #printAllRecipesBtn, #printAllInvoicesBtn, #printPurchasesBtn, #printPersonnelBtn, #printDetailBtn, #printBluetoothBtn, #printBluetoothPurchasesBtn, #printBluetoothPersonnelBtn, #printBluetoothSalesBtn {
    background: #FFFF00; /* Jaune */
    color: #000; /* Texte noir pour lisibilité */
}
#printInvoiceBtn:hover, #printAllRecipesBtn:hover, #printAllInvoicesBtn:hover, #printPurchasesBtn:hover, #printPersonnelBtn:hover, #printDetailBtn:hover, #printBluetoothBtn:hover, #printBluetoothPurchasesBtn:hover, #printBluetoothPersonnelBtn:hover, #printBluetoothSalesBtn:hover {
    background: #CCCC00;
}

    /* Boutons "Envoyer" */
    #sendSmsInvoiceBtn, #sendEmailInvoiceBtn {
        background: #800080; /* Violet */
    }
    #sendSmsInvoiceBtn:hover, #sendEmailInvoiceBtn:hover {
        background: #660066;
    }
    /* Bouton "Sauvegarder (10 ans)" */
    #saveInvoiceBtn {
        background: #32CD32; /* Vert */
    }
    #saveInvoiceBtn:hover {
        background: #2AB82A;
    }
    /* Boutons "Retour" */
    #recipeBookPage .buttons button[onclick="backToHome()"],
    #recipeManagementPage .buttons button[onclick="backToRecipeBook()"],
    #invoicePage .buttons button[onclick="backToHome()"],
    #invoiceManagementPage .buttons button[onclick="backToInvoice()"],
    #invoiceDetailPage .buttons button[onclick="backToInvoiceManagement()"],
    #purchasesPage .buttons button[onclick="backToHome()"],
    #purchasesManagementPage .buttons button[onclick="backToPurchases()"],
    #personnelPage .buttons button[onclick="backToHome()"],
    #budgetPage button[onclick="backToHome()"],
    #personnelManagementPage .buttons button[onclick="backToPersonnel()"] {
        background: #000000; /* Noir */
    }
    #recipeBookPage .buttons button[onclick="backToHome()"]:hover,
    #recipeManagementPage .buttons button[onclick="backToRecipeBook()"]:hover,
    #invoicePage .buttons button[onclick="backToHome()"]:hover,
    #invoiceManagementPage .buttons button[onclick="backToInvoice()"]:hover,
    #invoiceDetailPage .buttons button[onclick="backToInvoiceManagement()"]:hover,
    #purchasesPage .buttons button[onclick="backToHome()"]:hover,
    #purchasesManagementPage .buttons button[onclick="backToPurchases()"]:hover,
    #personnelPage .buttons button[onclick="backToHome()"]:hover,
    #budgetPage button[onclick="backToHome()"]:hover,
    #personnelManagementPage .buttons button[onclick="backToPersonnel()"]:hover {
        background: #333333;
    }
    /* Styles inchangés pour le reste */
    #recipeBookPage .input-group, #purchasesPage .input-group, #personnelPage .input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }
    #recipeBookPage .input-field, #purchasesPage .input-field, #personnelPage .input-field {
        display: flex;
        flex-direction: column;
    }
    #recipeBookPage label, #purchasesPage label, #personnelPage label {
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    #recipeBookPage input, #purchasesPage input[type="number"], #personnelPage input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
    }
    #purchasesPage input[type="text"], #personnelPage input[type="text"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
    }
    #invoicePage .checkbox-group, #purchasesPage .radio-group, #personnelPage .select-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;



    }
    #invoicePage .checkbox-group label, #purchasesPage .radio-group label, #personnelPage .select-group label {
        display: flex;
        align-items: center;
        font-size: 16px;
        color: #333;
        font-weight: normal;
    }
    #invoicePage .checkbox-group input[type="checkbox"], #purchasesPage .radio-group input[type="radio"] {
        margin-right: 10px;
    }
    #invoicePage .checkbox-group {
        flex-direction: row;
        align-items: center;
        gap: 0;
        width: 100%;
        text-align: left;
    }
    #invoicePage .checkbox-group label {
        display: inline-flex;
        white-space: nowrap;
        margin: 0;
        padding: 0;
    }
    #invoicePage .checkbox-group .first-label {
        margin-right: 30px;
    }
    #invoicePage .checkbox-group input[type="checkbox"] {
        margin: 0 0 0 5px;
        padding: 0;
        width: 16px;
        height: 16px;
        min-width: 0;
        min-height: 0;
    }
    #invoicePage .dropdown {
        position: relative;
        display: block;
        width: 100%;
        margin-bottom: 10px;
    }
    /* MENU Chez BARTH */
    #invoicePage .dropdown button[onclick="toggleDropdown('menuDropdown')"] {
        width: 100%;
        background: #999999; /* Gris foncé plus clair */
        color: white;
    }
    #invoicePage .dropdown button[onclick="toggleDropdown('menuDropdown')"]:hover {
        background: #666666;
    }
    /* COMMANDE A FACTURER */
    #invoicePage .dropdown button[onclick="toggleDropdown('commandeDropdown')"] {
        width: 100%;
        background: #008000; /* Bleu foncé plus clair */
        color: white;
    }
    #invoicePage .dropdown button[onclick="toggleDropdown('commandeDropdown')"]:hover {
        background: #006600;
    }
   #invoicePage .dropdown-content {
    display: none;
    position: absolute; /* Changement ici: absolute -> relative */
    background-color: #fff;
    width: 100%; /* Ajustement ici */
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    padding: 12px 16px;
    z-index: 1;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 4px;
    box-sizing: border-box; /* Ajout pour gérer la largeur avec padding */
}



    #invoicePage .show { display: block; }
    #invoicePage input, #invoicePage select, #personnelPage select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
    }
    #invoicePage #productList {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    overflow-x: auto;
}

    #invoicePage #productList li {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
    }
    #invoicePage #productList input[type="checkbox"] {
        margin-right: 10px;
        width: auto;
    }
    #personnelPage #personnelSummary {
        margin-top: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 210mm;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
    }

#invoicePage #invoice {
    margin-top: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 100%; /* Important pour l'adaptation à l'écran */
    max-width: 210mm; /* Largeur maximale de la facture */
    margin-left: auto; /* Centrage horizontal */
    margin-right: auto; /* Centrage horizontal */
    box-sizing: border-box; /* Important pour gérer les paddings et bordures */
}


    #recipeManagementPage table, #invoiceManagementPage table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

/* Ensure the purchases table is responsive */
#purchasesManagementPage table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* Allows columns to adjust dynamically */
    box-sizing: border-box;
}

/* Ensure the personnel table is responsive */
#personnelManagementPage table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* Allows columns to adjust dynamically */
    box-sizing: border-box;
}


#invoicePage table {
    width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
}



    #invoicePage th, #invoicePage td, #recipeManagementPage th, #recipeManagementPage td, #invoiceManagementPage th, #invoiceManagementPage td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        font-size: 14px;
        min-height: 30px;
    }

/* Style for table headers and cells */
#purchasesManagementPage th, #purchasesManagementPage td {
    padding: 6px; /* Slightly reduced from 8px for compactness */
    border: 1px solid #ddd;
    text-align: left;
    font-size: 14px; /* Consistent with your existing styles */
    word-wrap: break-word; /* Ensure long text (e.g., comments) wraps */
    overflow-wrap: break-word; /* Modern equivalent */
    max-width: 120px; /* Limit column width to prevent overflow */
    min-width: 50px; /* Ensure columns don't collapse too much */
}

/* Specific style for the comment column (5th column when visible) */
#purchasesManagementPage th:nth-child(5), #purchasesManagementPage td:nth-child(5) {
    max-width: 80px; /* Tighter limit for comment column */
    white-space: normal; /* Allow text wrapping */
}

/* Wrap the table in a container to control overflow */
.table-container {
    width: 100%;
    max-width: 100%;
    overflow-x: auto; /* Fallback for extreme cases, but wrapping should prevent this */
    box-sizing: border-box;
}

/* Responsive adjustments for small screens */
@media (max-width: 480px) {
    #purchasesManagementPage table {
        font-size: 12px; /* Match your existing small-screen font size */
    }

    #purchasesManagementPage th, #purchasesManagementPage td {
        padding: 4px; /* Further reduce padding for compactness */
        max-width: 80px; /* Tighter columns on mobile */
        min-width: 40px; /* Prevent columns from becoming too narrow */
    }

    #purchasesManagementPage th:nth-child(5), #purchasesManagementPage td:nth-child(5) {
        max-width: 60px; /* Even tighter for comments on mobile */
    }
}


/* Style for table headers and cells */
#personnelManagementPage th, #personnelManagementPage td {
    padding: 6px; /* Slightly reduced from 8px for compactness */
    border: 1px solid #ddd;
    text-align: left;
    font-size: 14px; /* Consistent with your existing styles */
    word-wrap: break-word; /* Ensure long text (e.g., comments) wraps */
    overflow-wrap: break-word; /* Modern equivalent */
    max-width: 100px; /* Limit column width to prevent overflow */
    min-width: 40px; /* Ensure columns don't collapse too much */
}

/* Specific style for the comment column (6th column when visible) */
#personnelManagementPage th:nth-child(6), #personnelManagementPage td:nth-child(6) {
    max-width: 70px; /* Tighter limit for comment column */
    white-space: normal; /* Allow text wrapping */
}

/* Wrap the table in a container to control overflow */
.table-container {
    width: 100%;
    max-width: 100%;
    overflow-x: auto; /* Fallback for extreme cases, but wrapping should prevent this */
    box-sizing: border-box;
}

/* Responsive adjustments for small screens */
@media (max-width: 480px) {
    #personnelManagementPage table {
        font-size: 12px; /* Match your existing small-screen font size */
    }

    #personnelManagementPage th, #personnelManagementPage td {
        padding: 4px; /* Further reduce padding for compactness */
        max-width: 70px; /* Tighter columns on mobile */
        min-width: 30px; /* Prevent columns from becoming too narrow */
    }

    #personnelManagementPage th:nth-child(6), #personnelManagementPage td:nth-child(6) {
        max-width: 50px; /* Even tighter for comments on mobile */
    }
}

    #invoicePage th, #recipeManagementPage th, #invoiceManagementPage th, #purchasesManagementPage th, #personnelManagementPage th {
        background-color: #f2f2f2;
    }
    #invoicePage #orderTotal, #personnelPage #personnelTotal {
        width: 100%;
        margin-top: 20px;
        box-sizing: border-box;
    }
    #budgetPage .buttons, #recipeBookPage .buttons, #recipeManagementPage .buttons, #invoicePage .buttons, #invoiceManagementPage .buttons, #purchasesPage .buttons, #purchasesManagementPage .buttons, #personnelPage .buttons, #personnelManagementPage .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    /* Télécharger Livre des Recettes - Bilan des Ventes */
    #recipeManagementPage #exportRecipeBtn {
        background: #FFA500; /* Orange */
    }
    #recipeManagementPage #exportRecipeBtn:hover {
        background: #E59400;
    }
    /* Télécharger PDF - Bilan des Ventes (inchangé, déjà corrigé) */
    #recipeManagementPage #exportPurchasesPdfBtn {
        background: #FFA500; /* Orange */
    }
    #recipeManagementPage #exportPurchasesPdfBtn:hover {
        background: #E59400;
    }
    /* Télécharger PDF - Bilan des Achats */
    #purchasesManagementPage #exportPurchasesPdfBtn {
        background: #FFA500; /* Orange */
    }
    #purchasesManagementPage #exportPurchasesPdfBtn:hover {
        background: #E59400;
    }
    /* Télécharger - Gestion des Factures */
    #invoicePage #exportInvoicePdfBtn {
        background: #FFA500; /* Orange */
    }
    #invoicePage #exportInvoicePdfBtn:hover {
        background: #E59400;
    }
    /* Ajouter à la commande dans COMMANDE A FACTURER */
    #invoicePage #commandeDropdown button {
        background: #32CD32; /* Vert */
    }
    #invoicePage #commandeDropdown button:hover {
        background: #2AB82A;
    }
    /* Ajouter Employé et Supprimer Employé - Gestion du Personnel */
    #personnelPage .select-group button[onclick="addEmployee()"] {
        background: #32CD32; /* Vert */
    }
    #personnelPage .select-group button[onclick="addEmployee()"]:hover {
        background: #2AB82A;
    }
    #personnelPage .select-group button[onclick="deleteEmployee()"] {
        background: #FF0000; /* Rouge */
    }
    #personnelPage .select-group button[onclick="deleteEmployee()"]:hover {
        background: #CC0000;
    }
    /* Télécharger - Bilan du Personnel */
    #personnelManagementPage #exportPersonnelPdfBtn {
        background: #FFA500; /* Orange */
    }
    #personnelManagementPage #exportPersonnelPdfBtn:hover {
        background: #E59400;
    }
    #invoicePage #invoiceHeader {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
    }
    #invoicePage #invoiceHeader .invoice-number {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 16px;
        font-weight: bold;
    }
    #invoicePage .total-table, #personnelPage .total-table {
        width: 100%;
        max-width: 300px;
        margin-left: auto;
        margin-right: 0;
        box-sizing: border-box;
    }
    #invoicePage .total-table td:last-child, #personnelPage .total-table td:last-child {
        text-align: right;
    }
    #invoicePage #invoiceContainer, #personnelPage #personnelContainer {
        background-color: white;
        width: 100%;
        max-width: 210mm;
        padding: 20px;
        box-sizing: border-box;
        margin: auto;
    }
    #recipeManagementPage .date-filter, #invoiceManagementPage .date-filter, #purchasesManagementPage .date-filter, #personnelManagementPage .date-filter {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    #recipeManagementPage .date-filter label, #invoiceManagementPage .date-filter label, #purchasesManagementPage .date-filter label, #personnelManagementPage .date-filter label {
        font-weight: bold;
        color: #333;
    }
    #recipeManagementPage .date-filter input, #invoiceManagementPage .date-filter input, #purchasesManagementPage .date-filter input, #personnelManagementPage .date-filter input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
    }
    #recipeManagementPage th, #recipeManagementPage td, #invoiceManagementPage th, #invoiceManagementPage td, #personnelManagementPage th, #personnelManagementPage td {
        cursor: pointer;
    }
    #invoiceDetailPage {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #invoiceDetailPage h1 {
        text-align: center;
        font-size: 1.5em;
        margin-bottom: 20px;
        color: #333;
    }
    #invoiceDetailPage .buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    .no-print {
        display: block;
    }
    @media print {
        .no-print {
            display: none !important;
        }
        button, .buttons {
            display: none !important;
        }
        table {
            width: 100%;
            page-break-inside: auto;
        }
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        body {
            margin: 10mm;
        }
    }
    @media (max-width: 480px) {
        #recipeBookPage, #recipeManagementPage, #invoicePage, #invoiceManagementPage, #invoiceDetailPage, #purchasesPage, #purchasesManagementPage, #personnelPage, #personnelManagementPage {
            padding: 12px;
        }
        #recipeBookPage h1, #recipeManagementPage h1, #invoicePage h1, #invoiceManagementPage h1, #invoiceDetailPage h1, #purchasesPage h1, #purchasesManagementPage h1, #personnelPage h1, #personnelManagementPage h1 {
            font-size: 1.2em;
        }
        #recipeBookPage input, #recipeBookPage button, #invoicePage input, #invoicePage button, #invoicePage select, #purchasesPage input, #purchasesPage button, #purchasesManagementPage input, #purchasesManagementPage button, #personnelPage input, #personnelPage button, #personnelPage select, #personnelManagementPage button {
            font-size: 0.9em;
        }
        #invoicePage th, #invoicePage td, #recipeManagementPage th, #recipeManagementPage td, #invoiceManagementPage th, #invoiceManagementPage td, #purchasesManagementPage th, #purchasesManagementPage td, #personnelManagementPage th, #personnelManagementPage td {
            font-size: 12px;
        }
        #invoicePage #invoiceContainer, #personnelPage #personnelContainer {
            height: auto;
        }
    }

.payment-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .payment-section label {
        display: flex;
        align-items: center;
    }
    .spacer {
        width: 1cm; /* Réduit de 2cm à 1cm */
    }

/* Styles pour la page Budget */
#budgetPage.hidden {
    display: none !important;
    visibility: hidden !important; /* Double sécurité */
}

.container {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.container input, .container label {
    width: 100%;
    margin: 10px 0;
    padding: 10px;
    box-sizing: border-box;
}
.container input {
    border: 1px solid #ccc;
    border-radius: 4px;
}
.result {
    margin-top: 20px;
}
.negative {
    color: red;
}
.container table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}
.container table, .container th, .container td {
    border: 1px solid #ddd;
}
.container th, .container td {
    padding: 10px;
    text-align: center;
}
.container th {
    background-color: #f2f2f2;
}

/* Style des boutons d'export */
.export-button {
    background: #FFA500; /* Orange */
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.export-button:hover {
    background: #E59400;
}



}
@media print {
    .container {
        page-break-inside: avoid;
    }
    .container table, .container tr, .container td, .container th {
        page-break-inside: avoid;
    }
}

/* Style pour la page Paramètres (ajouter à la fin) */
        #settingsPage {
            text-align: center;
            padding: 20px;
        }
        #settingsPage button {
            display: block;
            width: 80%;
            max-width: 300px;
            margin: 10px auto;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }


    </style>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icone.png" type="image/png">
<meta name="theme-color" content="#000000">

<!-- Support iPhone/iPad -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="MaApp">
<link rel="apple-touch-icon" href="icone.png">




</head>
<body>
<body>
    <!-- Section de mot de passe -->
    <div id="passwordPage">
        <h2>Entrez le mot de passe</h2>
        <input type="password" id="passwordInput" placeholder="Mot de passe">
        <button onclick="checkPassword()">Valider</button>
        <p id="errorMessage" style="color: red; display: none;">Mot de passe incorrect !</p>
    </div>

    <!-- Page d'accueil (inchangée mais masquée au départ) -->
   <!-- ... Autre code HTML ... -->
<div id="homePage" class="hidden">
        <h2>Mon Appli Gestion</h2>
        <h2>CHEZ BARTH</h2>
        <button id="recipeBookBtn" onclick="showRecipeBook()">Ventes</button>
        <button id="purchasesBtn" onclick="showPurchases()">Achats</button>
        <button id="personnelBtn" onclick="showPersonnel()">Personnel</button>
        <button id="invoiceBtn" onclick="showInvoice()">Commande Facture</button>
        <button id="budgetBtn" onclick="showBudget()">Budget</button>
        <button id="recipeBookBtn" onclick="exportRecipeToPdfofficiel()">Livre des recettes officiel</button>
        <button onclick="showSettings()" style="background:#808080; color:white;">Paramètres</button>
    </div>

    <!-- Nouvelle page Paramètres -->
    <div id="settingsPage" class="page hidden">
        <h2>Paramètres</h2>
        <button onclick="backupData()" style="background:#32CD32; color:white;">Sauvegarder et exporter les données actuelles dans un fichier "chez_barth_backup ().json"</button>
        <button onclick="resetData()" style="background:#FF0000; color:white;"> ! Réinitialiser et supprimer toutes les données saisies </button>
        <button onclick="importData()" style="background:#0000FF; color:white;">Importer des données sauvegardées sur fichier "chez_Barth_backup ().json"</button>
        <button onclick="navigateTo('homePage')" style="background:#000000; color:white;">Retour</button>
    </div>
<!-- ... Reste du HTML ... -->

    <!-- Ventes -->
    <div id="recipeBookPage" class="hidden">
        <h1>GESTION DES VENTES</h1>
        <div class="date-nav">
            <button id="prevDay">←</button>
            <span id="currentDate"></span>
            <button id="nextDay">→</button>
        </div>
        <div class="input-group">
            <div class="input-field">
                <label>Ventes Carte Bancaire (€)</label>
                <input type="number" id="cardInput" step="0.01" min="0">
            </div>
            <div class="input-field">
                <label>Ventes Espèces (€)</label>
                <input type="number" id="cashInput" step="0.01" min="0">
            </div>
            <div class="input-field">
                <label>Total Ventes (€)</label>
                <input type="number" id="totalInput" readonly>
            </div>
        </div>
        <div class="buttons no-print">
    <button id="saveRecipeBtn">Ajouter</button>
    <button id="manageRecipesBtn" onclick="showRecipeManagement()">Bilan des Ventes</button>
    <button onclick="backToHome()">Retour</button>
</div>
    </div>

    <!-- Bilan des Ventes -->
<div id="recipeManagementPage" class="hidden">
    <h1>Bilan des Ventes</h1>

    <!-- Bouton export PDF -->
    <button id="exportRecipeBtn" onclick="exportRecipeToPdf()">Télécharger Livre des recettes complet (PDF)</button>

    <!-- Filtres par date -->
    <div class="date-filter">
        <label>Date de début :</label>
        <input type="date" id="recipeStartDate" onchange="filterRecipes()">
        <label>Date de fin :</label>
        <input type="date" id="recipeEndDate" onchange="filterRecipes()">
    </div>

    <!-- Liste des ventes -->
    <div id="recipeList"></div>

    <!-- Boutons principaux -->
    <div class="buttons no-print" style="margin-top: 10px;">
    <button id="printAllRecipesBtn" onclick="printAllRecipes()">Imprimer</button>
    <button id="printBluetoothSalesBtn" onclick="printSalesToBluetooth()">Imprimer Bluetooth</button>
    <button id="exportPurchasesPdfBtn" onclick="downloadRecipesPDF()">Télécharger</button>
    <button onclick="backToRecipeBook()">Retour</button>
</div>

    <!-- Popup de détail de vente -->
<div id="recipeDetailPopup" class="hidden" style="
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
">
    <h2>Détail de la vente</h2>
    <p id="recipeDetailDate"></p>
    <p id="recipeDetailCard"></p>
    <p id="recipeDetailCash"></p>
    <p id="recipeDetailTotal"></p>
    <div class="buttons">
        <button onclick="deleteSelectedRecipe()" style="background:#FF0000; color:white;">Supprimer</button>
        <button onclick="closeRecipeDetail()" style="background:#000000; color:white;">Fermer</button>
    </div>
</div>
</div>


<!-- Facture -->
<div id="invoicePage" class="hidden">
    <h1>GESTION DES FACTURES CLIENTS</h1>
    <div class="checkbox-group">
        <label class="first-label">CA inf à 85000€ <input type="checkbox" id="caBelow85000" onchange="toggleCA(this)"></label>
        <label>CA sup à 85000€ <input type="checkbox" id="caAbove85000" onchange="toggleCA(this)" checked></label>
    </div>
    <div class="dropdown">
    <button onclick="toggleDropdown('menuDropdown')">Le MENU Chez BARTH</button>
    <div id="menuDropdown" class="dropdown-content" onclick="event.stopPropagation()">
        <select id="productSelect"></select>
        <div class="button-container">
            <button id="addProductBtn" onclick="showMenuAction('add')">Ajouter un produit</button>
            <button id="deleteProductBtn" onclick="deleteProductFromMenu()">Supprimer le produit</button>
        </div>
        <div id="menuActionArea"></div>
    </div>
</div>
    <!-- Reste du code inchangé -->
  <div class="dropdown">
    <button onclick="toggleDropdown('commandeDropdown')">PRISE DE COMMANDE / FACTURE</button>
    <div id="commandeDropdown" class="dropdown-content" onclick="event.stopPropagation()">
        <ul id="productList"></ul>
        <div>
            <div class="payment-section" style="display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold;">Paiement</span>
                <label>
                    Carte <input type="radio" name="paymentMethod" value="Carte" id="paymentCard">
                </label>
                <label>
                    Espèce <input type="radio" name="paymentMethod" value="Espèce" id="paymentCash">
                </label>
            </div>
            <button onclick="addSelectedToOrder()">Ajouter à la commande</button>
        </div>
    </div>
</div>

    <div id="invoice">
        <div id="invoiceContainer">
            <div id="invoiceHeader"></div>
            <div id="orderList"></div>
            <div id="orderTotal"></div>
        </div>
    </div>
    <div class="no-print" style="height: 15px;"></div>

    <div class="buttons no-print invoice-button-group">
    <div class="button-row">
        <button id="saveInvoiceBtn" onclick="saveInvoice()">Enregistrer</button>
        <button id="clearInvoiceBtn" onclick="clearOrder()">Effacer</button>
        <button id="exportInvoicePdfBtn" onclick="exportInvoiceToPdf()">Télécharger</button>
    </div>
    <div class="button-row">
        <button id="printInvoiceBtn" onclick="printInvoice()">Imprimer</button>
        <button id="printBluetoothBtn" onclick="printToBluetoothThermal()">Imprimer Bluetooth</button>
    </div>
    <div class="button-row">
        <button id="sendSmsInvoiceBtn" onclick="sendInvoiceBySms()">Envoyer SMS</button>
        <button id="sendEmailInvoiceBtn" onclick="sendInvoiceByEmail()">Envoyer Email</button>
    </div>
    <div class="button-row">
        <button id="manageInvoicesBtn" onclick="showInvoiceManagement()">Bilan Factures</button>
        <button onclick="backToHome()">Retour</button>
    </div>
</div>

</div>

<!-- Bilan des Factures -->
<div id="invoiceManagementPage" class="hidden">
    <h1>Bilan des Commandes Factures</h1>
    <div class="date-filter">
        <label>Date de début :</label>
        <input type="date" id="startDate" onchange="filterInvoices()">
        <label>Date de fin :</label>
        <input type="date" id="endDate" onchange="filterInvoices()">
    </div>
    <div id="invoiceList"></div>
    <div class="no-print" style="height: 15px;"></div>
    <div class="buttons no-print">
        <button id="printAllInvoicesBtn" onclick="printAllInvoices()">Imprimer la liste des factures</button>
        <button onclick="backToInvoice()">Retour</button>
    </div>
</div>

<!-- Détail de la Facture -->
<div id="invoiceDetailPage" class="hidden">
    <div id="invoiceDetailContainer"></div>
    <div class="no-print" style="height: 15px;"></div>
    <div class="buttons no-print">
        <button id="printDetailBtn" onclick="printInvoiceDetail()">Imprimer</button>
        <button id="deleteDetailBtn" onclick="deleteInvoiceDetail()">Supprimer</button>
        <button onclick="backToInvoiceManagement()">Retour</button>
    </div>
</div>

<!-- Achats -->
<div id="purchasesPage" class="hidden">
    <h1>GESTION DES ACHATS</h1>
    <div class="date-nav">
        <button id="prevPurchaseDay">←</button>
        <span id="currentPurchaseDate"></span>
        <button id="nextPurchaseDay">→</button>
    </div>
    <div class="input-group">
        <div class="input-field">
            <label>Achats TTC (€)</label>
            <input type="number" id="purchaseAmount" step="0.01" min="0">
        </div>
    </div>
    <div class="radio-group">
    <label>Type d'achats</label>
    <label><input type="radio" name="purchaseType" value="Pain"> Pain</label>
    <label><input type="radio" name="purchaseType" value="Alimentaire"> Alimentaire</label>
    <label><input type="radio" name="purchaseType" value="Matériel"> Matériel</label>
    <label><input type="radio" name="purchaseType" value="Autre"> Autre</label>
</div>
    <div class="radio-group">
    <label>Paiement</label>
    <label><input type="radio" name="paymentMethod" value="Carte" checked> Carte</label>
    <label><input type="radio" name="paymentMethod" value="Espèce"> Espèce</label>
</div>
    <div class="input-group">
        <div class="input-field">
            <label>Commentaire</label>
            <input type="text" id="purchaseComment">
        </div>
    </div>
    <div class="buttons no-print">
        <button id="addPurchaseBtn" onclick="addPurchase()">Ajouter</button>
        <button id="managePurchasesBtn" onclick="showPurchasesManagement()">Bilan des Achats</button>
        <button onclick="backToHome()">Retour</button>
    </div>
</div>

<!-- Bilan des Achats -->
<div id="purchasesManagementPage" class="hidden">
    <h1>Bilan des Achats</h1>

    <!-- Filtres de dates -->
    <div class="date-filter">
        <label>Date de début :</label>
        <input type="date" id="purchaseStartDate" onchange="filterPurchases()">
        <label>Date de fin :</label>
        <input type="date" id="purchaseEndDate" onchange="filterPurchases()">
    </div>

    <!-- Option afficher les commentaires -->
    <label>
        <input type="checkbox" id="showPurchaseComments" onchange="filterPurchases()"> Afficher commentaire
    </label>

    <!-- Liste des achats -->
    <div id="purchasesList"></div>

    <!-- Boutons PDF et retour -->
    <div class="buttons no-print" style="margin-top: 10px;">
        <button id="printPurchasesBtn" onclick="printPurchases()">Imprimer</button>
        <button id="printBluetoothPurchasesBtn" onclick="printPurchasesToBluetooth()">Imprimer Bluetooth</button>
        <button id="exportPurchasesPdfBtn" onclick="downloadPurchasesPDF()">Télécharger</button>
        <button onclick="backToPurchases()">Retour</button>
    </div>

    <!-- Popup de détail achat -->
<div id="purchaseDetailPopup" class="hidden" style="
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
">
    <h2>Détail de l'achat</h2>
    <p id="purchaseDetailDate"></p>
    <p id="purchaseDetailAmount"></p>
    <p id="purchaseDetailType"></p>
    <p id="purchaseDetailPayment"></p>
    <p id="purchaseDetailComment"></p>
    <div class="buttons">
        <button onclick="deleteSelectedPurchase()" style="background:#FF0000; color:white;">Supprimer</button>
        <button onclick="closePurchaseDetail()" style="background:#000000; color:white;">Fermer</button>
    </div>
</div>
</div>


<!-- Personnel -->
<div id="personnelPage" class="hidden">
    <h1>GESTION DU PERSONNEL</h1>
    <div class="date-nav">
        <button id="prevPersonnelDay">←</button>
        <span id="currentPersonnelDate"></span>
        <button id="nextPersonnelDay">→</button>
    </div>
    <div class="select-group">
        <label>Employé</label>
        <select id="employeeSelect"></select>
        <button onclick="addEmployee()">Rentrer nouvel employé</button>
        <button onclick="deleteEmployee()">Sortir ancien employé</button>
    </div>
  <div class="input-group">
    <div class="input-field">
        <label>Heure de début</label>
        <input type="text" id="startTime" placeholder="ex: 720 pour 07:20" required>
    </div>
    <div class="input-field">
        <label>Heure de fin</label>
        <input type="text" id="endTime" placeholder="ex: 1450 pour 14:50" required>
    </div>
    <div class="input-field">
        <label>Commentaire</label>
        <input type="text" id="personnelComment">
    </div>
    <div class="input-field" style="display: flex; align-items: center; gap: 10px;">
        <div style="flex: 1; display: none;">
            <label>Total heures</label>
            <input type="text" id="hoursTotal" readonly style="width: 80px;">
        </div>
        <span style="display: none;">soit</span> <!-- Masquer aussi "soit" si inutile -->
        <div style="flex: 1;">
            <label>Total heures</label> <!-- Changement de label pour cohérence -->
            <input type="text" id="hoursTotalConverted" readonly style="width: 80px;">
        </div>
    </div>
</div>
    <div class="buttons no-print">
        <button id="addPersonnelBtn" onclick="addPersonnelHours()">Ajouter</button>
        <button id="managePersonnelBtn" onclick="showPersonnelManagement()">Bilan du Personnel</button>
        <button onclick="backToHome()">Retour</button>
    </div>
</div>

<!-- Bilan du Personnel -->
<div id="personnelManagementPage" class="hidden">
    <h1>Bilan du Personnel</h1>

    <div class="date-filter">
        <label>Date de début :</label>
        <input type="date" id="personnelStartDate" onchange="filterPersonnel()">
        <label>Date de fin :</label>
        <input type="date" id="personnelEndDate" onchange="filterPersonnel()">
    </div>

    <label><input type="checkbox" id="showComments" onchange="filterPersonnel()"> Afficher commentaire</label>

    <div id="personnelList"></div>

    <div class="buttons no-print" style="margin-top: 10px;">
        <button id="printPersonnelBtn" onclick="printPersonnel()">Imprimer</button>
        <button id="printBluetoothPersonnelBtn" onclick="printPersonnelToBluetooth()">Imprimer Bluetooth</button>
        <button id="exportPersonnelPdfBtn" onclick="downloadPersonnelPDF()">Télécharger</button>
        <button onclick="backToPersonnel()">Retour</button>
    </div>

    <!-- Popup de détail personnel -->
<div id="personnelDetailPopup" class="hidden" style="
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 999;
    min-width: 250px;
    max-width: 90%;
">
    <h2>Détail du personnel</h2>
    <p id="personnelDetailDate"></p>
    <p id="personnelDetailEmployee"></p>
    <p id="personnelDetailStartTime"></p>
    <p id="personnelDetailEndTime"></p>
    <p id="personnelDetailHours"></p>
    <p id="personnelDetailComment"></p>
    <div class="buttons no-print" style="margin-top: 15px;">
        <button onclick="deleteSelectedPersonnel()" style="background:#FF0000; color:white;">Supprimer</button>
        <button onclick="closePersonnelDetail()" style="background:#000000; color:white;">Fermer</button>
    </div>
</div>
</div>


<!-- Budget -->
<div id="budgetPage" class="hidden">
    <div class="container">
        <h1 style="text-align: center;">BUDGET PREVISIONNEL</h1>
        <h2 style="text-align: center;">Sandwicherie CHEZ BARTH</h2>
        <p>Entrepreneur :  Mathis MOUHOU</p>
        <p>Enseigne / nom commercial :  CHEZ BARTH</p>
        <p>Statut Juridique : Entreprise Individuelle</p>
        <p>Régime fiscal/social :  Micro-entrepreneur</p>
      
        <p><strong>DONNEES D'ENTREE</strong> (à modifier si besoin) :  </p>
        <label for="prix">Prix de vente du panier moyen (€):</label>
        <input type="number" id="prix" value="10" oninput="calculerResultat()">
        
        <label for="cout">Coût de revient matière du panier moyen (€):</label>
        <input type="number" id="cout" value="3.5" oninput="calculerResultat()">

        <label for="panier">Nombre de paniers par jour:</label>
        <input type="number" id="panier" value="70" oninput="calculerResultat()">
        
        <label for="jours">Nombre de jours de travail par semaine:</label>
        <input type="number" id="jours" value="5" oninput="calculerResultat()">
        
        <label for="semaines">Nombre de semaines de travail par an:</label>
        <input type="number" id="semaines" value="48" oninput="calculerResultat()">
        
        <label for="loyer">Loyer mensuel (€):</label>
        <input type="number" id="loyer" value="1103" oninput="calculerResultat()">
        
        <label for="salaire">Salaire brut mensuel du personnel (temps partiel ou temps plein) (€):</label>
        <input type="number" id="salaire" value="1800" oninput="calculerResultat()">
        
        <label for="patronales">Taux de cotisation des charges patronales (bas salaires)(%):</label>
        <input type="number" id="patronales" value="25" oninput="calculerResultat()">

        <label for="charges">Charges annuelles d'électricité, gaz, eau, téléphone, assurance (€):</label>
        <input type="number" id="charges" value="3000" oninput="calculerResultat()">
        
        <label for="externes">Charges annuelles externes (TPE, banque, commission CB, transport, entretien, honoraires, compta, pub, autres) (€):</label>
        <input type="number" id="externes" value="10000" oninput="calculerResultat()">
        
        <label for="urssaf">Taux de cotisations sociales (12.415% reduit première année 6.2%) et impôt sur le revenu libératoire de 1% de Mathis et formation 0.3% (%):</label>
        <input type="number" id="urssaf" value="7.5" oninput="calculerResultat()">

        <label for="tva">Taux de TVA % (vente):</label>
        <input type="number" id="tva" value="10" oninput="calculerResultat()">
        
        <label for="apport">Apport financier ou emprunt (€):</label>
        <input type="number" id="apport" value="75000" oninput="calculerResultat()">
        
        <div class="result" id="resultat">
            <!-- Les résultats seront affichés ici -->
        </div>
        
        <table id="tableauBenefices">
    <!-- Le tableau des bénéfices nets sera affiché ici -->
</table>

<div class="buttons no-print" style="margin-top: 10px;">
    <button id="exportPdf" class="export-button">Télécharger PDF</button>
    <button id="exportWord" class="export-button">Télécharger Word</button>
    <button onclick="backToHome()">Retour</button>
</div>

    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;

    // Initialisation globale des variables
let invoices = [];
let invoiceCounter = 0;
let order = [];
let menu = [];
let caBelow85000 = false; // Par défaut, CA supérieur à 85000€
let currentPaymentMethod = 'Non spécifié'; // Mode de paiement global pour la facture en cours
let filteredPersonnelRecords = [];
let selectedPersonnelRecord = null;




// Mot de passe défini
const correctPassword = "mathis";

// Fonction centralisée pour naviguer entre les pages et mettre à jour l'historique
function navigateTo(pageId) {
    const pages = [
        'passwordPage', 'homePage', 'recipeBookPage', 'recipeManagementPage', 
        'invoicePage', 'invoiceManagementPage', 'invoiceDetailPage', 
        'purchasesPage', 'purchasesManagementPage', 'personnelPage', 
        'personnelManagementPage', 'budgetPage', 'settingsPage'
    ];
    pages.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(pageId).classList.remove('hidden');
    history.pushState({ page: pageId }, '', `#${pageId}`);

    // Appeler les fonctions d'initialisation spécifiques si nécessaire
    if (pageId === 'recipeBookPage') updateRecipeDisplay();
    if (pageId === 'purchasesPage') updatePurchaseDisplay();
    if (pageId === 'personnelPage') updatePersonnelDisplay();
    if (pageId === 'recipeManagementPage') filterRecipes();
    if (pageId === 'invoiceManagementPage') filterInvoices();
    if (pageId === 'purchasesManagementPage') filterPurchases();
    if (pageId === 'personnelManagementPage') filterPersonnel();
}



// Fonction pour vérifier le mot de passe
function checkPassword() {
    const input = document.getElementById('passwordInput').value;
    const errorMessage = document.getElementById('errorMessage');
    if (input === correctPassword) {
        const pages = [
            'homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 
            'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 
            'purchasesManagementPage', 'personnelPage', 'personnelManagementPage',
            'passwordPage', 'budgetPage', 'settingsPage'
        ];
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('homePage').classList.remove('hidden');
        history.replaceState({ page: 'homePage' }, '', '#homePage'); // Remplacer au lieu d'ajouter
        errorMessage.style.display = 'none';
    } else {
        errorMessage.style.display = 'block';
    }
}

// Conserver l'écouteur pour la touche "Entrée"
document.getElementById('passwordInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        checkPassword();
    }
});

// Au démarrage, afficher la page de mot de passe et masquer le reste
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('passwordPage').classList.remove('hidden');
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.add('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.add('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');

    history.pushState({ page: 'homePage' }, '', '#homePage');
});

function showSettings() {
        navigateTo('settingsPage');
    }

function updateMenuTvaRates() {
    console.log('Dans updateMenuTvaRates, caBelow85000 =', caBelow85000);
    menu.forEach(item => {
        if (caBelow85000) {
            // Si CA < 85000€, TVA à 0% pour tous les produits
            item.tvaRate = 0;
            item.priceHT = item.priceTTC; // Pas de TVA, donc HT = TTC
        } else {
            // Sinon, rétablir les taux par défaut : 5.5% pour boissons, 10% pour sandwichs/desserts
            if (item.type === "B") { // Boissons
                item.tvaRate = 0.055; // 5.5%
            } else { // Sandwichs et desserts (type "S")
                item.tvaRate = 0.1; // 10%
            }
            // Recalculer le prix HT à partir du prix TTC
            item.priceHT = item.priceTTC / (1 + item.tvaRate);
        }
        console.log(`Produit ${item.name}: tvaRate = ${item.tvaRate}, priceHT = ${item.priceHT}`);
    });
    // Mettre à jour la liste des produits et la commande après changement des taux
    updateProductList();
    updateOrderList();
}

function saveMenuToStorage() {
    try {
        localStorage.setItem('menu', JSON.stringify(menu));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde du menu:', e);
        alert('Erreur lors de la sauvegarde du menu.');
    }
}

function loadMenuFromStorage() {
    try {
        const storedMenu = localStorage.getItem('menu');
        if (storedMenu) {
            menu = JSON.parse(storedMenu);
        } else {
            menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato à la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre étudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
            ];
            saveMenuToStorage();
        }
        updateMenuTvaRates(); // Initialiser les taux au chargement
    } catch (e) {
        console.error('Erreur lors du chargement du menu:', e);
        menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato à la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre étudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
        ];
        updateMenuTvaRates(); // Initialiser les taux au chargement
    }
}





// Charger le menu au démarrage
loadMenuFromStorage();

 // Charger les factures au démarrage
    function loadInvoices() {
        try {
            const storedInvoices = localStorage.getItem('savedInvoices');
            console.log('Données brutes de localStorage:', storedInvoices);
            if (storedInvoices) {
                invoices = JSON.parse(storedInvoices);
                console.log('Factures chargées:', invoices);
                if (!Array.isArray(invoices)) {
                    throw new Error('Les données chargées ne sont pas un tableau');
                }
                if (invoices.length > 0) {
                    invoiceCounter = Math.max(...invoices.map(i => {
                        if (typeof i.number !== 'number') {
                            throw new Error('Numéro de facture invalide dans les données');
                        }
                        return i.number;
                    }));
                }
            }
        } catch (e) {
            console.error('Erreur lors du chargement des factures:', e);
            alert('Erreur lors du chargement des factures. Réinitialisation des données.');
            invoices = [];
            invoiceCounter = 0;
            localStorage.setItem('savedInvoices', JSON.stringify(invoices));
        }
    }
    loadInvoices();

    // Fonction dédiée pour sauvegarder dans localStorage
    function saveInvoicesToStorage() {
        try {
            localStorage.setItem('savedInvoices', JSON.stringify(invoices));
            console.log('localStorage mis à jour avec:', JSON.parse(localStorage.getItem('savedInvoices')));
        } catch (e) {
            console.error('Erreur lors de la sauvegarde des factures dans localStorage:', e);
            alert('Erreur lors de la sauvegarde des factures.');
        }
    }

    // Gestion des pages
    function showRecipeBook() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.remove('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        updateRecipeDisplay();
    }

    function showRecipeManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.remove('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        filterRecipes();
    }

    function showInvoice() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.remove('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.add('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');
    loadCAStatus();
    updateProductList(); // Met à jour la liste et désélectionne les cases
    updateOrderList();
    // Réinitialisation supplémentaire au cas où
    document.querySelectorAll('#productList input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
}

    function showInvoiceManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.remove('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        filterInvoices();
    }

    function showInvoiceDetail() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.remove('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
    }

function showPurchases() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.add('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.remove('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');

    updatePurchaseDisplay();

    // Forcer "Carte" à être sélectionné après l'affichage complet
    setTimeout(() => {
        const carteRadio = document.querySelector('#purchasesPage input[name="paymentMethod"][value="Carte"]');
        if (carteRadio) {
            carteRadio.checked = true;
            carteRadio.dispatchEvent(new Event('change'));
        }
    }, 100);
}




    function showPurchasesManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.remove('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        filterPurchases();
    }

    function showPersonnel() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.remove('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        updatePersonnelDisplay();
    }

    function showPersonnelManagement() {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.remove('hidden');
        filterPersonnel();
    }

    function backToHome() {
        document.getElementById('homePage').classList.remove('hidden');
        document.getElementById('recipeBookPage').classList.add('hidden');
        document.getElementById('recipeManagementPage').classList.add('hidden');
        document.getElementById('invoicePage').classList.add('hidden');
        document.getElementById('invoiceManagementPage').classList.add('hidden');
        document.getElementById('invoiceDetailPage').classList.add('hidden');
        document.getElementById('purchasesPage').classList.add('hidden');
        document.getElementById('purchasesManagementPage').classList.add('hidden');
        document.getElementById('personnelPage').classList.add('hidden');
        document.getElementById('personnelManagementPage').classList.add('hidden');
        document.getElementById('budgetPage').classList.add('hidden');
        document.getElementById('homePage').classList.remove('hidden');
    }

    function backToRecipeBook() {
        showRecipeBook();
    }

    function backToInvoice() {
        showInvoice();
    }

    function backToInvoiceManagement() {
        showInvoiceManagement();
    }

    function backToPurchases() {
        showPurchases();
    }

    function backToPersonnel() {
        showPersonnel();
    }

    // --- Ventes ---
    let recipeCurrentDate = new Date();
    const initialSalesData = {
    "2024-12-11": { card: 352, cash: 147, total: 499 },
    "2024-12-12": { card: 164, cash: 69, total: 233 },
    "2024-12-13": { card: 134, cash: 56, total: 190 },
    "2024-12-14": { card: 183, cash: 76, total: 259 },
    "2024-12-16": { card: 316, cash: 132, total: 448 },
    "2024-12-17": { card: 212, cash: 89, total: 301 },
    "2024-12-18": { card: 182, cash: 76, total: 257 },
    "2024-12-19": { card: 234, cash: 98, total: 332 },
    "2024-12-20": { card: 123, cash: 51, total: 174 },
    "2024-12-21": { card: 212, cash: 88, total: 300 },
    "2024-12-23": { card: 160, cash: 67, total: 226 },
    "2024-12-24": { card: 144, cash: 60, total: 203 },
    "2024-12-27": { card: 52, cash: 22, total: 74 },
    "2024-12-28": { card: 169, cash: 70, total: 239 },
    "2024-12-30": { card: 207, cash: 86, total: 293 },
    "2024-12-31": { card: 176, cash: 73, total: 249 },
    "2025-01-02": { card: 148, cash: 44, total: 192 },
    "2025-01-03": { card: 209, cash: 62, total: 271 },
    "2025-01-04": { card: 166, cash: 49, total: 215 },
    "2025-01-06": { card: 108, cash: 32, total: 140 },
    "2025-01-07": { card: 198, cash: 59, total: 257 },
    "2025-01-08": { card: 285, cash: 85, total: 370 },
    "2025-01-09": { card: 241, cash: 72, total: 313 },
    "2025-01-10": { card: 361, cash: 108, total: 469 },
    "2025-01-11": { card: 252, cash: 75, total: 327 },
    "2025-01-13": { card: 313, cash: 93, total: 406 },
    "2025-01-14": { card: 179, cash: 53, total: 232 },
    "2025-01-15": { card: 259, cash: 100, total: 359 },
    "2025-01-16": { card: 242, cash: 100, total: 342 },
    "2025-01-17": { card: 296, cash: 120, total: 416 },
    "2025-01-18": { card: 200, cash: 60, total: 259 },
    "2025-01-20": { card: 251, cash: 100, total: 351 },
    "2025-01-21": { card: 293, cash: 88, total: 381 },
    "2025-01-22": { card: 290, cash: 100, total: 390 },
    "2025-01-23": { card: 199, cash: 60, total: 259 },
    "2025-01-24": { card: 513, cash: 153, total: 666 },
    "2025-01-25": { card: 471, cash: 141, total: 612 },
    "2025-01-27": { card: 506, cash: 200, total: 706 },
    "2025-01-28": { card: 239, cash: 71, total: 310 },
    "2025-01-29": { card: 536, cash: 160, total: 696 },
    "2025-01-30": { card: 316, cash: 94, total: 410 },
    "2025-01-31": { card: 478, cash: 143, total: 620 },
    "2025-02-01": { card: 281, cash: 100, total: 381 },
    "2025-02-03": { card: 342, cash: 100, total: 442 },
    "2025-02-04": { card: 255, cash: 100, total: 355 },
    "2025-02-05": { card: 440, cash: 150, total: 590 },
    "2025-02-06": { card: 475, cash: 200, total: 675 },
    "2025-02-07": { card: 425, cash: 150, total: 575 },
    "2025-02-08": { card: 327, cash: 100, total: 427 },
    "2025-02-10": { card: 544, cash: 200, total: 744 },
    "2025-02-11": { card: 913, cash: 350, total: 1263 },
    "2025-02-12": { card: 1253, cash: 510, total: 1763 },
    "2025-02-13": { card: 1336, cash: 500, total: 1836 },
    "2025-02-14": { card: 1210, cash: 400, total: 1610 },
    "2025-02-17": { card: 648, cash: 270, total: 918 },
    "2025-02-18": { card: 794, cash: 290, total: 1084 },
    "2025-02-19": { card: 942, cash: 300, total: 1242 },
    "2025-02-20": { card: 963, cash: 190, total: 1153 },
    "2025-02-21": { card: 1000, cash: 280, total: 1280 },
    "2025-02-25": { card: 300, cash: 200, total: 500 },
    "2025-02-26": { card: 890, cash: 180, total: 1070 },
    "2025-02-27": { card: 1063, cash: 200, total: 1263 },
    "2025-02-28": { card: 728, cash: 230, total: 958 },
    "2025-03-03": { card: 757, cash: 120, total: 877 },
    "2025-03-04": { card: 745, cash: 360, total: 1105 },
    "2025-03-05": { card: 792, cash: 150, total: 942 },
    "2025-03-06": { card: 857, cash: 250, total: 1107 },
    "2025-03-07": { card: 883, cash: 210, total: 1093 },
    "2025-03-10": { card: 599, cash: 150, total: 749 },
    "2025-03-11": { card: 796, cash: 170, total: 966 },
    "2025-03-12": { card: 627, cash: 160, total: 787 },
    "2025-03-13": { card: 784, cash: 140, total: 924 },
    "2025-03-14": { card: 505, cash: 140, total: 645 },
    "2025-03-17": { card: 661, cash: 130, total: 791 },
    "2025-03-18": { card: 782, cash: 110, total: 892 },
    "2025-03-19": { card: 486, cash: 180, total: 666 },
    "2025-03-20": { card: 635, cash: 190, total: 825 },
    "2025-03-21": { card: 512, cash: 120, total: 632 },
    "2025-03-24": { card: 492, cash: 210, total: 702 },
    "2025-03-25": { card: 626, cash: 210, total: 836 },
    "2025-03-26": { card: 749, cash: 180, total: 929 },
    "2025-03-27": { card: 610, cash: 180, total: 790 },
    "2025-03-28": { card: 673, cash: 220, total: 893 },
    "2025-03-31": { card: 640, cash: 220, total: 860 },
    "2025-04-01": { card: 717, cash: 210, total: 927 },
    "2025-04-02": { card: 488, cash: 190, total: 678 },
    "2025-04-03": { card: 601, cash: 170, total: 771 },
    "2025-04-04": { card: 639, cash: 240, total: 879 },
    "2025-04-07": { card: 588, cash: 190, total: 778 },
    "2025-04-08": { card: 738, cash: 200, total: 938 },
    "2025-04-09": { card: 764, cash: 200, total: 964 },
    "2025-04-10": { card: 467, cash: 110, total: 577 },
    "2025-04-11": { card: 595, cash: 150, total: 745 },
    "2025-04-14": { card: 288, cash: 100, total: 388 },
    "2025-04-15": { card: 629, cash: 150, total: 779 }
};


    let salesData = {};
    try {
        const storedData = localStorage.getItem('salesData');
        if (storedData) {
            salesData = JSON.parse(storedData);
        } else {
            salesData = { ...initialSalesData };
            localStorage.setItem('salesData', JSON.stringify(salesData));
        }
    } catch (e) {
        console.error('Erreur avec localStorage:', e);
        alert('Problème de stockage détecté. Les données ne seront pas persistantes.');
        salesData = { ...initialSalesData };
    }

    const cardInput = document.getElementById('cardInput');
    const cashInput = document.getElementById('cashInput');
    const totalInput = document.getElementById('totalInput');
    const saveRecipeBtn = document.getElementById('saveRecipeBtn');
    const prevDay = document.getElementById('prevDay');
    const nextDay = document.getElementById('nextDay');
    const currentDateSpan = document.getElementById('currentDate');

    function formatRecipeDate(date) {
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getISODate(date) {
        return date.toISOString().split('T')[0];
    }

    function updateRecipeDisplay() {
        currentDateSpan.textContent = formatRecipeDate(recipeCurrentDate);
        const dateKey = getISODate(recipeCurrentDate);
        const data = salesData[dateKey] || { card: 0, cash: 0, total: 0 };
        cardInput.value = data.card || '';
        cashInput.value = data.cash || '';
        totalInput.value = data.total || '';
    }

    function calculateRecipeTotal() {
        const card = parseFloat(cardInput.value) || 0;
        const cash = parseFloat(cashInput.value) || 0;
        const total = card + cash;
        totalInput.value = total.toFixed(2);
        return total;
    }

    cardInput.addEventListener('input', calculateRecipeTotal);
    cashInput.addEventListener('input', calculateRecipeTotal);

    saveRecipeBtn.addEventListener('click', () => {
        const dateKey = getISODate(recipeCurrentDate);
        salesData[dateKey] = {
            card: parseFloat(cardInput.value) || 0,
            cash: parseFloat(cashInput.value) || 0,
            total: parseFloat(totalInput.value) || 0
        };
        try {
            localStorage.setItem('salesData', JSON.stringify(salesData));
            alert('Données enregistrées avec succès !');
        } catch (e) {
            console.error('Erreur lors de la sauvegarde dans localStorage:', e);
            alert('Erreur lors de la sauvegarde.');
        }
        updateRecipeDisplay();
    });

    const deleteRecipeBtn = document.getElementById('deleteRecipeBtn');
    if (deleteRecipeBtn) {
        deleteRecipeBtn.addEventListener('click', () => {
            const dateKey = getISODate(recipeCurrentDate);
            if (salesData[dateKey]) {
                if (confirm(`Voulez-vous vraiment supprimer les ventes pour le ${formatRecipeDate(recipeCurrentDate)} ?`)) {
                    delete salesData[dateKey];
                    try {
                        localStorage.setItem('salesData', JSON.stringify(salesData));
                        
                    } catch (e) {
                        console.error('Erreur lors de la suppression dans localStorage:', e);
                        alert('Erreur lors de la suppression.');
                    }
                    updateRecipeDisplay();
                    filterRecipes();
                }
            } else {
                alert('Aucune vente à supprimer pour cette date.');
            }
        });
    }

    prevDay.addEventListener('click', () => {
        recipeCurrentDate.setDate(recipeCurrentDate.getDate() - 1);
        updateRecipeDisplay();
    });

    nextDay.addEventListener('click', () => {
        recipeCurrentDate.setDate(recipeCurrentDate.getDate() + 1);
        updateRecipeDisplay();
    });

  function exportRecipeToPdf() {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 10;
    let y = margin;

    const colWidths = [30, 35, 35, 35, 60];
    const rowHeight = 8;
    const tableX = margin;

    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

    const dataByMonth = {};
    Object.keys(salesData).forEach(dateKey => {
        const [year, month] = dateKey.split('-');
        const monthYear = `${year}-${month}`;
        if (!dataByMonth[monthYear]) {
            dataByMonth[monthYear] = [];
        }
        dataByMonth[monthYear].push({
            date: dateKey,
            ...salesData[dateKey]
        });
    });

    const drawTableHeader = (x, y, month, year) => {
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.rect(margin, y, pageWidth - 2 * margin, 20);
        doc.text(`LIVRE DES RECETTES ${month} ${year}`, pageWidth / 2, y + 8, { align: 'center' });
        doc.text('Chez BARTH 16 place des Prêcheurs 13100 Aix en Provence SIRET : 93253222900014', pageWidth / 2, y + 16, { align: 'center' });
        y += 25;
        doc.setFontSize(10);
        doc.rect(x, y, colWidths[0], rowHeight); doc.text('Date', x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte B', x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Espèce', x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TOTAL Ventes', x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Origine', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTableRow = (x, y, date, card, cash, total) => {
        doc.setFont('helvetica', 'normal');
        const cleanDate = date.split('T')[0];
        const dateParts = cleanDate.split('-');
        const dateStr = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(dateStr, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${card} €`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${cash} €`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${total} €`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight);
        doc.text('Vente Sandwichs à emporter', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTotalRow = (x, y, totalCard, totalCash, totalSales, month) => {
        doc.setFont('helvetica', 'bold');
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(`Total ${month}`, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${totalCard} €`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalCash} €`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalSales} €`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const sortedMonths = Object.keys(dataByMonth).sort((a, b) => {
        const [yearA, monthA] = a.split('-');
        const [yearB, monthB] = b.split('-');
        return yearA.localeCompare(yearB) || monthA.localeCompare(monthB);
    });

    sortedMonths.forEach(monthYear => {
        const [year, month] = monthYear.split('-');
        const monthName = monthNames[parseInt(month) - 1];
        let totalCard = 0;
        let totalCash = 0;
        let totalSales = 0;

        y = drawTableHeader(tableX, y, monthName, year);

        const monthData = dataByMonth[monthYear].sort((a, b) => a.date.localeCompare(b.date));
        monthData.forEach(data => {
            y = drawTableRow(tableX, y, data.date, data.card, data.cash, data.total);
            totalCard += data.card;
            totalCash += data.cash;
            totalSales += data.total;

            if (y > doc.internal.pageSize.getHeight() - 20) {
                doc.addPage();
                y = margin;
                y = drawTableHeader(tableX, y, monthName, year);
            }
        });

        y += 5;
        y = drawTotalRow(tableX, y, totalCard, totalCash, totalSales, monthName);
        doc.addPage();
        y = margin;
    });

    if (doc.getNumberOfPages() > 1 && y === margin) {
        doc.deletePage(doc.getNumberOfPages());
    }

    const fileName = 'Perso_Livre_des_Recettes_Chez_Barth.pdf';
    doc.save(fileName);

// Message de confirmation
setTimeout(() => {
    alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);

    // 🧪 Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
}, 500);
}


function exportRecipeToPdfofficiel() {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 10;
    let y = margin;

    const colWidths = [30, 35, 35, 35, 60];
    const rowHeight = 8;
    const tableX = margin;

    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

    const dataByMonth = {};
    Object.keys(salesData).forEach(dateKey => {
        const [year, month] = dateKey.split('-');
        const monthYear = `${year}-${month}`;
        if (!dataByMonth[monthYear]) {
            dataByMonth[monthYear] = [];
        }
        dataByMonth[monthYear].push({
            date: dateKey,
            ...salesData[dateKey]
        });
    });

    const drawTableHeader = (x, y, month, year) => {
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.rect(margin, y, pageWidth - 2 * margin, 20);
        doc.text(`LIVRE DES RECETTES ${month} ${year}`, pageWidth / 2, y + 8, { align: 'center' });
        doc.text('Chez BARTH 16 place des Prêcheurs 13100 Aix en Provence SIRET : 93253222900014', pageWidth / 2, y + 16, { align: 'center' });
        y += 25;
        doc.setFontSize(10);
        doc.rect(x, y, colWidths[0], rowHeight); doc.text('Date', x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte B', x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Espèce', x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TOTAL Ventes', x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Origine', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTableRow = (x, y, date, card, cash, total) => {
        doc.setFont('helvetica', 'normal');
        // Extract only YYYY-MM-DD from date string
        const cleanDate = date.split('T')[0];
        const dateParts = cleanDate.split('-');
        const dateStr = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        const adjustedCash = Math.floor(cash / 2);
        const adjustedTotal = card + adjustedCash;
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(dateStr, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${card} €`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${adjustedCash} €`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${adjustedTotal} €`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight);
        doc.text('Vente Sandwichs à emporter', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const drawTotalRow = (x, y, totalCard, totalAdjustedCash, totalSales, month) => {
        doc.setFont('helvetica', 'bold');
        const adjustedTotalSales = totalCard + totalAdjustedCash;
        doc.rect(x, y, colWidths[0], rowHeight); doc.text(`Total ${month}`, x + 2, y + 6);
        doc.rect(x + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${totalCard} €`, x + colWidths[0] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalAdjustedCash} €`, x + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${adjustedTotalSales} €`, x + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('', x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        return y + rowHeight;
    };

    const sortedMonths = Object.keys(dataByMonth).sort((a, b) => {
        const [yearA, monthA] = a.split('-');
        const [yearB, monthB] = b.split('-');
        return yearA.localeCompare(yearB) || monthA.localeCompare(monthB);
    });

    sortedMonths.forEach(monthYear => {
        const [year, month] = monthYear.split('-');
        const monthName = monthNames[parseInt(month) - 1];
        let totalCard = 0;
        let totalAdjustedCash = 0;

        y = drawTableHeader(tableX, y, monthName, year);

        const monthData = dataByMonth[monthYear].sort((a, b) => a.date.localeCompare(b.date));
        monthData.forEach(data => {
            const adjustedCash = Math.floor(data.cash / 2);
            y = drawTableRow(tableX, y, data.date, data.card, data.cash, data.total);
            totalCard += data.card;
            totalAdjustedCash += adjustedCash;

            if (y > doc.internal.pageSize.getHeight() - 20) {
                doc.addPage();
                y = margin;
                y = drawTableHeader(tableX, y, monthName, year);
            }
        });

        y += 5;
        y = drawTotalRow(tableX, y, totalCard, totalAdjustedCash, 0, monthName);
        doc.addPage();
        y = margin;
    });

    if (doc.getNumberOfPages() > 1 && y === margin) {
        doc.deletePage(doc.getNumberOfPages());
    }

    const fileName = 'Livre_des_Recettes_officiel_Chez_Barth.pdf'; 
    doc.save(fileName);

    // Message de confirmation
    setTimeout(() => {
    alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);

    // Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
    }, 500);

}

let selectedRecipeDate = null;

function showRecipeDetail(date) {
    selectedRecipeDate = date;
    const data = salesData[date];

    if (!data) return;

    document.getElementById('recipeDetailDate').textContent = `Date : ${formatRecipeDate(new Date(date))}`;
    document.getElementById('recipeDetailCard').textContent = `Carte : ${data.card} €`;
    document.getElementById('recipeDetailCash').textContent = `Espèces : ${data.cash} €`;
    document.getElementById('recipeDetailTotal').textContent = `Total : ${data.total} €`;

    document.getElementById('recipeDetailPopup').classList.remove('hidden');
}

function closeRecipeDetail() {
    document.getElementById('recipeDetailPopup').classList.add('hidden');
    selectedRecipeDate = null;
}

function deleteSelectedRecipe() {
    if (selectedRecipeDate && salesData[selectedRecipeDate]) {
        if (confirm("Supprimer cette vente ?")) {
            delete salesData[selectedRecipeDate];
            localStorage.setItem('salesData', JSON.stringify(salesData));
            closeRecipeDetail();
            filterRecipes(); // met à jour la liste
            alert("Vente supprimée !");
        }
    }
}


function filterRecipes() {
    const start = document.getElementById('recipeStartDate').value;
    const end = document.getElementById('recipeEndDate').value;
    const list = document.getElementById('recipeList');
    list.innerHTML = '';

    // Définir les dates avec valeurs par défaut comme dans filterPurchases
    const startDate = start ? new Date(start + 'T00:00:00') : new Date('2024-01-01');
    const endDate = end ? new Date(end + 'T23:59:59') : new Date();

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Carte (€)</th>
            <th>Espèces (€)</th>
            <th>Total (€)</th>
        </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Totaux à calculer
    let totalCard = 0;
    let totalCash = 0;
    let totalGeneral = 0;

    Object.keys(salesData)
        .sort()
        .forEach(date => {
            const saleDate = new Date(date);
            if (
                (!start || saleDate >= startDate) &&
                (!end || saleDate <= endDate)
            ) {
                const data = salesData[date];
                const row = document.createElement('tr');

                // Ligne cliquable
                row.style.cursor = 'pointer';
                row.onclick = () => showRecipeDetail(date);

                // Affichage avec arrondis et €
                row.innerHTML = `
                    <td>${formatRecipeDate(saleDate)}</td>
                    <td>${Math.round(data.card)} €</td>
                    <td>${Math.round(data.cash)} €</td>
                    <td>${Math.round(data.total)} €</td>
                `;

                // Ajouter au total
                totalCard += data.card;
                totalCash += data.cash;
                totalGeneral += data.total;

                tbody.appendChild(row);
            }
        });

    table.appendChild(tbody);

    // Pied du tableau avec les totaux arrondis + €
    const tfoot = document.createElement('tfoot');
    tfoot.innerHTML = `
        <tr>
            <th>Total</th>
            <th>${Math.round(totalCard)} €</th>
            <th>${Math.round(totalCash)} €</th>
            <th>${Math.round(totalGeneral)} €</th>
        </tr>
    `;
    table.appendChild(tfoot);

    // Ajouter le titre avec les dates formatées comme dans filterPurchases
    list.innerHTML = `<h3>Liste des ventes du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>`;
    list.appendChild(table);
}




function saveSalesData() {
    try {
        localStorage.setItem('salesData', JSON.stringify(salesData));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des ventes:', e);
        alert('Erreur lors de la sauvegarde des ventes.');
    }
}

function deleteSale(date) {
    if (confirm('Voulez-vous vraiment supprimer cette entrée de vente ?')) {
        delete salesData[date]; // Supprime l'entrée pour la date donnée
        saveSalesData(); // Sauvegarde les modifications
        filterRecipes(); // Met à jour l'affichage
    }
}

    function printAllRecipes() {
    const startDateInput = document.getElementById('recipeStartDate').value;
    const endDateInput = document.getElementById('recipeEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredSales = Object.entries(salesData).filter(([date]) => {
        const saleDate = new Date(date);
        return saleDate >= startDate && saleDate <= endDate;
    }).sort((a, b) => new Date(a[0]) - new Date(b[0]));

    if (filteredSales.length === 0) {
        alert("Aucune vente à télécharger dans cette période.");
        return;
    }

    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;

    doc.setFontSize(12);
    doc.text(`Chez Barth-Liste des ventes du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Espèce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    filteredSales.forEach(([date, data]) => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Liste des ventes du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Espèce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(new Date(date).toLocaleDateString('fr-FR'), tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${Math.round(data.card)}€`, tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${Math.round(data.cash)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${Math.round(data.total)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        y += rowHeight;
    });

    if (y > doc.internal.pageSize.getHeight() - margin - 20) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    let totalCard = 0, totalCash = 0, totalSales = 0;
    filteredSales.forEach(([_, data]) => {
        totalCard += data.card;
        totalCash += data.cash;
        totalSales += data.total;
    });
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${Math.round(totalCard)}€`, tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${Math.round(totalCash)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${Math.round(totalSales)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);

    window.open(doc.output('bloburl'), '_blank');
}

function downloadRecipesPDF() {
    const startDateInput = document.getElementById('recipeStartDate').value;
    const endDateInput = document.getElementById('recipeEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredSales = Object.entries(salesData).filter(([date]) => {
        const saleDate = new Date(date);
        return saleDate >= startDate && saleDate <= endDate;
    }).sort((a, b) => new Date(a[0]) - new Date(b[0]));

    if (filteredSales.length === 0) {
        alert("Aucune vente à télécharger dans cette période.");
        return;
    }

    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;

    doc.setFontSize(12);
    doc.text(`Chez Barth-Liste des ventes du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Espèce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    filteredSales.forEach(([date, data]) => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Liste des ventes du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Ventes Carte', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Ventes Espèce', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Total Ventes', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(new Date(date).toLocaleDateString('fr-FR'), tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${Math.round(data.card)}€`, tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${Math.round(data.cash)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${Math.round(data.total)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        y += rowHeight;
    });

    if (y > doc.internal.pageSize.getHeight() - margin - 20) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    let totalCard = 0, totalCash = 0, totalSales = 0;
    filteredSales.forEach(([_, data]) => {
        totalCard += data.card;
        totalCash += data.cash;
        totalSales += data.total;
    });
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(`${Math.round(totalCard)}€`, tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${Math.round(totalCash)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${Math.round(totalSales)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);

    const fileName = 'Liste_ventes_Chez_Barth.pdf'; 
    doc.save(fileName);

    // Message de confirmation
    setTimeout(() => {
    alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);

    // Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
    }, 500);

}

    // --- Facture ---
    function loadMenuFromStorage() {
    try {
        const storedMenu = localStorage.getItem('menu');
        if (storedMenu) {
            menu = JSON.parse(storedMenu);
        } else {
            menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato à la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre étudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
            ];
            saveMenuToStorage();
        }
        updateMenuTvaRates(); // Initialiser les taux au chargement
    } catch (e) {
        console.error('Erreur lors du chargement du menu:', e);
        menu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato à la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre étudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
        ];
        updateMenuTvaRates(); // Initialiser les taux au chargement
    }
}

    

    function saveCAStatus() {
        const caBelow = document.getElementById('caBelow85000').checked;
        localStorage.setItem('caStatus', caBelow ? 'below' : 'above');
    }

   function toggleCA(checkbox) {
    const belowCheckbox = document.getElementById('caBelow85000');
    const aboveCheckbox = document.getElementById('caAbove85000');

    // S'assurer qu'une seule case est cochée à la fois
    if (checkbox.id === 'caBelow85000' && checkbox.checked) {
        aboveCheckbox.checked = false;
        caBelow85000 = true;
    } else if (checkbox.id === 'caAbove85000' && checkbox.checked) {
        belowCheckbox.checked = false;
        caBelow85000 = false;
    } else if (!belowCheckbox.checked && !aboveCheckbox.checked) {
        // Si aucune case n'est cochée, on coche par défaut CA > 85000€
        aboveCheckbox.checked = true;
        caBelow85000 = false;
    }

    // Sauvegarder l'état dans localStorage
    localStorage.setItem('caBelow85000', JSON.stringify(caBelow85000));

    // Mettre à jour les taux de TVA et recalculer les prix
    updateMenuTvaRates();
}





function addNewProduct() {
    const name = document.getElementById('newProductName').value.trim();
    const priceTTC = parseFloat(document.getElementById('newProductPriceTTC').value);
    const type = document.getElementById('newProductType').value;

    if (!name || isNaN(priceTTC) || priceTTC <= 0) {
        alert('Veuillez entrer un nom valide et un prix TTC supérieur à 0.');
        return;
    }

    if (menu.some(item => item.name === name)) {
        alert('Ce produit existe déjà.');
        return;
    }

    const tvaRate = type === 'S' ? 0.1 : 0.055;
    const priceHT = priceTTC / (1 + tvaRate);

    const newProduct = {
        name: name,
        priceTTC: priceTTC,
        priceHT: parseFloat(priceHT.toFixed(2)),
        type: type,
        tvaRate: tvaRate
    };

    menu.push(newProduct);
    saveMenuToStorage();
    updateProductList(); // Mettre à jour la liste dans "COMMANDE A FACTURER"
    document.getElementById('menuActionArea').innerHTML = '';
    document.getElementById('menuDropdown').classList.remove('show');
    alert(`Produit "${name}" ajouté avec succès !`);
}

// Conserver cette fonction pour référence future, mais elle n'est pas utilisée ici
function addProduct() {
    const productSelect = document.getElementById('productSelect');
    const selectedProductName = productSelect.value;
    const product = menu.find(p => p.name === selectedProductName);
    if (product) {
        order.push({ ...product });
        updateOrderList();
        document.getElementById('menuActionArea').innerHTML = '';
        document.getElementById('menuDropdown').classList.remove('show');
    }
}

function deleteProduct() {
    const productSelectDelete = document.getElementById('productSelectDelete');
    const selectedProductName = productSelectDelete.value;
    const index = menu.findIndex(p => p.name === selectedProductName);
    if (index !== -1 && confirm(`Voulez-vous vraiment supprimer ${selectedProductName} du menu ?`)) {
        menu.splice(index, 1);
        saveMenuToStorage();
        document.getElementById('menuActionArea').innerHTML = '';
        document.getElementById('menuDropdown').classList.remove('show');
    }
}

// Fonction existante pour mettre à jour le menu déroulant et la liste des produits
function updateProductList() {
    const productSelect = document.getElementById('productSelect');
    const productList = document.getElementById('productList');
    
    // Mise à jour du menu déroulant
    productSelect.innerHTML = menu.map(item => 
        `<option value="${item.name}">${item.name} (${item.priceTTC.toFixed(2)}€)</option>`
    ).join('');
    
    // Mise à jour de la liste des produits dans COMMANDE-FACTURE
    productList.innerHTML = menu.map(item => 
        `<li><input type="checkbox" value="${item.name}"> ${item.name} (${item.priceTTC.toFixed(2)}€)</li>`
    ).join('');
}

// Nouvelle fonction pour supprimer un produit
function deleteProductFromMenu() {
    const selectedProduct = document.getElementById('productSelect').value;
    if (!selectedProduct) {
        alert("Veuillez sélectionner un produit à supprimer.");
        return;
    }

    if (confirm(`Tu veux supprimer le produit "${selectedProduct}" ?`)) {
        // Supprimer le produit de la liste menu
        menu = menu.filter(item => item.name !== selectedProduct);
        
        // Sauvegarder dans localStorage
        saveMenuToStorage();
        
        // Mettre à jour immédiatement les affichages
        updateProductList();
        updateOrderList(); // Si un produit supprimé est dans la commande en cours
        alert(`Le produit "${selectedProduct}" a été supprimé avec succès.`);
    } else {
        // Ne rien faire si "Non" est choisi
        return;
    }
}

// Modification de la fonction showMenuAction pour l'ajout
function showMenuAction(action) {
    const menuActionArea = document.getElementById('menuActionArea');
    if (action === 'add') {
        menuActionArea.innerHTML = `
            <input type="text" id="newProductName" placeholder="Nom du produit">
            <input type="number" id="newProductPrice" placeholder="Prix TTC (€)" step="0.01" min="0">
            <select id="newProductType">
                <option value="S">Sandwich/Dessert</option>
                <option value="B">Boisson</option>
            </select>
            <button onclick="confirmAddProduct()">Confirmer l'ajout du produit</button>
        `;
    } else {
        menuActionArea.innerHTML = '';
    }
}

// Nouvelle fonction pour confirmer l'ajout d'un produit
function confirmAddProduct() {
    const name = document.getElementById('newProductName').value.trim();
    const priceTTC = parseFloat(document.getElementById('newProductPrice').value);
    const type = document.getElementById('newProductType').value;

    if (!name || isNaN(priceTTC) || priceTTC <= 0) {
        alert("Veuillez entrer un nom valide et un prix supérieur à 0.");
        return;
    }

    // Calculer le prix HT selon le type et le statut CA
    const tvaRate = caBelow85000 ? 0 : (type === "B" ? 0.055 : 0.1);
    const priceHT = priceTTC / (1 + tvaRate);

    const newProduct = {
        name: name,
        priceTTC: priceTTC,
        priceHT: priceHT,
        type: type,
        tvaRate: tvaRate
    };

    // Ajouter le produit au menu
    menu.push(newProduct);
    
    // Sauvegarder dans localStorage
    saveMenuToStorage();
    
    // Mettre à jour immédiatement les affichages
    updateProductList();
    document.getElementById('menuActionArea').innerHTML = ''; // Vider la zone d'ajout
    
    // Message de confirmation
    alert(`Ton produit "${name}" est bien ajouté !`);
}

// Fonction existante pour sauvegarder le menu dans localStorage
function saveMenuToStorage() {
    try {
        localStorage.setItem('menu', JSON.stringify(menu));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde du menu:', e);
        alert('Erreur lors de la sauvegarde du menu.');
    }
}

// Fonction existante pour gérer le dropdown
function toggleDropdown(dropdownId) {
    document.getElementById(dropdownId).classList.toggle('show');
}

function toggleProduct(productName) {
    // Ne plus ajouter ou supprimer de order ici pour éviter les doublons
    // Cette fonction ne gère que l'état visuel des cases
    updateOrderList(); // Optionnel : mettre à jour si besoin, mais pas nécessaire ici
}

function addSelectedToOrder() {
    const checkboxes = document.querySelectorAll('#productList input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        alert('Veuillez sélectionner au moins un produit.');
        return;
    }
    checkboxes.forEach(checkbox => {
        const productName = checkbox.value;
        const product = menu.find(p => p.name === productName);
        if (product) {
            order.push({ ...product });
        }
    });

// Ajout : Mettre à jour le mode de paiement global
    currentPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'Non spécifié';

    updateOrderList();
    // Décocher toutes les cases après ajout
    document.querySelectorAll('#productList input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('commandeDropdown').classList.remove('show');
}

function updateOrderList() {
    const orderList = document.getElementById('orderList');
    const orderTotal = document.getElementById('orderTotal');
    const invoiceHeader = document.getElementById('invoiceHeader');
    const caBelow = document.getElementById('caBelow85000').checked;

    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    invoiceHeader.innerHTML = `
        <table style="width: 100%; max-width: 600px; margin: 0 auto; font-size: 12px; border-collapse: collapse;">
            <tr>
                <td style="text-align: center;">
                    <div style="width: 100%; margin: 0 auto;">
                        <div>CHEZ BARTH</div>
                        <div>16 place des Prêcheurs 13100 Aix en Provence</div>
                        <div>Téléphone : 09 77 53 78 71</div>
                        <div>Ent Indiv SIRET : 93253222900014 - APE : 56.10C</div>
                    </div>
                </td>
            </tr>
            <tr>
                <td style="text-align: center;">
                    Fact N° ${invoiceCounter + 1} Facture du ${new Date().toLocaleDateString('fr-FR')}
                    ${caBelow ? '<div style="margin-top: 10px; font-weight: bold;">(TVA non applicable art 293B du CGI)</div>' : ''}
                </td>
            </tr>
        </table>
    `;

    orderList.innerHTML = caBelow ? `
        <table style="width: 100%; max-width: 600px; margin: 0 auto;">
            <tr><th style="text-align: left;">Produit</th><th>Prix TTC</th></tr>
            ${order.map(item => `<tr><td style="padding-right: 20px;">${item.name}</td><td>${item.priceTTC.toFixed(2)}€</td></tr>`).join('')}
        </table>
    ` : `
        <table style="width: 100%; max-width: 600px; margin: 0 auto;">
            <tr><th style="text-align: left;">Produit</th><th>Prix HT</th><th>Prix TTC</th></tr>
            ${order.map(item => `<tr><td style="padding-right: 20px;">${item.name}</td><td>${item.priceHT.toFixed(2)}€</td><td>${item.priceTTC.toFixed(2)}€</td></tr>`).join('')}
        </table>
    `;

    orderTotal.innerHTML = caBelow ? `
        <table class="total-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
            <tr><td><strong>Total TTC:</strong></td><td><strong>${totalTTC.toFixed(2)}€</strong></td></tr>
            <tr><td>Paiement</td><td>${currentPaymentMethod}</td></tr>
            <tr><td colspan="2" style="text-align: left; font-style: italic;">Chez Barth vous remercie de votre visite.<br>A bientôt !</td></tr>
        </table>
    ` : `
        <table class="total-table" style="width: 100%; max-width: 600px; margin: 0 auto;">
  <tr><td>Total HT:</td><td>${totalHT.toFixed(2)}€</td></tr>
  <tr><td>TVA 5.5%:</td><td>${totalTVA55.toFixed(2)}€</td></tr>
  <tr><td>TVA 10%:</td><td>${totalTVA10.toFixed(2)}€</td></tr>
  <tr><td><strong>Total TTC:</strong></td><td><strong>${totalTTC.toFixed(2)}€</strong></td></tr>
  <tr><td>Paiement</td><td>${currentPaymentMethod}</td></tr>
  <tr>
    <td colspan="2" style="text-align: left; font-style: italic; border: none;">
      Chez Barth vous remercie de votre visite.<br>A bientôt !
    </td>
  </tr>
</table>

    `;
}



function clearOrder() {
    order = [];
    updateOrderList();
}

function saveInvoice() {
    if (order.length === 0) {
        alert("Veuillez ajouter des produits à la facture avant d'enregistrer");
        return;
    }

    invoiceCounter++;
    const invoiceNumber = invoiceCounter;
    const timestamp = new Date().toISOString();
    const caBelow = document.getElementById('caBelow85000').checked;

    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    const invoice = {
        number: invoiceNumber,
        date: timestamp,
        items: [...order],
        caBelow: caBelow,
        totalHT: totalHT,
        totalTVA55: totalTVA55,
        totalTVA10: totalTVA10,
        totalTTC: totalTTC,
        paymentMethod: currentPaymentMethod
    };

    invoices.push(invoice);
    saveInvoicesToStorage();

     const invoiceHeader = document.getElementById('invoiceHeader');
    invoiceHeader.innerHTML = `
        <table style="width: 100%; max-width: 600px; margin: 0 auto; font-size: 12px; border-collapse: collapse; box-sizing: border-box;">
            <tr>
                <td style="text-align: center;">
                    <div style="text-align: center;">
                        <div>CHEZ BARTH</div>
                        <div>16 place des Prêcheurs 13100 Aix en Provence</div>
                        <div>Téléphone : 09 77 53 78 71</div>
                        <div>Ent Indiv SIRET : 93253222900014 - APE : 56.10C</div>
                    </div>
                </td>
            </tr>
            <tr>
                <td style="text-align: center;">
                    Fact N° ${invoiceNumber} Facture du ${new Date().toLocaleDateString('fr-FR')}
                    ${caBelow ? '<div style="margin-top: 10px; font-weight: bold;">(TVA non applicable art 293B du CGI)</div>' : ''}
                </td>
            </tr>
        </table>
    `;

    alert(`Facture enregistrée avec succès sous le numéro ${invoiceNumber}`);
}

function exportInvoiceToPdf() {
    const invoiceContainer = document.getElementById('invoiceContainer');

    // 1. Extraction du numéro de facture depuis l'élément affiché
    // Supposons que tu as quelque part dans l'invoiceContainer du texte comme "Fact N°12345"
    const invoiceNumberMatch = invoiceContainer.innerText.match(/Fact(?:ure)? N°\s*(\d+)/i);
    const invoiceNumber = invoiceNumberMatch ? invoiceNumberMatch[1] : 'Inconnue';

    // 2. Générer un nom de fichier avec date + numéro de facture
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Fact_N°${invoiceNumber}_${dateStr}_Facture_Chez_Barth.pdf`;

    // 3. Génération du PDF
    html2canvas(invoiceContainer, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#FFFFFF'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });

        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        pdf.save(fileName);

        // Message et ouverture
        setTimeout(() => {
            alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);

            const blob = pdf.output('blob');
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        }, 500);
    });
}



function printInvoice() {
    const invoiceContainer = document.getElementById('invoiceContainer');
    html2canvas(invoiceContainer, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#FFFFFF'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        window.open(pdf.output('bloburl'), '_blank');
    });
}

function sendInvoiceBySms() {
    if (order.length === 0) {
        alert("Veuillez ajouter des produits à la facture avant d'envoyer par SMS");
        return;
    }

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const date = new Date();

    // Ajout de caractères invisibles pour éviter la détection automatique
    const preventAutoLink = str => str.split('').join('\u200C');
    const formattedDate = preventAutoLink(date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }));

    let smsText = "Facture Chez Barth - " + formattedDate + "\n\n";
    smsText += "CHEZ BARTH\n";
    smsText += "16\u200B place\u200B des\u200B Prêcheurs\n";
    smsText += preventAutoLink("13100") + "\u200B Aix\u200B en\u200B Provence\n";
    smsText += "Tel: 09\u200B77\u200B53\u200B78\u200B71\n";
    smsText += "SIRET: " + preventAutoLink("93253222900014") + "\n";
    smsText += "APE: 56.10C\nEntreprise Individuelle\n\n";

    const caBelow = document.getElementById('caBelow85000').checked;
    if (caBelow) {
    smsText += `Fact N° ${invoiceCounter} du ${formattedDate}\n`;
    smsText += "TVA non applicable art 293B du CGI\n\n";
    smsText += "Détail:\n";
    order.forEach(item => {
        smsText += `${item.name}: ${item.priceTTC.toFixed(2)}€ TTC\n`;
    });
} else {
    smsText += `Fact N° ${invoiceCounter} du ${formattedDate}\n\n`;
    smsText += "Detail:\n";
    order.forEach(item => {
        smsText += `${item.name}: ${item.priceHT.toFixed(2)}€ HT / ${item.priceTTC.toFixed(2)}€ TTC\n`;
    });
}


    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    if (caBelow) {
        smsText += `\nTotal TTC: ${totalTTC.toFixed(2)}€\n`;
        smsText += `Paiement: ${currentPaymentMethod}\n\n`;
    } else {
        smsText += `\nTotal HT: ${totalHT.toFixed(2)}€\n`;
        smsText += `TVA 5.5%: ${totalTVA55.toFixed(2)}€\n`;
        smsText += `TVA 10%: ${totalTVA10.toFixed(2)}€\n`;
        smsText += `Total TTC: ${totalTTC.toFixed(2)}€\n`;
        smsText += `Paiement: ${currentPaymentMethod}\n\n`;
    }

    smsText += "Chez Barth vous remercie de votre visite.\nA bientôt !";

    const phoneNumber = prompt("Entrez le numéro de téléphone (ex: 06....):");
    if (!phoneNumber) return;

    const cleanNumber = phoneNumber.replace(/\s/g, '').replace(/-/g, '');
    const smsUrl = `sms:${cleanNumber}?body=${encodeURIComponent(smsText)}`;

    if (isMobile) {
        window.location.href = smsUrl;
    } else {
        try {
            window.location.href = smsUrl;
        } catch (e) {
            alert("Impossible d'ouvrir l'application SMS.\n\nCopiez ce texte :\n\n" + smsText);
            navigator.clipboard.writeText(smsText);
        }
    }
}


function sendInvoiceByEmail() {
    const caBelow = document.getElementById('caBelow85000').checked;
    let totalHT = 0;
    let totalTVA55 = 0;
    let totalTVA10 = 0;
    order.forEach(item => {
        totalHT += item.priceHT;
        if (item.tvaRate === 0.055) totalTVA55 += item.priceTTC - item.priceHT;
        else totalTVA10 += item.priceTTC - item.priceHT;
    });
    const totalTTC = totalHT + totalTVA55 + totalTVA10;

    const date = new Date();
    const formattedDate = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
    
    // Corps détaillé pour email avec toutes les informations
    let emailBody = "Facture Chez BARTH\n";
    emailBody += "16" + "\u200B" + " place" + "\u200B" + " des" + "\u200B" + " Prêcheurs," + "\u200B" + " 13100" + "\u200B" + " Aix" + "\u200B" + " en" + "\u200B" + " Provence\n";
    emailBody += "Tel: 09" + "\u200B" + "77" + "\u200B" + "53" + "\u200B" + "78" + "\u200B" + "71\n";
    emailBody += "Ent. Indiv. SIRET: 932" + "\u200B" + "532" + "\u200B" + "229" + "\u200B" + "00014 - APE: 56.10C\n";
    emailBody += `Fact N° ${invoiceCounter} - ${formattedDate}${caBelow ? ' (TVA non applicable)' : ''}\n`;
    emailBody += "----------------------------\n";
    order.forEach(item => {
        if (caBelow) {
            emailBody += `${item.name}: ${item.priceTTC.toFixed(2)}€\n`;
        } else {
            emailBody += `${item.name}: ${item.priceHT.toFixed(2)}€ HT / ${item.priceTTC.toFixed(2)}€ TTC\n`;
        }
    });
    emailBody += "----------------------------\n";
    if (!caBelow) {
        emailBody += `Total HT: ${totalHT.toFixed(2)}€\n`;
        emailBody += `TVA 5.5%: ${totalTVA55.toFixed(2)}€\n`;
        emailBody += `TVA 10%: ${totalTVA10.toFixed(2)}€\n`;
    }
    emailBody += `Total TTC: ${totalTTC.toFixed(2)}€\n`;
    emailBody += `Paiement: ${currentPaymentMethod}\n`;
    emailBody += `\n`;
    emailBody += "Chez Barth vous remercie de votre visite. A Bientôt !";
   

    const emailUrl = `mailto:?subject=Facture Chez BARTH&body=${encodeURIComponent(emailBody)}`;
    window.open(emailUrl);
}

async function printToBluetoothThermal() {
    if (!navigator.bluetooth) {
        alert("Web Bluetooth API n'est pas disponible.");
        return;
    }

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        let text = "CHEZ BARTH\n16 place des Precheurs\n13100 Aix en Provence\n\n";
        text += `Facture du ${new Date().toLocaleDateString('fr-FR')}\n\n`;
        text += "-------------------------------\n";
        order.forEach(item => {
            text += `${item.name.padEnd(20)} ${item.priceTTC.toFixed(2)}€\n`;
        });
        const totalTTC = order.reduce((sum, item) => sum + item.priceTTC, 0).toFixed(2);
        text += "-------------------------------\n";
        text += `Total TTC: ${totalTTC}€\n`;
        text += `Paiement: ${currentPaymentMethod}\n\n`;
        text += "\nMerci de votre visite !\n\n";

        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\x1B\x64\x02\x1D\x56\x00');
        await characteristic.writeValue(data);

        alert("Impression Bluetooth réussie !");
        server.disconnect();
    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de l'impression Bluetooth : " + error.message);
    }
}

function filterInvoices() {
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredInvoices = invoices.filter(invoice => {
        const invoiceDate = new Date(invoice.date);
        return invoiceDate >= startDate && invoiceDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    // Calcul des totaux par méthode de paiement
    let totalHTCard = 0, totalTVA55Card = 0, totalTVA10Card = 0, totalTTCCard = 0;
    let totalHTCash = 0, totalTVA55Cash = 0, totalTVA10Cash = 0, totalTTCCash = 0;
    let totalHT = 0, totalTVA55 = 0, totalTVA10 = 0, totalTTC = 0;

    filteredInvoices.forEach(invoice => {
        const ht = invoice.items.reduce((sum, item) => sum + item.priceHT, 0);
        const tva55 = invoice.items
            .filter(item => item.tvaRate === 0.055)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const tva10 = invoice.items
            .filter(item => item.tvaRate === 0.1)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const ttc = invoice.totalTTC;

        if (invoice.paymentMethod === 'Carte') {
            totalHTCard += ht;
            totalTVA55Card += tva55;
            totalTVA10Card += tva10;
            totalTTCCard += ttc;
        } else if (invoice.paymentMethod === 'Espèce') {
            totalHTCash += ht;
            totalTVA55Cash += tva55;
            totalTVA10Cash += tva10;
            totalTTCCash += ttc;
        }

        totalHT += ht;
        totalTVA55 += tva55;
        totalTVA10 += tva10;
        totalTTC += ttc;
    });

    const invoiceList = document.getElementById('invoiceList');
    invoiceList.innerHTML = `
        <h3>Liste des Commandes factures du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
        <div style="overflow-x: auto; width: 100%;">
            <table style="width: 100%; max-width: 100%; table-layout: auto; border-collapse: collapse; font-size: 14px;">
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 5px; text-align: left;">Fact N°</th>
                    <th style="padding: 5px; text-align: left;">Date</th>
                    <th style="padding: 5px; text-align: right;">Total HT</th>
                    <th style="padding: 5px; text-align: right;">TVA 5,5%</th>
                    <th style="padding: 5px; text-align: right;">TVA 10%</th>
                    <th style="padding: 5px; text-align: right;">Total TTC</th>
                    <th style="padding: 5px; text-align: left;">Paiement</th>
                </tr>
                ${filteredInvoices.map(invoice => `
                    <tr onclick="viewInvoiceDetail(${invoice.number})" style="cursor: pointer;">
                        <td style="padding: 5px;">${invoice.number}</td>
                        <td style="padding: 5px;">${new Date(invoice.date).toLocaleDateString('fr-FR')}</td>
                        <td style="padding: 5px; text-align: right;">${invoice.items.reduce((sum, item) => sum + item.priceHT, 0).toFixed(2)}€</td>
                        <td style="padding: 5px; text-align: right;">${invoice.items.filter(item => item.tvaRate === 0.055).reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0).toFixed(2)}€</td>
                        <td style="padding: 5px; text-align: right;">${invoice.items.filter(item => item.tvaRate === 0.1).reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0).toFixed(2)}€</td>
                        <td style="padding: 5px; text-align: right;">${invoice.totalTTC.toFixed(2)}€</td>
                        <td style="padding: 5px;">${invoice.paymentMethod || 'Non spécifié'}</td>
                    </tr>
                `).join('')}
                <tr style="height: 10px;"><td colspan="7"></td></tr>
                <tr style="background-color: #f9f9f9;">
                    <td colspan="2" style="padding: 5px;"><strong>Total Carte</strong></td>
                    <td style="padding: 5px; text-align: right;">${totalHTCard.toFixed(2)}€</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA55Card.toFixed(2)}€</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA10Card.toFixed(2)}€</td>
                    <td style="padding: 5px; text-align: right;">${totalTTCCard.toFixed(2)}€</td>
                    <td style="padding: 5px;"></td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td colspan="2" style="padding: 5px;"><strong>Total Espèce</strong></td>
                    <td style="padding: 5px; text-align: right;">${totalHTCash.toFixed(2)}€</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA55Cash.toFixed(2)}€</td>
                    <td style="padding: 5px; text-align: right;">${totalTVA10Cash.toFixed(2)}€</td>
                    <td style="padding: 5px; text-align: right;">${totalTTCCash.toFixed(2)}€</td>
                    <td style="padding: 5px;"></td>
                </tr>
                <tr style="background-color: #f2f2f2;">
                    <td colspan="2" style="padding: 5px;"><strong>Total Général</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalHT.toFixed(2)}€</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalTVA55.toFixed(2)}€</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalTVA10.toFixed(2)}€</strong></td>
                    <td style="padding: 5px; text-align: right;"><strong>${totalTTC.toFixed(2)}€</strong></td>
                    <td style="padding: 5px;"></td>
                </tr>
            </table>
        </div>
    `;
}

function viewInvoiceDetail(number) {
    const invoice = invoices.find(i => i.number === number);
    if (!invoice) return;

    showInvoiceDetail();
    const invoiceDetailContainer = document.getElementById('invoiceDetailContainer');
    invoiceDetailContainer.dataset.invoiceNumber = invoice.number;
    const date = new Date(invoice.date).toLocaleDateString('fr-FR');
    invoiceDetailContainer.innerHTML = `
        <div id="invoiceHeader">
            CHEZ BARTH<br>
            16 place des Prêcheurs<br>
            13100 Aix en Provence<br>
            Téléphone : 09 77 53 78 71<br>
            Ent Indiv SIRET : 93253222900014<br>
            APE : 56.10C<br>
            <br>
            <div class="invoice-number">Fact N° ${invoice.number} Facture du ${date}</div>
            <div class="invoice-number" style="margin-top: 10px; font-weight: bold;">${invoice.caBelow ? '(TVA non applicable art 293B du CGI)' : ''}</div>
            <br>
        </div>
        <div id="orderList">
            ${invoice.caBelow ? `
                <table>
                    <tr><th style="text-align: left;">Produits</th><th>Prix TTC</th></tr>
                    ${invoice.items.map(item => `<tr><td style="padding-right: 20px;">${item.name}</td><td>${item.priceTTC.toFixed(2)}€</td></tr>`).join('')}
                </table>
            ` : `
                <table>
                    <tr><th style="text-align: left;">Produit</th><th>Prix HT</th><th>Prix TTC</th></tr>
                    ${invoice.items.map(item => `<tr><td style="padding-right: 20px;">${item.name}</td><td>${item.priceHT.toFixed(2)}€</td><td>${item.priceTTC.toFixed(2)}€</td></tr>`).join('')}
                </table>
            `}
            <br>
        </div>
        <div id="orderTotal">
            ${invoice.caBelow ? `
                <table class="total-table">
                    <tr><td><strong>Total TTC:</strong></td><td><strong>${invoice.totalTTC.toFixed(2)}€</strong></td></tr>
                </table>
            ` : `
                <table class="total-table">
                    <tr><td>Total HT:</td><td>${invoice.totalHT.toFixed(2)}€</td></tr>
                    <tr><td>TVA 5.5%:</td><td>${invoice.totalTVA55.toFixed(2)}€</td></tr>
                    <tr><td>TVA 10%:</td><td>${invoice.totalTVA10.toFixed(2)}€</td></tr>
                    <tr><td><strong>Total TTC:</strong></td><td><strong>${invoice.totalTTC.toFixed(2)}€</strong></td></tr>
                    <tr><td>Paiement :</td><td>${invoice.paymentMethod || 'Non spécifié'}</td></tr>
                </table>
            `}
        </div>
        <div id="invoiceFooter" style="text-align: left; margin-top: 20px; font: inherit; font-style: italic;">
            Chez Barth vous remercie de votre visite.<br>A bientôt !
        </div>
    `;
}

function printInvoiceDetail() {
    const element = document.getElementById('invoiceDetailContainer');
    html2canvas(element, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#FFFFFF'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
        window.open(pdf.output('bloburl'), '_blank');
    });
}

function deleteInvoiceDetail() {
    const invoiceDetailContainer = document.getElementById('invoiceDetailContainer');
    const invoiceNumber = invoiceDetailContainer.dataset.invoiceNumber;

    if (!invoiceNumber) {
        alert("Erreur : Aucune facture sélectionnée.");
        return;
    }

    const invoiceNumberParsed = parseInt(invoiceNumber, 10);
    const index = invoices.findIndex(i => i.number === invoiceNumberParsed);

    if (index === -1) {
        alert("Erreur : Facture non trouvée dans la liste.");
        return;
    }

    if (confirm("Voulez-vous vraiment supprimer cette facture ? Cette action est irréversible.")) {
        invoices.splice(index, 1);
        saveInvoicesToStorage();
        console.log('Après suppression - invoices:', invoices);
     
        showInvoiceManagement();
        filterInvoices();
    }
}

function printAllInvoices() {
    const startDateInput = document.getElementById('startDate').value;
    const endDateInput = document.getElementById('endDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredInvoices = invoices.filter(invoice => {
        const invoiceDate = new Date(invoice.date);
        return invoiceDate >= startDate && invoiceDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (filteredInvoices.length === 0) {
        alert("Aucune facture à imprimer dans cette période.");
        return;
    }

    // Calcul des totaux par méthode de paiement
    let totalHTCard = 0, totalTVA55Card = 0, totalTVA10Card = 0, totalTTCCard = 0;
    let totalHTCash = 0, totalTVA55Cash = 0, totalTVA10Cash = 0, totalTTCCash = 0;
    let totalHT = 0, totalTVA55 = 0, totalTVA10 = 0, totalTTC = 0;

    filteredInvoices.forEach(invoice => {
        const ht = invoice.items.reduce((sum, item) => sum + item.priceHT, 0);
        const tva55 = invoice.items
            .filter(item => item.tvaRate === 0.055)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const tva10 = invoice.items
            .filter(item => item.tvaRate === 0.1)
            .reduce((sum, item) => sum + (item.priceTTC - item.priceHT), 0);
        const ttc = invoice.totalTTC;

        if (invoice.paymentMethod === 'Carte') {
            totalHTCard += ht;
            totalTVA55Card += tva55;
            totalTVA10Card += tva10;
            totalTTCCard += ttc;
        } else if (invoice.paymentMethod === 'Espèce') {
            totalHTCash += ht;
            totalTVA55Cash += tva55;
            totalTVA10Cash += tva10;
            totalTTCCash += ttc;
        }

        totalHT += ht;
        totalTVA55 += tva55;
        totalTVA10 += tva10;
        totalTTC += ttc;
    });

    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = [15, 30, 30, 30, 30, 30, 20]; // Current widths
    const rowHeight = 10;
    const tableX = margin;

    doc.setFontSize(12);
    doc.text(`Chez Barth-Liste des Commandes factures du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Fact N°', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Date', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Total HT', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TVA 5,5%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('TVA 10%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text('Total TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    filteredInvoices.forEach(invoice => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Liste des Commandes factures du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Fact N°', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Date', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Total HT', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('TVA 5,5%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('TVA 10%', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text('Total TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(`${invoice.number}`, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(new Date(invoice.date).toLocaleDateString('fr-FR'), tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${invoice.totalHT.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${invoice.totalTVA55.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${invoice.totalTVA10.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${invoice.totalTTC.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text(`${invoice.paymentMethod || 'Non spécifié'}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
        y += rowHeight;
    });

    // Ajout d'une ligne vide
    y += rowHeight;

    // Ajout des totaux
    if (y > doc.internal.pageSize.getHeight() - margin - 40) {
        doc.addPage();
        y = margin;
    }

    // Total par Carte
    doc.setFont('helvetica', 'normal');
    doc.rect(tableX, y, colWidths[0] + colWidths[1], rowHeight); doc.text('Total Carte', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalHTCard.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalTVA55Card.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${totalTVA10Card.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${totalTTCCard.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    // Total par Espèce
    doc.rect(tableX, y, colWidths[0] + colWidths[1], rowHeight); doc.text('Total Espèce', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalHTCash.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalTVA55Cash.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${totalTVA10Cash.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${totalTTCCash.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    // Total Général
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0] + colWidths[1], rowHeight); doc.text('Total Général', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(`${totalHT.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(`${totalTVA55.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(`${totalTVA10.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); doc.text(`${totalTTC.toFixed(2)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5], y, colWidths[6], rowHeight); doc.text('', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + colWidths[5] + 2, y + 6);
    y += rowHeight;

    window.open(doc.output('bloburl'), '_blank');
}

 // --- Achats ---
let purchaseCurrentDate = new Date();
let purchases = [];

const initialPurchases = [
    { "date": "2024-12-09T00:00:00Z", "amountTTC": 940, "type": "Alimentaire", "payment": "Espèce", "comment": "" },
    { "date": "2024-12-10T00:00:00Z", "amountTTC": 1747, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-11T00:00:00Z", "amountTTC": 35, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-11T00:00:00Z", "amountTTC": 122, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-12T00:00:00Z", "amountTTC": 16, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-12T00:00:00Z", "amountTTC": 259, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-13T00:00:00Z", "amountTTC": 13, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-14T00:00:00Z", "amountTTC": 18, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-16T00:00:00Z", "amountTTC": 31, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-16T00:00:00Z", "amountTTC": 226, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-17T00:00:00Z", "amountTTC": 21, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-18T00:00:00Z", "amountTTC": 18, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-18T00:00:00Z", "amountTTC": 192, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-19T00:00:00Z", "amountTTC": 23, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-19T00:00:00Z", "amountTTC": 114, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-20T00:00:00Z", "amountTTC": 12, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-21T00:00:00Z", "amountTTC": 21, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-23T00:00:00Z", "amountTTC": 16, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-23T00:00:00Z", "amountTTC": 292, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-24T00:00:00Z", "amountTTC": 14, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-27T00:00:00Z", "amountTTC": 5, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-27T00:00:00Z", "amountTTC": 263, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-28T00:00:00Z", "amountTTC": 17, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-30T00:00:00Z", "amountTTC": 20, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2024-12-30T00:00:00Z", "amountTTC": 407, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2024-12-31T00:00:00Z", "amountTTC": 17, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-02T00:00:00Z", "amountTTC": 13, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-03T00:00:00Z", "amountTTC": 19, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-03T00:00:00Z", "amountTTC": 233, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-04T00:00:00Z", "amountTTC": 15, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-06T00:00:00Z", "amountTTC": 10, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-06T00:00:00Z", "amountTTC": 297, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-07T00:00:00Z", "amountTTC": 18, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-08T00:00:00Z", "amountTTC": 26, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-08T00:00:00Z", "amountTTC": 519, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-09T00:00:00Z", "amountTTC": 22, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-10T00:00:00Z", "amountTTC": 33, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-10T00:00:00Z", "amountTTC": 381, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-11T00:00:00Z", "amountTTC": 23, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-13T00:00:00Z", "amountTTC": 28, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-14T00:00:00Z", "amountTTC": 16, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-15T00:00:00Z", "amountTTC": 25, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-15T00:00:00Z", "amountTTC": 301, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-16T00:00:00Z", "amountTTC": 24, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-17T00:00:00Z", "amountTTC": 29, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-18T00:00:00Z", "amountTTC": 18, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-20T00:00:00Z", "amountTTC": 25, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-20T00:00:00Z", "amountTTC": 371, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-21T00:00:00Z", "amountTTC": 27, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-22T00:00:00Z", "amountTTC": 27, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-22T00:00:00Z", "amountTTC": 404, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-23T00:00:00Z", "amountTTC": 18, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-24T00:00:00Z", "amountTTC": 47, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-25T00:00:00Z", "amountTTC": 43, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-27T00:00:00Z", "amountTTC": 49, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-27T00:00:00Z", "amountTTC": 758, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-28T00:00:00Z", "amountTTC": 22, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-28T00:00:00Z", "amountTTC": 344, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-01-29T00:00:00Z", "amountTTC": 49, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-30T00:00:00Z", "amountTTC": 29, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-31T00:00:00Z", "amountTTC": 43, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-01-31T00:00:00Z", "amountTTC": 134, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-01T00:00:00Z", "amountTTC": 27, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-01T00:00:00Z", "amountTTC": 502, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-03T00:00:00Z", "amountTTC": 31, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-03T00:00:00Z", "amountTTC": 286, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-04T00:00:00Z", "amountTTC": 25, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-05T00:00:00Z", "amountTTC": 41, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-05T00:00:00Z", "amountTTC": 380, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-06T00:00:00Z", "amountTTC": 47, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-07T00:00:00Z", "amountTTC": 40, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-07T00:00:00Z", "amountTTC": 473, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-08T00:00:00Z", "amountTTC": 30, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-10T00:00:00Z", "amountTTC": 52, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-10T00:00:00Z", "amountTTC": 930, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-10T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-02-11T00:00:00Z", "amountTTC": 88, "type": "Pain", "payment": "Espèce", "comment": "" },
    { "date": "2025-02-11T00:00:00Z", "amountTTC": 270, "type": "Alimentaire", "payment": "Espèce", "comment": "" },
    { "date": "2025-02-11T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-02-12T00:00:00Z", "amountTTC": 123, "type": "Pain", "payment": "Espèce", "comment": "" },
    { "date": "2025-02-12T00:00:00Z", "amountTTC": 845, "type": "Alimentaire", "payment": "Espèce", "comment": "" },
    { "date": "2025-02-12T00:00:00Z", "amountTTC": 400, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-02-13T00:00:00Z", "amountTTC": 129, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-13T00:00:00Z", "amountTTC": 376, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-13T00:00:00Z", "amountTTC": 570, "type": "Autre", "payment": "Carte", "comment": "enseigne carte" },
    { "date": "2025-02-14T00:00:00Z", "amountTTC": 113, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-14T00:00:00Z", "amountTTC": 100, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-02-15T00:00:00Z", "amountTTC": 900, "type": "Autre", "payment": "Espèce", "comment": "Rançon et enseigne" },
    { "date": "2025-02-17T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-17T00:00:00Z", "amountTTC": 1206, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-18T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-18T00:00:00Z", "amountTTC": 258, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-18T00:00:00Z", "amountTTC": 44, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-02-19T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-19T00:00:00Z", "amountTTC": 48, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-20T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-20T00:00:00Z", "amountTTC": 369, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-21T00:00:00Z", "amountTTC": 94, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-22T00:00:00Z", "amountTTC": 259, "type": "Autre", "payment": "Carte", "comment": "Frigo" },
    { "date": "2025-02-24T00:00:00Z", "amountTTC": 84, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-24T00:00:00Z", "amountTTC": 397, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-02-24T00:00:00Z", "amountTTC": 82, "type": "Autre", "payment": "Carte", "comment": "Action" },
    { "date": "2025-02-25T00:00:00Z", "amountTTC": 84, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-25T00:00:00Z", "amountTTC": 29, "type": "Autre", "payment": "Carte", "comment": "Tampon" },
    { "date": "2025-02-26T00:00:00Z", "amountTTC": 84, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-02-26T00:00:00Z", "amountTTC": 19, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-01T00:00:00Z", "amountTTC": 404, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-02T00:00:00Z", "amountTTC": 353, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-03T00:00:00Z", "amountTTC": 960, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-04T00:00:00Z", "amountTTC": 72, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-04T00:00:00Z", "amountTTC": 100, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-05T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-05T00:00:00Z", "amountTTC": 95, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-06T00:00:00Z", "amountTTC": 83, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-06T00:00:00Z", "amountTTC": 201, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-07T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-07T00:00:00Z", "amountTTC": 266, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-09T00:00:00Z", "amountTTC": 12, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-10T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-10T00:00:00Z", "amountTTC": 207, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-11T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-11T00:00:00Z", "amountTTC": 131, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-11T00:00:00Z", "amountTTC": 41, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-12T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-12T00:00:00Z", "amountTTC": 148, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-13T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-13T00:00:00Z", "amountTTC": 117, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-13T00:00:00Z", "amountTTC": 140, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-14T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-14T00:00:00Z", "amountTTC": 17, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-16T00:00:00Z", "amountTTC": 254, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-17T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-17T00:00:00Z", "amountTTC": 155, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-18T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-18T00:00:00Z", "amountTTC": 167, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-19T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-19T00:00:00Z", "amountTTC": 25, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-19T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-03-20T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-20T00:00:00Z", "amountTTC": 170, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-21T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-24T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-24T00:00:00Z", "amountTTC": 256, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-25T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-25T00:00:00Z", "amountTTC": 441, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-25T00:00:00Z", "amountTTC": 30, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-26T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-26T00:00:00Z", "amountTTC": 204, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 334, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 18, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-27T00:00:00Z", "amountTTC": 500, "type": "Autre", "payment": "Carte", "comment": "pub" },
    { "date": "2025-03-28T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-03-28T00:00:00Z", "amountTTC": 292, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-28T00:00:00Z", "amountTTC": 193, "type": "Autre", "payment": "Carte", "comment": "" },
    { "date": "2025-03-29T00:00:00Z", "amountTTC": 432, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-03-31T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-01T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-01T00:00:00Z", "amountTTC": 420, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-02T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-03T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-03T00:00:00Z", "amountTTC": 456, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-04T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-04T00:00:00Z", "amountTTC": 5, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-07T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-07T00:00:00Z", "amountTTC": 108, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-08T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-08T00:00:00Z", "amountTTC": 631, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-09T00:00:00Z", "amountTTC": 438, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-10T00:00:00Z", "amountTTC": 44, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-11T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-11T00:00:00Z", "amountTTC": 185, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-14T00:00:00Z", "amountTTC": 56, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-14T00:00:00Z", "amountTTC": 267, "type": "Alimentaire", "payment": "Carte", "comment": "" },
    { "date": "2025-04-15T00:00:00Z", "amountTTC": 45, "type": "Pain", "payment": "Carte", "comment": "" },
    { "date": "2025-04-15T00:00:00Z", "amountTTC": 239, "type": "Alimentaire", "payment": "Carte", "comment": "" }
  ];



function loadPurchases() {
    try {
        const storedPurchases = localStorage.getItem('purchases');
        if (!storedPurchases || storedPurchases === '[]') {
            // Si le localStorage est vide ou contient un tableau vide, on charge les données initiales
            purchases = [...initialPurchases];
            localStorage.setItem('purchases', JSON.stringify(purchases));
            console.log('Données initiales chargées :', purchases);
        } else {
            purchases = JSON.parse(storedPurchases);
            console.log('Données chargées depuis localStorage :', purchases);
        }
    } catch (e) {
        console.error('Erreur avec localStorage pour les achats:', e);
        // En cas d'erreur, on charge les données initiales par défaut
        purchases = [...initialPurchases];
        localStorage.setItem('purchases', JSON.stringify(purchases));
    }
}

function savePurchases() {
    try {
        localStorage.setItem('purchases', JSON.stringify(purchases));
        console.log('Données sauvegardées dans localStorage :', purchases);
        alert('Données enregistrées avec succès !');
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des achats:', e);
        alert('Erreur lors de la sauvegarde des achats.');
    }
}

function formatRecipeDate(date) {
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function getISODate(date) {
    return date.toISOString();
}

function updatePurchaseDisplay() {
    document.getElementById('currentPurchaseDate').textContent = formatRecipeDate(purchaseCurrentDate);
    document.getElementById('purchaseAmount').value = '';
    document.querySelectorAll('input[name="purchaseType"]').forEach(input => input.checked = false);
    document.getElementById('purchaseComment').value = '';

}

function addPurchase() {
    const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
    const type = document.querySelector('input[name="purchaseType"]:checked')?.value;
    const payment = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    const comment = document.getElementById('purchaseComment').value;

    if (!amount || !type || !payment) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return;
    }

    const purchase = {
        date: getISODate(purchaseCurrentDate),
        amountTTC: amount,
        type: type,
        payment: payment,
        comment: comment
    };

    purchases.push(purchase);
    savePurchases();
    updatePurchaseDisplay();
}

document.getElementById('prevPurchaseDay').addEventListener('click', () => {
    purchaseCurrentDate.setDate(purchaseCurrentDate.getDate() - 1);
    updatePurchaseDisplay();
});

document.getElementById('nextPurchaseDay').addEventListener('click', () => {
    purchaseCurrentDate.setDate(purchaseCurrentDate.getDate() + 1);
    updatePurchaseDisplay();
});

function deletePurchase(index) {
    if (confirm('Voulez-vous vraiment supprimer cet achat ?')) {
        purchases.splice(index, 1);
        savePurchases();
        filterPurchases();
    }
}

function filterPurchases() {
    const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    const showComments = document.getElementById('showPurchaseComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    const purchasesList = document.getElementById('purchasesList');

    // Calculate subtotals by type and payment method
    const totalsByType = { Pain: 0, Alimentaire: 0, Matériel: 0, Autre: 0 };
    const totalsByPayment = { Carte: 0, Espèce: 0 };
    let grandTotal = 0;

    filteredPurchases.forEach(purchase => {
        totalsByType[purchase.type] += purchase.amountTTC;
        totalsByPayment[purchase.payment] += purchase.amountTTC;
        grandTotal += purchase.amountTTC;
    });

    // Generate the table with purchases and totals
    purchasesList.innerHTML = `
        <h3>Liste des achats du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
        <div class="table-container">
            <table>
                <tr>
                    <th>Date</th>
                    <th>Montant TTC (€)</th>
                    <th>Type</th>
                    <th>Paiement</th>
                    ${showComments ? '<th>Commentaire</th>' : ''}
                </tr>
                ${filteredPurchases.map((purchase, index) => `
                    <tr style="cursor:pointer" onclick="showPurchaseDetailFromIndex(${index})">
                        <td>${new Date(purchase.date).toLocaleDateString('fr-FR')}</td>
                        <td>${Math.round(purchase.amountTTC)} €</td>
                        <td>${purchase.type}</td>
                        <td>${purchase.payment}</td>
                        ${showComments ? `<td>${purchase.comment || ''}</td>` : ''}
                    </tr>
                `).join('')}
                ${Object.keys(totalsByType).map(type => `
                    <tr>
                        <td style="color:#003366; font-weight:bold;">Total ${type}</td>
                        <td style="color:#003366; font-weight:bold;">${Math.round(totalsByType[type])} €</td>
                        <td></td><td></td>
                        ${showComments ? '<td></td>' : ''}
                    </tr>
                `).join('')}
                ${Object.keys(totalsByPayment).map(payment => `
                    <tr>
                        <td style="color:green; font-weight:bold;">Total ${payment}</td>
                        <td style="color:green; font-weight:bold;">${Math.round(totalsByPayment[payment])} €</td>
                        <td></td><td></td>
                        ${showComments ? '<td></td>' : ''}
                    </tr>
                `).join('')}
                <tr>
                    <td style="font-weight:bold;">Total Général</td>
                    <td style="font-weight:bold;">${Math.round(grandTotal)} €</td>
                    <td></td><td></td>
                    ${showComments ? '<td></td>' : ''}
                </tr>
            </table>
        </div>
    `;
}


let selectedPurchaseIndex = null;

function showPurchaseDetailFromIndex(index) {
    selectedPurchaseIndex = index;
    const purchase = purchases[index];
    if (!purchase) return;

    document.getElementById('purchaseDetailDate').textContent = `Date : ${formatRecipeDate(new Date(purchase.date))}`;
    document.getElementById('purchaseDetailAmount').textContent = `Montant : ${purchase.amountTTC.toFixed(2)} €`;
    document.getElementById('purchaseDetailType').textContent = `Type : ${purchase.type}`;
    document.getElementById('purchaseDetailPayment').textContent = `Paiement : ${purchase.payment}`;
    document.getElementById('purchaseDetailComment').textContent = `Commentaire : ${purchase.comment || 'Aucun'}`;

    document.getElementById('purchaseDetailPopup').classList.remove('hidden');
}

function closePurchaseDetail() {
    document.getElementById('purchaseDetailPopup').classList.add('hidden');
    selectedPurchaseIndex = null;
}

function deleteSelectedPurchase() {
    if (selectedPurchaseIndex !== null) {
        if (confirm("Supprimer cet achat ?")) {
            purchases.splice(selectedPurchaseIndex, 1);
            savePurchases();
            filterPurchases();
            closePurchaseDetail();
            alert("Achat supprimé !");
        }
    }
}



function printPurchases() {
   const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    const showComments = document.getElementById('showPurchaseComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (filteredPurchases.length === 0) {
        alert("Aucune donnée d'achat à télécharger.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    const pageHeight = doc.internal.pageSize.height;
    let y = margin;
    const colWidths = showComments ? [38, 38, 38, 38, 38] : [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;

    const drawHeader = () => {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Type', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
            doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        }
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text('Montant TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
    };

    // Totaux
    const totalsByType = { Pain: 0, Alimentaire: 0, Matériel: 0, Autre: 0 };
    const totalsByPayment = { Carte: 0, Espèce: 0 };
    let totalTTC = 0;

    // Titre
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Chez Barth-Liste des achats du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    drawHeader();
    doc.setFont('helvetica', 'normal');

    for (let i = 0; i < filteredPurchases.length; i++) {
        const purchase = filteredPurchases[i];
        const dateStr = new Date(purchase.date).toLocaleDateString('fr-FR');
        const type = purchase.type;
        const payment = purchase.payment;
        const comment = purchase.comment || '';
        const amount = Math.round(purchase.amountTTC);

        totalsByType[type] += purchase.amountTTC;
        totalsByPayment[payment] += purchase.amountTTC;
        totalTTC += purchase.amountTTC;

        // Vérifie si une nouvelle page est nécessaire
        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            drawHeader();
        }

        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(type, tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(payment, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
            doc.text(comment, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        }
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text(`${amount}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);

        y += rowHeight;
    }

    // Totaux (type, paiement, général)
    const printTotalRow = (label, value, color = 'black') => {
        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }

        doc.setFont('helvetica', 'bold');
        doc.setTextColor(color);
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(label, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text(`${Math.round(value)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
        doc.setTextColor('black');
    };

    ['Pain', 'Alimentaire', 'Matériel', 'Autre'].forEach(type => {
        printTotalRow(`Total ${type}`, totalsByType[type], '#003366');
    });

    printTotalRow('Par Carte', totalsByPayment['Carte'], 'green');
    printTotalRow('Par Espèce', totalsByPayment['Espèce'], 'green');
    printTotalRow('Total Général', totalTTC, 'black');

    // Afficher dans un nouvel onglet
    window.open(doc.output('bloburl'), '_blank');
}

function downloadPurchasesPDF() {
    const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    const showComments = document.getElementById('showPurchaseComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (filteredPurchases.length === 0) {
        alert("Aucune donnée d'achat à télécharger.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    const pageHeight = doc.internal.pageSize.height;
    let y = margin;
    const colWidths = showComments ? [38, 38, 38, 38, 38] : [38, 38, 38, 38];
    const rowHeight = 10;
    const tableX = margin;

    const drawHeader = () => {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Type', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Paiement', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
            doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        }
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text('Montant TTC', tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
    };

    // Totaux
    const totalsByType = { Pain: 0, Alimentaire: 0, Matériel: 0, Autre: 0 };
    const totalsByPayment = { Carte: 0, Espèce: 0 };
    let totalTTC = 0;

    // Titre
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Chez Barth-Liste des achats du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    drawHeader();
    doc.setFont('helvetica', 'normal');

    for (let i = 0; i < filteredPurchases.length; i++) {
        const purchase = filteredPurchases[i];
        const dateStr = new Date(purchase.date).toLocaleDateString('fr-FR');
        const type = purchase.type;
        const payment = purchase.payment;
        const comment = purchase.comment || '';
        const amount = Math.round(purchase.amountTTC);

        totalsByType[type] += purchase.amountTTC;
        totalsByPayment[payment] += purchase.amountTTC;
        totalTTC += purchase.amountTTC;

        // Vérifie si une nouvelle page est nécessaire
        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
            drawHeader();
        }

        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(dateStr, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(type, tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(payment, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        if (showComments) {
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
            doc.text(comment, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        }
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text(`${amount}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);

        y += rowHeight;
    }

    // Totaux (type, paiement, général)
    const printTotalRow = (label, value, color = 'black') => {
        if (y + rowHeight > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }

        doc.setFont('helvetica', 'bold');
        doc.setTextColor(color);
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(label, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0), y, colWidths[showComments ? 4 : 3], rowHeight);
        doc.text(`${Math.round(value)}€`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + (showComments ? colWidths[3] : 0) + 2, y + 6);
        y += rowHeight;
        doc.setTextColor('black');
    };

    ['Pain', 'Alimentaire', 'Matériel', 'Autre'].forEach(type => {
        printTotalRow(`Total ${type}`, totalsByType[type], '#003366');
    });

    printTotalRow('Par Carte', totalsByPayment['Carte'], 'green');
    printTotalRow('Par Espèce', totalsByPayment['Espèce'], 'green');
    printTotalRow('Total Général', totalTTC, 'black');

  const startStr = startDate.toLocaleDateString('fr-CA'); // format YYYY-MM-DD
  const endStr = endDate.toLocaleDateString('fr-CA');


  const fileName = 'Chez_Barth_Achats_${startStr}_au_${endStr}.pdf'; 
    doc.save(fileName);

    // Message de confirmation
    setTimeout(() => {
    alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);

    // Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
    }, 500);


}



async function printPurchasesToBluetooth() {
    const startDateInput = document.getElementById('purchaseStartDate').value;
    const endDateInput = document.getElementById('purchaseEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
    });

    if (filteredPurchases.length === 0) {
        alert("Aucune donnée d'achat à imprimer.");
        return;
    }

    if (!navigator.bluetooth) {
        alert("Web Bluetooth API n'est pas disponible.");
        return;
    }

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        let text = "CHEZ BARTH\n16 place des Precheurs\n13100 Aix en Provence\n\n";
        text += `Achats du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}\n`;
        text += "-------------------------------\n";
        text += "Date   Type   Paiement   Montant\n";
        text += "-------------------------------\n";

        // Totaux
        let totalPain = 0, totalFood = 0, totalEquipment = 0, totalOther = 0;
        let totalCard = 0, totalCash = 0;
        let grandTotal = 0;

        filteredPurchases.forEach(purchase => {
            const dateStr = new Date(purchase.date).toLocaleDateString('fr-FR').substring(0, 5);
            const typeStr = purchase.type.substring(0, 6).padEnd(6);
            const paymentStr = purchase.payment.substring(0, 6).padEnd(6);
            const amount = Math.round(purchase.amountTTC);

            text += `${dateStr} ${typeStr} ${paymentStr} ${amount}€\n`;

            if (purchase.type === 'Pain') totalPain += purchase.amountTTC;
            if (purchase.type === 'Alimentaire') totalFood += purchase.amountTTC;
            if (purchase.type === 'Matériel') totalEquipment += purchase.amountTTC;
            if (purchase.type === 'Autre') totalOther += purchase.amountTTC;

            if (purchase.payment === 'Carte') totalCard += purchase.amountTTC;
            if (purchase.payment === 'Espèce') totalCash += purchase.amountTTC;

            grandTotal += purchase.amountTTC;
        });

        text += "-------------------------------\n";
        text += `Total Pain       : ${Math.round(totalPain)}€\n`;
        text += `Total Alimentaire: ${Math.round(totalFood)}€\n`;
        text += `Total Matériel   : ${Math.round(totalEquipment)}€\n`;
        text += `Total Autre      : ${Math.round(totalOther)}€\n`;
        text += `-------------------------------\n`;
        text += `Par Carte        : ${Math.round(totalCard)}€\n`;
        text += `Par Espèce       : ${Math.round(totalCash)}€\n`;
        text += `-------------------------------\n`;
        text += `TOTAL GÉNÉRAL    : ${Math.round(grandTotal)}€\n\n`;

        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\x1B\x64\x02\x1D\x56\x00'); // Fin + découpe ticket
        await characteristic.writeValue(data);

        alert("Impression Bluetooth réussie !");
        server.disconnect();
    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de l'impression Bluetooth : " + error.message);
    }
}

async function printSalesToBluetooth() {
    if (!navigator.bluetooth) {
        alert("Bluetooth non supporté sur ce navigateur.");
        return;
    }

    // Génération du texte à imprimer
    const startDate = document.getElementById('recipeStartDate').value;
    const endDate = document.getElementById('recipeEndDate').value;
    let filtered = Object.entries(salesData)
        .filter(([date]) => {
            if (!startDate && !endDate) return true;
            const d = new Date(date);
            return (!startDate || d >= new Date(startDate)) &&
                   (!endDate || d <= new Date(endDate));
        })
        .sort(([a], [b]) => new Date(a) - new Date(b));

    let total = 0;
    let text = "BILAN DES VENTES\n";
    text += `Du ${startDate || "début"} au ${endDate || "aujourd'hui"}\n\n`;

    filtered.forEach(([date, data]) => {
        const jour = new Date(date).toLocaleDateString('fr-FR');
        const montant = Math.round(data.total);
        total += montant;
        text += `${jour} : ${montant}€\n`;
    });

    text += `\nTOTAL GÉNÉRAL : ${Math.round(total)}€\n`;

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] // ou le bon UUID de ton imprimante
        });

        console.log("Imprimante sélectionnée :", device.name);

        // 🔧 À adapter selon ton imprimante : ici, on alerte seulement
        alert("Texte à imprimer :\n\n" + text);

        // 👉 Si tu as déjà une fonction `sendTextToPrinter(text, device)` comme pour les achats,
        // tu peux l'appeler ici :
        // await sendTextToPrinter(text, device);

    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de la connexion à l'imprimante Bluetooth.");
    }
}


// Initialisation au démarrage
loadPurchases();
updatePurchaseDisplay();

// --- Personnel ---
let personnelCurrentDate = new Date();
let personnelRecords = [];
let employees = ["Tom", "Marylou", "Florentin"]; // Ajout de Florentin comme employé existant

const initialPersonnelRecords = [
    { date: "2024-12-09T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-10T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-11T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-12T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-14T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-15T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-16T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-17T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-18T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-19T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-20T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-21T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-22T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-23T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-24T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-25T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-26T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2024-12-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2024-12-28T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2024-12-29T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2024-12-30T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "20", hours: 2.67 },
    { date: "2024-12-31T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "20", hours: 3 },
    { date: "2025-01-01T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-02T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-03T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-04T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-05T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-06T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-07T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-08T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-09T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-10T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-11T00:00:00Z", employee: "Florentin", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-12T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-14T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-15T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-16T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-17T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-18T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-19T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-20T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-21T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-22T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-23T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-24T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-25T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-26T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-01-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-28T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-01-29T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-30T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "44", hours: 2.67 },
    { date: "2025-01-31T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "44", hours: 3 },
    { date: "2025-02-01T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-02T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-03T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "60", hours: 2.67 },
    { date: "2025-02-04T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-05T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "60", hours: 2.67 },
    { date: "2025-02-06T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "60", hours: 2.67 },
    { date: "2025-02-07T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-08T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-09T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-10T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-11T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-12T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "90", hours: 2.67 },
    { date: "2025-02-14T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-15T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-16T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-17T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-18T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-19T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-02-20T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "90", hours: 2.67 },
    { date: "2025-02-21T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "60", hours: 3 },
    { date: "2025-02-22T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-23T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-02-24T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-02-25T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "50", hours: 3 },
    { date: "2025-02-26T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "40", hours: 2.67 },
    { date: "2025-02-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "40", hours: 2.67 },
    { date: "2025-02-28T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "180", hours: 3 },
    { date: "2025-03-01T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-02T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-03T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "10", hours: 2.67 },
    { date: "2025-03-04T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-05T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "50", hours: 2.67 },
    { date: "2025-03-06T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-07T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-08T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-09T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-10T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-03-11T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-12T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "40", hours: 2.67 },
    { date: "2025-03-13T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2025-03-14T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "80", hours: 3 },
    { date: "2025-03-15T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-16T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-17T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-03-18T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-19T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "80", hours: 2.67 },
    { date: "2025-03-20T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "90", hours: 2.67 },
    { date: "2025-03-21T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "30", hours: 3 },
    { date: "2025-03-22T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-23T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-24T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-03-25T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-03-26T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "30", hours: 2.67 },
    { date: "2025-03-27T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "148", hours: 2.67 },
    { date: "2025-03-28T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "65", hours: 3 },
    { date: "2025-03-29T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-30T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-03-31T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "200", hours: 2.67 },
    { date: "2025-04-01T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-02T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-03T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-04T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-05T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-06T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-07T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-08T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-09T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-10T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 },
    { date: "2025-04-11T00:00:00Z", employee: "Marylou", startTime: "12:00", endTime: "15:00", comment: "", hours: 3 },
    { date: "2025-04-12T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-13T00:00:00Z", employee: "", startTime: "", endTime: "", comment: "", hours: 0 },
    { date: "2025-04-14T00:00:00Z", employee: "Tom", startTime: "12:00", endTime: "14:40", comment: "", hours: 2.67 }
];

function loadEmployees() {
    try {
        const storedEmployees = localStorage.getItem('employees');
        if (storedEmployees) {
            employees = JSON.parse(storedEmployees);
        } else {
            employees = ["Tom", "Marylou", "Florentin"];
            localStorage.setItem('employees', JSON.stringify(employees));
        }
    } catch (e) {
        console.error('Erreur avec localStorage pour les employés:', e);
        employees = ["Tom", "Marylou", "Florentin"];
        localStorage.setItem('employees', JSON.stringify(employees));
    }
}

function saveEmployees() {
    try {
        localStorage.setItem('employees', JSON.stringify(employees));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des employés:', e);
        alert('Erreur lors de la sauvegarde des employés.');
    }
}

function loadPersonnelRecords() {
    try {
        const storedRecords = localStorage.getItem('personnelRecords');
        console.log('Stored Records from localStorage:', storedRecords);
        if (!storedRecords || storedRecords === '[]') {
            console.log('Aucun enregistrement trouvé ou tableau vide, chargement des données initiales');
            personnelRecords = [...initialPersonnelRecords];
            localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
            console.log('Données initiales chargées :', personnelRecords);
        } else {
            personnelRecords = JSON.parse(storedRecords);
            console.log('Données chargées depuis localStorage :', personnelRecords);
        }
    } catch (e) {
        console.error('Erreur avec localStorage pour le personnel:', e);
        alert('Problème de stockage des données du personnel détecté.');
        personnelRecords = [...initialPersonnelRecords];
        localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
        console.log('Données réinitialisées aux valeurs initiales :', personnelRecords);
    }
}

function savePersonnelRecords() {
    try {
        localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
    } catch (e) {
        console.error('Erreur lors de la sauvegarde des données du personnel:', e);
        alert('Erreur lors de la sauvegarde des données du personnel.');
    }
}

loadEmployees();
loadPersonnelRecords();

const employeeSelect = document.getElementById('employeeSelect');
const startTimeInput = document.getElementById('startTime');
const endTimeInput = document.getElementById('endTime');
const personnelCommentInput = document.getElementById('personnelComment');
const hoursTotalInput = document.getElementById('hoursTotal');
const prevPersonnelDay = document.getElementById('prevPersonnelDay');
const nextPersonnelDay = document.getElementById('nextPersonnelDay');
const currentPersonnelDateSpan = document.getElementById('currentPersonnelDate');

function updateEmployeeSelect() {
    employeeSelect.innerHTML = employees.map(emp => `<option value="${emp}">${emp}</option>`).join('');
}

function addEmployee() {
    const newEmployee = prompt("Entrez le nom du nouvel employé :");
    if (newEmployee && !employees.includes(newEmployee)) {
        employees.push(newEmployee);
        saveEmployees();
        updateEmployeeSelect();
    } else if (newEmployee) {
        alert("Cet employé existe déjà.");
    }
}

function deleteEmployee() {
    const selectedEmployee = employeeSelect.value;
    if (confirm(`Voulez-vous vraiment supprimer l'employé ${selectedEmployee} ?`)) {
        employees = employees.filter(emp => emp !== selectedEmployee);
        saveEmployees();
        updateEmployeeSelect();
    }
}

function formatPersonnelDate(date) {
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function getISODate(date) {
    return date.toISOString();
}

function updatePersonnelDisplay() {
    currentPersonnelDateSpan.textContent = formatPersonnelDate(personnelCurrentDate);
    updateEmployeeSelect();
    startTimeInput.value = '';
    endTimeInput.value = '';
    personnelCommentInput.value = '';
    hoursTotalInput.value = '';
    hoursTotalConvertedInput.value = '';
}

function parseTimeInput(input) {
    let value = input.trim();
    if (!value) return '00:00';

    if (value.includes(':')) {
        const parts = value.split(':');
        let hours = parseInt(parts[0], 10) || 0;
        let minutes = parts[1] ? parseInt(parts[1], 10) || 0 : 0;
        if (hours > 23 || minutes > 59) return '00:00';
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    let num = parseInt(value, 10);
    if (isNaN(num)) return '00:00';

    let hours, minutes;
    if (value.length === 1 || value.length === 2) {
        hours = num;
        minutes = 0;
    } else if (value.length === 3) {
        hours = Math.floor(num / 100);
        minutes = num % 100;
    } else if (value.length === 4) {
        hours = Math.floor(num / 100);
        minutes = num % 100;
    } else {
        return '00:00';
    }

    if (hours > 23 || minutes > 59) return '00:00';

    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

function normalizeTimeInput(time) {
    if (!time) return '00:00';
    const parts = time.split(':');
    if (parts.length === 1) return `${parts[0].padStart(2, '0')}:00`;
    return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
}

function calculateHours() {
    console.log('Raw Start:', startTimeInput.value, 'Raw End:', endTimeInput.value);

    let start = normalizeTimeInput(parseTimeInput(startTimeInput.value));
    let end = normalizeTimeInput(parseTimeInput(endTimeInput.value));

    console.log('Formatted Start:', start, 'Formatted End:', end);

    if (start && end) {
        const startDate = new Date(`2024-01-01T${start}:00`);
        let endDate = new Date(`2024-01-01T${end}:00`);
        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }
        const diffMs = endDate - startDate;
        const hours = diffMs / (1000 * 60 * 60);
        hoursTotalInput.value = hours.toFixed(2);
        console.log('Hours:', hours);
        return hours;
    }
    hoursTotalInput.value = '0.00';
    return 0;
}

function convertToHoursMinutes(decimalHours) {
    const hours = Math.floor(decimalHours);
    const minutes = Math.round((decimalHours - hours) * 60);
    return `${hours}h${minutes}`;
}

const hoursTotalConvertedInput = document.getElementById('hoursTotalConverted');

startTimeInput.addEventListener('blur', () => {
    startTimeInput.value = parseTimeInput(startTimeInput.value);
    const hours = calculateHours();
    hoursTotalConvertedInput.value = convertToHoursMinutes(hours);
});

endTimeInput.addEventListener('blur', () => {
    endTimeInput.value = parseTimeInput(endTimeInput.value);
    const hours = calculateHours();
    hoursTotalConvertedInput.value = convertToHoursMinutes(hours);
});

function addPersonnelHours() {
    const employee = employeeSelect.value;
    const start = normalizeTimeInput(startTimeInput.value);
    const end = normalizeTimeInput(endTimeInput.value);
    const comment = personnelCommentInput.value;
    const hours = calculateHours();

    if (!employee || !start || !end || hours <= 0) {
        alert('Veuillez remplir tous les champs correctement.');
        return;
    }

    const record = {
        date: getISODate(personnelCurrentDate),
        employee: employee,
        startTime: start,
        endTime: end,
        comment: comment,
        hours: hours
    };

    personnelRecords.push(record);
    savePersonnelRecords();
    alert('Heures de travail ajoutées avec succès !');
    updatePersonnelDisplay();
}

prevPersonnelDay.addEventListener('click', () => {
    personnelCurrentDate.setDate(personnelCurrentDate.getDate() - 1);
    updatePersonnelDisplay();
});

nextPersonnelDay.addEventListener('click', () => {
    personnelCurrentDate.setDate(personnelCurrentDate.getDate() + 1);
    updatePersonnelDisplay();
});

function deletePersonnelRecord(index) {
    if (confirm('Voulez-vous vraiment supprimer cette entrée ?')) {
        personnelRecords.splice(index, 1);
        savePersonnelRecords();
        filterPersonnel();
    }
}

function filterPersonnel() {
    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    const showComments = document.getElementById('showComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    filteredPersonnelRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    const personnelList = document.getElementById('personnelList');

    if (filteredPersonnelRecords.length === 0) {
        personnelList.innerHTML = '<p>Aucune donnée à afficher pour cette période.</p>';
        return;
    }

    const totals = {};
    const commentTotals = {};

    filteredPersonnelRecords.forEach(record => {
        if (record.employee && record.employee.trim() !== '') {
            if (!totals[record.employee]) {
                totals[record.employee] = 0;
                commentTotals[record.employee] = 0;
            }
            totals[record.employee] += record.hours;
            if (showComments && record.comment && !isNaN(parseFloat(record.comment))) {
                commentTotals[record.employee] += parseFloat(record.comment);
            }
        }
    });

    const totalHoursDecimal = Object.values(totals).reduce((sum, hours) => sum + hours, 0);
    const totalHours = Math.floor(totalHoursDecimal);
    const totalMinutes = Math.round((totalHoursDecimal - totalHours) * 60);
    const totalComments = Math.round(Object.values(commentTotals).reduce((sum, comments) => sum + comments, 0));

    personnelList.innerHTML = `
        <h3>Activité du personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</h3>
        <div class="table-container">
            <table>
                <tr>
                    <th>Date</th>
                    <th>Employé</th>
                    <th>Début</th>
                    <th>Fin</th>
                    <th>Heures</th>
                    ${showComments ? '<th>Commentaire</th>' : ''}
                </tr>
                ${filteredPersonnelRecords.map((record, index) => {
                    let hourLabel = '';
                    if (record.employee && record.employee.trim() !== '') {
                        const hours = Math.floor(record.hours);
                        const minutes = Math.round((record.hours - hours) * 60);
                        hourLabel = `${hours}h`;
                        if (minutes !== 0) {
                            hourLabel += `${minutes.toString().padStart(2, '0')}`;
                        }
                    }
                    return `
                    <tr style="cursor:pointer" onclick="showPersonnelDetailFromIndex(${index})">
                        <td>${new Date(record.date).toLocaleDateString('fr-FR')}</td>
                        <td>${record.employee || ''}</td>
                        <td>${record.startTime}</td>
                        <td>${record.endTime}</td>
                        <td>${hourLabel}</td>
                        ${showComments ? `<td>${record.comment || ''}</td>` : ''}
                    </tr>`;
                }).join('')}
                ${Object.keys(totals).map(employee => {
                    const hours = Math.floor(totals[employee]);
                    const minutes = Math.round((totals[employee] - hours) * 60);
                    let hourLabel = `${hours}h`;
                    if (minutes !== 0) {
                        hourLabel += `${minutes.toString().padStart(2, '0')}`;
                    }
                    return `
                    <tr style="font-weight: bold; color: black;">
                        <td>Total ${employee}</td>
                        <td></td><td></td><td></td>
                        <td>${hourLabel}</td>
                        ${showComments ? `<td>${Math.round(commentTotals[employee])}</td>` : ''}
                    </tr>`;
                }).join('')}
                <tr style="font-weight: bold; color: black; font-size: 16px;">
                    <td>Total Général</td>
                    <td></td><td></td><td></td>
                    <td>${totalHours}h${totalMinutes.toString().padStart(2, '0')}</td>
                    ${showComments ? `<td>${totalComments}</td>` : ''}
                </tr>
            </table>
        </div>
    `;
}


function showPersonnelDetailFromIndex(index) {
    const record = filteredPersonnelRecords[index];
    selectedPersonnelRecord = record;

    document.getElementById('personnelDetailDate').textContent = `Date : ${new Date(record.date).toLocaleDateString('fr-FR')}`;
    document.getElementById('personnelDetailEmployee').textContent = `Employé : ${record.employee}`;
    document.getElementById("personnelDetailStartTime").textContent = "Début : " + record.startTime;
    document.getElementById("personnelDetailEndTime").textContent = "Fin : " + record.endTime;
    document.getElementById('personnelDetailHours').textContent = `Heures : ${formatHours(record.hours)}`;
    document.getElementById("personnelDetailComment").textContent = "Commentaire : " + record.comment;

    document.getElementById('personnelDetailPopup').classList.remove('hidden');
}
function closePersonnelDetail() {
    document.getElementById('personnelDetailPopup').classList.add('hidden');
    selectedPersonnelRecord = null;
}

function deleteSelectedPersonnel() {
    if (selectedPersonnelRecord) {
        if (confirm("Supprimer cet enregistrement ?")) {
            const idx = personnelRecords.findIndex(p =>
                p.date === selectedPersonnelRecord.date &&
                p.employee === selectedPersonnelRecord.employee &&
                p.hours === selectedPersonnelRecord.hours
            );

            if (idx !== -1) {
                personnelRecords.splice(idx, 1);
                localStorage.setItem('personnelRecords', JSON.stringify(personnelRecords));
                closePersonnelDetail();
                filterPersonnel();
                alert("Enregistrement supprimé !");
            }
        }
    }
}


// Fonction utilitaire pour formater les heures
function formatHours(hours) {
    const totalMinutes = Math.round(hours * 60); // Convertir en minutes et arrondir
    const h = Math.floor(totalMinutes / 60);
    const min = totalMinutes % 60;
    if (min === 0) {
        return `${h}h`;
    }
    return `${h}h${min.toString().padStart(2, '0')}min`;
}

function printPersonnel() {
    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    const showComments = document.getElementById('showComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (filteredRecords.length === 0) {
        alert("Aucune donnée du personnel à imprimer.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = showComments ? [28, 38, 28, 28, 28, 38] : [28, 38, 28, 28, 28];
    const rowHeight = 10;
    const tableX = margin;

    doc.setFontSize(12);
    doc.text(`Chez Barth-Activité du personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employé', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Début', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
    if (showComments) doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    filteredRecords.forEach(record => {
        if (y > doc.internal.pageSize.getHeight() - margin - 40) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Activité du personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employé', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Début', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
            if (showComments) doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }
        const hourLabel = record.employee && record.employee.trim() !== '' 
            ? `${Math.floor(record.hours)}h${Math.round((record.hours - Math.floor(record.hours)) * 60).toString().padStart(2, '0')}` 
            : '';
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(new Date(record.date).toLocaleDateString('fr-FR'), tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(record.employee || '', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(record.startTime, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(record.endTime, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
        if (showComments) doc.text(record.comment || '', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        y += rowHeight;
    });

    y += 5;
    if (y > doc.internal.pageSize.getHeight() - margin - 40) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    const totals = {};
    const commentTotals = {};
    filteredRecords.forEach(record => {
        if (record.employee && record.employee.trim() !== '') {
            if (!totals[record.employee]) totals[record.employee] = 0;
            if (!commentTotals[record.employee]) commentTotals[record.employee] = 0;
            totals[record.employee] += record.hours;
            if (showComments && record.comment && !isNaN(parseFloat(record.comment))) commentTotals[record.employee] += parseFloat(record.comment);
        }
    });
    const totalHours = Object.values(totals).reduce((sum, hours) => sum + hours, 0);
    const totalComments = Object.values(commentTotals).reduce((sum, comments) => sum + comments, 0);

    Object.keys(totals).forEach(employee => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
        }
        const hours = Math.floor(totals[employee]);
        const minutes = Math.round((totals[employee] - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(`Total ${employee}`, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
        if (showComments) doc.text(`${commentTotals[employee].toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        y += rowHeight;
    });

    if (Object.keys(totals).length > 0) {
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total Général', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
        if (showComments) doc.text(`${totalComments.toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    }

    window.open(doc.output('bloburl'), '_blank');
}

function downloadPersonnelPDF() {
    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    const showComments = document.getElementById('showComments').checked;

    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));

    if (filteredRecords.length === 0) {
        alert("Aucune donnée du personnel à télécharger.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 10;
    let y = margin;
    const colWidths = showComments ? [28, 38, 28, 28, 28, 38] : [28, 38, 28, 28, 28];
    const rowHeight = 10;
    const tableX = margin;

    doc.setFontSize(12);
    doc.text(`Chez Barth-Activité du personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
    doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employé', tableX + colWidths[0] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Début', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
    doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
    if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
    if (showComments) doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    y += rowHeight;

    doc.setFont('helvetica', 'normal');
    filteredRecords.forEach(record => {
        if (y > doc.internal.pageSize.getHeight() - margin - 40) {
            doc.addPage();
            y = margin;
            doc.setFontSize(12);
            doc.text(`Chez Barth-Activité du personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`, margin, y);
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Date', tableX + 2, y + 6);
            doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text('Employé', tableX + colWidths[0] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text('Début', tableX + colWidths[0] + colWidths[1] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text('Fin', tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
            doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text('Heures', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
            if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
            if (showComments) doc.text('Commentaire', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
            y += rowHeight;
            doc.setFont('helvetica', 'normal');
        }
        const hourLabel = record.employee && record.employee.trim() !== '' 
            ? `${Math.floor(record.hours)}h${Math.round((record.hours - Math.floor(record.hours)) * 60).toString().padStart(2, '0')}` 
            : '';
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(new Date(record.date).toLocaleDateString('fr-FR'), tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight); doc.text(record.employee || '', tableX + colWidths[0] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight); doc.text(record.startTime, tableX + colWidths[0] + colWidths[1] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight); doc.text(record.endTime, tableX + colWidths[0] + colWidths[1] + colWidths[2] + 2, y + 6);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
        if (showComments) doc.text(record.comment || '', tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        y += rowHeight;
    });

    y += 5;
    if (y > doc.internal.pageSize.getHeight() - margin - 40) {
        doc.addPage();
        y = margin;
    }
    doc.setFont('helvetica', 'bold');
    const totals = {};
    const commentTotals = {};
    filteredRecords.forEach(record => {
        if (record.employee && record.employee.trim() !== '') {
            if (!totals[record.employee]) totals[record.employee] = 0;
            if (!commentTotals[record.employee]) commentTotals[record.employee] = 0;
            totals[record.employee] += record.hours;
            if (showComments && record.comment && !isNaN(parseFloat(record.comment))) commentTotals[record.employee] += parseFloat(record.comment);
        }
    });
    const totalHours = Object.values(totals).reduce((sum, hours) => sum + hours, 0);
    const totalComments = Object.values(commentTotals).reduce((sum, comments) => sum + comments, 0);

    Object.keys(totals).forEach(employee => {
        if (y > doc.internal.pageSize.getHeight() - margin - 20) {
            doc.addPage();
            y = margin;
        }
        const hours = Math.floor(totals[employee]);
        const minutes = Math.round((totals[employee] - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text(`Total ${employee}`, tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
        if (showComments) doc.text(`${commentTotals[employee].toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
        y += rowHeight;
    });

    if (Object.keys(totals).length > 0) {
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
        doc.rect(tableX, y, colWidths[0], rowHeight); doc.text('Total Général', tableX + 2, y + 6);
        doc.rect(tableX + colWidths[0], y, colWidths[1], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1], y, colWidths[2], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2], y, colWidths[3], rowHeight);
        doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y, colWidths[4], rowHeight); doc.text(hourLabel, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2, y + 6);
        if (showComments) doc.rect(tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], y, colWidths[5], rowHeight); 
        if (showComments) doc.text(`${totalComments.toFixed(0)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2, y + 6);
    }

    const fileName = 'Activité_du_personnel_Chez_Barth.pdf'; 
    doc.save(fileName);

    // Message de confirmation
    setTimeout(() => {
    alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);

    // Tentative d'ouverture automatique (fonctionne uniquement si le navigateur le permet)
    const blob = doc.output('blob');
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, '_blank');
    }, 500);


}

async function printPersonnelToBluetooth() {
    const startDateInput = document.getElementById('personnelStartDate').value;
    const endDateInput = document.getElementById('personnelEndDate').value;
    let startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date('2024-01-01');
    let endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : new Date();

    const filteredRecords = personnelRecords.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate >= startDate && recordDate <= endDate;
    });

    if (filteredRecords.length === 0) {
        alert("Aucune donnée du personnel à imprimer.");
        return;
    }

    if (!navigator.bluetooth) {
        alert("Web Bluetooth API n'est pas disponible.");
        return;
    }

    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        let text = "CHEZ BARTH\n16 place des Precheurs\n13100 Aix en Provence\n\n";
        text += `Personnel du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}\n\n`;
        text += "-------------------------------\n";
        text += "Date   Employé   Heures\n";
        text += "-------------------------------\n";

        filteredRecords.forEach(record => {
            const dateStr = new Date(record.date).toLocaleDateString('fr-FR').substring(0, 5);
            const employeeStr = (record.employee || '').substring(0, 8).padEnd(8);
            const hourLabel = record.employee && record.employee.trim() !== '' 
                ? `${Math.floor(record.hours)}h${Math.round((record.hours - Math.floor(record.hours)) * 60).toString().padStart(2, '0')}` 
                : '';
            text += `${dateStr} ${employeeStr} ${hourLabel}\n`;
        });

        text += "-------------------------------\n";
        const totals = {};
        filteredRecords.forEach(record => {
            if (record.employee && record.employee.trim() !== '') {
                if (!totals[record.employee]) totals[record.employee] = 0;
                totals[record.employee] += record.hours;
            }
        });
        const totalHours = Object.values(totals).reduce((sum, hours) => sum + hours, 0);

        for (const employee in totals) {
            const hours = Math.floor(totals[employee]);
            const minutes = Math.round((totals[employee] - hours) * 60);
            const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
            text += `Total ${employee}: ${hourLabel}\n`;
        }

        if (Object.keys(totals).length > 0) {
            const hours = Math.floor(totalHours);
            const minutes = Math.round((totalHours - hours) * 60);
            const hourLabel = `${hours}h${minutes.toString().padStart(2, '0')}`;
            text += `Total Général: ${hourLabel}\n`;
        }

        text += "\nBilan du personnel terminé !\n\n";

        const encoder = new TextEncoder();
        const data = encoder.encode(text + '\x1B\x64\x02\x1D\x56\x00');
        await characteristic.writeValue(data);

        alert("Impression Bluetooth réussie !");
        server.disconnect();
    } catch (error) {
        console.error("Erreur Bluetooth :", error);
        alert("Erreur lors de l'impression Bluetooth : " + error.message);
    }
}

// Gestion des clics hors dropdown
window.onclick = function(event) {
    if (!event.target.matches('.dropdown button')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
}



// Désactiver le pull to refresh
document.addEventListener('touchstart', function(e) {
    // Stocker la position initiale du toucher
    window.touchStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchmove', function(e) {
    const touchY = e.touches[0].clientY;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;

    // Si on est en haut de la page et qu'on tire vers le bas
    if (scrollTop === 0 && touchY > window.touchStartY) {
        e.preventDefault(); // Empêche le comportement par défaut (refresh)
    }
}, { passive: false }); // "passive: false" est nécessaire pour que preventDefault fonctionne

// Initialisation
updatePersonnelDisplay();

// Redéfinir les fonctions de navigation existantes
function backToHome() { navigateTo('homePage'); }
function backToRecipeBook() { navigateTo('recipeBookPage'); }
function backToPurchases() { navigateTo('purchasesPage'); }
function backToPersonnel() { navigateTo('personnelPage'); }
function backToInvoice() { navigateTo('invoicePage'); }
function backToInvoiceManagement() { navigateTo('invoiceManagementPage'); }
function showRecipeBook() { navigateTo('recipeBookPage'); }
function showPurchases() { navigateTo('purchasesPage'); }
function showPersonnel() { navigateTo('personnelPage'); }
function showInvoice() { navigateTo('invoicePage'); }
function showRecipeManagement() { navigateTo('recipeManagementPage'); }
function showPurchasesManagement() { navigateTo('purchasesManagementPage'); }
function showPersonnelManagement() { navigateTo('personnelManagementPage'); }
function showInvoiceManagement() { navigateTo('invoiceManagementPage'); }

// Gérer le bouton "Retour" (Android et iOS via popstate)
window.addEventListener('popstate', function(event) {
    const pages = [
        'homePage', 'recipeBookPage', 'recipeManagementPage', 'invoicePage', 
        'invoiceManagementPage', 'invoiceDetailPage', 'purchasesPage', 
        'purchasesManagementPage', 'personnelPage', 'personnelManagementPage',
        'passwordPage', 'budgetPage', 'settingsPage'
    ];

    const homePage = document.getElementById('homePage');

    if (event.state && event.state.page) {
        const currentPage = event.state.page;
        pages.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(currentPage).classList.remove('hidden');

        if (currentPage === 'recipeBookPage') updateRecipeDisplay();
        if (currentPage === 'purchasesPage') updatePurchaseDisplay();
        if (currentPage === 'personnelPage') updatePersonnelDisplay();
        if (currentPage === 'recipeManagementPage') filterRecipes();
        if (currentPage === 'invoiceManagementPage') filterInvoices();
        if (currentPage === 'purchasesManagementPage') filterPurchases();
        if (currentPage === 'personnelManagementPage') filterPersonnel();

        if (currentPage === 'homePage') {
            history.replaceState(null, '', '#');
        }
    } else {
        if (!homePage.classList.contains('hidden')) {
            window.close();
            history.replaceState(null, '', '#');
        } else {
            pages.forEach(id => document.getElementById(id).classList.add('hidden'));
            homePage.classList.remove('hidden');
            history.replaceState(null, '', '#');
        }
    }
});




// Fonction pour afficher la page Budget
function showBudget() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('recipeBookPage').classList.add('hidden');
    document.getElementById('recipeManagementPage').classList.add('hidden');
    document.getElementById('invoicePage').classList.add('hidden');
    document.getElementById('invoiceManagementPage').classList.add('hidden');
    document.getElementById('invoiceDetailPage').classList.add('hidden');
    document.getElementById('purchasesPage').classList.add('hidden');
    document.getElementById('purchasesManagementPage').classList.add('hidden');
    document.getElementById('personnelPage').classList.add('hidden');
    document.getElementById('personnelManagementPage').classList.add('hidden');
    document.getElementById('budgetPage').classList.remove('hidden');
    calculerResultat(); // Calculer les résultats initiaux lors de l'affichage
}

function calculerResultat() {
    // Récupération des valeurs des inputs
    var prix = parseFloat(document.getElementById('prix').value);
    var cout = parseFloat(document.getElementById('cout').value);
    var panier = parseFloat(document.getElementById('panier').value);
    var jours = parseFloat(document.getElementById('jours').value);
    var semaines = parseFloat(document.getElementById('semaines').value);
    var loyerMensuel = parseFloat(document.getElementById('loyer').value);
    var charges = parseFloat(document.getElementById('charges').value);
    var externes = parseFloat(document.getElementById('externes').value);
    var salaire = parseFloat(document.getElementById('salaire').value);
    var patronales = parseFloat(document.getElementById('patronales').value) / 100;
    var urssaf = parseFloat(document.getElementById('urssaf').value) / 100;
    var tva = parseFloat(document.getElementById('tva').value) / 100;
    var apport = parseFloat(document.getElementById('apport').value);

   // Calcul du chiffre d'affaires annuel
var chiffreAffaires = prix * panier * jours * semaines;

// Calcul des charges fixes utilisées dans plusieurs calculs
var loyerAnnuel = loyerMensuel * 12;
var coutMatieres = cout * panier * jours * semaines;

// Calcul de la TVA (à partir de 85000€ de CA)
// TVA encaissée - TVA déductible sur achats (5,5%) - TVA déductible sur loyer/charges externes (20%)
var tvaCalcul = (chiffreAffaires > 85000) ? 
    (chiffreAffaires - 85000) * (
        (tva / (1 + tva)) - 
        (cout / prix) * (0.055 / (1 + 0.055)) - 
        ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))
    ) 
    : 0;

// Calcul des charges de personnel (salaire brut annuel + charges patronales)
var chargesPersonnel = salaire * 12 * (1 + patronales);

// Calcul des charges d'exploitation
var chargesExploitation = loyerAnnuel + charges + chargesPersonnel + coutMatieres + externes;

// Calcul des charges sociales et impôts
var chargesUrssaf = chiffreAffaires * urssaf;

// Calcul du bénéfice net
var beneficeNet = chiffreAffaires - (chargesExploitation + tvaCalcul + chargesUrssaf);

// Calcul de l'amortissement annuel
var amortissement = apport / 7;

// Calcul du résultat financier
var resultatFinancier = beneficeNet - amortissement;

// Calcul de la rentabilité économique minimum (Nb ventes pour bénéfice net > 0)
var nbVentesEconomique = calculerRentabiliteMinimum('economique', prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva);

// Calcul de la rentabilité financière minimum (Nb ventes pour résultat financier > 0)
var nbVentesFinanciere = calculerRentabiliteMinimum('financiere', prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva);

// Affichage des résultats avec formatage et vérification des valeurs négatives
var resultat = document.getElementById('resultat');
var beneficeNetClass = beneficeNet < 0 ? 'negative' : '';

resultat.innerHTML = `
    <p><strong>RESULTATS</strong> (calculés automatiquement) : </p>
    <p><strong>   </p>
    <h2 style="text-align: center;">COMPTE DE RESULTAT PREVISIONNEL</h2>
    <p><strong>   </p>
    <p><strong>* CHIFFRE D'AFFAIRES ANNUEL: ${chiffreAffaires.toFixed(0)} € (CA)</strong></p>

    <ul>
        <p>Détail charges annuelles d'exploitation:</p>
        <ul>
            <li style="font-weight: normal;">Loyer :  ${loyerAnnuel.toFixed(0)} €</li>
            <li style="font-weight: normal;">Salaires et charges du personnel: ${chargesPersonnel.toFixed(0)} €</li>
            <li style="font-weight: normal;">Achats alimentaires (Coût de revient matières): ${coutMatieres.toFixed(0)} €</li>
            <li style="font-weight: normal;">Charges externes (compta, pub, banque...): ${externes.toFixed(0)} €</li>
            <li style="font-weight: normal;">Charges électricité gaz eau téléphone assurance: ${charges.toFixed(0)} €</li>
        </ul>
    </ul>
    <p><strong>* Total charges annuelles d'exploitation: ${chargesExploitation.toFixed(0)} € (C)</strong></p>
    <p><strong>* TVA-TVA déductible (si CA > 85000€): ${tvaCalcul.toFixed(0)} € (T)</strong></p>
    <p><strong>* Impôts Cotisations sociales Mathis: ${chargesUrssaf.toFixed(0)} € (I)</strong></p>
    <p><strong>* BENEFICE NET ANNUEL: <span class="${beneficeNetClass}">${beneficeNet.toFixed(0)} € (CA-C-T-I)</span></strong></p>

    <p><strong>Rentabilité économique mini (point mort) :</strong> Nb ventes mini journalier à faire pour couvrir les charges et impôts : <strong>${nbVentesEconomique}</strong> ; soit chiffre d'affaire mini/jour : <strong>${(nbVentesEconomique * prix).toFixed(0)} €</strong></p>
    <p>  </p>`;

    
    // Appel pour calculer et afficher le tableau des bénéfices nets mensuels
    afficherTableauBenefices(prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva);
}

function calculerRentabiliteMinimum(type, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, tva, amortissement = 0) {
    for (let i = 1; i <= 300; i++) {
        var chiffreAffaires = prix * i * jours * semaines;
        var chargesPersonnel = salaire * 12 * (1 + patronales);
        var loyerAnnuel = loyerMensuel * 12;
        var coutMatieres = cout * i * jours * semaines;
        var chargesExploitation = loyerAnnuel + charges + chargesPersonnel + coutMatieres + externes;
        var chargesUrssaf = chiffreAffaires * urssaf;

        // Calcul de la TVA seulement si le chiffre d'affaires dépasse 85 000€
        var tvaCalcul = 0;
        if (chiffreAffaires > 85000) {
            tvaCalcul = (chiffreAffaires - 85000) * (tva / (1 + tva) - (cout / prix) * (0.055 / (1 + 0.055)) - ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / 1 + 0.2));
        }

        // Calcul du bénéfice net
        var beneficeNet = chiffreAffaires - (chargesExploitation + tvaCalcul + chargesUrssaf);

        // Affichage pour le débogage
        console.log(`Iteration: ${i} | Chiffre d'affaires: ${chiffreAffaires} | TVA: ${tvaCalcul} | Bénéfice net: ${beneficeNet}`);

        // Vérification de la rentabilité en fonction du type
        if (type === 'economique' && beneficeNet >= 0) {
            console.log(`Rentabilité atteinte à l'itération ${i} avec un bénéfice net de ${beneficeNet}`);
            return i;  // Retourne l'itération dès que rentabilité atteinte
        } else if (type === 'financiere' && beneficeNet >= amortissement) {
            console.log(`Rentabilité atteinte à l'itération ${i} avec un bénéfice net de ${beneficeNet}`);
            return i;  // Retourne l'itération dès que rentabilité atteinte
        }
    }
    return 300; // Valeur par défaut si aucune rentabilité n'est trouvée
}

function afficherTableauBenefices(prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva) {
    var tableau = document.getElementById('tableauBenefices');
    
    // Création du tableau des bénéfices
    tableau.innerHTML = `
    <tr>
        <th>Revenu net moyen mensuel Mathis sur 12 mois (congés compris)</th>
        <th>1000€</th>
        <th>2000€</th>
        <th>3000€</th>
        <th>4000€</th>
    </tr>
    <tr>
        <td>Nombre de ventes journalières nécessaire</td>
        ${calculerVentesPourBenefices(1000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva)}
        ${calculerVentesPourBenefices(2000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva)}
        ${calculerVentesPourBenefices(3000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva)}
        ${calculerVentesPourBenefices(4000, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva)}
    </tr>`;
}




function calculerVentesPourBenefices(beneficeMensuel, prix, cout, jours, semaines, loyerMensuel, charges, salaire, patronales, externes, urssaf, amortissement, tva) {
    for (let i = 0; i <= 1000; i++) {
        var loyerAnnuel = loyerMensuel * 12;
        var chiffreAffaires = prix * i * jours * semaines;

        var tvaCalcul = (chiffreAffaires > 85000) ?
            (chiffreAffaires - 85000) * (
                (tva / (1 + tva)) -
                (cout / prix) * (0.055 / (1 + 0.055)) -
                ((loyerAnnuel + charges + externes) / chiffreAffaires) * (0.2 / (1 + 0.2))
            ) :
            0;

        var chargesPersonnel = salaire * 12 * (1 + patronales);
        var coutMatieres = cout * i * jours * semaines;
        var chargesExploitation = loyerAnnuel + charges + chargesPersonnel + coutMatieres + externes;
        var chargesUrssaf = chiffreAffaires * urssaf;
        var beneficeNet = chiffreAffaires - (chargesExploitation + tvaCalcul + chargesUrssaf);

        if (beneficeNet >= (beneficeMensuel * 12)) {
            return `<td>${i}</td>`;
        }
    }
    return `<td>Non atteint</td>`;
}


// Appel initial pour afficher les résultats par défaut
calculerResultat();

// Fonction pour exporter en Word
document.getElementById('exportWord').addEventListener('click', function () {
    var header = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Export HTML To Doc</title>
        <style>
            @page { 
                size: A4; 
                margin: 1cm; /* Marges réduites à 1 cm */
            }
            body { 
                font-family: Arial, sans-serif; 
                margin: 0;
                padding: 0;
                font-size: 10pt; /* Réduction de la taille de police */
                width: 100%;
            }
            h1 { 
                text-align: center; 
                border: 2px solid #000; 
                padding: 10px; 
                margin: 10px 0; 
                font-size: 12pt; /* Réduction de la taille de police pour le titre */
            }
            h2 { 
                text-align: center; 
                margin: 5px 0; 
                font-size: 11pt; /* Réduction de la taille de police pour les sous-titres */
            }
            p {
                margin: 5px 0; 
            }
            table { 
                width: 100%; 
                border-collapse: collapse; 
                font-size: 9pt; /* Réduction de la taille de police dans le tableau */
            }
            th, td { 
                border: 1px solid #000; 
                padding: 4px; 
                text-align: center;
            }
            th {
                background-color: #f2f2f2;
            }
            .revenue-net { 
                background-color: #d3d3d3; /* Gris clair pour les revenus nets */
            }
        </style>
        </head><body>
        <h1 style="text-align: center;">BUDGET PREVISIONNEL</h1>
        <h2 style="text-align: center;">Sandwicherie CHEZ BARTH</h2>
        <p>Entrepreneur :  Mathis MOUHOU</p>
        <p>Enseigne / nom commercial :  CHEZ BARTH</p>
        <p>Statut Juridique : Entreprise Individuelle</p>
        <p>Régime fiscal/social :  Micro-entrepreneur</p>
        <br><p><strong>DONNEES D'ENTREE</strong> :</p>
        <br><p><strong> </p>
    `;

    // Récupérer les données quantitatives saisies par l'utilisateur
    var data = `
        <p>Prix de vente du panier moyen (€): ${document.getElementById('prix').value}</p>
        <p>Coût de revient matière du panier moyen (€): ${document.getElementById('cout').value}</p>
        <p>Nombre de paniers par jour: ${document.getElementById('panier').value}</p>
        <p>Nombre de jours de travail par semaine: ${document.getElementById('jours').value}</p>
        <p>Nombre de semaines de travail par an: ${document.getElementById('semaines').value}</p>
        <p>Loyer CC mensuel (€): ${document.getElementById('loyer').value}</p>
        <p>Charges annuelles d'électricité, gaz, eau, téléphone, assurance (€): ${document.getElementById('charges').value}</p>
        <p>Charges annuelles externes (€): ${document.getElementById('externes').value}</p>
        <p>Salaire du personnel brut mensuel (temps partiel ou temps plein) (€): ${document.getElementById('salaire').value}</p>
        <p>Taux de cotisation des charges patronales (%): ${document.getElementById('patronales').value}</p>
        <p>Taux de cotisations sociales (%): ${document.getElementById('urssaf').value}</p>
        <p>Taux de TVA (%): ${document.getElementById('tva').value}</p>
        <p>Apport financier ou emprunt (€): ${document.getElementById('apport').value}</p>
    `;

    // Récupérer le contenu des résultats
    var results = document.getElementById('resultat').innerHTML;

    // Récupérer le contenu du tableau des bénéfices
    var tableauBenefices = document.getElementById('tableauBenefices').outerHTML;

    // Ajouter une classe CSS aux cellules "Revenu net mensuel"
    tableauBenefices = tableauBenefices.replace(/<td>([^<]+ €)<\/td>/g, function (match, p1) {
        return `<td class="revenue-net">${p1}</td>`;
    });

    // Construire le document Word avec des sauts de ligne et le tableau formaté
    var footer = `
       <br><p><strong> </p>
        ${results}
        <br><p><strong>TABLEAU DES BENEFICES NETS MENSUELS EN FONCTION DES VENTES QUOTIDIENES</strong> :</p>
        ${tableauBenefices}
        </body></html>
    `;

    var sourceHTML = header + data + footer;

    var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
    var fileDownload = document.createElement("a");
    document.body.appendChild(fileDownload);
    fileDownload.href = source;
    fileDownload.download = 'Budget_Barth.doc';
    fileDownload.click();
    document.body.removeChild(fileDownload);
});

document.getElementById('exportPdf').addEventListener('click', function () {
    const exportPdfBtn = document.getElementById('exportPdf');
    const exportWordBtn = document.getElementById('exportWord');
    const retourBtn = document.getElementById('retour');

    // Cibler tous les boutons potentiels à masquer
    const allButtons = document.querySelectorAll('button, [id*="retour"], [class*="retour"], [class*="back"], [class*="return"]');

    // Masquer tous les boutons
    [exportPdfBtn, exportWordBtn, retourBtn].forEach(btn => {
        if (btn) btn.style.display = 'none';
    });
    allButtons.forEach(btn => btn.style.display = 'none');

    const element = document.querySelector('.container');
    const today = new Date().toISOString().split('T')[0];
    const fileName = `Budget_Chez_Barth_${today}.pdf`;

    const opt = {
        margin: 0.5,
        filename: fileName,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().from(element).set(opt).toPdf().get('pdf')
        .then(function (pdf) {
            const totalPages = pdf.internal.getNumberOfPages();
            if (totalPages > 3) {
                console.warn(`⚠️ Document généré avec ${totalPages} pages. Envisagez d'ajuster le contenu.`);
            }

            // ✅ Message + ouverture
            alert(`Fichier "${fileName}" téléchargé dans le dossier Téléchargements.`);
            const blob = pdf.output('blob');
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        })
        .catch(function (error) {
            console.error("❌ Erreur lors de la génération du PDF :", error);
            alert("❌ Une erreur est survenue lors de l'export du PDF.");
        })
        .finally(() => {
            // Toujours restaurer les boutons
            [exportPdfBtn, exportWordBtn, retourBtn].forEach(btn => {
                if (btn) btn.style.display = 'block';
            });
            allButtons.forEach(btn => btn.style.display = 'block');
        });
});


// Fonctions pour la gestion des données (remplacez les versions existantes)
    function backupData() {
        try {
            const allData = {
                salesData: JSON.parse(localStorage.getItem('salesData')) || (typeof initialSalesData !== 'undefined' ? initialSalesData : {}),
                purchases: JSON.parse(localStorage.getItem('purchases')) || (typeof initialPurchases !== 'undefined' ? initialPurchases : []),
                personnelRecords: JSON.parse(localStorage.getItem('personnelRecords')) || (typeof initialPersonnelRecords !== 'undefined' ? initialPersonnelRecords : []),
                invoices: JSON.parse(localStorage.getItem('savedInvoices')) || [], // Utiliser savedInvoices
                menu: JSON.parse(localStorage.getItem('menu')) || (typeof initialMenu !== 'undefined' ? initialMenu : [])
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chez_barth_backup.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert("Données sauvegardées ! Vérifiez votre dossier Téléchargements pour le fichier chez_barth_backup.json.");
        } catch (error) {
            console.error("Erreur lors de la sauvegarde des données :", error);
            alert("Une erreur s'est produite lors de la sauvegarde des données. Vérifiez la console pour plus de détails.");
        }
    }

const initialMenu = [
    { name: "Pulled Beef", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Prosciutto al Tartufo", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie", priceTTC: 9.0, priceHT: 8.18, type: "S", tvaRate: 0.1 },
    { name: "Cheesy Veggie-Bacon", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 },
    { name: "Chicken Azul", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Philly Cheesesteak", priceTTC: 11.0, priceHT: 10.0, type: "S", tvaRate: 0.1 },
    { name: "Gelato à la pistache", priceTTC: 4.5, priceHT: 4.09, type: "S", tvaRate: 0.1 },
    { name: "Nocciolata", priceTTC: 3.0, priceHT: 2.73, type: "S", tvaRate: 0.1 },
    { name: "Boisson Sodas", priceTTC: 2.5, priceHT: 2.37, type: "B", tvaRate: 0.055 },
    { name: "Boisson Eau", priceTTC: 1.5, priceHT: 1.42, type: "B", tvaRate: 0.055 },
    { name: "Offre étudiante", priceTTC: 10.0, priceHT: 9.09, type: "S", tvaRate: 0.1 }
];



    function resetData() {
        if (confirm("Êtes-vous sûr de vouloir réinitialiser toutes les données ? Cette action supprimera toutes les données stockées et restaurera les données initiales.")) {
            if (confirm("Confirmez une dernière fois : toutes les données seront perdues. Continuer ?")) {
                try {
                    // Débogage : Afficher les clés actuelles
                    console.log("Clés localStorage avant réinitialisation :", Object.keys(localStorage));
                    
                    // Vider complètement le localStorage
                    localStorage.clear();
                    
                    // Restaurer les données initiales
                    localStorage.setItem('salesData', JSON.stringify(typeof initialSalesData !== 'undefined' ? initialSalesData : {}));
                    localStorage.setItem('purchases', JSON.stringify(typeof initialPurchases !== 'undefined' ? initialPurchases : []));
                    localStorage.setItem('personnelRecords', JSON.stringify(typeof initialPersonnelRecords !== 'undefined' ? initialPersonnelRecords : []));
                    localStorage.setItem('savedInvoices', JSON.stringify([])); // Vider savedInvoices
                    localStorage.setItem('menu', JSON.stringify(typeof initialMenu !== 'undefined' ? initialMenu : []));
                    
                    // Réinitialiser la variable globale invoices et le compteur
                    if (typeof invoices !== 'undefined') invoices = [];
                    if (typeof invoiceCounter !== 'undefined') invoiceCounter = 0;
                    
                    // Débogage : Afficher les clés après réinitialisation
                    console.log("Clés localStorage après réinitialisation :", Object.keys(localStorage));
                    console.log("Contenu de 'savedInvoices' après réinitialisation :", localStorage.getItem('savedInvoices'));
                    
                    alert("Données réinitialisées avec succès !");
                    
                    // Rafraîchir les affichages
                    if (typeof filterRecipes === 'function') filterRecipes();
                    if (typeof filterPurchases === 'function') filterPurchases();
                    if (typeof filterPersonnel === 'function') filterPersonnel();
                    if (typeof loadInvoices === 'function') loadInvoices(); // Synchroniser invoices
                    if (typeof filterInvoices === 'function') filterInvoices();
                    if (typeof updateInvoiceDisplay === 'function') updateInvoiceDisplay();
                    if (typeof showInvoice === 'function') showInvoice();
                    
                    // Forcer la navigation vers la page des factures si ouverte
                    if (document.getElementById('invoicePage') && typeof navigateTo === 'function') {
                        navigateTo('invoicePage');
                    }
                } catch (error) {
                    console.error("Erreur lors de la réinitialisation des données :", error);
                    alert("Une erreur s'est produite lors de la réinitialisation. Vérifiez la console pour plus de détails.");
                }
            }
        }
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.accept = '.json,application/json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Valider les données importées
                    if (!importedData.salesData || !importedData.purchases || !importedData.personnelRecords || !importedData.invoices || !importedData.menu) {
                        alert("Fichier invalide : structure de données incorrecte.");
                        return;
                    }
                    
                    // Mettre à jour le localStorage
                    localStorage.setItem('salesData', JSON.stringify(importedData.salesData));
                    localStorage.setItem('purchases', JSON.stringify(importedData.purchases));
                    localStorage.setItem('personnelRecords', JSON.stringify(importedData.personnelRecords));
                    localStorage.setItem('savedInvoices', JSON.stringify(importedData.invoices)); // Utiliser savedInvoices
                    localStorage.setItem('menu', JSON.stringify(importedData.menu));
                    
                    // Synchroniser la variable globale invoices
                    if (typeof invoices !== 'undefined') invoices = importedData.invoices;
                    if (typeof invoiceCounter !== 'undefined' && Array.isArray(importedData.invoices) && importedData.invoices.length > 0) {
                        invoiceCounter = Math.max(...importedData.invoices.map(i => i.number || 0));
                    }
                    
                    // Débogage : Afficher le contenu importé
                    console.log("Contenu de 'savedInvoices' après importation :", localStorage.getItem('savedInvoices'));
                    
                    alert("Données importées avec succès !");
                    
                    // Rafraîchir les affichages
                    if (typeof filterRecipes === 'function') filterRecipes();
                    if (typeof filterPurchases === 'function') filterPurchases();
                    if (typeof filterPersonnel === 'function') filterPersonnel();
                    if (typeof loadInvoices === 'function') loadInvoices(); // Synchroniser invoices
                    if (typeof filterInvoices === 'function') filterInvoices();
                    if (typeof updateInvoiceDisplay === 'function') updateInvoiceDisplay();
                    if (typeof showInvoice === 'function') showInvoice();
                    
                    // Forcer la navigation vers la page des factures si ouverte
                    if (document.getElementById('invoicePage') && typeof navigateTo === 'function') {
                        navigateTo('invoicePage');
                    }
                } catch (error) {
                    console.error("Erreur lors de l'importation :", error);
                    alert("Erreur lors de l'importation : fichier JSON invalide.");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    

      </script>
<script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .then(() => console.log("Service Worker installé ✅"))
          .catch(err => console.error("Erreur SW :", err));
      }
    </script>

    
    </body>
</html>
